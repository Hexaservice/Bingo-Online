<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cantar Sorteo</title>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(rgba(255,255,255,0.7), rgba(255,255,255,0.7)),
                  url('https://img.freepik.com/vectores-premium/padrao-sem-costura-com-simbolos-de-dolar-e-porcentagem_637741-777.jpg');
      background-repeat: repeat;
      background-size: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      text-align: center;
      padding: 10px 5px 40px;
      box-sizing: border-box;
    }
    h1 {
      font-family: 'Bangers', cursive;
      color: white;
      text-shadow: 0 0 12px #1e3aa8;
      margin: 5px 0 10px 0;
      font-size: 2rem;
    }
    .menu-btn {
      width: 250px;
      height: 60px;
      font-family: 'Bangers', cursive;
      font-size: 1.4rem;
      background: rgba(0, 170, 255, 0.8);
      color: white;
      border: 4px solid #FFD700;
      border-radius: 10px;
      text-shadow: 2px 2px 4px #000;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
    }
    .menu-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(255,215,0,0.8); }
    .menu-btn:active { transform: scale(0.95); box-shadow: 0 0 5px rgba(255,215,0,0.8); }
    #salir-btn {
      position: fixed;
      top: 5px;
      left: 5px;
      width: 120px;
      height: 40px;
      background: orange;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      font-size: 1.2rem;
    }
    #salir-btn .label { font-size: 1.1rem; }
    @media (orientation: portrait) {
      #salir-btn { width: 40px; }
      #salir-btn .label { display: none; }
      #detalle-container { margin-left: 5px; margin-right: 5px; }
    }
    #sorteo-btn {
      width: 240px;
      font-size: 1.1rem;
      padding: 6px 10px;
      text-align: center;
      border: 3px solid #FFD700;
      border-radius: 10px;
      background: linear-gradient(#dddddd, #ffffff);
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-transform: uppercase;
      color: #000;
      font-family: 'Bangers', cursive;
      text-shadow: 1px 1px 2px #fff;
    }
    #sorteo-btn.diario { background: linear-gradient(#008000,#ffffff); }
    #sorteo-btn.especial { background: linear-gradient(#ff8800,#ffffff); }
    #sorteo-btn.finalizado { background: linear-gradient(#444,#bbbbbb); color: #fff; }
    #sorteo-btn.jugando { background: linear-gradient(#6a0dad,#ffffff); color: #fff; }
    .sorteo-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      margin-bottom: 10px;
    }
    #fecha-hora-sorteo {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-family: 'Bangers', cursive;
      font-size: 1rem;
    }
    #fecha-sorteo, #hora-sorteo {
      display: flex;
      gap: 6px;
      align-items: center;
      justify-content: center;
      color: #0f2a0f;
      white-space: nowrap;
    }
    .datos-sorteo {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      justify-content: center;
      margin-top: 5px;
      font-family: 'Bangers', cursive;
    }
    #premio-repartir {
      color: white;
      font-family: 'Bangers', cursive;
      font-size: 1.6rem;
      text-shadow: 0 0 10px #004488;
      display: flex;
      gap: 6px;
      align-items: center;
    }
    #premio-valor { text-shadow: 0 0 10px #004488; }
    #stats-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    #valor-carton, #cartones-jugando {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #fff;
      text-shadow: 0 0 6px #003300;
      font-size: 1.3rem;
    }
    #valor-carton span.valor, #cartones-jugando span.valor { font-size: 1.6rem; }
    #cartones-jugando span.extra { color: #00008b; text-shadow: 0 0 6px #fff; }
    #detalle-container {
      border: 2px solid #013220;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(0,60,0,0.85), rgba(255,255,255,0.95));
      padding: 15px 14px 20px;
      margin: 10px auto 0;
      width: min(420px, 92vw);
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }
    #sorteo-nombre {
      font-size: 1rem;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 0 6px #000;
      margin-bottom: 6px;
    }
    #estado-actual {
      font-family: 'Bangers', cursive;
      font-size: 1.2rem;
      color: #111;
      text-shadow: 0 0 4px rgba(255,255,255,0.8);
      display: flex;
      justify-content: center;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }
    .estado-badge {
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 1rem;
      letter-spacing: 1px;
    }
    .estado-badge.activo { background: rgba(0,128,0,0.15); color: #0f8b0f; border: 1px solid rgba(15,139,15,0.5); }
    .estado-badge.sellado { background: rgba(110,110,110,0.2); color: #444; border: 1px solid rgba(110,110,110,0.5); }
    .estado-badge.jugando { background: rgba(106,13,173,0.15); color: #6a0dad; border: 1px solid rgba(106,13,173,0.4); animation: zoomInOut 1.2s ease-in-out infinite; }
    .estado-badge.finalizado { background: rgba(30,30,30,0.1); color: #000; border: 1px solid rgba(0,0,0,0.4); }
    #resumen-sorteo {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-family: 'Poppins', sans-serif;
      color: #0b1d0b;
      font-weight: 600;
      align-items: center;
    }
    #resumen-sorteo div { display: flex; justify-content: center; gap: 12px; align-items: center; flex-wrap: wrap; font-size: 0.95rem; }
    #tipo-sorteo span { white-space: nowrap; text-transform: uppercase; }
    #acciones-sorteo {
      margin-top: 14px;
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .estado-btn {
      width: 52px;
      height: 52px;
      border-radius: 12px;
      border: 3px solid #FFD700;
      background: linear-gradient(#0a8800,#ffffff);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0,0,0,0.4);
      transition: transform 0.2s;
    }
    .estado-btn:hover { transform: scale(1.05); }
    #pdf-btn { background: linear-gradient(#003c71,#ffffff); }
    #jugar-btn { background: linear-gradient(#4b0082,#ffffff); }
    #finalizar-btn { background: linear-gradient(#8b0000,#ffffff); }
    .estado-btn img { width: 24px; height: 24px; }
    #tabla-cantos-wrapper {
      margin: 16px auto 0;
      width: min(420px, 92vw);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    #tabla-cantos-titulo {
      font-family: 'Bangers', cursive;
      font-size: 1.2rem;
      color: #0f2a0f;
      text-shadow: 0 0 4px rgba(255,255,255,0.8);
      margin: 0;
    }
    #tabla-cantos-container {
      width: 100%;
      border-radius: 12px;
      padding: 10px;
      background: linear-gradient(145deg, rgba(255,255,255,0.85), rgba(200,255,200,0.9));
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      transition: filter 0.3s ease, opacity 0.3s ease;
    }
    #tabla-cantos-container.disabled {
      filter: grayscale(0.9);
      opacity: 0.75;
    }
    #tabla-cantos {
      width: 100%;
      border-collapse: separate;
      border-spacing: 6px;
      text-align: center;
      font-family: 'Bangers', cursive;
    }
    #tabla-cantos thead th {
      font-size: 1.4rem;
      color: #0a5c0a;
      text-shadow: 0 0 6px #fff;
    }
    .canto-cell {
      border-radius: 10px;
      padding: 8px 4px;
      font-size: 1.1rem;
      background: linear-gradient(160deg, rgba(240,255,240,0.95), rgba(180,235,180,0.9));
      border: 2px solid rgba(15,90,15,0.5);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .canto-cell:hover {
      transform: scale(1.05);
      box-shadow: 0 0 6px rgba(0,128,0,0.6);
    }
    .canto-cell.selected {
      background: radial-gradient(circle at center, rgba(0,200,0,0.85), rgba(255,255,0,0.9));
      color: #083108;
      box-shadow: 0 0 8px rgba(255,255,0,0.8);
      transform: scale(1.03);
    }
    #tabla-cantos-container.disabled .canto-cell {
      pointer-events: none;
      cursor: default;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.75);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      padding: 12px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 6px;
      width: min(420px, 90vw);
      max-height: 80vh;
      overflow-y: auto;
      font-family: 'Poppins', sans-serif;
    }
    .sorteo-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 6px 8px;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .sorteo-item:hover { border-color: #1e90ff; }
    .sorteo-item.diario { background: linear-gradient(#b8ffb8, #ffffff); }
    .sorteo-item.especial { background: linear-gradient(#ffd1a1,#ffffff); }
    .sorteo-item.sellado { background: linear-gradient(#cccccc,#ffffff); color: #333; }
    .sorteo-item.jugando { background: linear-gradient(#d8b0ff,#ffffff); color: #331155; }
    .sorteo-item.finalizado { background: linear-gradient(#aaaaaa,#eeeeee); color: #222; }
    .sorteo-header { display: flex; justify-content: space-between; font-weight: 700; font-size: 1rem; }
    .sorteo-detalle { display: flex; gap: 6px; align-items: center; font-size: 0.85rem; }
    .sorteo-extra { display: flex; flex-direction: column; gap: 3px; font-size: 0.8rem; color: #0f2a0f; }
    .attention { animation: zoomInOut 1s infinite; }
    @keyframes zoomInOut { 0%,100% { transform: scale(1); } 50% { transform: scale(1.15); } }
    #mensaje-area {
      margin-top: 10px;
      font-family: 'Poppins', sans-serif;
      color: #111;
      font-size: 0.9rem;
      background: rgba(255,255,255,0.6);
      padding: 6px 10px;
      border-radius: 8px;
      max-width: 480px;
    }
    #footer {
      margin-top: auto;
      font-size: 0.7rem;
      color: #000;
      text-align: center;
    }
    #footer #derechos { font-size: 0.6rem; }
  </style>
</head>
<body>
  <button id="salir-btn" class="menu-btn"><span class="tri">&#9664;</span><span class="label">Salir</span></button>
  <h1>CANTAR SORTEO</h1>
  <section id="sorteo-section">
    <div class="sorteo-info">
      <button id="sorteo-btn">Selecciona Sorteo</button>
      <div id="fecha-hora-sorteo">
        <div id="fecha-sorteo"></div>
        <div id="hora-sorteo"></div>
      </div>
    </div>
    <div class="datos-sorteo">
      <div id="premio-repartir"><span>PREMIO A REPARTIR:</span> <span id="premio-valor">0</span></div>
      <div id="stats-row">
        <div id="valor-carton"><span>üíµ</span> Cart√≥n: <span class="valor" id="valor-carton-valor">0</span></div>
        <div id="cartones-jugando">
          <img src="https://cdn-icons-png.flaticon.com/32/5065/5065890.png" class="carton-icon" alt="Cart√≥n" style="width:28px;height:28px;">
          Jugando: <span class="valor" id="cartones-jugando-valor">0</span>
          <span class="extra">+</span>
          <span class="valor extra" id="cartones-gratis-jugando">0</span>
        </div>
      </div>
    </div>
  </section>
  <section id="detalle-container">
    <div id="sorteo-nombre">Selecciona un sorteo para ver los detalles</div>
    <div id="estado-actual">Estado: <span class="estado-badge">-</span></div>
    <div id="resumen-sorteo">
      <div id="tipo-sorteo"></div>
    </div>
    <div id="acciones-sorteo">
      <button id="sellar-btn" class="estado-btn" title="Sellar sorteo">
        <img src="https://api.iconify.design/mdi/seal-variant.svg?color=white" alt="Sellar">
      </button>
      <button id="pdf-btn" class="estado-btn" title="Generar PDF">
        <img src="https://api.iconify.design/mdi/book-open-page-variant.svg?color=white" alt="PDF">
      </button>
      <button id="jugar-btn" class="estado-btn" title="Cambiar a Jugando">
        <img src="https://api.iconify.design/mdi/slot-machine.svg?color=white" alt="Jugar">
      </button>
      <button id="finalizar-btn" class="estado-btn" title="Finalizar sorteo">
        <img src="https://api.iconify.design/mdi/flag-checkered.svg?color=white" alt="Finalizar">
      </button>
    </div>
  </section>
  <section id="tabla-cantos-wrapper">
    <h2 id="tabla-cantos-titulo">N√öMEROS CANTADOS</h2>
    <div id="tabla-cantos-container" class="disabled"></div>
  </section>
  <div id="mensaje-area">Selecciona un sorteo para administrar su estado.</div>
  <div id="footer">
    <div id="fecha-hora"></div>
    <div id="derechos">Todos los derechos reservados ¬Æ Hexaservice 2025</div>
  </div>
  <div id="sorteos-modal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation();">
      <h3 style="text-align:center;font-family:'Bangers',cursive;color:#1e3aa8;margin:0 0 6px 0;">Sorteos Disponibles</h3>
      <div id="sorteos-list" style="display:flex;flex-direction:column;gap:6px;"></div>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-auth-compat.js"></script>
  <script src="auth.js"></script>
  <script src="scripts/timezone.js"></script>
  <script>
  ensureAuth('Administrador');
  initServerTime().then(()=>initFechaHora());

  let sorteos = [];
  let currentSorteoId = null;
  let currentSorteoData = null;
  let sorteoUnsub = null;

  const btnSorteo = document.getElementById('sorteo-btn');
  const fechaEl = document.getElementById('fecha-sorteo');
  const horaEl = document.getElementById('hora-sorteo');
  const premioEl = document.getElementById('premio-valor');
  const valorCartonEl = document.getElementById('valor-carton-valor');
  const cartonesPagosEl = document.getElementById('cartones-jugando-valor');
  const cartonesGratisEl = document.getElementById('cartones-gratis-jugando');
  const sorteoNombreEl = document.getElementById('sorteo-nombre');
  const estadoActualEl = document.getElementById('estado-actual');
  const tipoEl = document.getElementById('tipo-sorteo');
  const mensajeEl = document.getElementById('mensaje-area');
  const sellarBtn = document.getElementById('sellar-btn');
  const pdfBtn = document.getElementById('pdf-btn');
  const jugarBtn = document.getElementById('jugar-btn');
  const finalizarBtn = document.getElementById('finalizar-btn');
  const tablaCantosContainer = document.getElementById('tabla-cantos-container');
  const tablaCantosTitulo = document.getElementById('tabla-cantos-titulo');
  const cantoCeldas = new Map();
  let cantosSeleccionados = new Set();
  let cantosUnsub = null;

  document.getElementById('salir-btn').addEventListener('click',()=>{ window.location.href='admin.html'; });
  btnSorteo.addEventListener('click', abrirModalSorteos);
  sellarBtn.addEventListener('click', sellarSorteo);
  pdfBtn.addEventListener('click', abrirPDF);
  jugarBtn.addEventListener('click', cambiarAJugando);
  finalizarBtn.addEventListener('click', finalizarSorteo);
  construirTablaCantos();

  function getServerNow(){
    return new Date(Date.now() + (window.serverTime?.diferencia || 0));
  }

  function construirTablaCantos(){
    if(!tablaCantosContainer) return;
    tablaCantosContainer.innerHTML = '';
    cantoCeldas.clear();
    const tabla = document.createElement('table');
    tabla.id = 'tabla-cantos';
    const thead = document.createElement('thead');
    const headRow = document.createElement('tr');
    const letras = ['B','I','N','G','O'];
    letras.forEach(letra=>{
      const th = document.createElement('th');
      th.textContent = letra;
      headRow.appendChild(th);
    });
    thead.appendChild(headRow);
    tabla.appendChild(thead);
    const tbody = document.createElement('tbody');
    for(let fila=0; fila<15; fila++){
      const tr = document.createElement('tr');
      letras.forEach((letra, idx)=>{
        const base = idx * 15 + 1;
        const numero = base + fila;
        const numeroTexto = numero.toString().padStart(2,'0');
        const clave = `${letra}-${numeroTexto}`;
        const td = document.createElement('td');
        td.className = 'canto-cell';
        td.dataset.key = clave;
        td.textContent = clave;
        td.addEventListener('click', ()=>manejarCantoClick(clave));
        cantoCeldas.set(clave, td);
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }
    tabla.appendChild(tbody);
    tablaCantosContainer.appendChild(tabla);
  }

  async function manejarCantoClick(clave){
    if(!currentSorteoId || !currentSorteoData) return;
    if(tablaCantosContainer.classList.contains('disabled')) return;
    if(cantosSeleccionados.has(clave)) return;
    const confirmar = await confirm(`Confirmas la jugada de ${clave}?`);
    if(!confirmar) return;
    try {
      await db.collection('cantos').doc(currentSorteoId).set({
        numeros: firebase.firestore.FieldValue.arrayUnion(clave),
        actualizado: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      mensajeEl.textContent = `Se registr√≥ la jugada ${clave}.`;
    } catch (err) {
      console.error('Error registrando canto', err);
      alert('No fue posible registrar el canto.');
    }
  }

  function actualizarCantosSeleccionados(lista){
    const valores = Array.isArray(lista) ? lista : [];
    cantosSeleccionados = new Set(valores.map(v=>{
      const texto = (v ?? '').toString();
      return texto.toUpperCase();
    }));
    cantoCeldas.forEach((celda, clave)=>{
      if(cantosSeleccionados.has(clave)) celda.classList.add('selected');
      else celda.classList.remove('selected');
    });
  }

  function detenerCantos(){
    if(cantosUnsub){
      cantosUnsub();
      cantosUnsub = null;
    }
  }

  function escucharCantos(id){
    detenerCantos();
    if(!id){
      actualizarCantosSeleccionados([]);
      return;
    }
    const ref = db.collection('cantos').doc(id);
    cantosUnsub = ref.onSnapshot(doc=>{
      if(!doc.exists){
        actualizarCantosSeleccionados([]);
        return;
      }
      const data = doc.data() || {};
      const numeros = Array.isArray(data.numeros) ? data.numeros : [];
      actualizarCantosSeleccionados(numeros);
    }, err=>console.error('Error escuchando cantos', err));
  }

  function actualizarTablaEstado(){
    if(!tablaCantosContainer) return;
    const estado = (currentSorteoData?.estado || '').toString().toLowerCase();
    if(estado === 'jugando'){
      tablaCantosContainer.classList.remove('disabled');
      if(tablaCantosTitulo) tablaCantosTitulo.textContent = 'N√öMEROS CANTADOS';
    } else {
      tablaCantosContainer.classList.add('disabled');
      if(tablaCantosTitulo){
        tablaCantosTitulo.textContent = estado ? 'N√öMEROS CANTADOS (Inhabilitado)' : 'N√öMEROS CANTADOS';
      }
    }
  }

  function asegurarCampoPdf(id, data){
    if(!id || !data) return;
    if(typeof data.pdf === 'undefined' || data.pdf === null || data.pdf === ''){
      db.collection('sorteos').doc(id).set({ pdf: 'no' }, { merge: true }).catch(err=>{
        console.error('Error estableciendo pdf predeterminado', err);
      });
      data.pdf = 'no';
    }
  }

  function obtenerFechaDesdeValor(valor){
    if(!valor) return null;
    if(valor instanceof Date) return valor;
    if(typeof valor === 'object' && typeof valor.toDate === 'function'){ return valor.toDate(); }
    if(typeof valor !== 'string') return null;
    const limpio = valor.trim();
    if(!limpio) return null;
    if(limpio.includes('/')){
      const [dia, mes, anio] = limpio.split('/').map(num=>parseInt(num,10));
      if([dia, mes, anio].some(n=>isNaN(n))) return null;
      return new Date(anio, (mes||1)-1, dia||1);
    }
    if(limpio.includes('-')){
      const [anio, mes, dia] = limpio.split('-').map(num=>parseInt(num,10));
      if([dia, mes, anio].some(n=>isNaN(n))) return null;
      return new Date(anio, (mes||1)-1, dia||1);
    }
    const timestamp = Date.parse(limpio);
    if(!isNaN(timestamp)) return new Date(timestamp);
    return null;
  }

  function obtenerHoraDesdeValor(valor){
    if(!valor) return null;
    if(valor instanceof Date){
      return { hora: valor.getHours(), minuto: valor.getMinutes() };
    }
    if(typeof valor === 'object' && typeof valor.seconds === 'number'){
      const fecha = new Date(valor.seconds * 1000);
      return { hora: fecha.getHours(), minuto: fecha.getMinutes() };
    }
    if(typeof valor !== 'string') return null;
    let texto = valor.trim().toLowerCase();
    if(!texto) return null;
    let sufijo = null;
    if(/a\s*\.?m\.?/.test(texto)) sufijo = 'am';
    if(/p\s*\.?m\.?/.test(texto)) sufijo = 'pm';
    texto = texto.replace(/[^0-9:]/g, '');
    if(!texto) return null;
    const partes = texto.split(':');
    const horas = parseInt(partes[0] || '0', 10);
    const minutos = parseInt((partes[1] || '0').slice(0,2), 10);
    if(isNaN(horas) || isNaN(minutos)) return null;
    let hora24 = horas;
    if(sufijo === 'pm' && hora24 < 12) hora24 += 12;
    if(sufijo === 'am' && hora24 === 12) hora24 = 0;
    return { hora: hora24, minuto: minutos };
  }

  function formatearFecha(valor){
    const fecha = obtenerFechaDesdeValor(valor);
    if(!fecha || isNaN(fecha.getTime())) return '';
    const dia = String(fecha.getDate()).padStart(2,'0');
    const mes = String(fecha.getMonth()+1).padStart(2,'0');
    const anio = fecha.getFullYear();
    return `${dia}/${mes}/${anio}`;
  }

  function formatearHora(valor){
    const horaInfo = obtenerHoraDesdeValor(valor);
    if(!horaInfo) return '';
    const { hora, minuto } = horaInfo;
    const sufijo = hora >= 12 ? 'pm' : 'am';
    const hora12 = hora % 12 || 12;
    return `${hora12.toString().padStart(2,'0')}:${minuto.toString().padStart(2,'0')} ${sufijo}`;
  }

  function obtenerFechaSorteo(data){
    if(!data) return null;
    const fechaBase = obtenerFechaDesdeValor(data.fecha);
    const horaInfo = obtenerHoraDesdeValor(data.hora);
    if(!fechaBase || !horaInfo) return null;
    const { hora, minuto } = horaInfo;
    return new Date(fechaBase.getFullYear(), fechaBase.getMonth(), fechaBase.getDate(), hora, minuto);
  }

  function actualizarAnimaciones(){
    [sellarBtn, pdfBtn, jugarBtn].forEach(btn=>btn.classList.remove('attention'));
    actualizarBotones();
    if(!currentSorteoData) return;
    const ahora = getServerNow();
    const sorteoDate = obtenerFechaSorteo(currentSorteoData);
    const cierreRaw = parseInt(currentSorteoData.cierreMinutos || currentSorteoData.cierre || 0, 10);
    const cierre = isNaN(cierreRaw) ? 0 : cierreRaw;
    const inicioSellado = sorteoDate ? new Date(sorteoDate.getTime() - cierre * 60000) : null;
    const inicioSelladoValido = inicioSellado && !isNaN(inicioSellado.getTime());
    const estadoLower = (currentSorteoData.estado || '').toString().toLowerCase();
    const pdfEstado = (currentSorteoData.pdf || '').toString().toLowerCase();
    const esMismoDia = sorteoDate && ahora.toDateString() === sorteoDate.toDateString();
    if(estadoLower === 'activo' && inicioSelladoValido && sorteoDate && esMismoDia && ahora >= inicioSellado && ahora <= sorteoDate){
      sellarBtn.classList.add('attention');
    }
    if(estadoLower === 'sellado' && pdfEstado !== 'si'){
      pdfBtn.classList.add('attention');
    }
    if(estadoLower === 'sellado' && pdfEstado === 'si' && sorteoDate && ahora >= sorteoDate){
      jugarBtn.classList.add('attention');
    }
  }

  function actualizarEstadoVisual(estado){
    const estadoTexto = (estado || '-').toString().toUpperCase();
    const estadoNormalizado = (estado || '').toString().toLowerCase();
    let clase = '';
    if(estadoNormalizado === 'activo') clase = 'activo';
    else if(estadoNormalizado === 'sellado') clase = 'sellado';
    else if(estadoNormalizado === 'jugando') clase = 'jugando';
    else if(estadoNormalizado === 'finalizado') clase = 'finalizado';
    estadoActualEl.innerHTML = `Estado: <span class="estado-badge ${clase}">${estadoTexto}</span>`;
  }

  function actualizarBotones(){
    if(!currentSorteoData){
      [sellarBtn, pdfBtn, jugarBtn, finalizarBtn].forEach(btn=>btn.disabled=true);
      return;
    }
    const estado = (currentSorteoData.estado || '').toLowerCase();
    const ahora = getServerNow();
    const sorteoDate = obtenerFechaSorteo(currentSorteoData);
    const cierreRaw = parseInt(currentSorteoData.cierreMinutos || currentSorteoData.cierre || 0, 10);
    const cierre = isNaN(cierreRaw) ? 0 : cierreRaw;
    const inicioSellado = sorteoDate ? new Date(sorteoDate.getTime() - cierre * 60000) : null;
    const inicioSelladoValido = inicioSellado && !isNaN(inicioSellado.getTime());
    const esMismoDia = sorteoDate && ahora.toDateString() === sorteoDate.toDateString();
    const ventanaSellado = estado === 'activo' && inicioSelladoValido && sorteoDate && esMismoDia && ahora >= inicioSellado && ahora <= sorteoDate;
    const pdfEstado = (currentSorteoData.pdf || '').toString().toLowerCase();

    sellarBtn.disabled = !ventanaSellado;
    pdfBtn.disabled = estado !== 'sellado';
    jugarBtn.disabled = estado !== 'sellado' || pdfEstado !== 'si' || !sorteoDate || ahora < sorteoDate;
    finalizarBtn.disabled = estado !== 'jugando';
  }

  function mostrarDatos(){
    if(!currentSorteoData){
      btnSorteo.textContent = 'Selecciona Sorteo';
      fechaEl.textContent = '';
      horaEl.textContent = '';
      premioEl.textContent = '0';
      valorCartonEl.textContent = '0';
      cartonesPagosEl.textContent = '0';
      cartonesGratisEl.textContent = '0';
      sorteoNombreEl.textContent = 'Selecciona un sorteo para ver los detalles';
      actualizarEstadoVisual(null);
      tipoEl.innerHTML = '';
      mensajeEl.textContent = 'Selecciona un sorteo para administrar su estado.';
      [sellarBtn, pdfBtn, jugarBtn, finalizarBtn].forEach(btn=>btn.disabled=true);
      actualizarAnimaciones();
      actualizarCantosSeleccionados([]);
      actualizarTablaEstado();
      return;
    }
    const data = currentSorteoData;
    btnSorteo.textContent = data.nombre || 'Sorteo';
    btnSorteo.classList.remove('diario','especial','jugando','finalizado');
    if(data.estado === 'Jugando') btnSorteo.classList.add('jugando');
    else if(data.estado === 'Finalizado') btnSorteo.classList.add('finalizado');
    else if(data.tipo === 'Sorteo Diario') btnSorteo.classList.add('diario');
    else if(data.tipo === 'Sorteo Especial') btnSorteo.classList.add('especial');
    fechaEl.innerHTML = data.fecha ? `üìÖ ${formatearFecha(data.fecha)}` : '';
    horaEl.innerHTML = data.hora ? `‚è∞ ${formatearHora(data.hora)}` : '';
    premioEl.textContent = Math.round(data.totalPremios || 0);
    valorCartonEl.textContent = data.valorCarton || 0;
    cartonesPagosEl.textContent = data.cartonesjugando || 0;
    cartonesGratisEl.textContent = data.cartonesgratisjugando || 0;
    sorteoNombreEl.textContent = data.nombre || '';
    actualizarEstadoVisual(data.estado);
    const cierreVal = parseInt(data.cierreMinutos || data.cierre || 0, 10);
    const cierreMin = isNaN(cierreVal) ? null : cierreVal;
    const tipoNombre = ((data.tipo || '').replace(/^Sorteo\s+/i,'') || 'N/D').toUpperCase();
    const estadoLinea = (data.estado || '-').toString().toUpperCase();
    const cierreTexto = cierreMin !== null ? `${cierreMin} min.` : 'N/D';
    tipoEl.innerHTML = `<span>ESTADO: ${estadoLinea}</span><span>Tipo: ${tipoNombre}</span><span>Cierre: ${cierreTexto}</span>`;
    mensajeEl.textContent = '';
    actualizarBotones();
    actualizarAnimaciones();
    actualizarTablaEstado();
  }

  async function cargarSorteos(){
    sorteos = [];
    try {
      const snap = await db.collection('sorteos').get();
      const pendientesPdf = [];
      snap.forEach(doc=>{
        const d = doc.data();
        sorteos.push({
          id: doc.id,
          nombre: d.nombre || 'Sorteo',
          fecha: d.fecha || '',
          hora: d.hora || '',
          tipo: d.tipo || '',
          estado: d.estado || 'Activo',
          valorCarton: d.valorCarton || 0,
          cartonesjugando: d.cartonesjugando || 0,
          cartonesgratisjugando: d.cartonesgratisjugando || 0,
          totalPremios: d.totalPremios || 0,
          cierreMinutos: d.cierreMinutos || d.cierre || 0,
          pdf: d.pdf || 'no'
        });
        if(typeof d.pdf === 'undefined' || d.pdf === null || d.pdf === ''){
          pendientesPdf.push(doc.id);
        }
      });
      if(pendientesPdf.length){
        await Promise.all(pendientesPdf.map(id=>
          db.collection('sorteos').doc(id).set({ pdf: 'no' }, { merge: true })
        )).catch(err=>console.error('Error asegurando pdf en sorteos', err));
      }
    } catch (err) {
      console.error('Error cargando sorteos', err);
    }
  }

  async function abrirModalSorteos(){
    await cargarSorteos();
    if(!sorteos.length){
      mensajeEl.textContent = 'No hay sorteos disponibles en este momento.';
      return;
    }
    const cont = document.getElementById('sorteos-list');
    cont.innerHTML = '';
    const ordenados = [...sorteos].sort((a,b)=>{
      const fechaA = obtenerFechaSorteo(a) || new Date(0);
      const fechaB = obtenerFechaSorteo(b) || new Date(0);
      return fechaB - fechaA;
    });
    const activos = ordenados.filter(s=> (s.estado || '').toLowerCase() === 'activo');
    if(!activos.length){
      mensajeEl.textContent = 'No hay sorteos activos disponibles en este momento.';
      document.getElementById('sorteos-modal').style.display = 'none';
      return;
    }
    activos.forEach((s, idx)=>{
      const div = document.createElement('div');
      div.className = `sorteo-item ${s.estado ? s.estado.toLowerCase() : ''} ${s.tipo === 'Sorteo Diario' ? 'diario' : s.tipo === 'Sorteo Especial' ? 'especial' : ''}`.trim();
      const header = document.createElement('div');
      header.className = 'sorteo-header';
      header.innerHTML = `<span>${idx+1}. ${s.nombre}</span><span>${s.estado || ''}</span>`;
      div.appendChild(header);
      const detalle = document.createElement('div');
      detalle.className = 'sorteo-detalle';
      detalle.innerHTML = `${s.fecha ? `üìÖ ${formatearFecha(s.fecha)}` : ''} ${s.hora ? `‚è∞ ${formatearHora(s.hora)}` : ''}`;
      div.appendChild(detalle);
      const extra = document.createElement('div');
      extra.className = 'sorteo-extra';
      extra.innerHTML = `<span>Premio: ${Math.round(s.totalPremios || 0)}</span><span>Cartones: ${s.cartonesjugando || 0} + ${s.cartonesgratisjugando || 0}</span>`;
      div.appendChild(extra);
      div.addEventListener('click',()=>{
        seleccionarSorteo(s.id);
        document.getElementById('sorteos-modal').style.display = 'none';
      });
      cont.appendChild(div);
    });
    document.getElementById('sorteos-modal').style.display = 'flex';
  }

  function escucharSorteo(id){
    if(sorteoUnsub){ sorteoUnsub(); sorteoUnsub = null; }
    const ref = db.collection('sorteos').doc(id);
    sorteoUnsub = ref.onSnapshot(doc=>{
      if(!doc.exists){
        currentSorteoData = null;
        mostrarDatos();
        detenerCantos();
        return;
      }
      currentSorteoData = { id: doc.id, ...doc.data() };
      asegurarCampoPdf(doc.id, currentSorteoData);
      const idx = sorteos.findIndex(s=>s.id===doc.id);
      if(idx>=0){
        sorteos[idx] = { ...sorteos[idx], ...doc.data() };
      }
      mostrarDatos();
    }, err=>console.error('Error escuchando sorteo', err));
  }

  function seleccionarSorteo(id){
    currentSorteoId = id;
    const encontrado = sorteos.find(s=>s.id===id);
    currentSorteoData = encontrado ? { ...encontrado } : null;
    if(currentSorteoData){
      asegurarCampoPdf(currentSorteoId, currentSorteoData);
    }
    escucharSorteo(id);
    escucharCantos(id);
    mostrarDatos();
  }

  async function sellarSorteo(){
    if(!currentSorteoId || !currentSorteoData){ alert('Selecciona un sorteo primero.'); return; }
    if(currentSorteoData.estado === 'Sellado'){ alert('El sorteo ya est√° sellado.'); return; }
    if(currentSorteoData.estado === 'Jugando' || currentSorteoData.estado === 'Finalizado'){
      alert('El sorteo ya se encuentra en una fase posterior.');
      return;
    }
    const sorteoDate = obtenerFechaSorteo(currentSorteoData);
    if(!sorteoDate){ alert('Datos de fecha y hora inv√°lidos.'); return; }
    const cierreVal = parseInt(currentSorteoData.cierreMinutos || currentSorteoData.cierre || 0, 10);
    const cierre = isNaN(cierreVal) ? 0 : cierreVal;
    const inicioSellado = new Date(sorteoDate.getTime() - cierre * 60000);
    if(isNaN(inicioSellado.getTime())){
      alert('No se pudo calcular el inicio de sellado del sorteo.');
      return;
    }
    const ahora = getServerNow();
    if(ahora < inicioSellado){
      alert('A√∫n el sorteo no se puede sellar, no esta en los minutos previos al sorteo');
      return;
    }
    if(ahora > sorteoDate){
      alert('El sorteo ya super√≥ la hora programada.');
      return;
    }
    if(ahora.toDateString() !== sorteoDate.toDateString()){
      alert('Solo puedes sellar el d√≠a del sorteo.');
      return;
    }
    try {
      await db.collection('sorteos').doc(currentSorteoId).update({ estado: 'Sellado' });
      mensajeEl.textContent = 'El sorteo fue sellado correctamente.';
      sellarBtn.classList.remove('attention');
    } catch (err) {
      console.error('Error sellando sorteo', err);
      alert('No fue posible sellar el sorteo.');
    }
  }

  function abrirPDF(){
    if(!currentSorteoId || !currentSorteoData){ alert('Selecciona un sorteo primero.'); return; }
    if((currentSorteoData.estado || '') !== 'Sellado'){
      alert('Para generar el archivo PDF de sellado el sorteo debe estar Sellado primero');
      return;
    }
    const url = `pdfsorteo.html?s=${currentSorteoId}`;
    window.location.href = url;
  }

  async function cambiarAJugando(){
    if(!currentSorteoId || !currentSorteoData){ alert('Selecciona un sorteo primero.'); return; }
    if(currentSorteoData.estado === 'Jugando'){ alert('El sorteo ya est√° en estado Jugando.'); return; }
    if(currentSorteoData.estado === 'Finalizado'){ alert('El sorteo ya finaliz√≥.'); return; }
    if((currentSorteoData.estado || '').toLowerCase() !== 'sellado'){
      alert('El sorteo debe estar Sellado para iniciar el juego.');
      return;
    }
    if((currentSorteoData.pdf || '').toString().toLowerCase() !== 'si'){
      alert('Debes generar el PDF antes de iniciar el juego.');
      return;
    }
    const sorteoDate = obtenerFechaSorteo(currentSorteoData);
    if(!sorteoDate){ alert('Datos de fecha y hora inv√°lidos.'); return; }
    const ahora = getServerNow();
    if(ahora < sorteoDate){
      alert('A√∫n el sorteo no ha llegado a su fecha y hora de sorteo');
      return;
    }
    const confirmar = await confirm('¬øDeseas cambiar el estado del sorteo a "Jugando"?');
    if(!confirmar) return;
    try {
      await db.collection('sorteos').doc(currentSorteoId).update({ estado: 'Jugando' });
      mensajeEl.textContent = 'El sorteo cambi√≥ a estado Jugando.';
      jugarBtn.classList.remove('attention');
    } catch (err) {
      console.error('Error cambiando a Jugando', err);
      alert('No fue posible cambiar el estado a Jugando.');
    }
  }

  async function finalizarSorteo(){
    if(!currentSorteoId || !currentSorteoData){ alert('Selecciona un sorteo primero.'); return; }
    if((currentSorteoData.estado || '').toLowerCase() !== 'jugando'){
      alert('El sorteo debe estar en estado Jugando para finalizar.');
      return;
    }
    const confirmar = await confirm('¬øDeseas finalizar el sorteo actual? No podr√°s deshacer esta acci√≥n.');
    if(!confirmar) return;
    try {
      await db.collection('sorteos').doc(currentSorteoId).update({ estado: 'Finalizado' });
      mensajeEl.textContent = 'El sorteo fue finalizado correctamente.';
      finalizarBtn.classList.remove('attention');
    } catch (err) {
      console.error('Error finalizando sorteo', err);
      alert('No fue posible finalizar el sorteo.');
    }
  }

  async function inicializar(){
    await cargarSorteos();
    mostrarDatos();
  }

  setInterval(actualizarAnimaciones, 15000);

  inicializar();
  </script>
</body>
</html>
