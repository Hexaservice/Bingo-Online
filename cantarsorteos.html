<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cantar Sorteo</title>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(rgba(255,255,255,0.7), rgba(255,255,255,0.7)),
                  url('https://img.freepik.com/vectores-premium/padrao-sem-costura-com-simbolos-de-dolar-e-porcentagem_637741-777.jpg');
      background-repeat: repeat;
      background-size: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      text-align: center;
      padding: 10px 5px 40px;
      box-sizing: border-box;
    }
    h1 {
      font-family: 'Bangers', cursive;
      color: white;
      text-shadow: 0 0 12px #1e3aa8;
      margin: 5px 0 10px 0;
      font-size: 2rem;
    }
    .menu-btn {
      width: 250px;
      height: 60px;
      font-family: 'Bangers', cursive;
      font-size: 1.4rem;
      background: rgba(0, 170, 255, 0.8);
      color: white;
      border: 4px solid #FFD700;
      border-radius: 10px;
      text-shadow: 2px 2px 4px #000;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
    }
    .menu-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(255,215,0,0.8); }
    .menu-btn:active { transform: scale(0.95); box-shadow: 0 0 5px rgba(255,215,0,0.8); }
    #salir-btn {
      position: fixed;
      top: 5px;
      left: 5px;
      width: 120px;
      height: 40px;
      background: orange;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      font-size: 1.2rem;
    }
    #salir-btn .label { font-size: 1.1rem; }
    @media (orientation: portrait) {
      #salir-btn { width: 40px; }
      #salir-btn .label { display: none; }
      #detalle-container { margin-left: 5px; margin-right: 5px; }
    }
    #sorteo-btn {
      width: 240px;
      font-size: 1.1rem;
      padding: 6px 10px;
      text-align: center;
      border: 3px solid #FFD700;
      border-radius: 10px;
      background: linear-gradient(#dddddd, #ffffff);
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-transform: uppercase;
      color: #000;
      font-family: 'Bangers', cursive;
      text-shadow: 1px 1px 2px #fff;
    }
    #sorteo-btn.diario { background: linear-gradient(#008000,#ffffff); }
    #sorteo-btn.especial { background: linear-gradient(#ff8800,#ffffff); }
    #sorteo-btn.finalizado { background: linear-gradient(#444,#bbbbbb); color: #fff; }
    #sorteo-btn.jugando { background: linear-gradient(#6a0dad,#ffffff); color: #fff; }
    .sorteo-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      margin-bottom: 10px;
    }
    #fecha-hora-sorteo {
      display: flex;
      justify-content: center;
      width: 100%;
      font-family: 'Bangers', cursive;
      font-size: 1rem;
    }
    #tabla-fechas {
      border-collapse: collapse;
      margin: 0 auto;
    }
    #tabla-fechas td {
      border: none;
      padding: 2px 6px;
      vertical-align: middle;
      white-space: nowrap;
    }
    #tabla-fechas .celda-icono {
      width: 34px;
      text-align: right;
      padding: 2px 0;
    }
    #tabla-fechas .celda-valor {
      text-align: left;
      padding-left: 4px;
    }
    #tabla-fechas .celda-icono span,
    #tabla-fechas .celda-icono img {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
    }
    #tabla-fechas .celda-icono img {
      width: 24px;
      height: 24px;
    }
    #tabla-fechas .fila-fecha.oculta {
      display: none;
    }
    .valor-programado,
    .valor-actual,
    .valor-cierre {
      font-size: 1.05rem;
    }
    .valor-programado {
      font-family: 'Bangers', cursive;
      color: #0f2a0f;
      text-shadow: 0 0 3px rgba(255,255,255,0.85);
      letter-spacing: 1px;
    }
    .valor-actual {
      font-family: 'Bangers', cursive;
      color: #0b4dda;
      font-weight: 600;
      letter-spacing: 1px;
      text-shadow: 0 0 4px rgba(255,255,255,0.9);
    }
    .valor-cierre {
      font-family: 'Bangers', cursive;
      color: #ffffff;
      font-weight: 600;
      text-shadow: 0 0 6px rgba(0,0,0,0.9);
      letter-spacing: 1px;
    }
    .resaltado-actual {
      color: #0b4dda !important;
      text-shadow: 0 0 4px rgba(255,255,255,0.95) !important;
    }
    .datos-sorteo {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      justify-content: center;
      margin-top: 5px;
      font-family: 'Bangers', cursive;
    }
    #premio-repartir {
      color: white;
      font-family: 'Bangers', cursive;
      font-size: 1.6rem;
      text-shadow: 0 0 10px #004488;
      display: flex;
      gap: 6px;
      align-items: center;
    }
    #premio-valor { text-shadow: 0 0 10px #004488; }
    #stats-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    #valor-carton, #cartones-jugando {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #fff;
      text-shadow: 0 0 6px #003300;
      font-size: 1.3rem;
    }
    #valor-carton span.valor, #cartones-jugando span.valor { font-size: 1.6rem; }
    #cartones-jugando span.extra { color: #00008b; text-shadow: 0 0 6px #fff; }
    #detalle-container {
      border: 2px solid #013220;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(0,60,0,0.85), rgba(255,255,255,0.95));
      padding: 15px 14px 20px;
      margin: 16px 8px 0;
      width: min(360px, calc(100% - 16px));
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
      transition: background 0.3s ease;
    }
    #detalle-container.estado-sellado {
      background: linear-gradient(135deg, #c0c0c0, #ffffff);
    }
    #detalle-container.estado-pdf {
      background: linear-gradient(135deg, #3ba74d, #ffffff);
    }
    #detalle-container.estado-jugando {
      background: linear-gradient(135deg, #7f3fbf, #ffffff);
    }
    #detalle-container.estado-finalizado {
      background: linear-gradient(135deg, #8b4513, #ffffff);
    }
    #sorteo-nombre {
      font-size: 1rem;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 0 6px #000;
      margin-bottom: 6px;
    }
    #estado-actual {
      font-family: 'Bangers', cursive;
      font-size: 1.1rem;
      color: #111;
      text-shadow: 0 0 4px rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
      width: 100%;
    }
    #estado-actual .estado-etiqueta {
      letter-spacing: 1px;
    }
    .estado-etiqueta { text-transform: uppercase; }
    .estado-badge {
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 1rem;
      letter-spacing: 1px;
    }
    .tipo-estado {
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 1.05rem;
      text-shadow: 0 0 4px rgba(255,255,255,0.85);
    }
    .tipo-estado.diario { color: #0f8b0f; }
    .tipo-estado.especial { color: #ff8c00; }
    .tipo-estado.default { color: #1e3aa8; }
    .estado-badge.activo { background: rgba(0,128,0,0.15); color: #0f8b0f; border: 1px solid rgba(15,139,15,0.5); }
    .estado-badge.sellado { background: rgba(110,110,110,0.2); color: #444; border: 1px solid rgba(110,110,110,0.5); }
    .estado-badge.jugando { background: rgba(106,13,173,0.15); color: #6a0dad; border: 1px solid rgba(106,13,173,0.4); animation: zoomInOut 1.2s ease-in-out infinite; }
    .estado-badge.finalizado { background: rgba(30,30,30,0.1); color: #000; border: 1px solid rgba(0,0,0,0.4); }
    #resumen-sorteo {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-family: 'Poppins', sans-serif;
      color: #0b1d0b;
      font-weight: 600;
      align-items: center;
    }
    #resumen-sorteo div { display: flex; justify-content: center; gap: 12px; align-items: center; flex-wrap: wrap; font-size: 0.95rem; }
    #tipo-sorteo span { white-space: nowrap; text-transform: uppercase; }
    #acciones-sorteo {
      margin-top: 14px;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 12px;
      flex-wrap: wrap;
    }
    #modo-toggle-container {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      background: rgba(255,255,255,0.55);
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.08);
      flex-shrink: 0;
      margin-left: 4px;
    }
    #modo-manual-estado {
      font-family: 'Bangers', cursive;
      font-size: 0.85rem;
      color: #0b1d0b;
      text-shadow: 0 0 4px rgba(255,255,255,0.9);
      white-space: nowrap;
    }
    .modo-switch {
      position: relative;
      display: inline-block;
      width: 42px;
      height: 22px;
    }
    .modo-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .modo-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background-color: #c9c9c9;
      border-radius: 34px;
      transition: background-color 0.3s ease;
      box-shadow: inset 0 0 4px rgba(0,0,0,0.3);
    }
    .modo-slider:before {
      position: absolute;
      content: '';
      height: 16px;
      width: 16px;
      left: 3px;
      bottom: 3px;
      background-color: #ffffff;
      border-radius: 50%;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .modo-switch input:checked + .modo-slider {
      background: linear-gradient(135deg, #06b406, #8bff8b);
    }
    .modo-switch input:checked + .modo-slider:before {
      transform: translateX(18px);
    }
    .estado-btn {
      width: 52px;
      height: 52px;
      border-radius: 12px;
      border: 3px solid #FFD700;
      background: linear-gradient(#0a8800,#ffffff);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0,0,0,0.4);
      transition: transform 0.2s;
    }
    .estado-btn:hover { transform: scale(1.05); }
    #sellar-btn { background: linear-gradient(#707070,#d9d9d9); }
    #pdf-btn { background: linear-gradient(#008c3a,#66d17a); }
    #jugar-btn { background: linear-gradient(#4b0082,#ffffff); }
    #finalizar-btn { background: linear-gradient(#8b0000,#ffffff); }
    .estado-btn img { width: 24px; height: 24px; }
    #sellar-btn .stop-icon {
      font-family: 'Bangers', cursive;
      font-size: 0.95rem;
      letter-spacing: 1px;
      color: #ffffff;
    }
    #tabla-cantos-wrapper {
      margin: 16px 8px 0;
      width: min(360px, calc(100% - 16px));
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    #tabla-cantos-titulo {
      font-family: 'Bangers', cursive;
      font-size: 1.2rem;
      color: #0f2a0f;
      text-shadow: 0 0 4px rgba(255,255,255,0.8);
      margin: 0;
    }
    #tabla-cantos-container {
      width: 100%;
      border-radius: 12px;
      padding: 10px;
      background: linear-gradient(145deg, rgba(255,255,255,0.85), rgba(200,255,200,0.9));
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      transition: filter 0.3s ease, opacity 0.3s ease;
    }
    #tabla-cantos-container.disabled {
      filter: grayscale(0.9);
      opacity: 0.75;
    }
    #tabla-cantos-container.bloqueado {
      filter: none;
      opacity: 1;
    }
    #tabla-cantos {
      width: 100%;
      border-collapse: separate;
      border-spacing: 6px;
      text-align: center;
      font-family: 'Bangers', cursive;
    }
    #tabla-cantos thead th {
      font-size: 1.4rem;
      color: #0a5c0a;
      text-shadow: 0 0 6px #fff;
    }
    .canto-cell {
      border-radius: 10px;
      padding: 8px 4px;
      font-size: 1.1rem;
      background: linear-gradient(160deg, rgba(240,255,240,0.95), rgba(180,235,180,0.9));
      border: 2px solid rgba(15,90,15,0.5);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .canto-cell:hover {
      transform: scale(1.05);
      box-shadow: 0 0 6px rgba(0,128,0,0.6);
    }
    .canto-cell.selected {
      background: radial-gradient(circle at center, rgba(0,200,0,0.85), rgba(255,255,0,0.9));
      color: #083108;
      box-shadow: 0 0 8px rgba(255,255,0,0.8);
      transform: scale(1.03);
    }
    #tabla-cantos-container.disabled .canto-cell,
    #tabla-cantos-container.bloqueado .canto-cell {
      pointer-events: none;
      cursor: default;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.75);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      padding: 12px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 6px;
      width: min(420px, 90vw);
      max-height: 80vh;
      overflow-y: auto;
      font-family: 'Poppins', sans-serif;
    }
    #pdf-confirm-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
      z-index: 1200;
    }
    #pdf-confirm-modal.activo { display: flex; }
    .pdf-confirm-box {
      background: #ffffff;
      border-radius: 14px;
      padding: 24px 20px;
      max-width: 360px;
      width: 100%;
      text-align: center;
      box-shadow: 0 12px 28px rgba(0,0,0,0.35);
      font-family: 'Poppins', sans-serif;
    }
    .pdf-confirm-box h3 {
      margin: 0 0 12px 0;
      font-family: 'Bangers', cursive;
      font-size: 1.5rem;
      color: #0b5394;
    }
    .pdf-confirm-box p {
      margin: 0;
      font-size: 1rem;
      color: #1a1a1a;
    }
    .pdf-confirm-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-top: 18px;
    }
    .pdf-confirm-actions button {
      padding: 8px 18px;
      border-radius: 10px;
      border: 3px solid #FFD700;
      font-family: 'Bangers', cursive;
      font-size: 1rem;
      cursor: pointer;
      background: linear-gradient(#008c3a, #66d17a);
      color: #ffffff;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.4);
      box-shadow: 0 0 8px rgba(0,0,0,0.25);
      min-width: 110px;
    }
    .pdf-confirm-actions button.secundario {
      background: linear-gradient(#9c9c9c, #e0e0e0);
      color: #222;
    }
    .sorteo-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 10px 12px 52px 12px;
      border-radius: 10px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    .sorteo-item:hover { border-color: #1e90ff; box-shadow: 0 4px 12px rgba(0,0,0,0.18); transform: translateY(-1px); }
    .sorteo-item.activo { background: linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(15,157,88,0.95)); color: #0c3f1d; }
    .sorteo-item.inactivo { background: linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(198,40,40,0.92)); color: #4f0909; }
    .sorteo-item.sellado { background: linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(168,168,168,0.95)); color: #1f1f1f; }
    .sorteo-item.jugando { background: linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(106,13,173,0.92)); color: #2d0f44; }
    .sorteo-item.finalizado { background: linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(139,69,19,0.92)); color: #40210a; }
    .sorteo-header {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      font-weight: 700;
      font-size: 1rem;
      gap: 8px;
      padding-right: 70px;
    }
    .sorteo-header .titulo {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .tipo-tag {
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.8px;
      padding: 1px 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.85);
    }
    .tipo-tag.diario { color: #0d7a28; border: 1px solid rgba(13,122,40,0.4); }
    .tipo-tag.especial { color: #ff7b00; border: 1px solid rgba(255,123,0,0.4); }
    .sorteo-detalle {
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 0.85rem;
      flex-wrap: wrap;
    }
    .sorteo-detalle span { display: inline-flex; align-items: center; gap: 4px; }
    .cierre-hora {
      font-weight: 700;
      color: #0b4dda;
      text-shadow: 0 0 4px rgba(255,255,255,0.6);
    }
    .sorteo-extra {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.82rem;
      color: inherit;
      text-align: left;
    }
    .extra-premio {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 8px;
    }
    .extra-premio-main {
      font-weight: 700;
      color: #ffffff;
      text-shadow: 0 0 6px #072968;
    }
    .extra-premio-subtotales {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.7rem;
    }
    .forma-subtotal {
      font-weight: 700;
      text-shadow: 0 0 6px rgba(255,255,255,0.9), 0 0 12px rgba(255,255,255,0.8);
    }
    .forma-subtotal.forma1 { color: #1b8f3a; }
    .forma-subtotal.forma2 { color: #b8860b; }
    .forma-subtotal.forma3 { color: #1160c9; }
    .forma-subtotal.forma4 { color: #6a0dad; }
    .forma-subtotal.forma5 { color: #d2691e; }
    .extra-cartones,
    .extra-cantos { font-weight: 700; display: flex; align-items: center; gap: 4px; }
    .extra-cartones-pagos {
      color: #6a0dad;
      text-shadow: 0 0 4px rgba(255,255,255,0.9);
    }
    .extra-cartones-gratis {
      color: #001f54;
      text-shadow: 0 0 4px rgba(255,255,255,0.9);
    }
    .extra-cartones-mas {
      font-weight: 700;
      color: #ffffff;
      text-shadow: 0 0 4px rgba(0,0,0,0.3);
    }
    .extra-cantos-valor {
      color: #0db050;
      text-shadow: 0 0 4px rgba(255,215,0,0.9);
    }
    .extra-premio-main .valor-premio,
    .extra-cartones span,
    .extra-cantos span { font-weight: 700; }

    .sorteo-corner-info {
      position: absolute;
      right: 10px;
      bottom: 10px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      pointer-events: none;
    }

    .corner-cantos {
      font-family: 'Bangers', cursive;
      font-size: 1.2rem;
      color: #ffffff;
      text-shadow: 0 0 6px rgba(96,0,128,0.9), 0 0 14px rgba(128,0,192,0.8);
      letter-spacing: 1px;
    }

    .corner-cantos-valor {
      color: #ffffff;
      text-shadow: 0 0 8px rgba(96,0,128,0.95), 0 0 16px rgba(128,0,192,0.85);
    }

    .corner-estado {
      font-family: 'Bangers', cursive;
      font-size: 1rem;
      text-transform: uppercase;
      background: rgba(255,255,255,0.85);
      padding: 2px 10px;
      border-radius: 999px;
      color: #111;
      box-shadow: 0 0 6px rgba(0,0,0,0.15);
      letter-spacing: 1px;
    }

    .corner-estado.activo { color: #0f8b0f; }
    .corner-estado.inactivo { color: #c62828; }
    .corner-estado.sellado { color: #555555; }
    .corner-estado.jugando { color: #6a0dad; }
    .corner-estado.finalizado { color: #8b4513; }

    .corner-cantos.jugando {
      animation: zoomInOut 1.2s ease-in-out infinite;
    }
    .attention { animation: zoomInOut 1s infinite; }
    @keyframes zoomInOut { 0%,100% { transform: scale(1); } 50% { transform: scale(1.15); } }
    #mensaje-area {
      margin-top: 10px;
      font-family: 'Poppins', sans-serif;
      color: #111;
      font-size: 0.9rem;
      background: rgba(255,255,255,0.6);
      padding: 6px 10px;
      border-radius: 8px;
      max-width: 480px;
    }
    #footer {
      margin-top: auto;
      font-size: 0.7rem;
      color: #000;
      text-align: center;
    }
    #footer #derechos { font-size: 0.6rem; }
  </style>
</head>
<body>
  <button id="salir-btn" class="menu-btn"><span class="tri">&#9664;</span><span class="label">Salir</span></button>
  <h1>CANTAR SORTEO</h1>
  <section id="sorteo-section">
    <div class="sorteo-info">
      <button id="sorteo-btn">Selecciona Sorteo</button>
      <div id="fecha-hora-sorteo">
        <table id="tabla-fechas">
          <tbody>
            <tr id="fila-cierre" class="fila-fecha oculta">
              <td class="celda-icono">
                <img src="https://api.iconify.design/mdi/stop-circle.svg?color=%23ff3b30" alt="Cierre" loading="lazy">
              </td>
              <td class="celda-valor">
                <span id="fecha-cierre" class="valor-cierre"></span>
              </td>
              <td class="celda-icono">
                <img src="https://api.iconify.design/mdi/clock-time-ten-outline.svg?color=%23888888" alt="Hora de cierre" loading="lazy">
              </td>
              <td class="celda-valor">
                <span id="hora-cierre" class="valor-cierre"></span>
              </td>
            </tr>
            <tr class="fila-fecha">
              <td class="celda-icono">
                <img src="https://api.iconify.design/mdi/calendar.svg?color=%23ffb300" alt="Fecha programada" loading="lazy">
              </td>
              <td class="celda-valor">
                <span id="fecha-programada" class="valor-programado"></span>
              </td>
              <td class="celda-icono">
                <img src="https://api.iconify.design/mdi/clock-alert.svg?color=%23d32f2f" alt="Hora programada" loading="lazy">
              </td>
              <td class="celda-valor">
                <span id="hora-programada" class="valor-programado"></span>
              </td>
            </tr>
            <tr class="fila-fecha">
              <td class="celda-icono">
                <img src="https://api.iconify.design/mdi/calendar.svg?color=%23006ad4" alt="Fecha actual" loading="lazy">
              </td>
              <td class="celda-valor">
                <span id="fecha-actual" class="valor-actual resaltado-actual"></span>
              </td>
              <td class="celda-icono">
                <img src="https://api.iconify.design/mdi/clock-time-five.svg?color=%23006ad4" alt="Hora actual" loading="lazy">
              </td>
              <td class="celda-valor">
                <span id="hora-actual" class="valor-actual resaltado-actual"></span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="datos-sorteo">
      <div id="premio-repartir"><span>PREMIO A REPARTIR:</span> <span id="premio-valor">0</span></div>
      <div id="stats-row">
        <div id="valor-carton"><span>💵</span> Cartón: <span class="valor" id="valor-carton-valor">0</span></div>
        <div id="cartones-jugando">
          <img src="https://cdn-icons-png.flaticon.com/32/5065/5065890.png" class="carton-icon" alt="Cartón" style="width:28px;height:28px;">
          Jugando: <span class="valor" id="cartones-jugando-valor">0</span>
          <span class="extra">+</span>
          <span class="valor extra" id="cartones-gratis-jugando">0</span>
        </div>
      </div>
    </div>
  </section>
  <section id="detalle-container">
    <div id="sorteo-nombre">Selecciona un sorteo para ver los detalles</div>
    <div id="estado-actual">
      <span id="tipo-estado" class="tipo-estado"></span>
      <span class="estado-etiqueta">ESTADO:</span>
      <span id="estado-valor" class="estado-badge">-</span>
      <div id="modo-toggle-container">
        <label class="modo-switch" title="Cambiar modo Manual/Validado">
          <input type="checkbox" id="modo-manual-switch" aria-label="Interruptor de modo manual">
          <span class="modo-slider"></span>
        </label>
        <span id="modo-manual-estado">Validado</span>
      </div>
    </div>
    <div id="resumen-sorteo">
      <div id="tipo-sorteo"></div>
    </div>
    <div id="acciones-sorteo">
      <button id="sellar-btn" class="estado-btn" title="Sellar sorteo">
        <span class="stop-icon">STOP</span>
      </button>
      <button id="pdf-btn" class="estado-btn" title="Generar PDF">
        <img src="https://api.iconify.design/mdi/file-pdf-box.svg?color=white" alt="PDF">
      </button>
      <button id="jugar-btn" class="estado-btn" title="Cambiar a Jugando">
        <img src="https://api.iconify.design/mdi/slot-machine.svg?color=white" alt="Jugar">
      </button>
      <button id="finalizar-btn" class="estado-btn" title="Finalizar sorteo">
        <img src="https://api.iconify.design/mdi/flag-checkered.svg?color=white" alt="Finalizar">
      </button>
    </div>
  </section>
  <section id="tabla-cantos-wrapper">
    <h2 id="tabla-cantos-titulo">NÚMEROS CANTADOS</h2>
    <div id="tabla-cantos-container" class="disabled"></div>
  </section>
  <div id="mensaje-area">Selecciona un sorteo para administrar su estado.</div>
  <div id="footer">
    <div id="fecha-hora"></div>
    <div id="derechos">Todos los derechos reservados ® Hexaservice 2025</div>
  </div>
  <div id="sorteos-modal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation();">
      <h3 style="text-align:center;font-family:'Bangers',cursive;color:#1e3aa8;margin:0 0 6px 0;">Sorteos Disponibles</h3>
      <div id="sorteos-list" style="display:flex;flex-direction:column;gap:6px;"></div>
    </div>
  </div>
  <div id="pdf-confirm-modal" role="dialog" aria-modal="true" aria-labelledby="pdf-confirm-title">
    <div class="pdf-confirm-box">
      <h3 id="pdf-confirm-title">Guardar PDF</h3>
      <p>¿Ya se guardó el archivo PDF de este sorteo?</p>
      <div class="pdf-confirm-actions">
        <button id="pdf-confirm-si">Sí</button>
        <button id="pdf-confirm-no" class="secundario">No</button>
      </div>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-auth-compat.js"></script>
  <script src="auth.js"></script>
  <script src="scripts/timezone.js"></script>
  <script>
  ensureAuth('Administrador');
  initServerTime().then(()=>{
    inicializarFechaHoraFooter();
    iniciarActualizacionesActuales();
  });

  let sorteos = [];
  let currentSorteoId = null;
  let currentSorteoData = null;
  let sorteoUnsub = null;

  const btnSorteo = document.getElementById('sorteo-btn');
  const fechaProgramadaEl = document.getElementById('fecha-programada');
  const horaProgramadaEl = document.getElementById('hora-programada');
  const fechaActualValorEl = document.getElementById('fecha-actual');
  const horaActualValorEl = document.getElementById('hora-actual');
  const filaCierre = document.getElementById('fila-cierre');
  const fechaCierreEl = document.getElementById('fecha-cierre');
  const horaCierreEl = document.getElementById('hora-cierre');
  const premioEl = document.getElementById('premio-valor');
  const valorCartonEl = document.getElementById('valor-carton-valor');
  const cartonesPagosEl = document.getElementById('cartones-jugando-valor');
  const cartonesGratisEl = document.getElementById('cartones-gratis-jugando');
  const detalleContainer = document.getElementById('detalle-container');
  const sorteoNombreEl = document.getElementById('sorteo-nombre');
  const estadoActualEl = document.getElementById('estado-actual');
  const estadoValorEl = document.getElementById('estado-valor');
  const tipoEstadoEl = document.getElementById('tipo-estado');
  const tipoEl = document.getElementById('tipo-sorteo');
  const mensajeEl = document.getElementById('mensaje-area');
  const sellarBtn = document.getElementById('sellar-btn');
  const pdfBtn = document.getElementById('pdf-btn');
  const jugarBtn = document.getElementById('jugar-btn');
  const finalizarBtn = document.getElementById('finalizar-btn');
  const modoManualSwitch = document.getElementById('modo-manual-switch');
  const modoManualEstadoEl = document.getElementById('modo-manual-estado');
  const tablaCantosContainer = document.getElementById('tabla-cantos-container');
  const tablaCantosTitulo = document.getElementById('tabla-cantos-titulo');
  const cantoCeldas = new Map();
  let cantosSeleccionados = new Set();
  let cantosUnsub = null;
  const sorteoCookieDefaultKey = 'cantarsorteos_default';
  let sorteoCookieKey = sorteoCookieDefaultKey;
  let restauracionPendiente = false;
  let pdfDestinoUrl = '';
  let pdfAccionEnCurso = false;
  let modoManual = false;
  let infoTiempoSorteo = {
    fecha: null,
    fechaCierre: null,
    hora: null,
    horaCierre: null
  };
  const pdfConfirmModal = document.getElementById('pdf-confirm-modal');
  const pdfConfirmSiBtn = document.getElementById('pdf-confirm-si');
  const pdfConfirmNoBtn = document.getElementById('pdf-confirm-no');

  function setCookie(name, value){
    try {
      document.cookie = `${name}=${encodeURIComponent(value)};path=/;max-age=31536000`;
    } catch (err) {
      console.warn('No fue posible establecer la cookie para el sorteo seleccionado.', err);
    }
    try {
      localStorage.setItem(name, value);
    } catch (err) {
      console.warn('No fue posible almacenar el sorteo seleccionado en localStorage.', err);
    }
  }

  function getCookie(name){
    try {
      const match = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/[.$?*|{}()\[\]\\\/\+^]/g, '\\$&') + '=([^;]*)'));
      if(match){
        return decodeURIComponent(match[1]);
      }
    } catch (err) {
      console.warn('No fue posible leer la cookie del sorteo seleccionado.', err);
    }
    try {
      return localStorage.getItem(name);
    } catch (err) {
      console.warn('No fue posible recuperar el sorteo seleccionado desde localStorage.', err);
      return null;
    }
  }

  function deleteCookie(name){
    try {
      document.cookie = `${name}=;path=/;max-age=0`;
    } catch (err) {
      console.warn('No fue posible eliminar la cookie del sorteo seleccionado.', err);
    }
    try {
      localStorage.removeItem(name);
    } catch (err) {
      console.warn('No fue posible eliminar el sorteo seleccionado de localStorage.', err);
    }
  }

  function limpiarSorteoSeleccionado(){
    if(sorteoCookieKey){
      deleteCookie(sorteoCookieKey);
    }
    if(sorteoCookieKey !== sorteoCookieDefaultKey){
      deleteCookie(sorteoCookieDefaultKey);
    }
  }

  function esSorteoVisible(info){
    if(!info) return false;
    const condicionTexto = (info.condicion ?? info['condición'] ?? '').toString().trim().toUpperCase();
    return condicionTexto === 'VISIBLE';
  }

  function guardarSorteoSeleccionado(info){
    if(!sorteoCookieKey || !info) return;
    let payload;
    let referencia = null;
    if(typeof info === 'string'){
      if(!info) return;
      referencia = sorteos.find(s=>s.id===info) || null;
      if(!referencia || !esSorteoVisible(referencia)){
        limpiarSorteoSeleccionado();
        return;
      }
      payload = { id: info, tipo: referencia.tipo || '' };
    }else{
      const id = info.id || '';
      if(!id) return;
      if(!esSorteoVisible(info)){
        limpiarSorteoSeleccionado();
        return;
      }
      payload = { id, tipo: info.tipo || '' };
    }
    setCookie(sorteoCookieKey, JSON.stringify(payload));
    if(sorteoCookieKey !== sorteoCookieDefaultKey){
      setCookie(sorteoCookieDefaultKey, JSON.stringify(payload));
    }
  }

  function intentarRestaurarSorteo(){
    if(!sorteoCookieKey){
      restauracionPendiente = false;
      return false;
    }
    const guardado = getCookie(sorteoCookieKey);
    if(!guardado){
      restauracionPendiente = false;
      return false;
    }
    let idRestaurar = guardado;
    try {
      const data = JSON.parse(guardado);
      if(data && typeof data === 'object'){
        idRestaurar = data.id || '';
      }
    } catch (err) {
      idRestaurar = guardado;
    }
    if(!idRestaurar){
      restauracionPendiente = false;
      return false;
    }
    if(!sorteos || !sorteos.length){
      return false;
    }
    if(idRestaurar === currentSorteoId){
      restauracionPendiente = false;
      return true;
    }
    const existe = sorteos.find(s=>s.id===idRestaurar);
    if(!existe || !esSorteoVisible(existe)){
      limpiarSorteoSeleccionado();
      restauracionPendiente = false;
      return false;
    }
    seleccionarSorteo(idRestaurar);
    restauracionPendiente = false;
    return true;
  }

  auth.onAuthStateChanged(user=>{
    if(!user){
      sorteoCookieKey = sorteoCookieDefaultKey;
      restauracionPendiente = false;
      return;
    }
    const nuevoKey = `cantarsorteos_${user.email.replace(/[^\w]/g,'_')}`;
    if(!getCookie(nuevoKey)){
      const general = getCookie(sorteoCookieDefaultKey);
      if(general){
        setCookie(nuevoKey, general);
      }
    }
    sorteoCookieKey = nuevoKey;
    restauracionPendiente = true;
    if(intentarRestaurarSorteo()){
      restauracionPendiente = false;
    }
  });

  document.getElementById('salir-btn').addEventListener('click',()=>{ window.location.href='admin.html'; });
  btnSorteo.addEventListener('click', abrirModalSorteos);
  sellarBtn.addEventListener('click', sellarSorteo);
  pdfBtn.addEventListener('click', abrirPDF);
  jugarBtn.addEventListener('click', cambiarAJugando);
  finalizarBtn.addEventListener('click', finalizarSorteo);
  if(modoManualSwitch){
    modoManualSwitch.addEventListener('change', ()=>{
      modoManual = modoManualSwitch.checked;
      actualizarEstadoModo();
    });
    actualizarEstadoModo();
  }
  construirTablaCantos();
  if(pdfConfirmSiBtn){ pdfConfirmSiBtn.addEventListener('click', marcarPdfGuardado); }
  if(pdfConfirmNoBtn){ pdfConfirmNoBtn.addEventListener('click', irAGenerarPdf); }
  if(pdfConfirmModal){
    pdfConfirmModal.addEventListener('click', evento=>{
      if(evento.target === pdfConfirmModal){
        cerrarPdfConfirmacion();
        pdfDestinoUrl = '';
      }
    });
  }
  document.addEventListener('keydown', evento=>{
    if(evento.key === 'Escape' && pdfConfirmModal && pdfConfirmModal.classList.contains('activo')){
      cerrarPdfConfirmacion();
      pdfDestinoUrl = '';
    }
  });

  function obtenerServerTime(){
    if(typeof window !== 'undefined' && window.serverTime) return window.serverTime;
    if(typeof serverTime !== 'undefined') return serverTime;
    return null;
  }

  function getServerNow(){
    const st = obtenerServerTime();
    return new Date(Date.now() + (st?.diferencia || 0));
  }

  function esModoManual(){
    return modoManual === true;
  }

  function actualizarEstadoModo(){
    if(modoManualEstadoEl){
      modoManualEstadoEl.textContent = modoManual ? 'Manual' : 'Validado';
    }
  }

  function actualizarValoresActuales(){
    if(!fechaActualValorEl || !horaActualValorEl) return;
    try {
      const st = obtenerServerTime();
      const diferencia = st?.diferencia || 0;
      const ahora = new Date(Date.now() + diferencia);
      const zona = st?.zonaIana;
      const opcionesFecha = { day: '2-digit', month: '2-digit', year: 'numeric' };
      const opcionesHora = { hour: '2-digit', minute: '2-digit', hour12: true };
      if(zona){
        opcionesFecha.timeZone = zona;
        opcionesHora.timeZone = zona;
      }
      const fechaFormatter = new Intl.DateTimeFormat('es-ES', opcionesFecha);
      const horaFormatter = new Intl.DateTimeFormat('en-US', opcionesHora);
      const fechaStr = fechaFormatter.format(ahora);
      const horaStr = horaFormatter.format(ahora).toUpperCase();
      fechaActualValorEl.textContent = fechaStr;
      horaActualValorEl.textContent = horaStr;
      actualizarColoresFechas(ahora);
    } catch (err) {
      console.error('Error actualizando fecha y hora actuales', err);
    }
  }

  function inicializarFechaHoraFooter(){
    const footerEl = document.getElementById('fecha-hora');
    if(!footerEl) return;
    function renderFooter(){
      try {
        const st = obtenerServerTime();
        const diferencia = st?.diferencia || 0;
        const ahora = new Date(Date.now() + diferencia);
        const locale = st?.locale || 'es-ES';
        const zona = st?.zonaIana;
        const opcionesFecha = { year: 'numeric', month: 'long', day: 'numeric' };
        const opcionesHora = { hour: '2-digit', minute: '2-digit', hour12: true };
        if(zona){
          opcionesFecha.timeZone = zona;
          opcionesHora.timeZone = zona;
        }
        const fechaStr = ahora.toLocaleDateString(locale, opcionesFecha);
        let horaStr = ahora.toLocaleTimeString(locale, opcionesHora);
        horaStr = horaStr
          .replace(/\s*a\.?\s*m\.?/gi, ' AM')
          .replace(/\s*p\.?\s*m\.?/gi, ' PM');
        footerEl.textContent = '';
        const fragment = document.createDocumentFragment();
        if(st?.Pais){
          const paisSpan = document.createElement('span');
          paisSpan.className = 'pais-actual';
          paisSpan.textContent = `${st.Pais} |`;
          fragment.appendChild(paisSpan);
          fragment.appendChild(document.createTextNode(' '));
        }
        const fechaSpan = document.createElement('span');
        fechaSpan.className = 'fecha-actual-texto';
        fechaSpan.textContent = fechaStr;
        fragment.appendChild(fechaSpan);
        fragment.appendChild(document.createTextNode(' '));
        const horaSpan = document.createElement('span');
        horaSpan.className = 'hora-actual-texto';
        horaSpan.textContent = horaStr;
        fragment.appendChild(horaSpan);
        footerEl.appendChild(fragment);
      } catch (error) {
        console.error('Error actualizando fecha y hora del footer', error);
      }
    }
    renderFooter();
    setInterval(renderFooter, 1000);
  }

  function iniciarActualizacionesActuales(){
    actualizarValoresActuales();
    setInterval(actualizarValoresActuales, 1000);
  }

  function construirTablaCantos(){
    if(!tablaCantosContainer) return;
    tablaCantosContainer.innerHTML = '';
    cantoCeldas.clear();
    const tabla = document.createElement('table');
    tabla.id = 'tabla-cantos';
    const thead = document.createElement('thead');
    const headRow = document.createElement('tr');
    const letras = ['B','I','N','G','O'];
    letras.forEach(letra=>{
      const th = document.createElement('th');
      th.textContent = letra;
      headRow.appendChild(th);
    });
    thead.appendChild(headRow);
    tabla.appendChild(thead);
    const tbody = document.createElement('tbody');
    for(let fila=0; fila<15; fila++){
      const tr = document.createElement('tr');
      letras.forEach((letra, idx)=>{
        const base = idx * 15 + 1;
        const numero = base + fila;
        const numeroTexto = numero.toString().padStart(2,'0');
        const clave = `${letra}-${numeroTexto}`;
        const td = document.createElement('td');
        td.className = 'canto-cell';
        td.dataset.key = clave;
        td.textContent = clave;
        td.addEventListener('click', ()=>manejarCantoClick(clave));
        cantoCeldas.set(clave, td);
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }
    tabla.appendChild(tbody);
    tablaCantosContainer.appendChild(tabla);
  }

  async function manejarCantoClick(clave){
    if(!currentSorteoId || !currentSorteoData) return;
    if(tablaCantosContainer.classList.contains('disabled')) return;
    if(tablaCantosContainer.classList.contains('bloqueado')) return;
    if(cantosSeleccionados.has(clave)) return;
    const confirmar = confirm(`Confirmas la jugada de ${clave}?`);
    if(!confirmar) return;
    try {
      await db.collection('cantos').doc(currentSorteoId).set({
        numeros: firebase.firestore.FieldValue.arrayUnion(clave),
        actualizado: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      mensajeEl.textContent = `Se registró la jugada ${clave}.`;
    } catch (err) {
      console.error('Error registrando canto', err);
      alert('No fue posible registrar el canto.');
    }
  }

  function actualizarCantosSeleccionados(lista){
    const valores = Array.isArray(lista) ? lista : [];
    cantosSeleccionados = new Set(valores.map(v=>{
      const texto = (v ?? '').toString();
      return texto.toUpperCase();
    }));
    cantoCeldas.forEach((celda, clave)=>{
      if(cantosSeleccionados.has(clave)) celda.classList.add('selected');
      else celda.classList.remove('selected');
    });
  }

  function detenerCantos(){
    if(cantosUnsub){
      cantosUnsub();
      cantosUnsub = null;
    }
  }

  function escucharCantos(id){
    detenerCantos();
    if(!id){
      actualizarCantosSeleccionados([]);
      return;
    }
    const ref = db.collection('cantos').doc(id);
    cantosUnsub = ref.onSnapshot(doc=>{
      if(!doc.exists){
        actualizarCantosSeleccionados([]);
        if(currentSorteoData) currentSorteoData.cantos = [];
        return;
      }
      const data = doc.data() || {};
      const numeros = Array.isArray(data.numeros) ? data.numeros : [];
      actualizarCantosSeleccionados(numeros);
      if(currentSorteoData){
        currentSorteoData.cantos = numeros;
      }
      const idx = sorteos.findIndex(s=>s.id===id);
      if(idx>=0){
        sorteos[idx].cantos = numeros;
      }
    }, err=>console.error('Error escuchando cantos', err));
  }

  function actualizarTablaEstado(){
    if(!tablaCantosContainer) return;
    const estado = (currentSorteoData?.estado || '').toString().toLowerCase();
    const esFinalizado = estado === 'finalizado';
    const habilitado = estado === 'jugando';
    tablaCantosContainer.classList.toggle('disabled', !habilitado && !esFinalizado);
    tablaCantosContainer.classList.toggle('bloqueado', esFinalizado);
    if(tablaCantosTitulo){
      tablaCantosTitulo.textContent = esFinalizado ? 'NÚMEROS CANTADOS (FINALIZADO)' : 'NÚMEROS CANTADOS';
    }
  }

  function asegurarCampoPdf(id, data){
    if(!id || !data) return;
    if(typeof data.pdf === 'undefined' || data.pdf === null || data.pdf === ''){
      db.collection('sorteos').doc(id).set({ pdf: 'no' }, { merge: true }).catch(err=>{
        console.error('Error estableciendo pdf predeterminado', err);
      });
      data.pdf = 'no';
    }
  }

  function obtenerFechaDesdeValor(valor){
    if(!valor) return null;
    if(valor instanceof Date) return valor;
    if(typeof valor === 'object' && typeof valor.toDate === 'function'){ return valor.toDate(); }
    if(typeof valor !== 'string') return null;
    const limpio = valor.trim();
    if(!limpio) return null;
    if(limpio.includes('/')){
      const [dia, mes, anio] = limpio.split('/').map(num=>parseInt(num,10));
      if([dia, mes, anio].some(n=>isNaN(n))) return null;
      return new Date(anio, (mes||1)-1, dia||1);
    }
    if(limpio.includes('-')){
      const [anio, mes, dia] = limpio.split('-').map(num=>parseInt(num,10));
      if([dia, mes, anio].some(n=>isNaN(n))) return null;
      return new Date(anio, (mes||1)-1, dia||1);
    }
    const timestamp = Date.parse(limpio);
    if(!isNaN(timestamp)) return new Date(timestamp);
    return null;
  }

  function obtenerHoraDesdeValor(valor){
    if(!valor) return null;
    if(valor instanceof Date){
      return { hora: valor.getHours(), minuto: valor.getMinutes() };
    }
    if(typeof valor === 'object' && typeof valor.seconds === 'number'){
      const fecha = new Date(valor.seconds * 1000);
      return { hora: fecha.getHours(), minuto: fecha.getMinutes() };
    }
    if(typeof valor !== 'string') return null;
    let texto = valor.trim().toLowerCase();
    if(!texto) return null;
    let sufijo = null;
    if(/a\s*\.?m\.?/.test(texto)) sufijo = 'am';
    if(/p\s*\.?m\.?/.test(texto)) sufijo = 'pm';
    texto = texto.replace(/[^0-9:]/g, '');
    if(!texto) return null;
    const partes = texto.split(':');
    const horas = parseInt(partes[0] || '0', 10);
    const minutos = parseInt((partes[1] || '0').slice(0,2), 10);
    if(isNaN(horas) || isNaN(minutos)) return null;
    let hora24 = horas;
    if(sufijo === 'pm' && hora24 < 12) hora24 += 12;
    if(sufijo === 'am' && hora24 === 12) hora24 = 0;
    return { hora: hora24, minuto: minutos };
  }

  function formatearFecha(valor){
    const fecha = obtenerFechaDesdeValor(valor);
    if(!fecha || isNaN(fecha.getTime())) return '';
    const dia = String(fecha.getDate()).padStart(2,'0');
    const mes = String(fecha.getMonth()+1).padStart(2,'0');
    const anio = fecha.getFullYear();
    return `${dia}/${mes}/${anio}`;
  }

  function formatearHora(valor){
    const horaInfo = obtenerHoraDesdeValor(valor);
    if(!horaInfo) return '';
    const { hora, minuto } = horaInfo;
    const sufijo = hora >= 12 ? 'pm' : 'am';
    const hora12 = hora % 12 || 12;
    return `${hora12.toString().padStart(2,'0')}:${minuto.toString().padStart(2,'0')} ${sufijo}`;
  }

  const formatoNumeroES = new Intl.NumberFormat('es-ES');

  function formatearNumero(valor){
    const numero = Number(valor) || 0;
    return formatoNumeroES.format(Math.round(numero));
  }

  function obtenerValorHoraCierre(sorteo){
    if(!sorteo) return null;
    const claves=['horacierre','horaCierre','hora_cierre','cierre','cierreHora','cierrehora'];
    for(const clave of claves){
      const valor=sorteo?.[clave];
      if(valor===undefined || valor===null || valor==='') continue;
      if(typeof valor==='string'){
        const texto=valor.trim();
        if(!texto) continue;
        if(!/[0-9]:/.test(texto) && !/[ap]\.?m\.?/i.test(texto) && /^\d+$/.test(texto)){
          continue;
        }
        return texto;
      }
      return valor;
    }
    return null;
  }

  function obtenerFechaCierre(data){
    if(!data) return null;
    return obtenerFechaDesdeValor(data.fechacierre ?? data.fecha);
  }

  function obtenerFechaHoraCierre(data){
    if(!data) return null;
    const fechaBase = obtenerFechaCierre(data);
    if(!fechaBase || isNaN(fechaBase.getTime())) return null;
    const valorHora=obtenerValorHoraCierre(data);
    if(valorHora){
      const info=obtenerHoraDesdeValor(valorHora);
      if(info){
        return new Date(fechaBase.getFullYear(),fechaBase.getMonth(),fechaBase.getDate(),info.hora,info.minuto);
      }
      if(valorHora instanceof Date && !isNaN(valorHora.getTime())){
        return new Date(fechaBase.getFullYear(),fechaBase.getMonth(),fechaBase.getDate(),valorHora.getHours(),valorHora.getMinutes());
      }
    }
    const minutosFallback=parseInt(data.cierreMinutos ?? data.cierre ?? data.cierreminutos,10);
    if(!isNaN(minutosFallback)){
      const fechaSorteo=obtenerFechaSorteo(data);
      if(fechaSorteo && !isNaN(fechaSorteo.getTime())){
        return new Date(fechaSorteo.getTime()-minutosFallback*60000);
      }
    }
    return null;
  }

  function obtenerTextoHoraCierre(data){
    const valor=obtenerValorHoraCierre(data);
    if(valor){
      const texto=formatearHora(valor);
      if(texto) return texto;
    }
    const minutos=parseInt(data?.cierreMinutos ?? data?.cierre ?? data?.cierreminutos,10);
    if(!isNaN(minutos)) return `${minutos} min.`;
    return '';
  }

  function generarSubtotalesFormas(formas, totalPremios){
    if(!Array.isArray(formas) || !formas.length) return '';
    const totales = [];
    const premioBase = Number(totalPremios) || 0;
    formas.forEach(forma=>{
      const idx = parseInt(forma.idx, 10);
      const porcentaje = parseFloat(forma.porcentaje);
      if(!idx || isNaN(porcentaje) || porcentaje <= 0) return;
      const subtotal = premioBase > 0 ? (premioBase * (porcentaje / 100)) : 0;
      const clase = `forma${Math.min(idx,5)}`;
      totales.push(`<span class="forma-subtotal ${clase}">F${idx}: ${formatearNumero(subtotal)}</span>`);
    });
    return totales.join(' ');
  }

  function obtenerFechaSorteo(data){
    if(!data) return null;
    const fechaBase = obtenerFechaDesdeValor(data.fecha);
    const horaInfo = obtenerHoraDesdeValor(data.hora);
    if(!fechaBase || !horaInfo) return null;
    const { hora, minuto } = horaInfo;
    return new Date(fechaBase.getFullYear(), fechaBase.getMonth(), fechaBase.getDate(), hora, minuto);
  }

  function truncarFecha(fecha){
    if(!(fecha instanceof Date) || isNaN(fecha.getTime())) return null;
    return new Date(fecha.getFullYear(), fecha.getMonth(), fecha.getDate());
  }

  function compararFechasCalendario(a, b){
    const fechaA = truncarFecha(a);
    const fechaB = truncarFecha(b);
    if(!fechaA || !fechaB) return null;
    const tiempoA = fechaA.getTime();
    const tiempoB = fechaB.getTime();
    if(tiempoA === tiempoB) return 0;
    return tiempoA < tiempoB ? -1 : 1;
  }

  function compararHoraActualConInfo(actual, horaInfo){
    if(!(actual instanceof Date) || isNaN(actual.getTime()) || !horaInfo) return null;
    const horaNumero = Number(horaInfo.hora);
    const minutoNumero = Number(horaInfo.minuto);
    if(isNaN(horaNumero) || isNaN(minutoNumero)) return null;
    const minutosActual = actual.getHours() * 60 + actual.getMinutes();
    const minutosReferencia = (horaNumero * 60) + minutoNumero;
    if(minutosActual === minutosReferencia) return 0;
    return minutosActual < minutosReferencia ? -1 : 1;
  }

  function aplicarResaltadoTiempo(elemento, resaltar){
    if(!elemento) return;
    if(resaltar) elemento.classList.add('resaltado-actual');
    else elemento.classList.remove('resaltado-actual');
  }

  function actualizarVisibilidadFilaCierre(fechaTexto, horaTexto){
    if(!filaCierre) return;
    const fechaValida = typeof fechaTexto === 'string' ? fechaTexto.trim() : '';
    const horaValida = typeof horaTexto === 'string' ? horaTexto.trim() : '';
    const hayValor = Boolean(fechaValida || horaValida);
    filaCierre.classList.toggle('oculta', !hayValor);
  }

  function actualizarColoresFechas(ahoraParam){
    const ahora = (ahoraParam instanceof Date && !isNaN(ahoraParam.getTime())) ? ahoraParam : (getServerNow() || new Date());
    if(!(ahora instanceof Date) || isNaN(ahora.getTime())){
      aplicarResaltadoTiempo(fechaProgramadaEl, false);
      aplicarResaltadoTiempo(horaProgramadaEl, false);
      aplicarResaltadoTiempo(fechaCierreEl, false);
      aplicarResaltadoTiempo(horaCierreEl, false);
      return;
    }

    const comparacionFechaSorteo = infoTiempoSorteo.fecha ? compararFechasCalendario(infoTiempoSorteo.fecha, ahora) : null;
    const comparacionFechaCierre = infoTiempoSorteo.fechaCierre ? compararFechasCalendario(infoTiempoSorteo.fechaCierre, ahora) : null;

    const resaltarFechaSorteo = comparacionFechaSorteo !== null && comparacionFechaSorteo <= 0;
    let resaltarHoraSorteo = false;
    if(infoTiempoSorteo.hora && comparacionFechaSorteo !== null){
      if(comparacionFechaSorteo < 0){
        resaltarHoraSorteo = true;
      } else if(comparacionFechaSorteo === 0){
        const comparacionHora = compararHoraActualConInfo(ahora, infoTiempoSorteo.hora);
        resaltarHoraSorteo = comparacionHora !== null && comparacionHora >= 0;
      }
    }

    const resaltarFechaCierre = comparacionFechaCierre !== null && comparacionFechaCierre <= 0;
    let resaltarHoraCierre = false;
    if(infoTiempoSorteo.horaCierre && comparacionFechaCierre !== null){
      if(comparacionFechaCierre < 0){
        resaltarHoraCierre = true;
      } else if(comparacionFechaCierre === 0){
        const comparacionHora = compararHoraActualConInfo(ahora, infoTiempoSorteo.horaCierre);
        resaltarHoraCierre = comparacionHora !== null && comparacionHora >= 0;
      }
    }

    aplicarResaltadoTiempo(fechaProgramadaEl, resaltarFechaSorteo);
    aplicarResaltadoTiempo(horaProgramadaEl, resaltarHoraSorteo);
    aplicarResaltadoTiempo(fechaCierreEl, resaltarFechaCierre);
    aplicarResaltadoTiempo(horaCierreEl, resaltarHoraCierre);
  }

  function obtenerNombreSorteoActual(){
    return (currentSorteoData && currentSorteoData.nombre) ? currentSorteoData.nombre : 'este sorteo';
  }

  function actualizarAnimaciones(){
    [sellarBtn, pdfBtn, jugarBtn, finalizarBtn].forEach(btn=>btn.classList.remove('attention'));
    actualizarBotones();
    if(!currentSorteoData) return;
    const estadoLower = (currentSorteoData.estado || '').toString().toLowerCase();
    const pdfEstado = (currentSorteoData.pdf || '').toString().toLowerCase();
    if(estadoLower === 'activo'){
      sellarBtn.classList.add('attention');
    } else if(estadoLower === 'sellado'){
      if(pdfEstado === 'si') jugarBtn.classList.add('attention');
      else pdfBtn.classList.add('attention');
    } else if(estadoLower === 'jugando'){
      finalizarBtn.classList.add('attention');
    }
  }

  function actualizarEstadoVisual(estado){
    const estadoTexto = (estado || '-').toString().toUpperCase();
    const estadoNormalizado = (estado || '').toString().toLowerCase();
    let clase = '';
    if(estadoNormalizado === 'activo') clase = 'activo';
    else if(estadoNormalizado === 'sellado') clase = 'sellado';
    else if(estadoNormalizado === 'jugando') clase = 'jugando';
    else if(estadoNormalizado === 'finalizado') clase = 'finalizado';
    if(estadoValorEl){
      estadoValorEl.textContent = estadoTexto;
      estadoValorEl.className = ['estado-badge', clase].filter(Boolean).join(' ');
    }
  }

  function actualizarBotones(){
    if(!currentSorteoData){
      [sellarBtn, pdfBtn, jugarBtn, finalizarBtn].forEach(btn=>btn.disabled=true);
      return;
    }
    const estado = (currentSorteoData.estado || '').toLowerCase();
    const pdfEstado = (currentSorteoData.pdf || '').toString().toLowerCase();

    sellarBtn.disabled = estado !== 'activo';
    pdfBtn.disabled = estado !== 'sellado';
    jugarBtn.disabled = estado !== 'sellado' || pdfEstado !== 'si';
    finalizarBtn.disabled = estado !== 'jugando';
  }

  function mostrarDatos(){
    if(!currentSorteoData){
      btnSorteo.textContent = 'Selecciona Sorteo';
      if(fechaProgramadaEl) fechaProgramadaEl.textContent = '';
      if(horaProgramadaEl) horaProgramadaEl.textContent = '';
      if(fechaCierreEl) fechaCierreEl.textContent = '';
      if(horaCierreEl) horaCierreEl.textContent = '';
      actualizarVisibilidadFilaCierre('', '');
      premioEl.textContent = '0';
      valorCartonEl.textContent = '0';
      cartonesPagosEl.textContent = '0';
      cartonesGratisEl.textContent = '0';
      sorteoNombreEl.textContent = 'Selecciona un sorteo para ver los detalles';
      actualizarEstadoVisual(null);
      if(tipoEstadoEl){
        tipoEstadoEl.textContent = '';
        tipoEstadoEl.className = 'tipo-estado';
      }
      tipoEl.innerHTML = '';
      if(detalleContainer) detalleContainer.classList.remove('estado-sellado','estado-pdf','estado-jugando','estado-finalizado');
      mensajeEl.textContent = 'Selecciona un sorteo para administrar su estado.';
      [sellarBtn, pdfBtn, jugarBtn, finalizarBtn].forEach(btn=>btn.disabled=true);
      actualizarAnimaciones();
      actualizarCantosSeleccionados([]);
      actualizarTablaEstado();
      infoTiempoSorteo = { fecha: null, fechaCierre: null, hora: null, horaCierre: null };
      actualizarColoresFechas();
      return;
    }
    const data = currentSorteoData;
    btnSorteo.textContent = data.nombre || 'Sorteo';
    btnSorteo.classList.remove('diario','especial','jugando','finalizado');
    const estadoActual = data.estado || '';
    const tipoActual = (data.tipo || '').toLowerCase();
    const esDiario = tipoActual.includes('diario');
    const esEspecial = tipoActual.includes('especial') || tipoActual.includes('espacial');
    if(estadoActual === 'Jugando') btnSorteo.classList.add('jugando');
    else if(estadoActual === 'Finalizado') btnSorteo.classList.add('finalizado');
    else if(esDiario) btnSorteo.classList.add('diario');
    else if(esEspecial) btnSorteo.classList.add('especial');
    if(detalleContainer){
      detalleContainer.classList.remove('estado-sellado','estado-pdf','estado-jugando','estado-finalizado');
      const estadoLower = estadoActual.toLowerCase();
      const pdfEstado = (data.pdf || '').toString().toLowerCase();
      if(estadoLower === 'finalizado') detalleContainer.classList.add('estado-finalizado');
      else if(estadoLower === 'jugando') detalleContainer.classList.add('estado-jugando');
      else if(pdfEstado === 'si') detalleContainer.classList.add('estado-pdf');
      else if(estadoLower === 'sellado') detalleContainer.classList.add('estado-sellado');
    }
    const fechaSorteoBase = obtenerFechaDesdeValor(data.fecha);
    const fechaProgramadaCompleta = obtenerFechaSorteo(data);
    const fechaCierreBase = obtenerFechaDesdeValor(data.fechacierre ?? data.fecha);
    const horaSorteoInfo = obtenerHoraDesdeValor(data.hora);
    const valorHoraCierre = obtenerValorHoraCierre(data);
    let fechaHoraCierreCompleta = obtenerFechaHoraCierre(data);
    if(
      fechaHoraCierreCompleta instanceof Date &&
      !isNaN(fechaHoraCierreCompleta.getTime()) &&
      fechaProgramadaCompleta instanceof Date &&
      !isNaN(fechaProgramadaCompleta.getTime()) &&
      fechaHoraCierreCompleta.getTime() > fechaProgramadaCompleta.getTime()
    ){
      fechaHoraCierreCompleta = new Date(fechaProgramadaCompleta.getTime());
    }
    let horaCierreInfo = obtenerHoraDesdeValor(valorHoraCierre);
    if(!horaCierreInfo && fechaHoraCierreCompleta instanceof Date && !isNaN(fechaHoraCierreCompleta.getTime())){
      horaCierreInfo = obtenerHoraDesdeValor(fechaHoraCierreCompleta);
    }
    if(fechaProgramadaEl) fechaProgramadaEl.textContent = fechaSorteoBase ? formatearFecha(fechaSorteoBase) : '';
    if(horaProgramadaEl) horaProgramadaEl.textContent = data.hora ? formatearHora(data.hora) : '';
    let textoFechaCierre = '';
    if(fechaCierreEl){
      textoFechaCierre = fechaCierreBase ? formatearFecha(fechaCierreBase) : '';
      fechaCierreEl.textContent = textoFechaCierre;
    }
    let textoHoraCierre = '';
    if(horaCierreEl){
      if(valorHoraCierre){
        textoHoraCierre = formatearHora(valorHoraCierre);
      } else if(fechaHoraCierreCompleta instanceof Date && !isNaN(fechaHoraCierreCompleta.getTime())){
        textoHoraCierre = formatearHora(fechaHoraCierreCompleta);
      }
      horaCierreEl.textContent = textoHoraCierre;
    }
    actualizarVisibilidadFilaCierre(textoFechaCierre, textoHoraCierre);
    premioEl.textContent = Math.round(data.totalPremios || 0);
    valorCartonEl.textContent = data.valorCarton || 0;
    cartonesPagosEl.textContent = data.cartonesjugando || 0;
    cartonesGratisEl.textContent = data.cartonesgratisjugando || 0;
    sorteoNombreEl.textContent = data.nombre || '';
    actualizarEstadoVisual(data.estado);
    if(tipoEstadoEl){
      let tipoMostrar = '';
      if(esEspecial) tipoMostrar = 'ESPECIAL';
      else if(esDiario) tipoMostrar = 'DIARIO';
      const clases = ['tipo-estado'];
      if(esEspecial) clases.push('especial');
      else if(esDiario) clases.push('diario');
      tipoEstadoEl.className = clases.join(' ');
      tipoEstadoEl.textContent = tipoMostrar;
    }
    tipoEl.innerHTML = '';
    infoTiempoSorteo = {
      fecha: fechaSorteoBase instanceof Date && !isNaN(fechaSorteoBase.getTime()) ? fechaSorteoBase : null,
      fechaCierre: fechaCierreBase instanceof Date && !isNaN(fechaCierreBase.getTime()) ? fechaCierreBase : null,
      hora: horaSorteoInfo || null,
      horaCierre: horaCierreInfo || null
    };
    actualizarColoresFechas();
    mensajeEl.textContent = '';
    actualizarBotones();
    actualizarAnimaciones();
    actualizarTablaEstado();
  }

  async function cargarSorteos(){
    sorteos = [];
    try {
      const snap = await db.collection('sorteos').get();
      const pendientesPdf = [];
      const cantosPromises = [];
      const formasPromises = [];
      const registrosMap = new Map();
      snap.forEach(doc=>{
        const d = doc.data();
        const condicionRaw = (d?.condicion || '').toString().trim().toUpperCase();
        if(condicionRaw === 'ARCHIVADO') return;
        const registro = { id: doc.id, ...d, pdf: d.pdf || 'no', cantos: [], formas: [] };
        registro.condicion = condicionRaw || 'VISIBLE';
        registro.nombre = registro.nombre || 'Sorteo';
        registro.estado = registro.estado || 'Activo';
        registro.fecha = registro.fecha || '';
        registro.fechacierre = registro.fechacierre || registro.fecha || '';
        registro.hora = registro.hora || '';
        registro.tipo = registro.tipo || '';
        registro.valorCarton = registro.valorCarton || 0;
        registro.cartonesjugando = registro.cartonesjugando || 0;
        registro.cartonesgratisjugando = registro.cartonesgratisjugando || 0;
        registro.totalPremios = registro.totalPremios || 0;
        if((registro.horacierre === undefined || registro.horacierre === null || registro.horacierre==='') && registro.cierre){
          registro.horacierre = registro.cierre;
        }
        registrosMap.set(doc.id, registro);
        if(typeof d.pdf === 'undefined' || d.pdf === null || d.pdf === ''){
          pendientesPdf.push(doc.id);
        }
        cantosPromises.push(
          db.collection('cantos').doc(doc.id).get().then(cantoDoc=>{
            if(!cantoDoc.exists){
              registro.cantos = [];
              return;
            }
            const dataCantos = cantoDoc.data() || {};
            registro.cantos = Array.isArray(dataCantos.numeros) ? dataCantos.numeros : [];
          }).catch(err=>console.error('Error cargando cantos de sorteo', err))
        );
        formasPromises.push(
          db.collection('formas').where('sorteoId','==',doc.id).get().then(formasSnap=>{
            const arr = [];
            formasSnap.forEach(fdoc=>{
              const dataForma = fdoc.data() || {};
              arr.push({
                idx: dataForma.idx || dataForma.indice || arr.length + 1,
                nombre: dataForma.nombre || '',
                porcentaje: dataForma.porcentaje ?? dataForma.porcentajePremio ?? 0,
                cartonesGratis: dataForma.cartonesGratis ?? (dataForma.cartones || 0)
              });
            });
            arr.sort((a,b)=>(parseInt(a.idx,10)||0)-(parseInt(b.idx,10)||0));
            registro.formas = arr;
          }).catch(err=>console.error('Error cargando formas de sorteo', err))
        );
      });
      sorteos = Array.from(registrosMap.values());
      if(pendientesPdf.length){
        await Promise.all(pendientesPdf.map(id=>
          db.collection('sorteos').doc(id).set({ pdf: 'no' }, { merge: true })
        )).catch(err=>console.error('Error asegurando pdf en sorteos', err));
      }
      const espera = [];
      if(cantosPromises.length) espera.push(Promise.all(cantosPromises));
      if(formasPromises.length) espera.push(Promise.all(formasPromises));
      if(espera.length) await Promise.all(espera);
      if(restauracionPendiente){
        const restaurado = intentarRestaurarSorteo();
        restauracionPendiente = !restaurado;
      }
    } catch (err) {
      console.error('Error cargando sorteos', err);
    }
  }

  async function abrirModalSorteos(){
    await cargarSorteos();
    if(!sorteos.length){
      mensajeEl.textContent = 'No hay sorteos disponibles en este momento.';
      return;
    }
    mensajeEl.textContent = '';
    const cont = document.getElementById('sorteos-list');
    cont.innerHTML = '';
    const estadoOrden = { jugando: 0, sellado: 1, activo: 2, finalizado: 3 };
    const ahora = getServerNow() || new Date();
    const referencia = ahora instanceof Date && !isNaN(ahora.getTime()) ? ahora : new Date();
    const unicos = [];
    const vistos = new Set();
    sorteos.forEach(reg=>{
      if(!reg || !reg.id || vistos.has(reg.id)) return;
      vistos.add(reg.id);
      unicos.push(reg);
    });
    const ordenados = unicos.sort((a,b)=>{
      const estadoA = (a.estado || '').toString().toLowerCase();
      const estadoB = (b.estado || '').toString().toLowerCase();
      const prioridadA = estadoOrden.hasOwnProperty(estadoA) ? estadoOrden[estadoA] : 4;
      const prioridadB = estadoOrden.hasOwnProperty(estadoB) ? estadoOrden[estadoB] : 4;
      if(prioridadA !== prioridadB) return prioridadA - prioridadB;
      const fechaA = obtenerFechaSorteo(a);
      const fechaB = obtenerFechaSorteo(b);
      const diffA = fechaA ? Math.abs(fechaA - referencia) : Number.MAX_SAFE_INTEGER;
      const diffB = fechaB ? Math.abs(fechaB - referencia) : Number.MAX_SAFE_INTEGER;
      if(diffA !== diffB) return diffA - diffB;
      if(fechaA && fechaB && fechaA.getTime() !== fechaB.getTime()) return fechaA - fechaB;
      return (a.nombre || '').localeCompare(b.nombre || '');
    });
    ordenados.forEach((s, idx)=>{
      const div = document.createElement('div');
      const estadoLower = (s.estado || '').toString().toLowerCase().replace(/\s+/g,'-');
      div.className = ['sorteo-item', estadoLower].filter(Boolean).join(' ');
      const header = document.createElement('div');
      header.className = 'sorteo-header';
      const tipoTexto = (s.tipo || '').toString().toLowerCase();
      let tipoEtiqueta = '';
      if(tipoTexto.includes('especial')) tipoEtiqueta = '<span class="tipo-tag especial">ESPECIAL</span>';
      else if(tipoTexto.includes('diario')) tipoEtiqueta = '<span class="tipo-tag diario">DIARIO</span>';
      const nombreMostrar = (s.nombre || 'Sorteo').toString();
      const estadoMostrar = (s.estado || '-').toString();
      header.innerHTML = `<span class="titulo">${idx+1}. ${nombreMostrar}${tipoEtiqueta ? ` ${tipoEtiqueta}` : ''}</span>`;
      div.appendChild(header);
      const detalle = document.createElement('div');
      detalle.className = 'sorteo-detalle';
      const fechaTexto = s.fecha ? `<span class="detalle-fecha">📅 ${formatearFecha(s.fecha)}</span>` : '';
      const cierreTexto = obtenerTextoHoraCierre(s);
      const cierreHtml = cierreTexto ? `<span class="cierre-hora">CIERRE: ${cierreTexto}</span>` : '';
      const horaBase = s.hora ? `⏰ ${formatearHora(s.hora)}` : '';
      let horaTexto = '';
      if(horaBase){
        horaTexto = `<span class="detalle-hora">${horaBase}${cierreHtml ? ` ${cierreHtml}` : ''}</span>`;
      } else if(cierreHtml){
        horaTexto = `<span class="detalle-hora">${cierreHtml}</span>`;
      }
      detalle.innerHTML = [fechaTexto, horaTexto].filter(Boolean).join(' ');
      div.appendChild(detalle);
      const extra = document.createElement('div');
      extra.className = 'sorteo-extra';
      const cantosRegistrados = Array.isArray(s.cantos) ? s.cantos.length : 0;
      const totalPremios = Number(s.totalPremios) || 0;
      const subtotalesHtml = generarSubtotalesFormas(s.formas, totalPremios);
      const cartonesPagos = formatearNumero(s.cartonesjugando || 0);
      const cartonesGratis = formatearNumero(s.cartonesgratisjugando || 0);
      const cantosTexto = formatearNumero(cantosRegistrados);
      extra.innerHTML = `
        <div class="extra-premio">
          <span class="extra-premio-main">Premio: <span class="valor-premio">${formatearNumero(totalPremios)}</span></span>
          ${subtotalesHtml ? `<span class="extra-premio-subtotales">${subtotalesHtml}</span>` : ''}
        </div>
        <div class="extra-cartones">
          Cartones: <span class="extra-cartones-pagos">${cartonesPagos}</span>
          <span class="extra-cartones-mas">+</span>
          <span class="extra-cartones-gratis">${cartonesGratis}</span>
        </div>
      `;
      div.appendChild(extra);
      const corner = document.createElement('div');
      corner.className = 'sorteo-corner-info';
      const cornerCantos = document.createElement('div');
      cornerCantos.className = 'corner-cantos';
      cornerCantos.innerHTML = `Cantos: <span class="corner-cantos-valor">${cantosTexto}</span>`;
      if(estadoLower === 'jugando'){
        cornerCantos.classList.add('jugando');
      }
      const cornerEstado = document.createElement('div');
      cornerEstado.className = ['corner-estado', estadoLower].filter(Boolean).join(' ');
      cornerEstado.textContent = estadoMostrar;
      corner.appendChild(cornerCantos);
      corner.appendChild(cornerEstado);
      div.appendChild(corner);
      div.addEventListener('click',()=>{
        seleccionarSorteo(s.id);
        document.getElementById('sorteos-modal').style.display = 'none';
      });
      cont.appendChild(div);
    });
    document.getElementById('sorteos-modal').style.display = 'flex';
  }

  function escucharSorteo(id){
    if(sorteoUnsub){ sorteoUnsub(); sorteoUnsub = null; }
    const ref = db.collection('sorteos').doc(id);
    sorteoUnsub = ref.onSnapshot(doc=>{
      if(!doc.exists){
        limpiarSorteoSeleccionado();
        currentSorteoData = null;
        mostrarDatos();
        detenerCantos();
        return;
      }
      const cantosPrevios = currentSorteoData?.cantos || sorteos.find(s=>s.id===doc.id)?.cantos || [];
      currentSorteoData = { id: doc.id, ...doc.data(), cantos: cantosPrevios };
      if(currentSorteoData){
        currentSorteoData.condicion = (currentSorteoData.condicion || currentSorteoData['condición'] || '').toString().trim().toUpperCase() || 'VISIBLE';
      }
      asegurarCampoPdf(doc.id, currentSorteoData);
      const idx = sorteos.findIndex(s=>s.id===doc.id);
      if(idx>=0){
        const cantosExistentes = sorteos[idx].cantos || [];
        sorteos[idx] = { ...sorteos[idx], ...doc.data(), cantos: cantosExistentes };
        sorteos[idx].condicion = (sorteos[idx].condicion || sorteos[idx]['condición'] || '').toString().trim().toUpperCase() || 'VISIBLE';
      }
      guardarSorteoSeleccionado(currentSorteoData);
      mostrarDatos();
    }, err=>console.error('Error escuchando sorteo', err));
  }

  function seleccionarSorteo(id){
    if(!id) return;
    currentSorteoId = id;
    restauracionPendiente = false;
    const encontrado = sorteos.find(s=>s.id===id);
    currentSorteoData = encontrado ? { ...encontrado } : null;
    if(currentSorteoData){
      currentSorteoData.condicion = (currentSorteoData.condicion || currentSorteoData['condición'] || '').toString().trim().toUpperCase() || 'VISIBLE';
      guardarSorteoSeleccionado(currentSorteoData);
      asegurarCampoPdf(currentSorteoId, currentSorteoData);
      actualizarCantosSeleccionados(currentSorteoData.cantos || []);
    }
    escucharSorteo(id);
    escucharCantos(id);
    mostrarDatos();
  }

  async function sellarSorteo(){
    if(!currentSorteoId || !currentSorteoData){ alert('Selecciona un sorteo primero.'); return; }
    const estadoActual = (currentSorteoData.estado || '').toString().toLowerCase();
    if(estadoActual === 'sellado'){ alert('El sorteo ya está sellado.'); return; }
    if(estadoActual === 'jugando' || estadoActual === 'finalizado'){
      alert('El sorteo ya se encuentra en una fase posterior.');
      return;
    }

    if(esModoManual()){
      const confirmarManual = confirm('¿Deseas sellar el sorteo seleccionado?');
      if(!confirmarManual) return;
      await ejecutarSellado({ confirmadoManual: true });
      return;
    }

    if(estadoActual !== 'activo'){
      alert('El sorteo debe estar en estado Activo para poder ser sellado.');
      return;
    }

    const fechaProgramada = obtenerFechaSorteo(currentSorteoData);
    const fechaCierreBase = obtenerFechaCierre(currentSorteoData);
    const fechaHoraCierreOriginal = obtenerFechaHoraCierre(currentSorteoData);
    const ahora = getServerNow() || new Date();
    const fechaProgramadaValida = fechaProgramada instanceof Date && !isNaN(fechaProgramada.getTime());
    const fechaCierreValida = fechaCierreBase instanceof Date && !isNaN(fechaCierreBase.getTime());
    let fechaHoraCierreNormalizada = fechaHoraCierreOriginal;
    if(fechaHoraCierreNormalizada instanceof Date && fechaProgramadaValida && fechaHoraCierreNormalizada.getTime() > fechaProgramada.getTime()){
      fechaHoraCierreNormalizada = new Date(fechaProgramada.getTime());
    }
    const fechaHoraCierreValida = fechaHoraCierreNormalizada instanceof Date && !isNaN(fechaHoraCierreNormalizada.getTime());

    if(fechaCierreValida){
      const comparacionCierre = compararFechasCalendario(ahora, fechaCierreBase);
      if(comparacionCierre === null){
        alert('No se pudo determinar la fecha actual para validar el cierre.');
        return;
      }
      if(comparacionCierre < 0){
        alert('Aún no es la fecha de cierre del sorteo, no puede ser Sellado');
        return;
      }
      if(fechaHoraCierreValida && ahora < fechaHoraCierreNormalizada){
        alert('Hoy es el día del sorteo pero aún no ha llegado la hora de cierre');
        return;
      }
      if(!fechaHoraCierreValida && comparacionCierre === 0 && fechaProgramadaValida && ahora < fechaProgramada){
        alert('Hoy es el día del sorteo pero aún no ha llegado la hora de cierre');
        return;
      }
    } else if(fechaProgramadaValida){
      const comparacionFecha = compararFechasCalendario(ahora, fechaProgramada);
      if(comparacionFecha === null){
        alert('No se pudo determinar la fecha actual para validar el cierre.');
        return;
      }
      if(comparacionFecha < 0){
        alert('Aún no es la fecha del sorteo, no puede ser Sellado');
        return;
      }
      if(ahora < fechaProgramada){
        alert('Hoy es el día del sorteo pero aún no ha llegado la hora de cierre');
        return;
      }
    } else {
      const confirmarSinFecha = confirm('No se pudo determinar la fecha programada del sorteo. ¿Deseas sellarlo de todos modos?');
      if(!confirmarSinFecha) return;
      await ejecutarSellado();
      return;
    }

    const confirmarSellado = confirm('¿Estas seguro de Sellar el sorteo?');
    if(!confirmarSellado) return;

    await ejecutarSellado();
  }

  async function ejecutarSellado(opciones = {}){
    if(esModoManual() && !opciones.confirmadoManual){
      const confirmar = confirm('¿Deseas sellar el sorteo seleccionado?');
      if(!confirmar) return false;
    }
    try {
      await db.collection('sorteos').doc(currentSorteoId).update({ estado: 'Sellado', pdf: 'no' });
      mensajeEl.textContent = 'El sorteo fue sellado correctamente.';
      sellarBtn.classList.remove('attention');
      return true;
    } catch (err) {
      console.error('Error sellando sorteo', err);
      alert('No fue posible sellar el sorteo.');
      return false;
    }
  }

  function mostrarPdfConfirmacion(){
    if(!pdfConfirmModal) return;
    pdfConfirmModal.classList.add('activo');
    const foco = pdfConfirmSiBtn || pdfConfirmNoBtn;
    if(foco){ foco.focus(); }
  }

  function cerrarPdfConfirmacion(){
    if(!pdfConfirmModal) return;
    pdfConfirmModal.classList.remove('activo');
  }

  async function marcarPdfGuardado(){
    if(!currentSorteoId || !currentSorteoData){
      cerrarPdfConfirmacion();
      pdfDestinoUrl = '';
      return;
    }
    if(pdfAccionEnCurso) return;
    pdfAccionEnCurso = true;
    cerrarPdfConfirmacion();
    try {
      await db.collection('sorteos').doc(currentSorteoId).update({ pdf: 'si' });
      currentSorteoData.pdf = 'si';
      const idx = sorteos.findIndex(s=>s.id===currentSorteoId);
      if(idx>=0) sorteos[idx].pdf = 'si';
      actualizarBotones();
      actualizarAnimaciones();
      mostrarDatos();
      mensajeEl.textContent = 'Se marcó el documento PDF como guardado.';
    } catch (err) {
      console.error('Error actualizando estado del PDF', err);
      alert('No fue posible actualizar el estado del PDF.');
    } finally {
      pdfAccionEnCurso = false;
      pdfDestinoUrl = '';
    }
  }

  function irAGenerarPdf(){
    const destino = pdfDestinoUrl;
    pdfDestinoUrl = '';
    cerrarPdfConfirmacion();
    if(destino){
      window.location.href = destino;
    }
  }

  async function abrirPDF(){
    if(!currentSorteoId || !currentSorteoData){ alert('Selecciona un sorteo primero.'); return; }
    const estadoActual = (currentSorteoData.estado || '').toString().toLowerCase();
    if(estadoActual !== 'sellado'){
      if(esModoManual()){
        alert('Para generar el archivo PDF de sellado el sorteo debe estar Sellado primero');
      } else {
        alert('Aún no has sellado el sorteo, no se puede generar el PDF');
      }
      return;
    }
    pdfDestinoUrl = `pdfsorteo.html?s=${currentSorteoId}`;
    mostrarPdfConfirmacion();
  }

  async function cambiarAJugando(){
    if(!currentSorteoId || !currentSorteoData){ alert('Selecciona un sorteo primero.'); return; }
    const estadoActual = (currentSorteoData.estado || '').toString().toLowerCase();
    if(estadoActual === 'jugando'){ alert('El sorteo ya está en estado Jugando.'); return; }
    if(estadoActual === 'finalizado'){ alert('El sorteo ya finalizó.'); return; }
    if(estadoActual !== 'sellado'){
      alert('El sorteo debe estar Sellado para iniciar el juego.');
      return;
    }
    const pdfEstado = (currentSorteoData.pdf || '').toString().toLowerCase();
    if(pdfEstado !== 'si'){
      if(esModoManual()){
        alert('Debes generar el PDF antes de iniciar el juego.');
      } else {
        alert('Aún no has generado el pdf de las jugadas, antes de cantar las jugadas debes generar, descargar y compartir el pdf de cierre de jugadas');
      }
      return;
    }

    if(esModoManual()){
      const confirmarManual = confirm('¿Deseas cambiar el estado del sorteo a "Jugando"?');
      if(!confirmarManual) return;
      await actualizarEstadoJugando({ confirmadoManual: true });
      return;
    }

    const fechaProgramada = obtenerFechaSorteo(currentSorteoData);
    if(!fechaProgramada || isNaN(fechaProgramada.getTime())){
      alert('No se pudo determinar la fecha y hora programada del sorteo.');
      return;
    }

    const ahora = getServerNow() || new Date();
    const comparacionFecha = compararFechasCalendario(ahora, fechaProgramada);
    if(comparacionFecha === null){
      alert('No se pudo determinar la fecha actual para validar el inicio.');
      return;
    }
    if(comparacionFecha < 0){
      alert('Aún no es la fecha del sorteo, no puedes iniciar el juego.');
      return;
    }
    if(comparacionFecha === 0 && ahora < fechaProgramada){
      alert('Aún no ha llegado la hora programada para iniciar el juego.');
      return;
    }

    const nombre = obtenerNombreSorteoActual();
    const confirmar = confirm(`¿Deseas iniciar el juego del sorteo: ${nombre}?`);
    if(!confirmar) return;

    await actualizarEstadoJugando();
  }

  async function actualizarEstadoJugando(opciones = {}){
    if(esModoManual() && !opciones.confirmadoManual){
      const confirmar = confirm('¿Deseas cambiar el estado del sorteo a "Jugando"?');
      if(!confirmar) return false;
    }
    try {
      await db.collection('sorteos').doc(currentSorteoId).update({ estado: 'Jugando' });
      mensajeEl.textContent = 'El sorteo cambió a estado Jugando.';
      jugarBtn.classList.remove('attention');
      return true;
    } catch (err) {
      console.error('Error cambiando a Jugando', err);
      alert('No fue posible cambiar el estado a Jugando.');
      return false;
    }
  }

  async function finalizarSorteo(){
    if(!currentSorteoId || !currentSorteoData){ alert('Selecciona un sorteo primero.'); return; }
    if((currentSorteoData.estado || '').toLowerCase() !== 'jugando'){
      alert('El sorteo debe estar en estado Jugando para finalizar.');
      return;
    }
    const nombre = obtenerNombreSorteoActual();
    const confirmar = confirm(`¿Estas seguro de Finalizar el sorteo: ${nombre}?`);
    if(!confirmar) return;
    try {
      await db.collection('sorteos').doc(currentSorteoId).update({ estado: 'Finalizado' });
      mensajeEl.textContent = 'El sorteo fue finalizado correctamente.';
      finalizarBtn.classList.remove('attention');
    } catch (err) {
      console.error('Error finalizando sorteo', err);
      alert('No fue posible finalizar el sorteo.');
    }
  }

  async function inicializar(){
    await cargarSorteos();
    if(!intentarRestaurarSorteo()){
      mostrarDatos();
    }
  }

  setInterval(actualizarAnimaciones, 15000);

  inicializar();
  </script>
</body>
</html>
