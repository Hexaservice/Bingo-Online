<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Sorteo</title>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: only light;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: #ffffff;
      margin: 0;
      padding: 60px 15px 40px;
      box-sizing: border-box;
      color: #1a1a1a;
    }
    #salir-btn {
      position: fixed;
      top: 10px;
      left: 10px;
      width: 120px;
      height: 40px;
      background: orange;
      border: 4px solid orange;
      border-radius: 10px;
      color: white;
      text-shadow: 2px 2px 4px #000;
      font-family: 'Bangers', cursive;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      z-index: 1001;
    }
    #salir-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(255,215,0,0.8); }
    #salir-btn:active { transform: scale(0.95); }
    #salir-btn .label { font-size: 1.1rem; }
    @media (orientation: portrait) {
      #salir-btn { width: 40px; }
      #salir-btn .label { display: none; }
    }
    #acciones-fixed {
      position: fixed;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 10px;
      z-index: 1001;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    #acciones-fixed button {
      padding: 10px 18px;
      font-family: 'Bangers', cursive;
      font-size: 1.1rem;
      border-radius: 12px;
      border: 4px solid #FFD700;
      color: #ffffff;
      text-shadow: 1px 1px 2px #000;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    #acciones-fixed button:hover { transform: scale(1.05); }
    #acciones-fixed button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    #generar-cartones-btn {
      background: linear-gradient(#005bb5, #33a0ff);
    }
    #generar-pdf-btn {
      background: linear-gradient(#008c3a, #66d17a);
      display: none;
    }
    #pdf-listo-btn {
      background: linear-gradient(#b85c00, #ffaf40);
      display: none;
    }
    #pdf-wrapper {
      max-width: 960px;
      margin: 0 auto;
      text-align: center;
    }
    #resumen-pdf {
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(230,244,255,0.85));
      border: 3px solid rgba(11,83,148,0.2);
      border-radius: 24px;
      padding: 30px 20px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.1);
      margin-bottom: 26px;
    }
    #resumen-header {
      display: flex;
      flex-wrap: nowrap;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
      text-align: left;
    }
    #resumen-header .header-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 auto;
    }
    #logo {
      width: 110px;
      display: block;
    }
    #resumen-header .header-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-start;
      flex: 1 1 220px;
    }
    #nombre-sorteo {
      font-family: 'Bangers', cursive;
      font-size: clamp(2rem, 4vw, 2.6rem);
      color: #0b5394;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    #tipo-sorteo-titulo {
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      color: #0b5394;
      margin: 2px 0 0;
      font-weight: 600;
      text-transform: capitalize;
      line-height: 1.3;
    }
    #datos-generales {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px 16px;
      justify-content: center;
      align-items: stretch;
      margin: 10px auto 20px;
      padding: 14px 18px;
      border-radius: 18px;
      background: rgba(255,255,255,0.9);
      box-shadow: inset 0 0 0 1px rgba(11,83,148,0.08);
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    .dato-inline {
      display: grid;
      grid-template-columns: auto 1fr;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
      color: #0b5394;
      text-align: left;
      padding: 6px 12px;
      border-radius: 12px;
      background: rgba(11,83,148,0.05);
    }
    .dato-inline .dato-label {
      font-family: 'Bangers', cursive;
      font-size: 1rem;
      letter-spacing: 0.5px;
    }
    .dato-inline .dato-valor {
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      color: #1a1a1a;
      justify-self: end;
      text-align: right;
    }
    #dato-fecha { color: #005bbb; }
    #dato-cierre { color: #c62828; }
    #dato-hora { color: #2e7d32; }
    #dato-valor { color: #c76a00; }
    #dato-maxgratis { color: #6a1b9a; }
    .totales-header {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 12px;
      margin: 20px 0 18px;
      justify-content: center;
    }
    .totales-header h2 {
      font-family: 'Bangers', cursive;
      font-size: clamp(1.6rem, 4.5vw, 2rem);
      color: #0b6623;
      margin: 0;
      letter-spacing: 0.5px;
    }
    #total-premios {
      font-size: clamp(1.8rem, 6vw, 2.6rem);
      font-weight: 700;
      color: #0b6623;
      text-shadow: 0 0 6px rgba(255,255,255,0.9);
    }
    #formas-resumen {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      width: 100%;
    }
    .forma-item {
      display: grid;
      grid-template-columns: minmax(0, 1fr) clamp(140px, 32vw, 260px);
      align-items: stretch;
      min-width: 0;
      width: 100%;
      border-radius: 20px;
      overflow: hidden;
      background: rgba(255,255,255,0.92);
      border: 2px solid rgba(0,0,0,0.05);
      box-shadow: 0 8px 18px rgba(0,0,0,0.06);
      gap: 0;
    }
    .forma-resumen {
      display: grid;
      gap: 8px;
      padding: 14px 16px;
      position: relative;
      min-width: 0;
      text-align: left;
      align-content: start;
      border-right: 2px solid rgba(0,0,0,0.05);
      background: rgba(255,255,255,0.85);
    }
    .forma-info {
      display: grid;
      gap: 8px;
      text-align: left;
      align-content: start;
      min-width: 0;
    }
    .forma-titulo {
      font-family: 'Bangers', cursive;
      font-size: 1.2rem;
      color: var(--forma-color, #0b5394);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      grid-column: 1 / -1;
    }
    .forma-detalle {
      font-size: 0.95rem;
      color: #0b1d0b;
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 4px 8px;
      align-items: center;
      background: rgba(11,83,148,0.04);
      padding: 8px 12px;
      border-radius: 10px;
    }
    .forma-detalle .etiqueta {
      font-weight: 600;
      color: #0b5394;
    }
    .forma-detalle .valor {
      font-weight: 700;
      color: #1a1a1a;
      font-size: 1.05rem;
      display: block;
      width: 100%;
      text-align: right;
    }
    .forma-mini-carton-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: clamp(6px, 1.8vw, 12px);
      background: #ffffff;
      height: 100%;
      align-self: stretch;
      min-width: 0;
      border-left: 2px solid rgba(0,0,0,0.05);
      width: 100%;
      max-width: clamp(160px, 34vw, 240px);
      box-sizing: border-box;
    }
    .forma-mini-carton {
      border-collapse: separate;
      border-spacing: 0;
      background: linear-gradient(160deg, rgba(255,255,255,0.95), var(--forma-color-super-suave, #f3f7ff));
      border-radius: 8px;
      overflow: hidden;
      width: 100%;
      height: auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
      position: relative;
      z-index: 1;
      aspect-ratio: 5 / 6;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-auto-rows: 1fr;
      max-width: 100%;
    }
    .forma-mini-carton thead,
    .forma-mini-carton tbody,
    .forma-mini-carton tr {
      display: contents;
    }
    .forma-mini-carton th,
    .forma-mini-carton td {
      border: 1px solid rgba(0,0,0,0.12);
      font-weight: 700;
      background: #ffffff;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      aspect-ratio: 1 / 1;
      font-size: clamp(0.45rem, 1.95vmin, 0.82rem);
      min-width: 0;
    }
    .forma-mini-carton th {
      font-size: clamp(0.6rem, 2.4vmin, 1rem);
      color: #ffffff;
      background: linear-gradient(135deg, var(--forma-color-intenso, #0b5394), var(--forma-color, #0b5394));
      text-shadow: 0 1px 2px rgba(0,0,0,0.6);
    }
    .forma-mini-carton td.star {
      background: linear-gradient(145deg, var(--forma-color-suave, #6fa8dc), rgba(255,255,255,0.9));
    }
    .forma-mini-carton td.star .forma-estrella {
      color: var(--forma-color-intenso, #0b5394);
    }
    .forma-mini-carton td.free {
      background: linear-gradient(135deg, #ffb347, #ff7b00);
    }
    .forma-mini-carton td.free .forma-estrella {
      color: #ffffff;
    }
    .forma-mini-carton .forma-estrella {
      font-size: clamp(0.65rem, 2.8vmin, 1.15rem);
      text-shadow: 0 0 4px rgba(0,0,0,0.12);
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }
    #cartones-section {
      margin-top: 32px;
      text-align: left;
    }
    #cartones-section h2 {
      font-family: 'Bangers', cursive;
      font-size: 1.8rem;
      color: #0b5394;
      margin-bottom: 14px;
      text-align: center;
    }
    #cartones-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      justify-items: center;
      align-items: flex-start;
      width: 100%;
    }
    .pdf-carton {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
      justify-content: flex-start;
      background: transparent;
      border-radius: 12px;
      padding: 6px;
      box-shadow: none;
      border: none;
      page-break-inside: avoid;
      width: 100%;
      max-width: 220px;
    }
    .pdf-carton.gratis .pdf-carton-table {
      box-shadow: 0 0 0 2px rgba(0,76,153,0.25);
    }
    .pdf-carton-table {
      --cell-size: clamp(26px, 4.6vw, 36px);
      border-collapse: separate;
      border-spacing: 0;
      width: calc(var(--cell-size) * 5);
      margin: 0 auto;
      background: linear-gradient(#ffffff,#e8e8e8);
      border-radius: 12px;
      overflow: hidden;
      table-layout: fixed;
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }
    .pdf-carton-table th,
    .pdf-carton-table td {
      border: 2px solid rgba(128,128,128,0.65);
      width: var(--cell-size);
      height: var(--cell-size);
      aspect-ratio: 1 / 1;
      font-weight: 700;
      color: #1a1a1a;
      padding: 0;
      text-align: center;
      vertical-align: middle;
      line-height: var(--cell-size);
    }
    .pdf-carton-table th {
      font-size: calc(var(--cell-size) * 0.75);
    }
    .pdf-carton-table td {
      font-size: calc(var(--cell-size) * 0.48);
    }
    .pdf-carton-table th {
      font-size: 1.6rem;
      color: #ff6600;
      background: radial-gradient(circle,#ffffff,#ffffff 60%,rgba(0,170,0,0.75));
      text-shadow: 2px 2px 0 #000;
    }
    .pdf-carton-table td.free {
      background: radial-gradient(circle,#ffbd4f,#ffe8b3);
      font-size: calc(var(--cell-size) * 0.65);
      color: #ffffff;
    }
    .pdf-carton-datos {
      display: flex;
      flex-direction: column;
      gap: 4px;
      text-align: center;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      word-break: break-word;
    }
    .pdf-carton-datos .numero {
      font-size: 1.05rem;
      color: #0b5394;
    }
    .pdf-carton-datos .alias {
      font-size: 0.95rem;
      color: #004488;
    }
    .pdf-carton-datos .tipo {
      font-size: 0.85rem;
      color: #0b6623;
      text-transform: uppercase;
    }
    .cartones-placeholder {
      grid-column: 1 / -1;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      color: #1a1a1a;
      text-align: center;
      padding: 20px 10px;
      background: rgba(255,255,255,0.9);
      border-radius: 16px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.06);
    }
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-family: 'Bangers', cursive;
      font-size: 1.4rem;
      gap: 12px;
      z-index: 1200;
      text-align: center;
      padding: 20px;
      box-sizing: border-box;
    }
    #loading-overlay.activo { display: flex; }
    .spinner {
      width: 50px;
      height: 50px;
      border: 6px solid rgba(255,255,255,0.3);
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @media (max-width: 720px) {
      body { padding: 70px 10px 30px; }
      #resumen-pdf { padding: 22px 14px; }
      #acciones-fixed { right: 6px; }
      #acciones-fixed button { padding: 8px 14px; font-size: 1rem; }
      #resumen-header { gap: 12px; }
      #resumen-header .header-logo { justify-content: flex-start; }
      #resumen-header .header-info { align-items: flex-start; }
    }
    @media (max-width: 520px) {
      #resumen-header { flex-wrap: wrap; }
    }
    @media (max-width: 640px) {
      #cartones-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
      .pdf-carton { width: 100%; }
    }
    @media (orientation: landscape) and (max-width: 900px) {
      #cartones-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
      .pdf-carton-table { --cell-size: clamp(20px, 3.2vw, 28px); }
      #cartones-grid { gap: 12px; }
      .pdf-carton { max-width: 190px; }
    }
    @media (max-width: 480px) {
      #datos-generales { grid-template-columns: 1fr; }
    }
    @media (max-width: 720px) {
      .forma-item {
        grid-template-columns: minmax(0, 1fr) clamp(150px, 36vw, 220px);
      }
      .forma-resumen {
        padding: 12px;
      }
      .forma-titulo {
        font-size: 1.05rem;
      }
      .forma-detalle {
        font-size: 0.88rem;
        padding: 6px 10px;
      }
      .forma-detalle .valor {
        font-size: 0.95rem;
      }
      .forma-mini-carton-wrapper {
        max-width: clamp(150px, 42vw, 220px);
      }
    }
    @media (orientation: landscape) and (min-width: 700px) {
      #formas-resumen {
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      }
      .forma-item {
        grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
      }
      .forma-mini-carton-wrapper {
        max-width: none;
        align-items: stretch;
      }
    }
    @media (max-width: 640px) {
      .forma-item {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        align-items: stretch;
      }
      .forma-resumen {
        border-right: none;
        border-bottom: none;
        padding: clamp(10px, 3.5vw, 14px);
      }
      .forma-mini-carton-wrapper {
        border-left: 1px solid rgba(0,0,0,0.05);
        padding: clamp(6px, 3vw, 12px);
        max-width: clamp(140px, 50vw, 200px);
      }
    }
    @media (max-width: 520px) {
      #formas-resumen {
        grid-template-columns: 1fr;
      }
      .forma-resumen {
        padding: 10px;
        gap: 6px;
      }
      .forma-titulo {
        font-size: 0.98rem;
      }
      .forma-detalle {
        font-size: 0.82rem;
        padding: 6px 8px;
      }
      .forma-detalle .valor {
        font-size: 0.9rem;
      }
      .forma-mini-carton-wrapper {
        max-width: clamp(140px, 50vw, 200px);
      }
    }
    body.pdf-captura #formas-resumen {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 12px;
    }
    body.pdf-captura #formas-resumen .forma-item {
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text">Preparando información del sorteo, por favor espera</div>
  </div>
  <button id="salir-btn"><span class="tri">&#9664;</span><span class="label">Salir</span></button>
  <div id="acciones-fixed">
    <button id="generar-cartones-btn">Generar cartones</button>
    <button id="generar-pdf-btn">Generar PDF</button>
    <button id="pdf-listo-btn">PDF listo</button>
  </div>
  <div id="pdf-wrapper">
    <section id="resumen-pdf">
      <div id="resumen-header">
        <div class="header-logo">
          <img id="logo" src="https://i.imgur.com/twjhNtZ.png" alt="Bingo Online">
        </div>
        <div class="header-info">
          <h1 id="nombre-sorteo">Sorteo</h1>
          <div id="tipo-sorteo-titulo"></div>
        </div>
      </div>
      <div id="datos-generales">
        <div class="dato-inline"><span class="dato-label">Tipo de sorteo:</span><span id="dato-tipo" class="dato-valor">-</span></div>
        <div class="dato-inline"><span class="dato-label">Fecha del sorteo:</span><span id="dato-fecha" class="dato-valor">-</span></div>
        <div class="dato-inline"><span class="dato-label">Hora de cierre:</span><span id="dato-cierre" class="dato-valor">-</span></div>
        <div class="dato-inline"><span class="dato-label">Hora del sorteo:</span><span id="dato-hora" class="dato-valor">-</span></div>
        <div class="dato-inline"><span class="dato-label">Valor del cartón:</span><span id="dato-valor" class="dato-valor">-</span></div>
        <div class="dato-inline"><span class="dato-label">CARTONES GRATIS MÁXIMOS POR JUGADOR:</span><span id="dato-maxgratis" class="dato-valor">-</span></div>
      </div>
      <div class="totales-header">
        <h2>CRÉDITOS TOTALES A REPARTIR</h2>
        <div id="total-premios">0</div>
      </div>
      <div id="formas-resumen"></div>
    </section>
    <section id="cartones-section">
      <h2>Cartones del sorteo</h2>
      <div id="cartones-grid"></div>
    </section>
  </div>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="js/auth.js"></script>
  <script>
  ensureAuth('Administrador');

  const params = new URLSearchParams(window.location.search);
  const sorteoId = params.get('s');
  if(!sorteoId){
    alert('No se indicó un sorteo.');
    window.location.href = 'cantarsorteos.html';
  }

  const salirBtn = document.getElementById('salir-btn');
  const generarCartonesBtn = document.getElementById('generar-cartones-btn');
  const pdfBtn = document.getElementById('generar-pdf-btn');
  const pdfListoBtn = document.getElementById('pdf-listo-btn');
  const loadingOverlay = document.getElementById('loading-overlay');
  const loadingText = document.getElementById('loading-text');
  const nombreEl = document.getElementById('nombre-sorteo');
  const tipoTituloEl = document.getElementById('tipo-sorteo-titulo');
  const datoFechaEl = document.getElementById('dato-fecha');
  const datoHoraEl = document.getElementById('dato-hora');
  const datoCierreEl = document.getElementById('dato-cierre');
  const datoValorEl = document.getElementById('dato-valor');
  const datoMaxGratisEl = document.getElementById('dato-maxgratis');
  const datoTipoEl = document.getElementById('dato-tipo');
  const totalPremiosEl = document.getElementById('total-premios');
  const formasCont = document.getElementById('formas-resumen');
  const cartonesGrid = document.getElementById('cartones-grid');

  let sorteoData = null;
  let formasData = [];
  let cartonesData = [];
  let pdfNombreBase = 'pdf-sorteo';
  let cartonesCargados = false;
  let firebaseReadyPromise = null;

  function ensureFirebaseReady(){
    if(firebaseReadyPromise) return firebaseReadyPromise;
    if(typeof initFirebase !== 'function'){
      firebaseReadyPromise = Promise.reject(new Error('initFirebase no disponible'));
      return firebaseReadyPromise;
    }
    firebaseReadyPromise = initFirebase().catch(err => {
      console.error('Fallo al inicializar Firebase', err);
      throw err;
    });
    return firebaseReadyPromise;
  }

  const coloresFormas = ['#006400', '#b8860b', '#00008b', '#4b0082', '#8b4513', '#d2691e'];

  function normalizarHex(hex){
    if(typeof hex !== 'string') return hex;
    let limpio = hex.replace('#','');
    if(limpio.length === 3){
      limpio = limpio.split('').map(ch=>ch+ch).join('');
    }
    if(limpio.length !== 6) return null;
    return limpio;
  }

  function aclararColorHex(hex, factor = 0.55){
    const limpio = normalizarHex(hex);
    if(!limpio) return hex;
    const r = parseInt(limpio.slice(0,2), 16);
    const g = parseInt(limpio.slice(2,4), 16);
    const b = parseInt(limpio.slice(4,6), 16);
    const mezcla = (canal)=>{
      if(Number.isNaN(canal)) return canal;
      return Math.round(canal + (255 - canal) * factor);
    };
    const nr = mezcla(r);
    const ng = mezcla(g);
    const nb = mezcla(b);
    const hexCanal = (val)=>{
      if(!Number.isFinite(val)) return 'ff';
      return Math.min(255, Math.max(0, val)).toString(16).padStart(2,'0');
    };
    return `#${hexCanal(nr)}${hexCanal(ng)}${hexCanal(nb)}`;
  }

  function oscurecerColorHex(hex, factor = 0.35){
    const limpio = normalizarHex(hex);
    if(!limpio) return hex;
    const clampFactor = Math.min(Math.max(factor, 0), 1);
    const r = parseInt(limpio.slice(0,2), 16);
    const g = parseInt(limpio.slice(2,4), 16);
    const b = parseInt(limpio.slice(4,6), 16);
    const mezcla = (canal)=>{
      if(Number.isNaN(canal)) return canal;
      return Math.round(canal * (1 - clampFactor));
    };
    const hexCanal = (val)=>{
      if(!Number.isFinite(val)) return '00';
      return Math.min(255, Math.max(0, val)).toString(16).padStart(2,'0');
    };
    return `#${hexCanal(mezcla(r))}${hexCanal(mezcla(g))}${hexCanal(mezcla(b))}`;
  }

  salirBtn.addEventListener('click', ()=>{ window.location.href = 'cantarsorteos.html'; });
  if(generarCartonesBtn){ generarCartonesBtn.disabled = true; }
  if(generarCartonesBtn){ generarCartonesBtn.addEventListener('click', manejarGenerarCartones); }
  if(pdfBtn){ pdfBtn.addEventListener('click', generarPDF); }
  if(pdfListoBtn){ pdfListoBtn.addEventListener('click', confirmarPdfListo); }

  function mostrarLoading(mensaje){
    if(loadingText && mensaje){ loadingText.textContent = mensaje; }
    if(loadingOverlay){ loadingOverlay.classList.add('activo'); }
  }

  function ocultarLoading(){
    if(loadingOverlay){ loadingOverlay.classList.remove('activo'); }
  }

  function mostrarMensajeCartonesPendientes(){
    if(!cartonesGrid) return;
    cartonesGrid.innerHTML = '<div class="cartones-placeholder">Haz clic en "Generar cartones" para cargar los cartones del sorteo.</div>';
  }

  function formatearFechaParaMostrar(fecha){
    if(!fecha) return '-';
    const partes = fecha.includes('-') ? fecha.split('-') : fecha.split('/');
    if(partes.length === 3){
      const [anio, mes, dia] = partes[0].length === 4 ? partes : [partes[2], partes[1], partes[0]];
      return `${dia.padStart(2,'0')}/${mes.padStart(2,'0')}/${anio}`;
    }
    return fecha;
  }

  function formatearHoraParaMostrar(hora){
    if(!hora) return '-';
    const [hh = '00', mm = '00'] = hora.split(':');
    let h = parseInt(hh, 10);
    if(Number.isNaN(h)) h = 0;
    const sufijo = h >= 12 ? 'PM' : 'AM';
    h = h % 12 || 12;
    return `${h.toString().padStart(2,'0')}:${mm.padStart(2,'0')} ${sufijo}`;
  }

  function formatearNumero(valor){
    const numero = Number(valor);
    if(!Number.isFinite(numero)) return '0';
    return new Intl.NumberFormat('es-ES').format(numero);
  }

  function normalizarTextoArchivo(texto){
    if(!texto) return 'sorteo';
    const sinTildes = texto.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    return sinTildes.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'') || 'sorteo';
  }

  function formatearFechaArchivo(fecha){
    if(!fecha) return '00-00-0000';
    const partes = fecha.split('-');
    if(partes.length===3){
      const [anio, mes, dia] = partes;
      return `${dia.padStart(2,'0')}-${mes.padStart(2,'0')}-${anio}`;
    }
    const partesSlash = fecha.split('/');
    if(partesSlash.length===3){
      const [dia, mes, anio] = partesSlash;
      return `${dia.padStart(2,'0')}-${mes.padStart(2,'0')}-${anio}`;
    }
    return fecha.replace(/\//g,'-');
  }

  function construirNombreBaseArchivo(){
    if(!sorteoData) return 'pdf-sorteo';
    const nombre = normalizarTextoArchivo(sorteoData.nombre);
    const fecha = formatearFechaArchivo(sorteoData.fecha || '');
    return `${nombre}_${fecha}`;
  }

  function obtenerHoraGeneracionArchivo(fecha = new Date()){
    if(!(fecha instanceof Date) || Number.isNaN(fecha.getTime())){
      return '00-00-00-am';
    }
    const horas = fecha.getHours();
    const sufijo = horas >= 12 ? 'pm' : 'am';
    const hora12 = horas % 12 || 12;
    const minutos = fecha.getMinutes();
    const segundos = fecha.getSeconds();
    return `${hora12.toString().padStart(2,'0')}-${minutos.toString().padStart(2,'0')}-${segundos.toString().padStart(2,'0')}-${sufijo}`;
  }

  function construirNombreArchivo(){
    const base = pdfNombreBase || construirNombreBaseArchivo();
    return `${base}_${obtenerHoraGeneracionArchivo()}`;
  }

  function crearMiniCartonForma(forma){
    const posiciones = Array.isArray(forma.posiciones) ? forma.posiciones : [];
    const wrapper = document.createElement('div');
    wrapper.className = 'forma-mini-carton-wrapper';
    const color = obtenerColorForma(forma.idx || 1);
    const colorSuave = aclararColorHex(color, 0.65);
    const colorMuySuave = aclararColorHex(color, 0.82);
    const colorIntenso = oscurecerColorHex(color, 0.2);
    wrapper.style.setProperty('--forma-color', color);
    if(colorSuave){ wrapper.style.setProperty('--forma-color-suave', colorSuave); }
    if(colorMuySuave){ wrapper.style.setProperty('--forma-color-super-suave', colorMuySuave); }
    if(colorIntenso){ wrapper.style.setProperty('--forma-color-intenso', colorIntenso); }

    const table = document.createElement('table');
    table.className = 'forma-mini-carton';
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    ['B','I','N','G','O'].forEach(l=>{
      const th = document.createElement('th');
      th.textContent = l;
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    table.appendChild(thead);
    const tbody = document.createElement('tbody');
    for(let r=0; r<5; r++){
      const tr = document.createElement('tr');
      for(let c=0; c<5; c++){
        const td = document.createElement('td');
        if(r===2 && c===2){
          td.classList.add('free','star');
          td.innerHTML = '<span class="forma-estrella">★</span>';
        }else{
          const seleccionada = posiciones.some(p=>Number(p.r)===r && Number(p.c)===c);
          if(seleccionada){
            td.classList.add('star');
            td.innerHTML = '<span class="forma-estrella">★</span>';
            td.style.backgroundColor = aclararColorHex(color, 0.7);
          }
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    wrapper.appendChild(table);
    return wrapper;
  }

  function obtenerColorForma(idx){
    if(!idx) return '#0b5394';
    const posicion = (idx - 1) % coloresFormas.length;
    return coloresFormas[posicion] || '#0b5394';
  }

  function construirMapaPosiciones(posiciones){
    const mapa = new Map();
    if(!Array.isArray(posiciones)) return mapa;
    posiciones.forEach(p=>{
      const fila = Number(p.r);
      const col = Number(p.c);
      if(!Number.isFinite(fila) || !Number.isFinite(col)) return;
      const key = `${fila}-${col}`;
      if(typeof p.valor === 'string' || typeof p.valor === 'number'){
        mapa.set(key, p.valor);
      }
    });
    return mapa;
  }

  function crearCartonVisual(data){
    const carton = document.createElement('div');
    carton.className = 'pdf-carton';
    if((data.tipocarton || '').toLowerCase() === 'gratis'){
      carton.classList.add('gratis');
    }

    const tabla = document.createElement('table');
    tabla.className = 'pdf-carton-table';
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    ['B','I','N','G','O'].forEach(l=>{
      const th = document.createElement('th');
      th.textContent = l;
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    tabla.appendChild(thead);

    const mapa = construirMapaPosiciones(data.posiciones);
    const tbody = document.createElement('tbody');
    for(let r=0; r<5; r++){
      const tr = document.createElement('tr');
      for(let c=0; c<5; c++){
        const td = document.createElement('td');
        if(r===2 && c===2){
          td.classList.add('free');
          td.textContent = '★';
        }else{
          const key = `${r}-${c}`;
          const valor = mapa.get(key) || '';
          td.textContent = valor;
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    tabla.appendChild(tbody);
    carton.appendChild(tabla);

    const infoInferior = document.createElement('div');
    infoInferior.className = 'pdf-carton-datos';
    const numero = document.createElement('div');
    const numeroValor = Number(data.cartonNum ?? data.Ncarton);
    const numeroTexto = Number.isFinite(numeroValor) ? String(numeroValor).padStart(4,'0') : (data.Ncarton || data.cartonNum || '-');
    carton.dataset.numero = Number.isFinite(numeroValor) ? numeroValor : 0;
    numero.className = 'numero';
    numero.textContent = `Cartón ${numeroTexto}`;
    infoInferior.appendChild(numero);

    const alias = document.createElement('div');
    alias.className = 'alias';
    alias.textContent = data.alias ? `Alias: ${data.alias}` : 'Alias: -';
    infoInferior.appendChild(alias);

    const tipo = document.createElement('div');
    tipo.className = 'tipo';
    tipo.textContent = (data.tipocarton || 'pagado').toUpperCase();
    infoInferior.appendChild(tipo);

    carton.appendChild(infoInferior);
    return carton;
  }

  function renderFormas(){
    formasCont.innerHTML = '';
    if(!formasData.length){
      formasCont.innerHTML = '<div class="cartones-placeholder">No se registraron formas para este sorteo.</div>';
      return;
    }
    const total = Number(sorteoData.totalPremios || 0);
    formasData.sort((a,b)=>{
      const idxA = Number(a.idx) || 0;
      const idxB = Number(b.idx) || 0;
      return idxA - idxB;
    });
    formasData.forEach(forma=>{
      const color = obtenerColorForma(forma.idx || 1);
      const item = document.createElement('div');
      item.className = 'forma-item';

      const contenedor = document.createElement('div');
      contenedor.className = 'forma-resumen';
      contenedor.style.setProperty('--forma-color', color);

      const info = document.createElement('div');
      info.className = 'forma-info';
      const titulo = document.createElement('div');
      titulo.className = 'forma-titulo';
      titulo.textContent = `Forma ${forma.idx || ''}: ${forma.nombre || ''}`;
      info.appendChild(titulo);

      const porcentaje = parseFloat(forma.porcentaje || 0) || 0;
      const premioForma = porcentaje > 0 ? Math.round(total * (porcentaje / 100)) : 0;
      info.appendChild(crearDetalleForma('Premio', porcentaje > 0
        ? `${formatearNumero(premioForma)} créditos`
        : '-'));

      info.appendChild(crearDetalleForma('Cartones gratis', formatearNumero(forma.cartonesGratis || 0)));

      contenedor.appendChild(info);

      const miniCarton = crearMiniCartonForma(forma);

      item.appendChild(contenedor);
      item.appendChild(miniCarton);
      formasCont.appendChild(item);
    });
  }

  function crearDetalleForma(etiqueta, valor){
    const cont = document.createElement('div');
    cont.className = 'forma-detalle';
    const spanEtiqueta = document.createElement('span');
    spanEtiqueta.className = 'etiqueta';
    spanEtiqueta.textContent = `${etiqueta}:`;
    const spanValor = document.createElement('span');
    spanValor.className = 'valor';
    spanValor.textContent = valor;
    cont.appendChild(spanEtiqueta);
    cont.appendChild(spanValor);
    return cont;
  }

  function renderCartones(){
    cartonesGrid.innerHTML = '';
    pdfListoBtn.style.display = 'none';
    if(!cartonesData.length){
      cartonesGrid.innerHTML = '<div class="cartones-placeholder">No se encontraron cartones generados para este sorteo.</div>';
      return;
    }
    cartonesData.sort((a,b)=>{
      const numA = Number(a.cartonNum ?? a.Ncarton) || 0;
      const numB = Number(b.cartonNum ?? b.Ncarton) || 0;
      return numA - numB;
    });
    const fragment = document.createDocumentFragment();
    cartonesData.forEach(data=>{
      fragment.appendChild(crearCartonVisual(data));
    });
    cartonesGrid.appendChild(fragment);
  }

  async function cargarDatosBasicos(){
    mostrarLoading('Cargando información del sorteo, por favor espera');
    try {
      await ensureFirebaseReady();
      const sorteoDoc = await db.collection('sorteos').doc(sorteoId).get();
      if(!sorteoDoc.exists){
        alert('No se encontró el sorteo.');
        window.location.href = 'cantarsorteos.html';
        return;
      }
      sorteoData = sorteoDoc.data();
      nombreEl.textContent = sorteoData.nombre || 'Sorteo';
      tipoTituloEl.textContent = sorteoData.tipo ? sorteoData.tipo : '';
      datoFechaEl.textContent = formatearFechaParaMostrar(sorteoData.fecha || '');
      datoHoraEl.textContent = formatearHoraParaMostrar(sorteoData.hora || '');
      datoCierreEl.textContent = formatearHoraParaMostrar(sorteoData.horacierre || '');
      datoValorEl.textContent = `${formatearNumero(sorteoData.valorCarton || 0)} créditos`;
      datoMaxGratisEl.textContent = formatearNumero(sorteoData.maxcartongratis || 0);
      datoTipoEl.textContent = sorteoData.tipo || '-';
      totalPremiosEl.textContent = formatearNumero(sorteoData.totalPremios || 0);
      pdfNombreBase = construirNombreBaseArchivo();

      const formasSnap = await db.collection('formas').where('sorteoId','==',sorteoId).get();
      formasData = [];
      formasSnap.forEach(doc=>formasData.push(doc.data()));
      renderFormas();
      mostrarMensajeCartonesPendientes();
      if(generarCartonesBtn){ generarCartonesBtn.disabled = false; }
    } catch (err) {
      console.error('Error cargando datos', err);
      alert('Ocurrió un error cargando la información del sorteo.');
      window.location.href = 'cantarsorteos.html';
    } finally {
      ocultarLoading();
    }
  }

  async function cargarCartones(){
    mostrarLoading('Generando cartones del sorteo, por favor espera');
    try {
      await ensureFirebaseReady();
      const cartonesSnap = await db.collection('CartonJugado').where('sorteoId','==',sorteoId).get();
      cartonesData = [];
    cartonesSnap.forEach(doc=>cartonesData.push(doc.data()));
    renderCartones();
    cartonesCargados = cartonesData.length > 0;
    if(pdfBtn){
      pdfBtn.style.display = cartonesCargados ? 'block' : 'none';
      pdfBtn.disabled = !cartonesCargados;
    }
    if(generarCartonesBtn){ generarCartonesBtn.textContent = 'Regenerar cartones'; }
    } catch (err) {
      cartonesCargados = false;
      console.error('Error cargando cartones', err);
      alert('Ocurrió un error al generar los cartones del sorteo.');
      mostrarMensajeCartonesPendientes();
      if(pdfBtn){ pdfBtn.style.display = 'none'; }
    } finally {
      ocultarLoading();
    }
  }

  async function manejarGenerarCartones(){
    if(!sorteoData){ alert('La información del sorteo aún no está disponible.'); return; }
    if(!generarCartonesBtn || generarCartonesBtn.disabled) return;
    generarCartonesBtn.disabled = true;
    await cargarCartones();
    generarCartonesBtn.disabled = false;
  }

  async function generarPDF(){
    if(!sorteoData){ return; }
    if(!cartonesCargados){ alert('Primero debes generar los cartones del sorteo.'); return; }
    const jsPDFLib = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
    if(!window.html2canvas || !jsPDFLib){
      alert('Dependencias para generar PDF no disponibles');
      return;
    }
    if(pdfListoBtn){
      pdfListoBtn.style.display = 'none';
    }
    const nombreArchivo = `${construirNombreArchivo()}.pdf`;
    const resumen = document.getElementById('resumen-pdf');
    if(!resumen){
      alert('No se encontró el contenido del sorteo para generar el PDF.');
      return;
    }

    const textoOriginalPdf = pdfBtn ? pdfBtn.textContent : '';
    const textoOriginalCartones = generarCartonesBtn ? generarCartonesBtn.textContent : '';

    try {
      await ensureFirebaseReady();
      if(generarCartonesBtn){ generarCartonesBtn.disabled = true; }
      if(pdfBtn){
        pdfBtn.disabled = true;
        pdfBtn.textContent = 'Generando PDF...';
      }
      mostrarLoading('Generando PDF para descargar, por favor espera');

      document.body.classList.add('pdf-captura');
      await new Promise(resolve=>requestAnimationFrame(()=>resolve()));

      const pdf = new jsPDFLib('p', 'pt', 'a4');
      if(typeof pdf.setCompression === 'function'){
        pdf.setCompression(true);
      }
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const marginX = 24;
      const marginY = 24;

      const canvasScale = Math.min(1.8, Math.max(1.4, window.devicePixelRatio || 1.5));
      const canvasOptions = {
        scale: canvasScale,
        useCORS: true,
        logging: false,
        backgroundColor: '#ffffff'
      };

      const resumenCanvas = await window.html2canvas(resumen, canvasOptions);
      const resumenRatio = Math.min(
        (pageWidth - marginX * 2) / resumenCanvas.width,
        (pageHeight - marginY * 2) / resumenCanvas.height
      );
      const resumenWidth = resumenCanvas.width * resumenRatio;
      const resumenHeight = resumenCanvas.height * resumenRatio;
      const resumenX = (pageWidth - resumenWidth) / 2;
      const resumenY = (pageHeight - resumenHeight) / 2;
      pdf.addImage(resumenCanvas.toDataURL('image/jpeg', 0.85), 'JPEG', resumenX, resumenY, resumenWidth, resumenHeight);

      const cartonElements = Array.from(document.querySelectorAll('.pdf-carton'))
        .sort((a,b)=>{
          const numA = Number(a.dataset.numero || 0);
          const numB = Number(b.dataset.numero || 0);
          return numA - numB;
        });
      if(cartonElements.length){
        let paginaIniciada = false;
        let columna = 0;
        let cursorY = marginY;
        let alturaFila = 0;
        const espacioHorizontal = 12;
        const espacioVertical = 14;
        const anchoUtil = pageWidth - marginX * 2;
        const muestra = cartonElements[0];
        const anchoVisual = muestra ? Math.max(muestra.getBoundingClientRect().width, 200) : 220;
        const anchoReferencia = Math.max(200, Math.min(260, anchoVisual));
        const columnasMax = Math.max(2, Math.floor((anchoUtil + espacioHorizontal) / (anchoReferencia + espacioHorizontal)));
        const anchoColumna = (anchoUtil - espacioHorizontal * (columnasMax - 1)) / columnasMax;
        const limiteY = pageHeight - marginY;

        for(const elemento of cartonElements){
          const canvas = await window.html2canvas(elemento, { ...canvasOptions });

          const escala = anchoColumna / canvas.width;
          const renderWidth = anchoColumna;
          const renderHeight = canvas.height * escala;

          if(!paginaIniciada){
            pdf.addPage();
            paginaIniciada = true;
          }

          if(columna >= columnasMax){
            columna = 0;
            cursorY += alturaFila + espacioVertical;
            alturaFila = 0;
          }

          if(cursorY + renderHeight > limiteY){
            pdf.addPage();
            columna = 0;
            cursorY = marginY;
            alturaFila = 0;
          }

          const posX = marginX + columna * (anchoColumna + espacioHorizontal);
          pdf.addImage(canvas.toDataURL('image/jpeg', 0.82), 'JPEG', posX, cursorY, renderWidth, renderHeight);
          alturaFila = Math.max(alturaFila, renderHeight);
          columna++;
        }
      }

      pdf.save(nombreArchivo);
      if(pdfListoBtn){ pdfListoBtn.style.display = 'block'; pdfListoBtn.disabled = false; }
      alert('El PDF del sorteo ha sido generado. Descárgalo y luego confirma con "PDF listo".');
    } catch (err) {
      console.error('Error generando el PDF', err);
      alert('No se pudo generar el PDF del sorteo. Intenta nuevamente.');
    } finally {
      document.body.classList.remove('pdf-captura');
      if(pdfBtn){
        pdfBtn.disabled = false;
        pdfBtn.textContent = textoOriginalPdf || 'Generar PDF';
      }
      if(generarCartonesBtn){
        generarCartonesBtn.disabled = false;
        generarCartonesBtn.textContent = textoOriginalCartones || generarCartonesBtn.textContent;
      }
      ocultarLoading();
    }
  }

  async function confirmarPdfListo(){
    if(!sorteoId){ return; }
    const confirmar = await window.confirm('¿Confirmas que el PDF fue descargado correctamente?');
    if(!confirmar) return;
    try {
      await ensureFirebaseReady();
      if(pdfListoBtn){ pdfListoBtn.disabled = true; }
      mostrarLoading('Actualizando el estado del PDF, por favor espera');
      const timestamp = firebase.firestore.FieldValue.serverTimestamp();
      const eliminar = firebase.firestore.FieldValue.delete();
      const payload = {
        pdf: 'si',
        pdfActualizadoEn: timestamp,
        pdfUrl: eliminar,
        pdfStoragePath: eliminar
      };
      await Promise.all([
        db.collection('sorteos').doc(sorteoId).set(payload, { merge: true }),
        db.collection('cantarsorteos').doc(sorteoId).set(payload, { merge: true })
      ]);
      alert('El sorteo se marcó como PDF listo.');
      window.location.href = 'cantarsorteos.html';
    } catch (err) {
      console.error('Error actualizando el estado del PDF', err);
      alert('No se pudo actualizar el estado del PDF. Intenta nuevamente.');
      if(pdfListoBtn){ pdfListoBtn.disabled = false; }
    } finally {
      ocultarLoading();
    }
  }

  cargarDatosBasicos();
  </script>
</body>
</html>
