<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Sorteo</title>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #ffffff;
      margin: 0;
      padding: 60px 15px 40px;
      box-sizing: border-box;
      color: #1a1a1a;
    }
    #salir-btn {
      position: fixed;
      top: 10px;
      left: 10px;
      width: 120px;
      height: 40px;
      background: orange;
      border: 4px solid orange;
      border-radius: 10px;
      color: white;
      text-shadow: 2px 2px 4px #000;
      font-family: 'Bangers', cursive;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      z-index: 1001;
    }
    #salir-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(255,215,0,0.8); }
    #salir-btn:active { transform: scale(0.95); }
    #salir-btn .label { font-size: 1.1rem; }
    @media (orientation: portrait) {
      #salir-btn { width: 40px; }
      #salir-btn .label { display: none; }
    }
    #acciones-fixed {
      position: fixed;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 10px;
      z-index: 1001;
    }
    #acciones-fixed button {
      padding: 10px 18px;
      font-family: 'Bangers', cursive;
      font-size: 1.1rem;
      border-radius: 12px;
      border: 4px solid #FFD700;
      color: #ffffff;
      text-shadow: 1px 1px 2px #000;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    #acciones-fixed button:hover { transform: scale(1.05); }
    #acciones-fixed button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    #generar-cartones-btn {
      background: linear-gradient(#005bb5, #33a0ff);
    }
    #generar-pdf-btn {
      background: linear-gradient(#008c3a, #66d17a);
      display: none;
    }
    #pdf-wrapper {
      max-width: 900px;
      margin: 0 auto;
      text-align: center;
    }
    #logo {
      width: 140px;
      margin: 0 auto 15px;
      display: block;
    }
    #nombre-sorteo {
      font-family: 'Bangers', cursive;
      font-size: 2.2rem;
      color: #0b5394;
      margin: 5px 0;
      text-transform: uppercase;
    }
    #tipo-sorteo {
      font-family: 'Bangers', cursive;
      font-size: 1.4rem;
      color: #0b6623;
      margin-bottom: 8px;
    }
    #fecha-hora-line {
      display: flex;
      justify-content: center;
      gap: 20px;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 18px;
    }
    #premios-section {
      border: 2px solid #0b6623;
      border-radius: 16px;
      padding: 15px;
      background: linear-gradient(180deg, rgba(10,120,10,0.15), rgba(255,255,255,0.95));
      margin-bottom: 20px;
    }
    #premios-section h2 {
      font-family: 'Bangers', cursive;
      font-size: 1.6rem;
      color: #0b6623;
      margin: 0;
    }
    #total-premios {
      font-size: 2.4rem;
      font-weight: 700;
      color: #0b6623;
      text-shadow: 0 0 6px rgba(255,255,255,0.9);
      margin: 10px 0 20px;
    }
    #formas-container {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-start;
      margin-top: 12px;
    }
    .forma-linea {
      font-family: 'Bangers', cursive;
      font-size: 1.2rem;
      text-transform: uppercase;
    }
    .forma-detalles {
      font-family: 'Poppins', sans-serif;
      font-size: 0.9rem;
      margin-left: 12px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      color: #0b1d0b;
    }
    #cartones-section h2 {
      font-family: 'Bangers', cursive;
      font-size: 1.6rem;
      color: #0b5394;
      margin-bottom: 10px;
    }
    #cartones-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
    }
    .mini-carton-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 6px;
    }
    .mini-carton-wrapper {
      background: linear-gradient(green, yellow);
      padding: 4px;
      border-radius: 12px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
    }
    .mini-carton-wrapper.gratis {
      background: linear-gradient(#0000ff, #ffff66);
    }
    .mini-carton {
      border-collapse: separate;
      border-spacing: 0;
      background: linear-gradient(#ffffff,#cccccc);
      border-radius: 10px;
      overflow: hidden;
    }
    .mini-carton th, .mini-carton td {
      border: 1px solid gray;
      width: 28px;
      height: 28px;
      text-align: center;
      font-weight: 700;
      font-size: 0.8rem;
    }
    .mini-carton th {
      font-size: 1.1rem;
      color: #ff6600;
      background: radial-gradient(circle,#ffffff,#ffffff 60%,#00aa00);
      text-shadow: 1px 1px 0 #000;
    }
    .mini-carton-wrapper.gratis .mini-carton th {
      background: radial-gradient(circle,#ffffff,#ffffff 60%,#0000ff);
    }
    .mini-carton td.free {
      background: radial-gradient(circle,#ffffff,#ffff00);
      color: #e67e22;
    }
    .mini-carton td.free .estrella-libre {
      font-size: 1rem;
      color: #ff8c00;
    }
    .mini-inferior {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 0.9rem;
      color: #1a1a1a;
      text-align: center;
    }
    .mini-inferior .alias {
      font-size: 0.85rem;
      color: #004488;
    }
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-family: 'Bangers', cursive;
      font-size: 1.4rem;
      gap: 12px;
      z-index: 1200;
    }
    #loading-overlay { display: none; }
    #loading-overlay.activo { display: flex; }
    .spinner {
      width: 50px;
      height: 50px;
      border: 6px solid rgba(255,255,255,0.3);
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .cartones-placeholder {
      grid-column: 1 / -1;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      color: #1a1a1a;
      text-align: center;
      padding: 20px 10px;
    }
  </style>
</head>
<body>
  <div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text">Preparando información del sorteo, por favor espera</div>
  </div>
  <button id="salir-btn"><span class="tri">&#9664;</span><span class="label">Salir</span></button>
  <div id="acciones-fixed">
    <button id="generar-cartones-btn">Generar cartones</button>
    <button id="generar-pdf-btn">Generar PDF</button>
  </div>
  <div id="pdf-wrapper">
    <img id="logo" src="https://i.imgur.com/twjhNtZ.png" alt="Bingo Online">
    <div id="info-basica">
      <div id="nombre-sorteo">Sorteo</div>
      <div id="tipo-sorteo"></div>
      <div id="fecha-hora-line">
        <span id="fecha-sorteo"></span>
        <span id="hora-sorteo"></span>
      </div>
    </div>
    <section id="premios-section">
      <h2>CRÉDITOS TOTALES A REPARTIR</h2>
      <div id="total-premios">0</div>
      <div id="formas-container"></div>
    </section>
    <section id="cartones-section">
      <h2>Cartones del sorteo</h2>
      <div id="cartones-grid"></div>
    </section>
  </div>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnJ8O3ilS+AJGEylh4G6dkprdFMn/hTyBC0bYKT1eZq9VHtV6nRvWmvMRGsiE9z1FMvx6bMpiKFF59sGyg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-v3Z7xZPAKqz/mdrIW6DCe4k74vNysGEKMluSleqrs9jwELyhl725LLJoPLD114F8CbnMD4HzyBbs6k8ZZr3GkQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="js/auth.js"></script>
  <script>
  ensureAuth('Administrador');

  const params = new URLSearchParams(window.location.search);
  const sorteoId = params.get('s');
  if(!sorteoId){
    alert('No se indicó un sorteo.');
    window.location.href = 'cantarsorteos.html';
  }

  const salirBtn = document.getElementById('salir-btn');
  const generarCartonesBtn = document.getElementById('generar-cartones-btn');
  const pdfBtn = document.getElementById('generar-pdf-btn');
  const loadingOverlay = document.getElementById('loading-overlay');
  const loadingText = document.getElementById('loading-text');
  const nombreEl = document.getElementById('nombre-sorteo');
  const tipoEl = document.getElementById('tipo-sorteo');
  const fechaEl = document.getElementById('fecha-sorteo');
  const horaEl = document.getElementById('hora-sorteo');
  const totalPremiosEl = document.getElementById('total-premios');
  const formasCont = document.getElementById('formas-container');
  const cartonesGrid = document.getElementById('cartones-grid');

  let sorteoData = null;
  let formasData = [];
  let cartonesData = [];
  let pdfFileName = '';
  let cartonesCargados = false;
  let storage = null;
  let firebaseReadyPromise = null;

  function ensureFirebaseReady(){
    if(firebaseReadyPromise) return firebaseReadyPromise;
    if(typeof initFirebase !== 'function'){
      firebaseReadyPromise = Promise.reject(new Error('initFirebase no disponible'));
      return firebaseReadyPromise;
    }
    firebaseReadyPromise = initFirebase().catch(err => {
      console.error('Fallo al inicializar Firebase', err);
      throw err;
    });
    return firebaseReadyPromise;
  }

  function obtenerStorage(){
    if(storage) return storage;
    try {
      const appInstance = firebase.app();
      const opciones = (appInstance && appInstance.options) || {};
      const bucketConfig = (opciones.storageBucket || '').trim();

      if(bucketConfig){
        const bucketUrl = bucketConfig.startsWith('gs://') ? bucketConfig : `gs://${bucketConfig}`;
        try {
          storage = appInstance.storage(bucketUrl);
        } catch (bucketErr) {
          console.warn('Fallo al inicializar Storage con el bucket configurado, se usará el predeterminado.', bucketErr);
          storage = firebase.storage();
        }
      } else {
        storage = firebase.storage();
      }
    } catch (err) {
      console.error('No se pudo obtener la instancia de Firebase Storage', err);
      throw err;
    }
    return storage;
  }

  const coloresFormas = ['#006400', '#b8860b', '#00008b', '#4b0082', '#8b4513', '#d2691e'];

  salirBtn.addEventListener('click', ()=>{ window.location.href = 'cantarsorteos.html'; });
  if(generarCartonesBtn){ generarCartonesBtn.disabled = true; }
  if(generarCartonesBtn){ generarCartonesBtn.addEventListener('click', manejarGenerarCartones); }
  pdfBtn.addEventListener('click', generarPDF);

  function mostrarLoading(mensaje){
    if(loadingText && mensaje){ loadingText.textContent = mensaje; }
    if(loadingOverlay){ loadingOverlay.classList.add('activo'); }
  }

  function ocultarLoading(){
    if(loadingOverlay){ loadingOverlay.classList.remove('activo'); }
  }

  function mostrarMensajeCartonesPendientes(){
    if(!cartonesGrid) return;
    cartonesGrid.innerHTML = '<div class="cartones-placeholder">Haz clic en "Generar cartones" para cargar los cartones del sorteo.</div>';
  }

  function formatearFecha(fecha){
    if(!fecha) return '';
    const partes = fecha.includes('-') ? fecha.split('-') : fecha.split('/');
    if(partes.length===3){
      const [anio, mes, dia] = partes[0].length===4 ? partes : [partes[2], partes[1], partes[0]];
      return `📅 ${dia.padStart(2,'0')}/${mes.padStart(2,'0')}/${anio}`;
    }
    return `📅 ${fecha}`;
  }

  function formatearHora(hora){
    if(!hora) return '';
    const [hh = '00', mm = '00'] = hora.split(':');
    let h = parseInt(hh, 10);
    if(Number.isNaN(h)) h = 0;
    const sufijo = h >= 12 ? 'PM' : 'AM';
    h = h % 12 || 12;
    return `⏰ Hora: ${h.toString().padStart(2,'0')}:${mm.padStart(2,'0')} ${sufijo}`;
  }

  function normalizarTextoArchivo(texto){
    if(!texto) return 'sorteo';
    const sinTildes = texto.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    return sinTildes.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'') || 'sorteo';
  }

  function formatearFechaArchivo(fecha){
    if(!fecha) return '00-00-0000';
    const partes = fecha.split('-');
    if(partes.length===3){
      const [anio, mes, dia] = partes;
      return `${dia.padStart(2,'0')}-${mes.padStart(2,'0')}-${anio}`;
    }
    const partesSlash = fecha.split('/');
    if(partesSlash.length===3){
      const [dia, mes, anio] = partesSlash;
      return `${dia.padStart(2,'0')}-${mes.padStart(2,'0')}-${anio}`;
    }
    return fecha.replace(/\//g,'-');
  }

  function formatearHoraArchivo(hora){
    if(!hora) return '00-00-am';
    const [hh = '00', mm = '00'] = hora.split(':');
    let h = parseInt(hh, 10);
    if(Number.isNaN(h)) h = 0;
    const sufijo = h >= 12 ? 'pm' : 'am';
    h = h % 12 || 12;
    return `${h.toString().padStart(2,'0')}-${mm.padStart(2,'0')}-${sufijo}`;
  }

  function construirNombreArchivo(){
    if(!sorteoData) return 'pdf-sorteo';
    const nombre = normalizarTextoArchivo(sorteoData.nombre);
    const fecha = formatearFechaArchivo(sorteoData.fecha || '');
    const hora = formatearHoraArchivo(sorteoData.hora || '');
    return `${nombre}_${fecha}_${hora}`;
  }

  function crearMiniCarton(posiciones){
    const table = document.createElement('table');
    table.className = 'mini-carton';
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    ['B','I','N','G','O'].forEach(l=>{
      const th = document.createElement('th');
      th.textContent = l;
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    table.appendChild(thead);
    const tbody = document.createElement('tbody');
    for(let r=0; r<5; r++){
      const tr = document.createElement('tr');
      for(let c=0; c<5; c++){
        const td = document.createElement('td');
        if(r===2 && c===2){
          td.classList.add('free');
          td.innerHTML = '<span class="estrella-libre">★</span>';
        }else{
          const found = posiciones.find(p=>p.r===r && p.c===c);
          if(found){ td.textContent = found.valor; }
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    return table;
  }

  function obtenerColorForma(idx){
    if(!idx) return '#0b5394';
    const posicion = (idx - 1) % coloresFormas.length;
    return coloresFormas[posicion] || '#0b5394';
  }

  function renderFormas(){
    formasCont.innerHTML = '';
    const total = Number(sorteoData.totalPremios || 0);
    formasData.sort((a,b)=>(a.idx||0)-(b.idx||0));
    formasData.forEach(forma=>{
      const color = obtenerColorForma(forma.idx || 1);
      const titulo = document.createElement('div');
      titulo.className = 'forma-linea';
      titulo.style.color = color;
      titulo.textContent = `Forma ${forma.idx || ''}: ${forma.nombre || ''}`;
      formasCont.appendChild(titulo);
      const premioForma = Math.round(total * (parseFloat(forma.porcentaje || 0)/100));
      const detalles = document.createElement('div');
      detalles.className = 'forma-detalles';
      detalles.innerHTML = `<span>Premio: ${premioForma}</span><span>Cartones gratis: ${forma.cartonesGratis || 0}</span>`;
      formasCont.appendChild(detalles);
    });
  }

  function renderCartones(){
    cartonesGrid.innerHTML = '';
    if(!cartonesData.length){
      cartonesGrid.innerHTML = '<div class="cartones-placeholder">No se encontraron cartones generados para este sorteo.</div>';
      return;
    }
    cartonesData.sort((a,b)=> (Number(a.cartonNum) || 0) - (Number(b.cartonNum) || 0));
    cartonesData.forEach(data=>{
      const box = document.createElement('div');
      box.className = 'mini-carton-box';
      const wrapper = document.createElement('div');
      wrapper.className = 'mini-carton-wrapper';
      if((data.tipocarton || '').toLowerCase() === 'gratis'){ wrapper.classList.add('gratis'); }
      wrapper.appendChild(crearMiniCarton(data.posiciones || []));
      box.appendChild(wrapper);
      const infoInferior = document.createElement('div');
      infoInferior.className = 'mini-inferior';
      const numero = document.createElement('div');
      const numeroValor = Number(data.cartonNum);
      const numeroFormateado = Number.isFinite(numeroValor) ? numeroValor : 0;
      numero.textContent = `Cartón ${String(numeroFormateado).padStart(4,'0')}`;
      infoInferior.appendChild(numero);
      const alias = document.createElement('div');
      alias.className = 'alias';
      alias.textContent = data.alias ? `Alias: ${data.alias}` : 'Alias: -';
      infoInferior.appendChild(alias);
      box.appendChild(infoInferior);
      cartonesGrid.appendChild(box);
    });
  }

  async function cargarDatosBasicos(){
    mostrarLoading('Cargando información del sorteo, por favor espera');
    try {
      await ensureFirebaseReady();
      const sorteoDoc = await db.collection('sorteos').doc(sorteoId).get();
      if(!sorteoDoc.exists){
        alert('No se encontró el sorteo.');
        window.location.href = 'cantarsorteos.html';
        return;
      }
      sorteoData = sorteoDoc.data();
      nombreEl.textContent = sorteoData.nombre || 'Sorteo';
      tipoEl.textContent = sorteoData.tipo ? `Tipo de sorteo: ${sorteoData.tipo}` : '';
      fechaEl.textContent = formatearFecha(sorteoData.fecha || '');
      horaEl.textContent = formatearHora(sorteoData.hora || '');
      totalPremiosEl.textContent = Math.round(sorteoData.totalPremios || 0);
      pdfFileName = construirNombreArchivo();

      const formasSnap = await db.collection('formas').where('sorteoId','==',sorteoId).get();
      formasData = [];
      formasSnap.forEach(doc=>formasData.push(doc.data()));
      renderFormas();
      mostrarMensajeCartonesPendientes();
      if(generarCartonesBtn){ generarCartonesBtn.disabled = false; }
    } catch (err) {
      console.error('Error cargando datos', err);
      alert('Ocurrió un error cargando la información del sorteo.');
      window.location.href = 'cantarsorteos.html';
    } finally {
      ocultarLoading();
    }
  }

  async function cargarCartones(){
    mostrarLoading('Generando cartones del sorteo, por favor espera');
    try {
      await ensureFirebaseReady();
      const cartonesSnap = await db.collection('CartonJugado').where('sorteoId','==',sorteoId).get();
      cartonesData = [];
      cartonesSnap.forEach(doc=>cartonesData.push(doc.data()));
      renderCartones();
      cartonesCargados = true;
      pdfBtn.style.display = 'block';
      if(generarCartonesBtn){ generarCartonesBtn.textContent = 'Regenerar cartones'; }
    } catch (err) {
      cartonesCargados = false;
      console.error('Error cargando cartones', err);
      alert('Ocurrió un error al generar los cartones del sorteo.');
      mostrarMensajeCartonesPendientes();
      pdfBtn.style.display = 'none';
    } finally {
      ocultarLoading();
    }
  }

  async function manejarGenerarCartones(){
    if(!sorteoData){ alert('La información del sorteo aún no está disponible.'); return; }
    if(!generarCartonesBtn) return;
    if(generarCartonesBtn.disabled) return;
    generarCartonesBtn.disabled = true;
    await cargarCartones();
    generarCartonesBtn.disabled = false;
  }

  async function generarPDF(){
    if(!sorteoData){ return; }
    if(!cartonesCargados){ alert('Primero debes generar los cartones del sorteo.'); return; }
    const nombreArchivo = pdfFileName || construirNombreArchivo();
    const wrapper = document.getElementById('pdf-wrapper');
    if(!wrapper){
      alert('No se encontró el contenido del sorteo para generar el PDF.');
      return;
    }

    const textoOriginalPdf = pdfBtn ? pdfBtn.textContent : '';
    const textoOriginalCartones = generarCartonesBtn ? generarCartonesBtn.textContent : '';

    try {
      await ensureFirebaseReady();
      if(generarCartonesBtn){ generarCartonesBtn.disabled = true; }
      if(pdfBtn){
        pdfBtn.disabled = true;
        pdfBtn.textContent = 'Generando PDF...';
      }
      mostrarLoading('Generando PDF y cargándolo en la nube, por favor espera');

      if(!window.html2canvas || !window.jspdf){
        throw new Error('Dependencias para generar PDF no disponibles');
      }

      const canvas = await window.html2canvas(wrapper, {
        scale: 2,
        useCORS: true,
        logging: false
      });

      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'pt', 'a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const ratio = Math.min(pageWidth / canvas.width, pageHeight / canvas.height);
      const pdfWidth = canvas.width * ratio;
      const pdfHeight = canvas.height * ratio;
      const marginX = (pageWidth - pdfWidth) / 2;
      const marginY = (pageHeight - pdfHeight) / 2;
      pdf.addImage(imgData, 'PNG', marginX, marginY, pdfWidth, pdfHeight);

      const pdfBlob = pdf.output('blob');
      const storageInstance = obtenerStorage();
      const nombreNormalizado = normalizarTextoArchivo(nombreArchivo || 'sorteo');
      const fechaSubida = new Date().toISOString().replace(/[:.]/g,'-');
      const ruta = `sorteos/${sorteoId}/${nombreNormalizado}_${fechaSubida}.pdf`;
      const storageRef = storageInstance.ref().child(ruta);
      const snapshot = await storageRef.put(pdfBlob, { contentType: 'application/pdf' });
      const pdfUrl = await snapshot.ref.getDownloadURL();

      const payload = { pdf: 'si', pdfUrl };
      await Promise.all([
        db.collection('sorteos').doc(sorteoId).set(payload, { merge: true }),
        db.collection('cantarsorteos').doc(sorteoId).set(payload, { merge: true })
      ]);

      alert('El PDF del sorteo se generó y cargó correctamente.');
    } catch (err) {
      console.error('Error generando o subiendo el PDF', err);
      alert('No se pudo generar o subir el PDF del sorteo. Intenta nuevamente.');
    } finally {
      if(pdfBtn){
        pdfBtn.disabled = false;
        pdfBtn.textContent = textoOriginalPdf || 'Generar PDF';
      }
      if(generarCartonesBtn){
        generarCartonesBtn.disabled = false;
        generarCartonesBtn.textContent = textoOriginalCartones || generarCartonesBtn.textContent;
      }
      ocultarLoading();
    }
  }

  cargarDatosBasicos();
  </script>
</body>
</html>
