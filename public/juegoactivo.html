<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Juego Activo</title>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
      :root {
          --panel-bg: rgba(255, 255, 255, 0.92);
          --panel-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
          --texto-primario: #1f1f1f;
          --texto-secundario: #4b4b4b;
          --verde-canto: #0b8f1a;
          --canto-size: clamp(26px, 7vw, 44px);
          --mini-cell-size: clamp(20px, 4.4vw, 28px);
      }
      body {
          font-family: 'Poppins', sans-serif;
          background: linear-gradient(rgba(255, 255, 255, 0.75), rgba(255, 255, 255, 0.75)),
                      url('https://img.freepik.com/vetores-premium/padrao-sem-costura-com-simbolos-de-dolar-e-porcentagem_637741-777.jpg');
          background-repeat: repeat;
          background-size: auto;
          min-height: 100vh;
          margin: 0;
          display: flex;
          flex-direction: column;
          align-items: center;
      }
      main {
          width: 100%;
          max-width: 1200px;
          padding: 54px 18px 18px;
          box-sizing: border-box;
          display: flex;
          flex-direction: column;
          gap: 16px;
      }
      .back-btn {
          position: fixed;
          top: 8px;
          left: 8px;
          width: 44px;
          height: 44px;
          font-family: 'Bangers', cursive;
          font-size: 1.4rem;
          background: orange;
          color: white;
          border: 4px solid #FFD700;
          border-radius: 10px;
          text-shadow: 2px 2px 4px #000;
          display:flex;
          align-items:center;
          justify-content:center;
          z-index: 20;
          cursor: pointer;
      }
      .panel {
          background: var(--panel-bg);
          box-shadow: var(--panel-shadow);
          border-radius: 16px;
          padding: 16px;
          box-sizing: border-box;
          display: flex;
          flex-direction: column;
          gap: 12px;
      }
      #sorteo-header {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          gap: 6px;
          padding-top: 8px;
      }
      #sorteo-resumen {
          font-family: 'Bangers', cursive;
          font-size: clamp(1.8rem, 6vw, 2.6rem);
          letter-spacing: 1.6px;
          color: #ffffff;
          text-transform: uppercase;
          text-align: center;
      }
      #sorteo-resumen::after {
          content: '';
          display: block;
          margin-top: 4px;
          width: 62px;
          height: 4px;
          border-radius: 999px;
          background: rgba(255,255,255,0.35);
      }
      .sorteo-titulo-basico {
          text-shadow: 0 0 14px rgba(255,255,255,0.45), 2px 2px 5px rgba(0,0,0,0.85);
      }
      .sorteo-titulo-especial {
          text-shadow: 0 0 12px #ff9800, 0 0 22px rgba(255,152,0,0.75), 2px 2px 5px rgba(0,0,0,0.85);
      }
      .sorteo-titulo-diario {
          text-shadow: 0 0 12px #2ecc40, 0 0 22px rgba(46,204,64,0.75), 2px 2px 5px rgba(0,0,0,0.85);
      }
      #sorteo-detalles {
          font-size: 0.9rem;
          font-weight: 500;
          color: rgba(255,255,255,0.9);
          text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
          display: flex;
          gap: 10px;
          align-items: center;
          justify-content: center;
          flex-wrap: wrap;
      }
      #sorteo-detalles span {
          display: inline-flex;
          align-items: center;
          gap: 4px;
      }
      #sorteo-detalles strong {
          color: #ffffff;
      }
      #sorteo-detalles .detalle-tipo {
          text-transform: uppercase;
          font-weight: 700;
      }
      #panel-superior {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
          gap: 0;
          align-items: stretch;
      }
      #cantos-panel {
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          justify-content: flex-start;
          gap: 8px;
          padding: 0;
      }
      h2 {
          margin: 0;
          font-family: 'Bangers', cursive;
          letter-spacing: 1px;
          font-size: 1.4rem;
          color: #4b0082;
          text-align: left;
      }
      #cantos-grid {
          display: grid;
          grid-template-columns: repeat(5, minmax(0, 1fr));
          justify-content: flex-start;
          gap: 2px;
          font-family: 'Bangers', cursive;
          margin: 0;
      }
      .canto-cell {
          width: clamp(28px, 4.8vw, 44px);
          height: clamp(28px, 4.8vw, 44px);
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 6px;
          background: rgba(255,255,255,0.92);
          color: #1f1f1f;
          font-size: 0.9rem;
          box-shadow: inset 0 0 2px rgba(0,0,0,0.2);
          transition: transform 0.2s ease, background 0.2s ease, color 0.2s ease;
      }
      .canto-cell.encabezado {
          font-size: 1.18rem;
          color: #ffffff;
          text-shadow: 0 2px 4px rgba(0,0,0,0.85);
          box-shadow: none;
          background: transparent;
      }
      .canto-cell.cantado {
          background: radial-gradient(circle at center, rgba(255,255,255,0.75), rgba(33, 132, 59, 0.95));
          color: #ffffff;
          font-weight: 700;
          text-shadow: 0 0 6px rgba(0,0,0,0.85);
          transform: scale(1.05);
      }
      .canto-cell.ultimo {
          box-shadow: 0 0 10px rgba(255,215,0,0.9);
          transform: scale(1.12);
      }
      #ultimo-canto {
          font-size: 0.85rem;
          color: #1b5e20;
          text-align: center;
          font-weight: 600;
          letter-spacing: 0.4px;
      }
      #formas-columna {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 12px;
          padding: 0;
      }
      #formas-columna h2 {
          text-align: center;
      }
      #formas-panel {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: flex-start;
          gap: 10px;
      }
      .forma-btn {
          position: relative;
          width: 72px;
          height: 72px;
          border-radius: 20px;
          border: none;
          padding: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 8px 16px rgba(0,0,0,0.28);
          cursor: pointer;
          overflow: hidden;
          transition: transform 0.2s ease;
          background: #ccc;
          color: white;
          font-size: 1.2rem;
          font-family: 'Bangers', cursive;
      }
      .forma-btn:hover {
          transform: translateY(-3px);
      }
      .forma-btn img {
          width: 75%;
          height: 75%;
          object-fit: contain;
          filter: drop-shadow(0 0 4px rgba(0,0,0,0.3));
      }
      .forma-nombre {
          font-size: 0.75rem;
          text-align: center;
          color: var(--texto-primario);
          font-weight: 600;
          margin-top: 4px;
      }
      .forma-badge {
          position: absolute;
          top: -10px;
          right: -10px;
          min-width: 26px;
          height: 26px;
          border-radius: 999px;
          background: rgba(0,0,0,0.85);
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 0.82rem;
          border: 2px solid rgba(255,255,255,0.85);
          font-family: 'Bangers', cursive;
          box-shadow: 0 4px 8px rgba(0,0,0,0.35);
      }
      .forma-btn.sin-ganadores {
          opacity: 0.75;
          cursor: default;
      }
      #cartones-panel {
          display: flex;
          flex-direction: column;
          gap: 12px;
          padding: 0 6px 6px;
      }
      #cartones-panel h2 {
          text-align: center;
      }
      #cartones-grid {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 16px;
      }
      .carton-mini-wrapper {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 4px;
      }
      .carton-mini-wrapper.ganador .carton-mini {
          box-shadow: 0 0 16px rgba(255,215,0,0.7);
      }
      .carton-mini {
          border-collapse: separate;
          border-spacing: 0;
          background: linear-gradient(150deg, rgba(255,255,255,0.95), rgba(244,247,250,0.9));
          border-radius: 10px;
          overflow: hidden;
          width: clamp(150px, 26vw, 190px);
          table-layout: fixed;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          display: grid;
          grid-template-columns: repeat(5, 1fr);
          grid-auto-rows: 1fr;
          aspect-ratio: 5 / 6;
      }
      .carton-mini thead,
      .carton-mini tbody,
      .carton-mini tr {
          display: contents;
      }
      .carton-mini th,
      .carton-mini td {
          border: 1px solid rgba(0,0,0,0.14);
          text-align: center;
          font-weight: 700;
          font-size: 0.72rem;
          min-width: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          aspect-ratio: 1/1;
          background: #ffffff;
          color: #1a1a1a;
          padding: 0;
      }
      .carton-mini th {
          font-size: 0.88rem;
          color: #ffffff;
          background: linear-gradient(135deg, #0b5394, #1c6dd0);
          text-shadow: 0 1px 3px rgba(0,0,0,0.6);
      }
      .carton-mini td.free {
          background: linear-gradient(135deg, #ffb347, #ff7b00);
      }
      .carton-mini td.free .estrella {
          color: #ffffff;
          text-shadow: 0 0 6px rgba(0,0,0,0.3);
      }
      .carton-mini .estrella {
          font-size: 1.2rem;
          line-height: 1;
      }
      .carton-mini td.numero-cantado {
          background: radial-gradient(circle at center, rgba(255,255,153,0.85), rgba(33,132,59,0.95));
          color: #ffffff;
          text-shadow: 0 0 6px rgba(255,255,255,0.9);
      }
      .carton-info {
          font-size: 0.68rem;
          color: #ffffff;
          text-align: center;
          text-shadow: 1px 1px 3px rgba(0,0,0,0.75);
      }
      .mensaje {
          font-size: 0.85rem;
          color: var(--texto-secundario);
      }
      #cartones-mensaje,
      #formas-mensaje {
          text-align: center;
      }
      #resultados-contenedor {
          display: none;
      }
      #login-footer {
          margin: 30px 0 10px;
          text-align: center;
      }
      #fecha-hora, #derechos {
          font-size: 0.7rem;
          color: #000;
      }
      #derechos {
          font-size: 0.6rem;
      }
      .modal {
          position: fixed;
          inset: 0;
          background: rgba(0,0,0,0.8);
          display: none;
          align-items: center;
          justify-content: center;
          z-index: 100;
      }
      .modal.activa {
          display: flex;
      }
      .modal-contenido {
          background: #fff;
          border-radius: 18px;
          padding: 18px;
          max-width: 840px;
          max-height: 90vh;
          overflow-y: auto;
          box-shadow: 0 10px 25px rgba(0,0,0,0.3);
          display: flex;
          flex-direction: column;
          gap: 12px;
          width: min(90vw, 840px);
      }
      .modal-cerrar {
          align-self: flex-end;
          background: none;
          border: none;
          font-size: 1.4rem;
          cursor: pointer;
          color: #333;
      }
      #modal-ganadores-lista {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
          gap: 12px;
      }
      .ganador-card {
          background: linear-gradient(135deg, rgba(255,255,255,0.96), rgba(240,240,240,0.96));
          border-radius: 14px;
          padding: 10px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.18);
          display: flex;
          flex-direction: column;
          gap: 6px;
      }
      .ganador-info {
          font-size: 0.78rem;
          color: var(--texto-primario);
          display: flex;
          flex-direction: column;
          gap: 2px;
      }
      .ganador-info strong {
          color: #4b0082;
          font-family: 'Bangers', cursive;
          letter-spacing: 0.5px;
      }
      .modal-mensaje {
          font-size: 0.85rem;
          color: var(--texto-secundario);
      }
      @media (max-width: 768px) {
          :root {
              --canto-size: clamp(26px, 9vw, 38px);
              --mini-cell-size: clamp(18px, 6vw, 24px);
          }
          main {
              padding: 64px 12px 16px;
          }
          .back-btn {
              width: 40px;
              height: 40px;
              font-size: 1.2rem;
          }
          #panel-superior {
              grid-template-columns: 1fr;
          }
          #formas-panel {
              flex-direction: row;
              flex-wrap: wrap;
              justify-content: center;
          }
      }
      @media (orientation: landscape) and (max-width: 900px) {
          :root {
              --canto-size: clamp(24px, 6vw, 36px);
              --mini-cell-size: clamp(18px, 4.5vw, 24px);
          }
          main {
              padding-top: 58px;
          }
          #panel-superior {
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          }
          #cartones-grid {
              grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
              gap: 10px;
          }
      }
  </style>
</head>
<body>
  <button id="volver-btn" class="menu-btn back-btn" aria-label="Volver">&#9664;</button>
  <main>
    <header id="sorteo-header">
      <div id="sorteo-resumen" class="sorteo-titulo-basico">Cargando sorteo en vivo...</div>
      <div id="sorteo-detalles"></div>
    </header>
    <section id="panel-superior">
      <div id="cantos-panel">
        <div id="cantos-grid"></div>
        <div id="ultimo-canto"></div>
      </div>
      <aside id="formas-columna">
        <h2>Formas en juego</h2>
        <div id="formas-panel"></div>
        <div id="formas-mensaje" class="mensaje"></div>
      </aside>
    </section>
    <section id="cartones-panel">
      <h2>Mis cartones</h2>
      <div id="cartones-mensaje" class="mensaje"></div>
      <div id="cartones-grid"></div>
    </section>
  </main>

  <div id="login-footer">
    <div id="fecha-hora"></div>
    <div id="derechos">Todos los derechos reservados ® Hexaservice 2025</div>
  </div>

  <div id="modal-ganadores" class="modal">
    <div class="modal-contenido">
      <button class="modal-cerrar" id="modal-cerrar">✖</button>
      <h2 id="modal-titulo">Ganadores</h2>
      <div id="modal-subtitulo" class="mensaje"></div>
      <div id="modal-ganadores-lista"></div>
      <div id="modal-sin-ganadores" class="modal-mensaje"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-auth-compat.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/timezone.js"></script>
  <script>
  ensureAuth();
  initFechaHora('fecha-hora');

  const volverBtn = document.getElementById('volver-btn');
  volverBtn.addEventListener('click',()=>{window.location.href='player.html';});

  const cantosGridEl = document.getElementById('cantos-grid');
  const ultimoCantoEl = document.getElementById('ultimo-canto');
  const sorteoResumenEl = document.getElementById('sorteo-resumen');
  const sorteoDetallesEl = document.getElementById('sorteo-detalles');
  const formasPanelEl = document.getElementById('formas-panel');
  const formasMensajeEl = document.getElementById('formas-mensaje');
  const cartonesGridEl = document.getElementById('cartones-grid');
  const cartonesMensajeEl = document.getElementById('cartones-mensaje');
  const modalGanadores = document.getElementById('modal-ganadores');
  const modalCerrarBtn = document.getElementById('modal-cerrar');
  const modalTituloEl = document.getElementById('modal-titulo');
  const modalSubtituloEl = document.getElementById('modal-subtitulo');
  const modalListaEl = document.getElementById('modal-ganadores-lista');
  const modalSinGanadoresEl = document.getElementById('modal-sin-ganadores');

  const FORM_COLORS = ['#90ee90', '#fffacd', '#add8e6', '#d8b0ff', '#ffcc99', '#f77fb3', '#9ad3bc', '#fecf6a'];
  const BINGO_LETRAS = ['B','I','N','G','O'];

  const cantoCellsMap = new Map();
  let cantosOrdenados = [];
  let cantosEtiquetas = [];
  let cantosIndiceMap = new Map();
  let formasActivas = [];
  let cartonesSorteo = new Map();
  let cartonesGanadoresPorForma = new Map();
  let formasPorCarton = new Map();
  let activeSorteo = null;
  let activeSorteoId = null;
  let usuarioActual = null;

  let unsubscribeSorteos = null;
  let unsubscribeCantos = null;
  let unsubscribeFormas = null;
  let unsubscribeCartones = null;

  function crearGridCantos(){
    cantosGridEl.innerHTML='';
    cantoCellsMap.clear();
    BINGO_LETRAS.forEach(letra=>{
      const celda=document.createElement('div');
      celda.textContent=letra;
      celda.className='canto-cell encabezado';
      cantosGridEl.appendChild(celda);
    });
    for(let fila=0;fila<15;fila++){
      for(let col=0;col<5;col++){
        const numero=fila+1+col*15;
        const celda=document.createElement('div');
        celda.textContent=String(numero).padStart(2,'0');
        celda.dataset.numero=numero;
        celda.title=generarEtiquetaDesdeNumero(numero);
        celda.className='canto-cell';
        cantosGridEl.appendChild(celda);
        cantoCellsMap.set(numero,celda);
      }
    }
  }

  crearGridCantos();

  function formatearFecha(fechaStr){
    if(!fechaStr) return '';
    const partes=fechaStr.split('-');
    if(partes.length===3){
      return `${partes[2]}/${partes[1]}/${partes[0]}`;
    }
    return fechaStr;
  }

  function normalizarNumero(valor){
    if(typeof valor==='number' && Number.isFinite(valor)) return valor;
    if(typeof valor==='string'){
      const texto=valor.trim();
      if(texto==='') return null;
      const match=texto.toUpperCase().match(/^([BINGO])[-\s]?0*(\d{1,2})$/);
      if(match){
        const numero=parseInt(match[2],10);
        if(Number.isFinite(numero)){
          return numero;
        }
      }
      const n=parseInt(texto,10);
      if(Number.isFinite(n)) return n;
    }
    return null;
  }

  function generarEtiquetaDesdeNumero(numero){
    if(!Number.isFinite(numero)) return '';
    const entero=Math.trunc(numero);
    if(entero<=0) return numero.toString();
    const indice=Math.min(BINGO_LETRAS.length-1, Math.max(0, Math.floor((entero-1)/15)));
    const letra=BINGO_LETRAS[indice];
    return `${letra}-${String(entero).padStart(2,'0')}`;
  }

  function obtenerEtiquetaCanto(valor){
    if(typeof valor==='string'){
      const texto=valor.trim();
      if(texto){
        const match=texto.toUpperCase().match(/^([BINGO])[-\s]?0*(\d{1,2})$/);
        if(match){
          const letra=match[1];
          const numero=parseInt(match[2],10);
          if(Number.isFinite(numero)){
            return `${letra}-${String(numero).padStart(2,'0')}`;
          }
        }
      }
    }
    const numero=normalizarNumero(valor);
    if(numero===null) return '';
    return generarEtiquetaDesdeNumero(numero);
  }

  function colorConTransparencia(hex,alpha){
    if(!hex) return `rgba(255,255,255,${alpha})`;
    let valor=hex.replace('#','');
    if(valor.length===3){
      valor=valor.split('').map(c=>c+c).join('');
    }
    const num=parseInt(valor,16);
    if(Number.isNaN(num)) return `rgba(255,255,255,${alpha})`;
    const r=(num>>16)&255;
    const g=(num>>8)&255;
    const b=num&255;
    return `rgba(${r},${g},${b},${alpha})`;
  }

  function hexToRgb(hex){
    if(!hex) return null;
    let valor=hex.replace('#','');
    if(valor.length===3){
      valor=valor.split('').map(c=>c+c).join('');
    }
    if(valor.length!==6) return null;
    const num=parseInt(valor,16);
    if(Number.isNaN(num)) return null;
    return {
      r:(num>>16)&255,
      g:(num>>8)&255,
      b:num&255
    };
  }

  function ajustarLuminosidad(hex,porcentaje){
    const rgb=hexToRgb(hex);
    if(!rgb) return hex || '#ffffff';
    const factor=Math.max(-1, Math.min(1, porcentaje));
    const ajustar=valor=>{
      if(factor>=0){
        return Math.round(valor+(255-valor)*factor);
      }
      return Math.round(valor+(valor*factor));
    };
    const r=ajustar(rgb.r);
    const g=ajustar(rgb.g);
    const b=ajustar(rgb.b);
    return `rgb(${r}, ${g}, ${b})`;
  }

  function actualizarHeader(){
    if(!activeSorteo){
      sorteoResumenEl.className='sorteo-titulo-basico';
      sorteoResumenEl.textContent='No hay sorteos en vivo en este momento.';
      sorteoDetallesEl.innerHTML='';
      return;
    }
    const {nombre='',fecha='',tipo='',hora=''}=activeSorteo;
    const claseTitulo=['sorteo-titulo-basico'];
    const tipoNormalizado=(tipo||'').toLowerCase();
    if(tipoNormalizado.includes('especial')){
      claseTitulo.push('sorteo-titulo-especial');
    }else if(tipoNormalizado.includes('diario')){
      claseTitulo.push('sorteo-titulo-diario');
    }
    sorteoResumenEl.className=claseTitulo.join(' ');
    sorteoResumenEl.textContent=nombre||'Sorteo en vivo';
    const partes=[];
    if(tipo){
      partes.push(`<span class="detalle-tipo">${tipo}</span>`);
    }
    if(fecha){
      partes.push(`<span>Fecha: <strong>${formatearFecha(fecha)}</strong></span>`);
    }
    if(hora){
      partes.push(`<span>Hora: <strong>${hora}</strong></span>`);
    }
    sorteoDetallesEl.innerHTML=partes.join(' ');
  }

  function renderCantos(){
    if(!cantoCellsMap.size) crearGridCantos();
    cantoCellsMap.forEach(celda=>{
      celda.classList.remove('cantado','ultimo');
    });
    ultimoCantoEl.textContent='';
    const total=cantosOrdenados.length;
    cantosOrdenados.forEach((num,idx)=>{
      const celda=cantoCellsMap.get(num);
      if(celda){
        celda.classList.add('cantado');
        if(idx===total-1){
          celda.classList.add('ultimo');
        }
      }
    });
    if(total){
      const etiqueta=cantosEtiquetas[total-1] || generarEtiquetaDesdeNumero(cantosOrdenados[total-1]);
      ultimoCantoEl.textContent=`Último canto (${total}): ${etiqueta}`;
    }else{
      ultimoCantoEl.textContent='Aún no se han registrado cantos.';
    }
  }

  function limpiarPanelFormas(){
    formasPanelEl.innerHTML='';
    formasMensajeEl.textContent='';
  }

  function renderFormas(){
    limpiarPanelFormas();
    if(!formasActivas.length){
      formasMensajeEl.textContent='No hay formas registradas para este sorteo.';
      return;
    }
    formasActivas.forEach(forma=>{
      const colorBase=FORM_COLORS[(Number(forma.idx||1)-1)%FORM_COLORS.length];
      const wrapper=document.createElement('div');
      wrapper.style.display='flex';
      wrapper.style.flexDirection='column';
      wrapper.style.alignItems='center';
      wrapper.style.gap='4px';
      const btn=document.createElement('button');
      btn.className='forma-btn';
      const colorClaro=ajustarLuminosidad(colorBase,0.25);
      const colorOscuro=ajustarLuminosidad(colorBase,-0.35);
      btn.style.background=`linear-gradient(155deg, ${colorClaro}, ${colorOscuro})`;
      btn.style.boxShadow='0 12px 20px rgba(0,0,0,0.28)';
      if(forma.premioImagen){
        const img=document.createElement('img');
        img.src=forma.premioImagen;
        img.alt=forma.nombre||`Forma ${forma.idx}`;
        btn.appendChild(img);
      }else{
        btn.textContent=forma.idx?`F${String(forma.idx).padStart(2,'0')}`:'FORMA';
      }
      const ganadoresInfo=cartonesGanadoresPorForma.get(forma.idx)||{cartones:[]};
      const totalGanadores=(ganadoresInfo.cartones||[]).length;
      const badge=document.createElement('div');
      badge.className='forma-badge';
      badge.style.background=ajustarLuminosidad(colorBase,-0.55);
      badge.style.border=`2px solid ${ajustarLuminosidad(colorBase,0.25)}`;
      badge.textContent=totalGanadores;
      btn.appendChild(badge);
      if(totalGanadores>0){
        btn.addEventListener('click',()=>abrirModalGanadores(forma));
      }else{
        btn.classList.add('sin-ganadores');
      }
      btn.title=forma.nombre||`Forma ${forma.idx}`;
      wrapper.appendChild(btn);
      if(forma.nombre){
        const etiqueta=document.createElement('div');
        etiqueta.className='forma-nombre';
        etiqueta.textContent=forma.nombre;
        etiqueta.style.color=ajustarLuminosidad(colorBase,-0.45);
        wrapper.appendChild(etiqueta);
      }
      formasPanelEl.appendChild(wrapper);
    });
  }

  function crearMiniCartonDOM(posiciones){
    const tabla=document.createElement('table');
    tabla.className='carton-mini';
    const thead=document.createElement('thead');
    const trHead=document.createElement('tr');
    BINGO_LETRAS.forEach(letra=>{
      const th=document.createElement('th');
      th.textContent=letra;
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    tabla.appendChild(thead);
    const tbody=document.createElement('tbody');
    const mapaValor=new Map();
    posiciones.forEach(p=>{
      mapaValor.set(`${p.r}-${p.c}`,p.valor);
    });
    for(let r=0;r<5;r++){
      const tr=document.createElement('tr');
      for(let c=0;c<5;c++){
        const td=document.createElement('td');
        if(r===2 && c===2){
          td.classList.add('free');
          const icono=document.createElement('span');
          icono.className='estrella';
          icono.textContent='★';
          td.appendChild(icono);
        }else{
          const valor=mapaValor.get(`${r}-${c}`);
          if(valor!==undefined){
            const texto=valor.toString().padStart(2,'0');
            td.textContent=texto;
            if(cantosIndiceMap.has(valor)){
              td.classList.add('numero-cantado');
            }else{
              td.classList.add('numero-pendiente');
            }
          }
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    tabla.appendChild(tbody);
    return tabla;
  }

  function aplicarFondosGanadores(cartaEl, posiciones, formaIdx){
    const colorBase=FORM_COLORS[(Number(formaIdx||1)-1)%FORM_COLORS.length];
    const celdas=cartaEl.querySelectorAll('tbody td');
    posiciones.forEach(pos=>{
      const idx=pos.r*5+pos.c;
      if(idx>=0 && idx<celdas.length){
        const celda=celdas[idx];
        if(!celda || celda.classList.contains('free')) return;
        celda.style.background=colorConTransparencia(colorBase,0.35);
      }
    });
  }

  function renderCartonesJugador(){
    cartonesGridEl.innerHTML='';
    const lista=Array.from(cartonesSorteo.values()).filter(c=>c.userId=== (usuarioActual?usuarioActual.uid:null));
    if(!lista.length){
      cartonesMensajeEl.textContent='No tienes cartones participando en este sorteo.';
      return;
    }
    cartonesMensajeEl.textContent='';
    const decorados=lista.map(carton=>{
      const formasGanadas=formasPorCarton.get(carton.id)||[];
      const primerPaso=formasGanadas.length?Math.min(...formasGanadas.map(f=>f.paso)):Infinity;
      return {...carton, formasGanadas, primerPaso};
    });
    decorados.sort((a,b)=>{
      const aGan=a.formasGanadas.length>0;
      const bGan=b.formasGanadas.length>0;
      if(aGan!==bGan) return aGan?-1:1;
      if(aGan && bGan){
        if(a.primerPaso!==b.primerPaso) return a.primerPaso-b.primerPaso;
      }
      const numA=a.cartonNum ?? a.Ncarton ?? Number.MAX_SAFE_INTEGER;
      const numB=b.cartonNum ?? b.Ncarton ?? Number.MAX_SAFE_INTEGER;
      return numA-numB;
    });
    decorados.forEach(carton=>{
      const wrapper=document.createElement('div');
      wrapper.className='carton-mini-wrapper';
      if(carton.formasGanadas.length){
        wrapper.classList.add('ganador');
      }
      const tabla=crearMiniCartonDOM(carton.posiciones);
      if((carton.tipocarton||'').toLowerCase()==='gratis'){
        tabla.dataset.tipo='gratis';
      }
      wrapper.appendChild(tabla);
      carton.formasGanadas.forEach(f=>{
        aplicarFondosGanadores(tabla,f.forma.posicionesNormalizadas,f.forma.idx);
      });
      const info=document.createElement('div');
      info.className='carton-info';
      const numero=(carton.cartonNum ?? carton.Ncarton ?? '').toString();
      const partesInfo=[];
      partesInfo.push(`Cartón ${numero?`#${numero.padStart(4,'0')}`:'--'}`);
      partesInfo.push((carton.tipocarton||'Pagado').toUpperCase());
      if(carton.alias){
        partesInfo.push(`Alias: ${carton.alias}`);
      }
      info.textContent=partesInfo.join(' · ');
      wrapper.appendChild(info);
      cartonesGridEl.appendChild(wrapper);
    });
  }

  function abrirModalGanadores(forma){
    if(!forma) return;
    const info=cartonesGanadoresPorForma.get(forma.idx);
    const ganadores=info&&Array.isArray(info.cartones)?info.cartones:[];
    modalTituloEl.textContent=`Ganadores Forma ${String(forma.idx).padStart(2,'0')}`;
    modalSubtituloEl.textContent=forma.nombre?forma.nombre:'';
    modalListaEl.innerHTML='';
    modalSinGanadoresEl.textContent='';
    if(!ganadores.length){
      modalSinGanadoresEl.textContent='Aún no hay cartones ganadores para esta forma.';
    }else{
      const ordenados=ganadores.slice().sort((a,b)=>{
        const pasoA=(formasPorCarton.get(a.id)||[]).find(f=>f.forma.idx===forma.idx)?.paso??Infinity;
        const pasoB=(formasPorCarton.get(b.id)||[]).find(f=>f.forma.idx===forma.idx)?.paso??Infinity;
        if(pasoA!==pasoB) return pasoA-pasoB;
        const numA=a.cartonNum ?? a.Ncarton ?? Number.MAX_SAFE_INTEGER;
        const numB=b.cartonNum ?? b.Ncarton ?? Number.MAX_SAFE_INTEGER;
        return numA-numB;
      });
      ordenados.forEach(carton=>{
        const card=document.createElement('div');
        card.className='ganador-card';
        const tabla=crearMiniCartonDOM(carton.posiciones);
        aplicarFondosGanadores(tabla,forma.posicionesNormalizadas,forma.idx);
        card.appendChild(tabla);
        const infoBox=document.createElement('div');
        infoBox.className='ganador-info';
        const numero=(carton.cartonNum ?? carton.Ncarton ?? '').toString();
        infoBox.innerHTML=`<strong>Cartón ${numero?`#${numero.padStart(4,'0')}`:'--'}</strong>`+
          `<span>Alias: ${carton.alias || 'Sin alias'}</span>`+
          `<span>Tipo: ${(carton.tipocarton||'Pagado').toUpperCase()}</span>`;
        card.appendChild(infoBox);
        modalListaEl.appendChild(card);
      });
    }
    modalGanadores.classList.add('activa');
  }

  function cerrarModal(){
    modalGanadores.classList.remove('activa');
  }

  modalCerrarBtn.addEventListener('click',cerrarModal);
  modalGanadores.addEventListener('click',e=>{
    if(e.target===modalGanadores) cerrarModal();
  });

  function calcularGanadores(){
    cartonesGanadoresPorForma=new Map();
    formasPorCarton=new Map();
    cantosIndiceMap=new Map();
    cantosOrdenados.forEach((num,idx)=>{
      if(!cantosIndiceMap.has(num)) cantosIndiceMap.set(num,idx);
    });
    if(!formasActivas.length || !cartonesSorteo.size || !cantosOrdenados.length){
      renderFormas();
      renderCartonesJugador();
      return;
    }
    formasActivas.forEach(forma=>{
      const posiciones=forma.posicionesNormalizadas||[];
      if(!posiciones.length) return;
      let mejorPaso=Infinity;
      const ganadores=[];
      cartonesSorteo.forEach(carton=>{
        let valido=true;
        let maxPaso=-1;
        for(const pos of posiciones){
          const valor=carton.valorPorPos.get(`${pos.r}-${pos.c}`);
          if(valor===undefined){
            valido=false;
            break;
          }
          const idx=cantosIndiceMap.get(valor);
          if(idx===undefined){
            valido=false;
            break;
          }
          if(idx>maxPaso) maxPaso=idx;
        }
        if(!valido) return;
        if(maxPaso<mejorPaso){
          mejorPaso=maxPaso;
          ganadores.length=0;
          ganadores.push(carton);
        }else if(maxPaso===mejorPaso){
          ganadores.push(carton);
        }
      });
      cartonesGanadoresPorForma.set(forma.idx,{forma,cartones:ganadores,paso:mejorPaso});
      ganadores.forEach(carton=>{
        if(!formasPorCarton.has(carton.id)) formasPorCarton.set(carton.id,[]);
        formasPorCarton.get(carton.id).push({forma,paso:mejorPaso});
      });
    });
    formasPorCarton.forEach(lista=>{
      lista.sort((a,b)=>{
        if(a.paso!==b.paso) return a.paso-b.paso;
        return (a.forma.idx||0)-(b.forma.idx||0);
      });
    });
    renderFormas();
    renderCartonesJugador();
  }

  function procesarCantos(data){
    const lista=Array.isArray(data)?data:[];
    const normalizados=[];
    const etiquetas=[];
    lista.forEach(val=>{
      const n=normalizarNumero(val);
      if(n!==null){
        normalizados.push(n);
        const etiqueta=obtenerEtiquetaCanto(val);
        etiquetas.push(etiqueta || generarEtiquetaDesdeNumero(n));
      }
    });
    cantosOrdenados=normalizados;
    cantosEtiquetas=etiquetas;
    renderCantos();
    calcularGanadores();
  }

  function procesarFormas(snapshot){
    const arr=[];
    snapshot.forEach(doc=>{
      const data=doc.data()||{};
      const idx=Number(data.idx||data.indice||arr.length+1);
      const posiciones=Array.isArray(data.posiciones)?data.posiciones:[];
      const normalizadas=posiciones
        .map(p=>({r:Number(p.r),c:Number(p.c)}))
        .filter(p=>Number.isInteger(p.r)&&Number.isInteger(p.c));
      arr.push({
        id:doc.id,
        idx,
        nombre:data.nombre||'',
        premioImagen:data.premioImagen||data.imagen||'',
        posicionesNormalizadas:normalizadas
      });
    });
    arr.sort((a,b)=>(a.idx||0)-(b.idx||0));
    formasActivas=arr;
    calcularGanadores();
  }

  function procesarCartones(snapshot){
    const mapa=new Map();
    snapshot.forEach(doc=>{
      const data=doc.data()||{};
      const posicionesRaw=Array.isArray(data.posiciones)?data.posiciones:[];
      const posiciones=posicionesRaw
        .map(p=>({r:Number(p.r),c:Number(p.c),valor:normalizarNumero(p.valor ?? p.numero ?? p.value)}))
        .filter(p=>Number.isInteger(p.r)&&Number.isInteger(p.c)&&p.valor!==null);
      const valorPorPos=new Map();
      posiciones.forEach(p=>{
        valorPorPos.set(`${p.r}-${p.c}`,p.valor);
      });
      mapa.set(doc.id,{
        id:doc.id,
        sorteoId:data.sorteoId,
        userId:data.userId||'',
        alias:data.alias||'',
        cartonNum:data.cartonNum,
        Ncarton:data.Ncarton,
        tipocarton:data.tipocarton||'pagado',
        posiciones,
        valorPorPos
      });
    });
    cartonesSorteo=mapa;
    calcularGanadores();
  }

  function suscribirCantos(){
    if(unsubscribeCantos){
      unsubscribeCantos();
      unsubscribeCantos=null;
    }
    if(!activeSorteoId) return;
    unsubscribeCantos=db.collection('cantos').doc(activeSorteoId).onSnapshot(doc=>{
      const datos=doc.exists?(doc.data()?.numeros||[]):[];
      procesarCantos(datos);
    },err=>console.error('Error escuchando cantos',err));
  }

  function suscribirFormas(){
    if(unsubscribeFormas){
      unsubscribeFormas();
      unsubscribeFormas=null;
    }
    if(!activeSorteoId) return;
    unsubscribeFormas=db.collection('formas').where('sorteoId','==',activeSorteoId).onSnapshot(procesarFormas,err=>{
      console.error('Error escuchando formas',err);
    });
  }

  function suscribirCartones(){
    if(unsubscribeCartones){
      unsubscribeCartones();
      unsubscribeCartones=null;
    }
    if(!activeSorteoId) return;
    unsubscribeCartones=db.collection('CartonJugado').where('sorteoId','==',activeSorteoId).onSnapshot(procesarCartones,err=>{
      console.error('Error escuchando cartones',err);
    });
  }

  function seleccionarSorteo(activos){
    if(!activos.length){
      activeSorteo=null;
      activeSorteoId=null;
      actualizarHeader();
      if(unsubscribeCantos){unsubscribeCantos();unsubscribeCantos=null;}
      if(unsubscribeFormas){unsubscribeFormas();unsubscribeFormas=null;}
      if(unsubscribeCartones){unsubscribeCartones();unsubscribeCartones=null;}
      procesarCantos([]);
      formasActivas=[];
      renderFormas();
      cartonesSorteo=new Map();
      renderCartonesJugador();
      return;
    }
    const existente=activeSorteoId?activos.find(s=>s.id===activeSorteoId):null;
    const elegido=existente||activos[0];
    const cambio=activeSorteoId!==elegido.id;
    activeSorteo=elegido;
    activeSorteoId=elegido.id;
    actualizarHeader();
    if(cambio){
      procesarCantos([]);
      formasActivas=[];
      renderFormas();
      cartonesSorteo=new Map();
      renderCartonesJugador();
      suscribirCantos();
      suscribirFormas();
      suscribirCartones();
    }
  }

  function iniciarSorteosListener(){
    if(unsubscribeSorteos){
      unsubscribeSorteos();
      unsubscribeSorteos=null;
    }
    unsubscribeSorteos=db.collection('sorteos').where('estado','==','Jugando').onSnapshot(snapshot=>{
      const lista=[];
      snapshot.forEach(doc=>{
        const data=doc.data()||{};
        lista.push({id:doc.id,...data});
      });
      lista.sort((a,b)=>{
        const fechaA=(a.fecha||'');
        const fechaB=(b.fecha||'');
        if(fechaA!==fechaB) return fechaA.localeCompare(fechaB);
        return (a.hora||'').localeCompare(b.hora||'');
      });
      seleccionarSorteo(lista);
    },err=>{
      console.error('Error escuchando sorteos en juego',err);
    });
  }

  initFirebase()
    .then(()=>{
      auth.onAuthStateChanged(user=>{
        if(!user){
          window.location.href='index.html';
          return;
        }
        usuarioActual=user;
        iniciarSorteosListener();
      });
    })
    .catch(err=>{
      console.error('No se pudo inicializar Firebase',err);
      alert('Error inicializando la aplicación.');
    });
  </script>
</body>
</html>
