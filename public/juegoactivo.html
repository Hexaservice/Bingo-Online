<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Juego Activo</title>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
      :root {
          --panel-bg: rgba(255, 255, 255, 0.88);
          --panel-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
          --texto-primario: #1f1f1f;
          --texto-secundario: #4b4b4b;
          --verde-canto: #00c853;
          --canto-size: clamp(26px, 7vw, 44px);
          --mini-cell-size: clamp(20px, 4.4vw, 28px);
      }
      body {
          font-family: 'Poppins', sans-serif;
          background-color: #ffffff;
          min-height: 100vh;
          margin: 0;
          display: flex;
          flex-direction: column;
          align-items: center;
          position: relative;
          overflow-x: hidden;
      }
      body::before {
          content: '';
          position: fixed;
          inset: 0;
          background: url('https://img.freepik.com/vetores-premium/padrao-sem-costura-com-simbolos-de-dolar-e-porcentagem_637741-777.jpg') repeat;
          opacity: 0.08;
          pointer-events: none;
          z-index: -1;
      }
      main {
          width: 100%;
          max-width: 1200px;
          padding: 4px 14px 14px;
          box-sizing: border-box;
          display: flex;
          flex-direction: column;
          gap: 12px;
      }
      .back-btn {
          position: fixed;
          top: 8px;
          left: 8px;
          width: 44px;
          height: 44px;
          font-family: 'Bangers', cursive;
          font-size: 1.4rem;
          background: orange;
          color: white;
          border: 4px solid #FFD700;
          border-radius: 10px;
          text-shadow: 2px 2px 4px #000;
          display:flex;
          align-items:center;
          justify-content:center;
          z-index: 20;
          cursor: pointer;
      }
      .panel {
          background: var(--panel-bg);
          box-shadow: var(--panel-shadow);
          border-radius: 16px;
          padding: 16px;
          box-sizing: border-box;
          display: flex;
          flex-direction: column;
          gap: 12px;
      }
      #sorteo-header {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          gap: 2px;
          margin-top: -12px;
      }
      #sorteo-resumen {
          font-family: 'Bangers', cursive;
          font-size: clamp(1.8rem, 6vw, 2.6rem);
          letter-spacing: 1.6px;
          color: #ffffff;
          text-transform: uppercase;
          text-align: center;
          text-shadow: 0 0 16px rgba(0,0,0,0.55);
          transition: color 0.3s ease, text-shadow 0.3s ease;
      }
      #sorteo-resumen::after {
          content: '';
          display: block;
          margin-top: 2px;
          width: 62px;
          height: 4px;
          border-radius: 999px;
          background: rgba(255,255,255,0.35);
      }
      .sorteo-titulo-basico {
          text-shadow: 0 0 12px rgba(255,255,255,0.55), 2px 2px 5px rgba(0,0,0,0.6);
      }
      .sorteo-titulo-especial {
          color: #ff7b00;
          text-shadow: 0 0 14px rgba(255,152,0,0.55), 0 0 22px rgba(255,152,0,0.35), 2px 2px 5px rgba(0,0,0,0.6);
      }
      .sorteo-titulo-diario {
          color: #0aa128;
          text-shadow: 0 0 14px rgba(46,204,64,0.45), 0 0 22px rgba(46,204,64,0.25), 2px 2px 5px rgba(0,0,0,0.6);
      }
      #sorteo-detalles {
          font-size: 0.82rem;
          font-weight: 500;
          color: var(--texto-primario);
          display: flex;
          gap: 8px;
          align-items: center;
          justify-content: center;
          flex-wrap: wrap;
      }
      #sorteo-detalles .detalle-item {
          display: inline-flex;
          align-items: center;
          gap: 4px;
      }
      #sorteo-detalles .detalle-tipo {
          text-transform: uppercase;
          font-weight: 700;
          color: #222;
      }
      #sorteo-detalles .detalle-label {
          font-weight: 700;
          color: #000000;
      }
      #sorteo-detalles .detalle-valor {
          font-weight: 700;
      }
      #sorteo-detalles .detalle-valor.fecha {
          color: #6a0dad;
      }
      #sorteo-detalles .detalle-valor.hora {
          color: #0b4cc2;
      }
      #panel-superior {
          display: grid;
          grid-template-columns: minmax(0, 1.05fr) minmax(0, 0.95fr);
          gap: 12px;
          align-items: start;
      }
      #cantos-panel {
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          justify-content: flex-start;
          gap: 10px;
          padding: 0;
          background: transparent;
          width: 100%;
      }
      h2 {
          margin: 0;
          font-family: 'Bangers', cursive;
          letter-spacing: 1px;
          font-size: 1.4rem;
          color: #4b0082;
          text-align: left;
      }
      #cantos-grid {
          display: grid;
          grid-template-columns: repeat(5, minmax(0, 1fr));
          justify-content: flex-start;
          gap: 2px;
          font-family: 'Bangers', cursive;
          margin: 0;
      }
      .canto-cell {
          width: clamp(28px, 4.8vw, 44px);
          height: clamp(28px, 4.8vw, 44px);
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 6px;
          background: rgba(255,255,255,0.92);
          color: #1f1f1f;
          font-size: 0.9rem;
          box-shadow: inset 0 0 2px rgba(0,0,0,0.2);
          transition: transform 0.2s ease, background 0.2s ease, color 0.2s ease;
      }
      .canto-cell.encabezado {
          font-size: 1.18rem;
          color: #ff6600;
          text-shadow: 2px 2px 0 #000000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.25);
          background: radial-gradient(circle, #ffffff 0%, #ffffff 58%, var(--verde-canto));
          border-radius: 10px;
      }
      .canto-cell.cantado {
          background: radial-gradient(circle at center, rgba(255,255,255,0.75), rgba(0,200,83,0.95));
          color: #ffffff;
          font-weight: 700;
          text-shadow: 0 0 6px rgba(0,0,0,0.85);
          transform: scale(1.08);
      }
      .canto-cell.ultimo {
          box-shadow: 0 0 14px rgba(255,215,0,0.9);
          animation: focoUltimo 1.6s ease-in-out infinite;
      }
      #ultimo-canto {
          font-size: 0.78rem;
          color: var(--verde-canto);
          text-align: center;
          font-weight: 600;
          letter-spacing: 0.5px;
          display: flex;
          gap: 4px;
          align-items: center;
          justify-content: center;
          flex-wrap: wrap;
      }
      #ultimo-canto .ultimo-etiqueta {
          text-transform: uppercase;
          color: #1a1a1a;
      }
      #ultimo-canto .ultimo-total {
          color: var(--verde-canto);
      }
      #ultimo-canto .ultimo-numero {
          color: #0b4cc2;
          font-size: 1em;
          display: inline-flex;
          align-items: center;
          animation: focoUltimo 1.6s ease-in-out infinite;
      }
      #panel-derecho {
          display: flex;
          flex-direction: column;
          gap: 12px;
      }
      #formas-columna {
          display: flex;
          flex-direction: column;
          align-items: flex-end;
          gap: 10px;
          padding: 0;
          width: 100%;
      }
      #formas-columna h2 {
          text-align: right;
          font-family: 'Poppins', sans-serif;
          font-weight: 600;
          font-size: 0.9rem;
          letter-spacing: 0.4px;
          margin-bottom: 0;
          color: #1f1f1f;
      }
      #formas-panel {
          display: flex;
          flex-wrap: wrap;
          justify-content: flex-end;
          gap: 4px;
      }
      .forma-wrapper {
          display: flex;
          flex-direction: column;
          align-items: flex-end;
          gap: 2px;
      }
      .forma-boton {
          position: relative;
          min-width: 44px;
          height: 36px;
          border-radius: 8px;
          border: 2px solid #ff9800;
          padding: 0 8px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 4px 10px rgba(0,0,0,0.18);
          cursor: pointer;
          overflow: hidden;
          transition: transform 0.2s ease, box-shadow 0.2s ease;
          background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,138,0,0.75));
          color: #ffffff;
          font-size: 0.82rem;
          font-family: 'Bangers', cursive;
          text-transform: uppercase;
          text-shadow: 1px 1px 3px rgba(0,0,0,0.45);
      }
      .forma-boton:hover {
          transform: translateY(-2px) scale(1.02);
          box-shadow: 0 8px 16px rgba(0,0,0,0.28);
      }
      .forma-boton.sin-ganadores {
          opacity: 0.65;
          cursor: default;
          filter: saturate(0.55);
      }
      .forma-burbuja {
          position: absolute;
          top: -8px;
          right: -8px;
          min-width: 20px;
          height: 20px;
          border-radius: 999px;
          background: linear-gradient(150deg, #ff3d00, #ff9800);
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 0.6rem;
          border: 2px solid rgba(255, 244, 214, 0.9);
          font-family: 'Bangers', cursive;
          box-shadow: 0 4px 12px rgba(0,0,0,0.32);
      }
      .forma-nombre {
          font-size: 0.62rem;
          text-align: right;
          color: var(--texto-primario);
          font-weight: 600;
          max-width: 120px;
          line-height: 1.1;
      }
      #carton-destacado {
          display: none;
          flex-direction: column;
          gap: 12px;
          align-items: center;
          padding: 0;
          width: 100%;
      }
      #carton-destacado.activo {
          display: flex;
      }
      #cartones-panel {
          display: flex;
          flex-direction: column;
          gap: 12px;
          padding: 0;
          width: 100%;
      }
      #cartones-panel h2 {
          text-align: center;
      }
      #cartones-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
          gap: 10px;
      }
      .carton-mini-wrapper {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 4px;
          cursor: pointer;
      }
      .carton-mini-wrapper.seleccionado {
          transform: translateY(-2px);
      }
      .carton-mini-wrapper.ganador .carton-tabla {
          box-shadow: 0 0 16px rgba(255,215,0,0.7);
      }
      .carton-mini-wrapper.seleccionado .carton-tabla {
          outline: 3px solid rgba(255,215,0,0.55);
          outline-offset: 2px;
      }
      .carton-mini-wrapper:hover .carton-tabla {
          transform: translateY(-1px) scale(1.01);
      }
      .carton-visual {
          position: relative;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 4px;
          padding-top: 12px;
      }
      .carton-visual--mini {
          gap: 2px;
          padding-top: 10px;
      }
      .carton-visual--principal {
          padding-top: 14px;
      }
      .carton-forma-leyenda {
          position: absolute;
          top: 0;
          transform: translateY(-60%);
          background: rgba(0,0,0,0.65);
          color: #ffffff;
          font-size: 0.55rem;
          font-weight: 600;
          letter-spacing: 0.8px;
          text-transform: uppercase;
          border-radius: 999px;
          padding: 2px 8px;
          white-space: nowrap;
          opacity: 0;
          transition: opacity 0.3s ease;
      }
      .carton-visual--principal .carton-forma-leyenda {
          font-size: 0.6rem;
          padding: 3px 10px;
      }
      .carton-forma-leyenda.visible {
          opacity: 1;
      }
      .carton-info {
          font-size: 0.72rem;
          color: var(--texto-primario);
          text-align: center;
          font-weight: 600;
      }
      .carton-tabla {
          --cell-size: clamp(24px, 5.5vw, 34px);
          width: calc(var(--cell-size) * 5);
          border-collapse: separate;
          border-spacing: 0;
          background: linear-gradient(160deg, rgba(255,255,255,0.98), rgba(240,240,240,0.92));
          border-radius: 14px;
          overflow: hidden;
          box-shadow: 0 4px 12px rgba(0,0,0,0.18);
      }
      .carton-tabla thead th,
      .carton-tabla tbody td {
          width: var(--cell-size);
          height: var(--cell-size);
          border: 1px solid rgba(70,70,70,0.35);
          text-align: center;
          font-weight: 700;
          color: #1a1a1a;
          padding: 0;
          position: relative;
          overflow: hidden;
          background: rgba(255,255,255,0.95);
      }
      .carton-tabla thead th {
          font-size: calc(var(--cell-size) * 0.75);
          background: radial-gradient(circle, #ffffff 0%, #ffffff 60%, var(--verde-canto));
          color: #ff6600;
          text-shadow: 2px 2px 0 #000000;
      }
      .carton-tabla thead th .encabezado-letra {
          display: inline-block;
      }
      .carton-tabla.ganador thead th .encabezado-letra {
          animation: zoomPulse 1.6s ease-in-out infinite;
      }
      .carton-tabla tbody td {
          font-size: calc(var(--cell-size) * 0.55);
          transition: background 0.4s ease, transform 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
      }
      .carton-tabla td.free {
          background: radial-gradient(circle, #ffbd4f, #ffe8b3);
          color: #ffffff;
          font-size: calc(var(--cell-size) * 0.65);
      }
      .carton-tabla .estrella {
          font-size: 1.2em;
          line-height: 1;
          text-shadow: 0 0 4px rgba(0,0,0,0.3);
      }
      .carton-tabla .cell-content {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 100%;
          height: 100%;
          line-height: 1;
          font-weight: inherit;
      }
      .carton-tabla td.celda-cantada {
          background: radial-gradient(circle at center, rgba(0,200,83,0.32), rgba(0,200,83,0.96));
          color: #ffffff;
          box-shadow: inset 0 0 10px rgba(0,0,0,0.45);
      }
      .carton-tabla td.celda-cantada .cell-content {
          text-shadow: 0 0 6px rgba(0,0,0,0.85);
      }
      .carton-tabla td.celda-forma-activa {
          background: linear-gradient(180deg, rgba(var(--forma-rgb, 0, 120, 255), 0.95), rgba(var(--forma-rgb, 0, 120, 255), 0.65));
          color: #ffffff;
          box-shadow: inset 0 0 12px rgba(0,0,0,0.45);
      }
      .carton-tabla td.celda-forma-activa .cell-content {
          position: relative;
          z-index: 1;
          animation: zoomPulse 1.4s ease-in-out infinite;
          text-shadow: 0 0 10px rgba(0,0,0,0.9);
      }
      .carton-tabla--principal {
          --cell-size: clamp(38px, 7.8vw, 60px);
      }
      .carton-tabla--mini {
          --cell-size: clamp(24px, 5.5vw, 32px);
      }
      #carton-destacado .carton-tabla {
          width: clamp(260px, 85%, 480px);
      }
      #carton-destacado .carton-visor-info {
          margin-top: 6px;
      }
      .carton-mini-wrapper .carton-tabla {
          width: 100%;
      }
      .carton-visor-info {
          font-size: 0.85rem;
          font-weight: 700;
          color: var(--texto-primario);
          text-align: center;
      }
      .mensaje {
          font-size: 0.85rem;
          color: var(--texto-secundario);
      }
      #cartones-mensaje,
      #formas-mensaje {
          text-align: center;
      }
      #formas-mensaje {
          text-align: right;
      }
      #resultados-contenedor {
          display: none;
      }
      #login-footer {
          margin: 30px 0 10px;
          text-align: center;
      }
      #fecha-hora, #derechos {
          font-size: 0.7rem;
          color: #000;
      }
      #derechos {
          font-size: 0.6rem;
      }
      .modal {
          position: fixed;
          inset: 0;
          background: rgba(0,0,0,0.8);
          display: none;
          align-items: center;
          justify-content: center;
          z-index: 100;
      }
      .modal.activa {
          display: flex;
      }
      .modal-contenido {
          background: #fff;
          border-radius: 18px;
          padding: 18px;
          max-width: 840px;
          max-height: 90vh;
          overflow-y: auto;
          box-shadow: 0 10px 25px rgba(0,0,0,0.3);
          display: flex;
          flex-direction: column;
          gap: 12px;
          width: min(90vw, 840px);
      }
      .modal-cerrar {
          align-self: flex-end;
          background: none;
          border: none;
          font-size: 1.4rem;
          cursor: pointer;
          color: #333;
      }
      #modal-ganadores-lista {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
          gap: 12px;
      }
      .ganador-card {
          background: linear-gradient(135deg, rgba(255,255,255,0.96), rgba(240,240,240,0.96));
          border-radius: 14px;
          padding: 10px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.18);
          display: flex;
          flex-direction: column;
          gap: 6px;
      }
      .ganador-info {
          font-size: 0.78rem;
          color: var(--texto-primario);
          display: flex;
          flex-direction: column;
          gap: 2px;
      }
      .ganador-info strong {
          color: #4b0082;
          font-family: 'Bangers', cursive;
          letter-spacing: 0.5px;
      }
      .modal-mensaje {
          font-size: 0.85rem;
          color: var(--texto-secundario);
      }
      @keyframes zoomPulse {
          0% { transform: scale(1); }
          48% { transform: scale(1.24); }
          100% { transform: scale(1); }
      }
      @keyframes focoUltimo {
          0% { transform: scale(1); }
          45% { transform: scale(1.18); }
          100% { transform: scale(1); }
      }
      @media (max-width: 768px) {
          :root {
              --canto-size: clamp(24px, 10vw, 34px);
              --mini-cell-size: clamp(18px, 6vw, 22px);
          }
          main {
              padding: 16px 10px 14px;
          }
          .back-btn {
              width: 38px;
              height: 38px;
              font-size: 1.15rem;
          }
          #panel-superior {
              grid-template-columns: repeat(2, minmax(0, 1fr));
              gap: 8px;
          }
          #panel-derecho {
              gap: 10px;
          }
          #formas-panel {
              justify-content: flex-end;
          }
          .forma-boton {
              min-width: 40px;
              height: 32px;
              font-size: 0.78rem;
              padding: 0 6px;
          }
          .forma-burbuja {
              min-width: 18px;
              height: 18px;
              font-size: 0.55rem;
          }
          #carton-destacado .carton-tabla {
              max-width: clamp(220px, 96vw, 340px);
          }
          #cartones-grid {
              grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
              gap: 8px;
          }
          .carton-visual {
              padding-top: 12px;
          }
      }
      @media (orientation: landscape) and (max-width: 900px) {
          :root {
              --canto-size: clamp(24px, 7vw, 34px);
              --mini-cell-size: clamp(18px, 4.8vw, 22px);
          }
          main {
              padding-top: 46px;
          }
          #panel-superior {
              grid-template-columns: minmax(200px, 0.9fr) minmax(240px, 1fr);
          }
          #cartones-grid {
              grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
              gap: 8px;
          }
      }
  </style>
</head>
<body>
  <button id="volver-btn" class="menu-btn back-btn" aria-label="Volver">&#9664;</button>
  <main>
    <header id="sorteo-header">
      <div id="sorteo-resumen" class="sorteo-titulo-basico">Cargando sorteo en vivo...</div>
      <div id="sorteo-detalles"></div>
    </header>
    <section id="panel-superior">
      <div id="cantos-panel">
        <div id="cantos-grid"></div>
        <div id="ultimo-canto"></div>
      </div>
      <aside id="panel-derecho">
        <div id="formas-columna">
          <h2>Cartones ganadores con formas</h2>
          <div id="formas-panel"></div>
          <div id="formas-mensaje" class="mensaje"></div>
        </div>
        <div id="carton-destacado" aria-live="polite"></div>
        <section id="cartones-panel">
          <h2>Mis cartones</h2>
          <div id="cartones-mensaje" class="mensaje"></div>
          <div id="cartones-grid"></div>
        </section>
      </aside>
    </section>
  </main>

  <div id="login-footer">
    <div id="fecha-hora"></div>
    <div id="derechos">Todos los derechos reservados ® Hexaservice 2025</div>
  </div>

  <div id="modal-ganadores" class="modal">
    <div class="modal-contenido">
      <button class="modal-cerrar" id="modal-cerrar">✖</button>
      <h2 id="modal-titulo">Ganadores</h2>
      <div id="modal-subtitulo" class="mensaje"></div>
      <div id="modal-ganadores-lista"></div>
      <div id="modal-sin-ganadores" class="modal-mensaje"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-auth-compat.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/timezone.js"></script>
  <script>
  ensureAuth();
  initFechaHora('fecha-hora');

  const volverBtn = document.getElementById('volver-btn');
  volverBtn.addEventListener('click',()=>{window.location.href='player.html';});

  const cantosGridEl = document.getElementById('cantos-grid');
  const ultimoCantoEl = document.getElementById('ultimo-canto');
  const sorteoResumenEl = document.getElementById('sorteo-resumen');
  const sorteoDetallesEl = document.getElementById('sorteo-detalles');
  const formasPanelEl = document.getElementById('formas-panel');
  const formasMensajeEl = document.getElementById('formas-mensaje');
  const cartonesGridEl = document.getElementById('cartones-grid');
  const cartonesMensajeEl = document.getElementById('cartones-mensaje');
  const cartonDestacadoEl = document.getElementById('carton-destacado');
  const modalGanadores = document.getElementById('modal-ganadores');
  const modalCerrarBtn = document.getElementById('modal-cerrar');
  const modalTituloEl = document.getElementById('modal-titulo');
  const modalSubtituloEl = document.getElementById('modal-subtitulo');
  const modalListaEl = document.getElementById('modal-ganadores-lista');
  const modalSinGanadoresEl = document.getElementById('modal-sin-ganadores');

  const FORM_COLORS = ['#90ee90', '#fffacd', '#add8e6', '#d8b0ff', '#ffcc99', '#f77fb3', '#9ad3bc', '#fecf6a'];
  const BINGO_LETRAS = ['B','I','N','G','O'];

  const cantoCellsMap = new Map();
  let cantosOrdenados = [];
  let cantosEtiquetas = [];
  let cantosIndiceMap = new Map();
  let formasActivas = [];
  let cartonesSorteo = new Map();
  let cartonesGanadoresPorForma = new Map();
  let formasPorCarton = new Map();
  let activeSorteo = null;
  let activeSorteoId = null;
  let usuarioActual = null;

  let cartonSeleccionadoId = null;
  const animacionesCartones = new Map();

  let unsubscribeSorteos = null;
  let unsubscribeCantos = null;
  let unsubscribeFormas = null;
  let unsubscribeCartones = null;

  function crearGridCantos(){
    cantosGridEl.innerHTML='';
    cantoCellsMap.clear();
    BINGO_LETRAS.forEach(letra=>{
      const celda=document.createElement('div');
      celda.textContent=letra;
      celda.className='canto-cell encabezado';
      cantosGridEl.appendChild(celda);
    });
    for(let fila=0;fila<15;fila++){
      for(let col=0;col<5;col++){
        const numero=fila+1+col*15;
        const celda=document.createElement('div');
        celda.textContent=String(numero).padStart(2,'0');
        celda.dataset.numero=numero;
        celda.title=generarEtiquetaDesdeNumero(numero);
        celda.className='canto-cell';
        cantosGridEl.appendChild(celda);
        cantoCellsMap.set(numero,celda);
      }
    }
  }

  function obtenerColorParaForma(idx){
    const numero=Number(idx);
    if(Number.isFinite(numero) && numero>0){
      const posicion=(numero-1)%FORM_COLORS.length;
      return FORM_COLORS[posicion];
    }
    return FORM_COLORS[0];
  }

  function crearTablaCartonVisual(carton, modo='mini'){
    const contenedor=document.createElement('div');
    contenedor.className=`carton-visual carton-visual--${modo}`;
    const leyenda=document.createElement('div');
    leyenda.className='carton-forma-leyenda';
    contenedor.appendChild(leyenda);
    const tabla=document.createElement('table');
    tabla.className=`carton-tabla carton-tabla--${modo}`;
    tabla.dataset.cartonId=carton.id||'';
    const esGanador=Array.isArray(carton.formasGanadas)&&carton.formasGanadas.length>0;
    if(esGanador){
      tabla.classList.add('ganador');
    }
    const thead=document.createElement('thead');
    const trHead=document.createElement('tr');
    BINGO_LETRAS.forEach(letra=>{
      const th=document.createElement('th');
      const spanLetra=document.createElement('span');
      spanLetra.className='encabezado-letra';
      spanLetra.textContent=letra;
      th.appendChild(spanLetra);
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    tabla.appendChild(thead);
    const tbody=document.createElement('tbody');
    const mapaValor=new Map();
    (carton.posiciones||[]).forEach(p=>{
      const fila=Number(p.r);
      const col=Number(p.c);
      if(Number.isInteger(fila) && Number.isInteger(col)){
        mapaValor.set(`${fila}-${col}`,p.valor);
      }
    });
    const celdas=new Map();
    for(let r=0;r<5;r++){
      const fila=document.createElement('tr');
      for(let c=0;c<5;c++){
        const td=document.createElement('td');
        td.dataset.pos=`${r}-${c}`;
        let cantada='0';
        if(r===2 && c===2){
          td.classList.add('free');
          const icono=document.createElement('span');
          icono.className='cell-content estrella';
          icono.textContent='★';
          td.appendChild(icono);
        }else{
          const valor=mapaValor.get(`${r}-${c}`);
          const span=document.createElement('span');
          span.className='cell-content';
          if(valor!==undefined && valor!==null){
            const numero=Number(valor);
            const texto=Number.isFinite(numero)?String(numero).padStart(2,'0'):String(valor);
            span.textContent=texto;
            td.dataset.valor=numero;
            if(cantosIndiceMap.has(numero)){
              cantada='1';
              td.classList.add('celda-cantada');
            }
          }else{
            span.textContent='—';
          }
          td.appendChild(span);
        }
        td.dataset.cantada=cantada;
        fila.appendChild(td);
        celdas.set(`${r}-${c}`,td);
      }
      tbody.appendChild(fila);
    }
    tabla.appendChild(tbody);
    contenedor.appendChild(tabla);
    return {contenedor, tabla, celdas, letras:Array.from(trHead.querySelectorAll('.encabezado-letra')), leyenda};
  }

  function obtenerNumeroCarton(carton){
    const bruto=carton.cartonNum ?? carton.Ncarton;
    if(bruto===undefined || bruto===null) return '--';
    const numero=Number(bruto);
    if(Number.isFinite(numero)){
      return String(numero).padStart(4,'0');
    }
    const texto=String(bruto).trim();
    return texto||'--';
  }

  function formatearInfoCarton(carton){
    const partes=[];
    const numero=obtenerNumeroCarton(carton);
    partes.push(`Cartón ${numero==='--'?'--':`#${numero}`}`);
    const tipo=(carton.tipocarton||'Pagado').toString().toUpperCase();
    partes.push(tipo);
    if(carton.alias){
      partes.push(`Alias: ${carton.alias}`);
    }
    return partes.join(' · ');
  }

  function formatearDetalleCarton(carton){
    const partes=[];
    const numero=obtenerNumeroCarton(carton);
    partes.push(`Cartón ${numero==='--'?'--':`#${numero}`}`);
    if(carton.alias){
      partes.push(`Alias: ${carton.alias}`);
    }
    const tipo=(carton.tipocarton||'Pagado').toString().toUpperCase();
    partes.push(`Tipo: ${tipo}`);
    return partes.join(' • ');
  }

  function detenerAnimacionCarton(cartonId){
    const registro=animacionesCartones.get(cartonId);
    if(registro){
      if(registro.timer){
        clearTimeout(registro.timer);
      }
      if(Array.isArray(registro.tablas)){
        registro.tablas.forEach(aplicarResumenCarton);
      }
    }
    animacionesCartones.delete(cartonId);
  }

  function detenerTodasAnimaciones(){
    Array.from(animacionesCartones.keys()).forEach(detenerAnimacionCarton);
  }

  function aplicarResumenCarton(info){
    if(!info) return;
    info.celdas.forEach(celda=>{
      celda.classList.remove('forma-resaltada');
      celda.classList.remove('celda-forma-activa');
      celda.style.removeProperty('--forma-rgb');
      if(celda.dataset.cantada==='1'){
        celda.classList.add('celda-cantada');
      }else{
        celda.classList.remove('celda-cantada');
      }
    });
    if(info.leyenda){
      info.leyenda.textContent='';
      info.leyenda.classList.remove('visible');
    }
  }

  function aplicarFormaCarton(info, datosForma){
    if(!info || !datosForma) return;
    const rgb=hexToRgb(datosForma.color);
    const rgbTexto=rgb?`${rgb.r},${rgb.g},${rgb.b}`:'0,120,255';
    info.celdas.forEach(celda=>{
      celda.classList.remove('forma-resaltada');
      celda.classList.remove('celda-forma-activa');
      celda.style.removeProperty('--forma-rgb');
      if(celda.dataset.cantada==='1'){
        celda.classList.add('celda-cantada');
      }
    });
    (datosForma.posiciones||[]).forEach(pos=>{
      const clave=`${pos.r}-${pos.c}`;
      const celda=info.celdas.get(clave);
      if(!celda || celda.classList.contains('free')) return;
      if(celda.dataset.cantada!=='1') return;
      celda.classList.add('celda-forma-activa');
      celda.style.setProperty('--forma-rgb',rgbTexto);
    });
    if(info.leyenda){
      let etiqueta='Forma';
      if(datosForma.nombre && datosForma.nombre.trim().length){
        etiqueta=datosForma.nombre.trim();
      }else if(datosForma.indice!==undefined && datosForma.indice!==null){
        const indiceTexto=String(datosForma.indice).trim();
        etiqueta=`Forma ${indiceTexto.padStart(2,'0')}`;
      }
      info.leyenda.textContent=etiqueta;
      info.leyenda.classList.add('visible');
    }
  }

  function configurarAnimacionCarton(carton, tablasInfo){
    if(!carton || !Array.isArray(tablasInfo) || !tablasInfo.length) return;
    detenerAnimacionCarton(carton.id);
    tablasInfo.forEach(aplicarResumenCarton);
    const formasGanadas=Array.isArray(carton.formasGanadas)?carton.formasGanadas:[];
    const formasPreparadas=formasGanadas
      .map(item=>{
        const posiciones=item?.forma?.posicionesNormalizadas||[];
        if(!posiciones.length) return null;
        const idx=item?.forma?.idx ?? item?.idx;
        const nombre=item?.forma?.nombre ?? item?.nombre ?? '';
        return {
          posiciones,
          color:obtenerColorParaForma(idx),
          nombre,
          indice:idx
        };
      })
      .filter(Boolean);
    if(!formasPreparadas.length){
      return;
    }
    const secuencias=[];
    formasPreparadas.forEach(data=>{
      secuencias.push({tipo:'forma',data});
      secuencias.push({tipo:'resumen'});
    });
    if(!secuencias.length){
      return;
    }
    let indice=0;
    const registro={timer:null, tablas:tablasInfo};
    animacionesCartones.set(carton.id,registro);
    const ejecutar=()=>{
      if(!animacionesCartones.has(carton.id)) return;
      const actual=secuencias[indice];
      const duracion=actual.tipo==='forma'?3000:3000;
      if(actual.tipo==='forma'){
        tablasInfo.forEach(info=>aplicarFormaCarton(info,actual.data));
      }else{
        tablasInfo.forEach(aplicarResumenCarton);
      }
      registro.timer=setTimeout(()=>{
        indice=(indice+1)%secuencias.length;
        ejecutar();
      },duracion);
    };
    ejecutar();
  }

  crearGridCantos();

  function formatearFecha(fechaStr){
    if(!fechaStr) return '';
    const partes=fechaStr.split('-');
    if(partes.length===3){
      return `${partes[2]}/${partes[1]}/${partes[0]}`;
    }
    return fechaStr;
  }

  function normalizarNumero(valor){
    if(typeof valor==='number' && Number.isFinite(valor)) return valor;
    if(typeof valor==='string'){
      const texto=valor.trim();
      if(texto==='') return null;
      const match=texto.toUpperCase().match(/^([BINGO])[-\s]?0*(\d{1,2})$/);
      if(match){
        const numero=parseInt(match[2],10);
        if(Number.isFinite(numero)){
          return numero;
        }
      }
      const n=parseInt(texto,10);
      if(Number.isFinite(n)) return n;
    }
    return null;
  }

  function generarEtiquetaDesdeNumero(numero){
    if(!Number.isFinite(numero)) return '';
    const entero=Math.trunc(numero);
    if(entero<=0) return numero.toString();
    const indice=Math.min(BINGO_LETRAS.length-1, Math.max(0, Math.floor((entero-1)/15)));
    const letra=BINGO_LETRAS[indice];
    return `${letra}-${String(entero).padStart(2,'0')}`;
  }

  function obtenerEtiquetaCanto(valor){
    if(typeof valor==='string'){
      const texto=valor.trim();
      if(texto){
        const match=texto.toUpperCase().match(/^([BINGO])[-\s]?0*(\d{1,2})$/);
        if(match){
          const letra=match[1];
          const numero=parseInt(match[2],10);
          if(Number.isFinite(numero)){
            return `${letra}-${String(numero).padStart(2,'0')}`;
          }
        }
      }
    }
    const numero=normalizarNumero(valor);
    if(numero===null) return '';
    return generarEtiquetaDesdeNumero(numero);
  }

  function colorConTransparencia(hex,alpha){
    if(!hex) return `rgba(255,255,255,${alpha})`;
    let valor=hex.replace('#','');
    if(valor.length===3){
      valor=valor.split('').map(c=>c+c).join('');
    }
    const num=parseInt(valor,16);
    if(Number.isNaN(num)) return `rgba(255,255,255,${alpha})`;
    const r=(num>>16)&255;
    const g=(num>>8)&255;
    const b=num&255;
    return `rgba(${r},${g},${b},${alpha})`;
  }

  function hexToRgb(hex){
    if(!hex) return null;
    let valor=hex.replace('#','');
    if(valor.length===3){
      valor=valor.split('').map(c=>c+c).join('');
    }
    if(valor.length!==6) return null;
    const num=parseInt(valor,16);
    if(Number.isNaN(num)) return null;
    return {
      r:(num>>16)&255,
      g:(num>>8)&255,
      b:num&255
    };
  }

  function ajustarLuminosidad(hex,porcentaje){
    const rgb=hexToRgb(hex);
    if(!rgb) return hex || '#ffffff';
    const factor=Math.max(-1, Math.min(1, porcentaje));
    const ajustar=valor=>{
      if(factor>=0){
        return Math.round(valor+(255-valor)*factor);
      }
      return Math.round(valor+(valor*factor));
    };
    const r=ajustar(rgb.r);
    const g=ajustar(rgb.g);
    const b=ajustar(rgb.b);
    return `rgb(${r}, ${g}, ${b})`;
  }

  function actualizarHeader(){
    if(!activeSorteo){
      sorteoResumenEl.className='sorteo-titulo-basico';
      sorteoResumenEl.textContent='No hay sorteos en vivo en este momento.';
      sorteoDetallesEl.innerHTML='';
      return;
    }
    const {nombre='',fecha='',tipo='',hora=''}=activeSorteo;
    const claseTitulo=['sorteo-titulo-basico'];
    const tipoNormalizado=(tipo||'').toLowerCase();
    if(tipoNormalizado.includes('especial')){
      claseTitulo.push('sorteo-titulo-especial');
    }else if(tipoNormalizado.includes('diario')){
      claseTitulo.push('sorteo-titulo-diario');
    }
    sorteoResumenEl.className=claseTitulo.join(' ');
    sorteoResumenEl.textContent=nombre||'Sorteo en vivo';
    const partes=[];
    if(tipo){
      partes.push(`<span class="detalle-item"><span class="detalle-tipo">${tipo}</span></span>`);
    }
    if(fecha){
      partes.push(`<span class="detalle-item"><span class="detalle-label">Fecha:</span><span class="detalle-valor fecha">${formatearFecha(fecha)}</span></span>`);
    }
    if(hora){
      partes.push(`<span class="detalle-item"><span class="detalle-label">Hora:</span><span class="detalle-valor hora">${hora}</span></span>`);
    }
    sorteoDetallesEl.innerHTML=partes.join(' ');
  }

  function renderCantos(){
    if(!cantoCellsMap.size) crearGridCantos();
    cantoCellsMap.forEach(celda=>{
      celda.classList.remove('cantado','ultimo');
    });
    ultimoCantoEl.textContent='';
    const total=cantosOrdenados.length;
    cantosOrdenados.forEach((num,idx)=>{
      const celda=cantoCellsMap.get(num);
      if(celda){
        celda.classList.add('cantado');
        if(idx===total-1){
          celda.classList.add('ultimo');
        }
      }
    });
    if(total){
      const etiqueta=cantosEtiquetas[total-1] || generarEtiquetaDesdeNumero(cantosOrdenados[total-1]);
      ultimoCantoEl.innerHTML=`<span class="ultimo-etiqueta">Último</span><span class="ultimo-total">(${total})</span>: <span class="ultimo-numero">${etiqueta}</span>`;
    }else{
      ultimoCantoEl.textContent='Aún no se han registrado cantos.';
    }
  }

  function limpiarPanelFormas(){
    formasPanelEl.innerHTML='';
    formasMensajeEl.textContent='';
  }

  function renderFormas(){
    limpiarPanelFormas();
    if(!formasActivas.length){
      formasMensajeEl.textContent='No hay formas registradas para este sorteo.';
      return;
    }
    const fragment=document.createDocumentFragment();
    formasActivas.forEach(forma=>{
      const indice=Number(forma.idx||1);
      const colorBase=FORM_COLORS[(Number.isFinite(indice)&&indice>0?indice-1:0)%FORM_COLORS.length];
      const wrapper=document.createElement('div');
      wrapper.className='forma-wrapper';
      const boton=document.createElement('button');
      boton.type='button';
      boton.className='forma-boton';
      const colorSuperior=ajustarLuminosidad(colorBase,0.35);
      const colorInferior=ajustarLuminosidad(colorBase,-0.1);
      boton.style.background=`linear-gradient(180deg, ${colorSuperior}, ${colorInferior})`;
      boton.style.borderColor='#ff9800';
      boton.style.color='#ffffff';
      const indiceTexto=forma.idx!==undefined&&forma.idx!==null?String(forma.idx).replace(/^0+/,''):'';
      boton.textContent=indiceTexto?`F${indiceTexto}`:'FORMA';
      const ganadoresInfo=cartonesGanadoresPorForma.get(forma.idx)||{cartones:[]};
      const totalGanadores=(ganadoresInfo.cartones||[]).length;
      const burbuja=document.createElement('span');
      burbuja.className='forma-burbuja';
      const tonoBurbuja1=ajustarLuminosidad(colorBase,0.25);
      const tonoBurbuja2=ajustarLuminosidad(colorBase,-0.2);
      burbuja.style.background=`linear-gradient(150deg, ${tonoBurbuja1}, ${tonoBurbuja2})`;
      burbuja.style.borderColor='rgba(255, 244, 214, 0.9)';
      burbuja.textContent=totalGanadores;
      boton.appendChild(burbuja);
      if(totalGanadores>0){
        boton.addEventListener('click',()=>abrirModalGanadores(forma));
      }else{
        boton.classList.add('sin-ganadores');
      }
      boton.title=forma.nombre?forma.nombre:`Forma ${indiceTexto||forma.idx||''}`;
      wrapper.appendChild(boton);
      if(forma.nombre){
        const etiqueta=document.createElement('div');
        etiqueta.className='forma-nombre';
        etiqueta.textContent=forma.nombre;
        etiqueta.style.color=ajustarLuminosidad(colorBase,-0.45);
        wrapper.appendChild(etiqueta);
      }
      fragment.appendChild(wrapper);
    });
    formasPanelEl.appendChild(fragment);
  }

  function renderCartonesJugador(){
    detenerTodasAnimaciones();
    cartonesGridEl.innerHTML='';
    cartonDestacadoEl.innerHTML='';
    cartonDestacadoEl.classList.remove('activo');
    const lista=Array.from(cartonesSorteo.values()).filter(c=>c.userId===(usuarioActual?usuarioActual.uid:null));
    if(!lista.length){
      cartonesMensajeEl.textContent='No tienes cartones participando en este sorteo.';
      cartonSeleccionadoId=null;
      return;
    }
    cartonesMensajeEl.textContent='';
    const decorados=lista.map(carton=>{
      const formasGanadas=formasPorCarton.get(carton.id)||[];
      const primerPaso=formasGanadas.length?Math.min(...formasGanadas.map(f=>f.paso)):Infinity;
      return {...carton, formasGanadas, primerPaso};
    });
    decorados.sort((a,b)=>{
      const aGan=a.formasGanadas.length>0;
      const bGan=b.formasGanadas.length>0;
      if(aGan!==bGan) return aGan?-1:1;
      if(aGan && bGan){
        if(a.primerPaso!==b.primerPaso) return a.primerPaso-b.primerPaso;
      }
      const numA=a.cartonNum ?? a.Ncarton ?? Number.MAX_SAFE_INTEGER;
      const numB=b.cartonNum ?? b.Ncarton ?? Number.MAX_SAFE_INTEGER;
      return numA-numB;
    });
    if(!cartonSeleccionadoId || !decorados.some(c=>c.id===cartonSeleccionadoId)){
      cartonSeleccionadoId=decorados[0].id;
    }
    const tablasPorCarton=new Map();
    const registrarTabla=(cartonId,info)=>{
      if(!info) return;
      if(!tablasPorCarton.has(cartonId)) tablasPorCarton.set(cartonId,[]);
      tablasPorCarton.get(cartonId).push(info);
    };
    const fragment=document.createDocumentFragment();
    decorados.forEach(carton=>{
      const wrapper=document.createElement('div');
      wrapper.className='carton-mini-wrapper';
      if(carton.formasGanadas.length){
        wrapper.classList.add('ganador');
      }
      if(carton.id===cartonSeleccionadoId){
        wrapper.classList.add('seleccionado');
      }
      const tablaInfo=crearTablaCartonVisual(carton,'mini');
      aplicarResumenCarton(tablaInfo);
      registrarTabla(carton.id,tablaInfo);
      wrapper.appendChild(tablaInfo.contenedor);
      const info=document.createElement('div');
      info.className='carton-info';
      info.textContent=formatearInfoCarton(carton);
      wrapper.appendChild(info);
      wrapper.addEventListener('click',()=>{
        if(cartonSeleccionadoId!==carton.id){
          cartonSeleccionadoId=carton.id;
          renderCartonesJugador();
        }
      });
      fragment.appendChild(wrapper);
    });
    cartonesGridEl.appendChild(fragment);
    const seleccionado=decorados.find(c=>c.id===cartonSeleccionadoId);
    if(seleccionado){
      const tablaInfoPrincipal=crearTablaCartonVisual(seleccionado,'principal');
      aplicarResumenCarton(tablaInfoPrincipal);
      registrarTabla(seleccionado.id,tablaInfoPrincipal);
      cartonDestacadoEl.appendChild(tablaInfoPrincipal.contenedor);
      const infoDetalle=document.createElement('div');
      infoDetalle.className='carton-visor-info';
      infoDetalle.textContent=formatearDetalleCarton(seleccionado);
      cartonDestacadoEl.appendChild(infoDetalle);
      cartonDestacadoEl.classList.add('activo');
    }
    decorados.forEach(carton=>{
      const tablas=tablasPorCarton.get(carton.id)||[];
      configurarAnimacionCarton(carton,tablas);
    });
  }

  function abrirModalGanadores(forma){
    if(!forma) return;
    const info=cartonesGanadoresPorForma.get(forma.idx);
    const ganadores=info&&Array.isArray(info.cartones)?info.cartones:[];
    modalTituloEl.textContent=`Ganadores Forma ${String(forma.idx).padStart(2,'0')}`;
    modalSubtituloEl.textContent=forma.nombre?forma.nombre:'';
    modalListaEl.innerHTML='';
    modalSinGanadoresEl.textContent='';
    if(!ganadores.length){
      modalSinGanadoresEl.textContent='Aún no hay cartones ganadores para esta forma.';
    }else{
      const ordenados=ganadores.slice().sort((a,b)=>{
        const pasoA=(formasPorCarton.get(a.id)||[]).find(f=>f.forma.idx===forma.idx)?.paso??Infinity;
        const pasoB=(formasPorCarton.get(b.id)||[]).find(f=>f.forma.idx===forma.idx)?.paso??Infinity;
        if(pasoA!==pasoB) return pasoA-pasoB;
        const numA=a.cartonNum ?? a.Ncarton ?? Number.MAX_SAFE_INTEGER;
        const numB=b.cartonNum ?? b.Ncarton ?? Number.MAX_SAFE_INTEGER;
        return numA-numB;
      });
      ordenados.forEach(carton=>{
        const card=document.createElement('div');
        card.className='ganador-card';
        const cartonExtendido={...carton, formasGanadas:[{forma}]};
        const tablaInfo=crearTablaCartonVisual(cartonExtendido,'mini');
        aplicarResumenCarton(tablaInfo);
        aplicarFormaCarton(tablaInfo,{posiciones:forma.posicionesNormalizadas||[],color:obtenerColorParaForma(forma.idx)});
        card.appendChild(tablaInfo.contenedor);
        const infoBox=document.createElement('div');
        infoBox.className='ganador-info';
        const numero=(carton.cartonNum ?? carton.Ncarton ?? '').toString();
        infoBox.innerHTML=`<strong>Cartón ${numero?`#${numero.padStart(4,'0')}`:'--'}</strong>`+
          `<span>Alias: ${carton.alias || 'Sin alias'}</span>`+
          `<span>Tipo: ${(carton.tipocarton||'Pagado').toUpperCase()}</span>`;
        card.appendChild(infoBox);
        modalListaEl.appendChild(card);
      });
    }
    modalGanadores.classList.add('activa');
  }

  function cerrarModal(){
    modalGanadores.classList.remove('activa');
  }

  modalCerrarBtn.addEventListener('click',cerrarModal);
  modalGanadores.addEventListener('click',e=>{
    if(e.target===modalGanadores) cerrarModal();
  });

  function calcularGanadores(){
    cartonesGanadoresPorForma=new Map();
    formasPorCarton=new Map();
    cantosIndiceMap=new Map();
    cantosOrdenados.forEach((num,idx)=>{
      if(!cantosIndiceMap.has(num)) cantosIndiceMap.set(num,idx);
    });
    if(!formasActivas.length || !cartonesSorteo.size || !cantosOrdenados.length){
      renderFormas();
      renderCartonesJugador();
      return;
    }
    formasActivas.forEach(forma=>{
      const posiciones=forma.posicionesNormalizadas||[];
      if(!posiciones.length) return;
      let mejorPaso=Infinity;
      const ganadores=[];
      cartonesSorteo.forEach(carton=>{
        let valido=true;
        let maxPaso=-1;
        for(const pos of posiciones){
          const valor=carton.valorPorPos.get(`${pos.r}-${pos.c}`);
          if(valor===undefined){
            valido=false;
            break;
          }
          const idx=cantosIndiceMap.get(valor);
          if(idx===undefined){
            valido=false;
            break;
          }
          if(idx>maxPaso) maxPaso=idx;
        }
        if(!valido) return;
        if(maxPaso<mejorPaso){
          mejorPaso=maxPaso;
          ganadores.length=0;
          ganadores.push(carton);
        }else if(maxPaso===mejorPaso){
          ganadores.push(carton);
        }
      });
      cartonesGanadoresPorForma.set(forma.idx,{forma,cartones:ganadores,paso:mejorPaso});
      ganadores.forEach(carton=>{
        if(!formasPorCarton.has(carton.id)) formasPorCarton.set(carton.id,[]);
        formasPorCarton.get(carton.id).push({forma,paso:mejorPaso});
      });
    });
    formasPorCarton.forEach(lista=>{
      lista.sort((a,b)=>{
        if(a.paso!==b.paso) return a.paso-b.paso;
        return (a.forma.idx||0)-(b.forma.idx||0);
      });
    });
    renderFormas();
    renderCartonesJugador();
  }

  function procesarCantos(data){
    const lista=Array.isArray(data)?data:[];
    const normalizados=[];
    const etiquetas=[];
    lista.forEach(val=>{
      const n=normalizarNumero(val);
      if(n!==null){
        normalizados.push(n);
        const etiqueta=obtenerEtiquetaCanto(val);
        etiquetas.push(etiqueta || generarEtiquetaDesdeNumero(n));
      }
    });
    cantosOrdenados=normalizados;
    cantosEtiquetas=etiquetas;
    renderCantos();
    calcularGanadores();
  }

  function procesarFormas(snapshot){
    const arr=[];
    snapshot.forEach(doc=>{
      const data=doc.data()||{};
      const idx=Number(data.idx||data.indice||arr.length+1);
      const posiciones=Array.isArray(data.posiciones)?data.posiciones:[];
      const normalizadas=posiciones
        .map(p=>({r:Number(p.r),c:Number(p.c)}))
        .filter(p=>Number.isInteger(p.r)&&Number.isInteger(p.c));
      arr.push({
        id:doc.id,
        idx,
        nombre:data.nombre||'',
        premioImagen:data.premioImagen||data.imagen||'',
        posicionesNormalizadas:normalizadas
      });
    });
    arr.sort((a,b)=>(a.idx||0)-(b.idx||0));
    formasActivas=arr;
    calcularGanadores();
  }

  function procesarCartones(snapshot){
    const mapa=new Map();
    snapshot.forEach(doc=>{
      const data=doc.data()||{};
      const posicionesRaw=Array.isArray(data.posiciones)?data.posiciones:[];
      const posiciones=posicionesRaw
        .map(p=>({r:Number(p.r),c:Number(p.c),valor:normalizarNumero(p.valor ?? p.numero ?? p.value)}))
        .filter(p=>Number.isInteger(p.r)&&Number.isInteger(p.c)&&p.valor!==null);
      const valorPorPos=new Map();
      posiciones.forEach(p=>{
        valorPorPos.set(`${p.r}-${p.c}`,p.valor);
      });
      mapa.set(doc.id,{
        id:doc.id,
        sorteoId:data.sorteoId,
        userId:data.userId||'',
        alias:data.alias||'',
        cartonNum:data.cartonNum,
        Ncarton:data.Ncarton,
        tipocarton:data.tipocarton||'pagado',
        posiciones,
        valorPorPos
      });
    });
    cartonesSorteo=mapa;
    calcularGanadores();
  }

  function suscribirCantos(){
    if(unsubscribeCantos){
      unsubscribeCantos();
      unsubscribeCantos=null;
    }
    if(!activeSorteoId) return;
    unsubscribeCantos=db.collection('cantos').doc(activeSorteoId).onSnapshot(doc=>{
      const datos=doc.exists?(doc.data()?.numeros||[]):[];
      procesarCantos(datos);
    },err=>console.error('Error escuchando cantos',err));
  }

  function suscribirFormas(){
    if(unsubscribeFormas){
      unsubscribeFormas();
      unsubscribeFormas=null;
    }
    if(!activeSorteoId) return;
    unsubscribeFormas=db.collection('formas').where('sorteoId','==',activeSorteoId).onSnapshot(procesarFormas,err=>{
      console.error('Error escuchando formas',err);
    });
  }

  function suscribirCartones(){
    if(unsubscribeCartones){
      unsubscribeCartones();
      unsubscribeCartones=null;
    }
    if(!activeSorteoId) return;
    unsubscribeCartones=db.collection('CartonJugado').where('sorteoId','==',activeSorteoId).onSnapshot(procesarCartones,err=>{
      console.error('Error escuchando cartones',err);
    });
  }

  function seleccionarSorteo(activos){
    if(!activos.length){
      activeSorteo=null;
      activeSorteoId=null;
      actualizarHeader();
      if(unsubscribeCantos){unsubscribeCantos();unsubscribeCantos=null;}
      if(unsubscribeFormas){unsubscribeFormas();unsubscribeFormas=null;}
      if(unsubscribeCartones){unsubscribeCartones();unsubscribeCartones=null;}
      procesarCantos([]);
      formasActivas=[];
      renderFormas();
      cartonesSorteo=new Map();
      renderCartonesJugador();
      return;
    }
    const existente=activeSorteoId?activos.find(s=>s.id===activeSorteoId):null;
    const elegido=existente||activos[0];
    const cambio=activeSorteoId!==elegido.id;
    activeSorteo=elegido;
    activeSorteoId=elegido.id;
    actualizarHeader();
    if(cambio){
      procesarCantos([]);
      formasActivas=[];
      renderFormas();
      cartonesSorteo=new Map();
      renderCartonesJugador();
      suscribirCantos();
      suscribirFormas();
      suscribirCartones();
    }
  }

  function iniciarSorteosListener(){
    if(unsubscribeSorteos){
      unsubscribeSorteos();
      unsubscribeSorteos=null;
    }
    unsubscribeSorteos=db.collection('sorteos').where('estado','==','Jugando').onSnapshot(snapshot=>{
      const lista=[];
      snapshot.forEach(doc=>{
        const data=doc.data()||{};
        lista.push({id:doc.id,...data});
      });
      lista.sort((a,b)=>{
        const fechaA=(a.fecha||'');
        const fechaB=(b.fecha||'');
        if(fechaA!==fechaB) return fechaA.localeCompare(fechaB);
        return (a.hora||'').localeCompare(b.hora||'');
      });
      seleccionarSorteo(lista);
    },err=>{
      console.error('Error escuchando sorteos en juego',err);
    });
  }

  initFirebase()
    .then(()=>{
      auth.onAuthStateChanged(user=>{
        if(!user){
          window.location.href='index.html';
          return;
        }
        usuarioActual=user;
        iniciarSorteosListener();
      });
    })
    .catch(err=>{
      console.error('No se pudo inicializar Firebase',err);
      alert('Error inicializando la aplicación.');
    });
  </script>
</body>
</html>
