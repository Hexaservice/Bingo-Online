<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Juego Activo</title>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
      :root {
          --panel-bg: rgba(255, 255, 255, 0.88);
          --panel-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
          --texto-primario: #1f1f1f;
          --texto-secundario: #4b4b4b;
          --verde-canto: #00c853;
          --color-bingo-pagado: #00c853;
          --color-bingo-gratis: #1d4ed8;
          --canto-size: clamp(26px, 7vw, 44px);
          --mini-cell-size: clamp(20px, 4.4vw, 28px);
          --canto-cell-size: clamp(28px, 4.8vw, 44px);
      }
      body {
          font-family: 'Poppins', sans-serif;
          background-color: #ffffff;
          min-height: 100vh;
          margin: 0;
          display: flex;
          flex-direction: column;
          align-items: center;
          position: relative;
          overflow-x: hidden;
      }
      body::before {
          content: '';
          position: fixed;
          inset: 0;
          background: url('https://img.freepik.com/vetores-premium/padrao-sem-costura-com-simbolos-de-dolar-e-porcentagem_637741-777.jpg') repeat;
          opacity: 0.08;
          pointer-events: none;
          z-index: -1;
      }
      main {
          width: 100%;
          max-width: 1200px;
          padding: 4px 14px 14px;
          box-sizing: border-box;
          display: grid;
          gap: 12px;
          grid-template-columns: minmax(0, 1fr);
          grid-template-areas:
              "header"
              "panel"
              "mis-cartones";
      }
      .back-btn {
          position: fixed;
          top: 8px;
          left: 8px;
          width: 44px;
          height: 44px;
          font-family: 'Bangers', cursive;
          font-size: 1.4rem;
          background: orange;
          color: white;
          border: 4px solid #FFD700;
          border-radius: 10px;
          text-shadow: 2px 2px 4px #000;
          display:flex;
          align-items:center;
          justify-content:center;
          z-index: 20;
          cursor: pointer;
      }
      .panel {
          background: var(--panel-bg);
          box-shadow: var(--panel-shadow);
          border-radius: 16px;
          padding: 16px;
          box-sizing: border-box;
          display: flex;
          flex-direction: column;
          gap: 12px;
      }
      #sorteo-header {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          gap: 2px;
          margin-top: -12px;
          grid-area: header;
      }
      #sorteo-resumen {
          font-family: 'Bangers', cursive;
          font-size: clamp(1.8rem, 6vw, 2.6rem);
          letter-spacing: 1.6px;
          color: #ffffff;
          text-transform: uppercase;
          text-align: center;
          text-shadow: 0 0 16px rgba(0,0,0,0.55);
          transition: color 0.3s ease, text-shadow 0.3s ease;
      }
      #sorteo-resumen.sorteo-titulo-especial {
          color: #ffffff;
          text-shadow: 0 0 18px rgba(255, 123, 0, 0.85), 0 0 32px rgba(255, 152, 0, 0.5), 2px 2px 6px rgba(0,0,0,0.65);
      }
      #sorteo-resumen.sorteo-titulo-diario {
          color: #ffffff;
          text-shadow: 0 0 18px rgba(10, 161, 40, 0.8), 0 0 32px rgba(46, 204, 64, 0.5), 2px 2px 6px rgba(0,0,0,0.65);
      }
      #sorteo-resumen::after {
          content: '';
          display: block;
          margin-top: 2px;
          width: 62px;
          height: 4px;
          border-radius: 999px;
          background: rgba(255,255,255,0.35);
      }
      .sorteo-titulo-basico {
          text-shadow: 0 0 12px rgba(255,255,255,0.55), 2px 2px 5px rgba(0,0,0,0.6);
      }
      #sorteo-detalles {
          font-size: 0.82rem;
          font-weight: 500;
          color: var(--texto-primario);
          display: flex;
          gap: 8px;
          align-items: center;
          justify-content: center;
          flex-wrap: wrap;
      }
      #sorteo-detalles .detalle-item {
          display: inline-flex;
          align-items: center;
          gap: 4px;
      }
      #sorteo-detalles .detalle-tipo {
          text-transform: uppercase;
          font-weight: 700;
      }
      #sorteo-detalles .detalle-tipo-especial {
          color: #ff7b00;
          text-shadow: 0 0 10px rgba(255, 123, 0, 0.6);
      }
      #sorteo-detalles .detalle-tipo-diario {
          color: #0aa128;
          text-shadow: 0 0 10px rgba(10, 161, 40, 0.55);
      }
      #sorteo-detalles .detalle-label {
          font-weight: 700;
          color: #000000;
      }
      #sorteo-detalles .detalle-valor {
          font-weight: 700;
      }
      #sorteo-detalles .detalle-valor.fecha {
          color: #6a0dad;
      }
      #sorteo-detalles .detalle-valor.hora {
          color: #0b4cc2;
      }
      #panel-superior {
          grid-area: panel;
          display: grid;
          grid-template-columns: minmax(0, 1fr) minmax(0, clamp(240px, 44vw, 520px));
          grid-template-areas:
              "cantos carton"
              "mensaje carton";
          align-items: stretch;
          row-gap: clamp(6px, 2vw, 12px);
          column-gap: clamp(6px, 2vw, 14px);
          width: 100%;
          margin: 0;
          padding: 0;
          padding-bottom: calc(var(--panel-botones-altura, 0px) + var(--panel-botones-separacion, 0px));
          position: relative;
          --panel-botones-altura: 0px;
          --panel-botones-separacion: 0px;
          --panel-botones-top: 100%;
      }
      #cantos-panel {
          grid-area: cantos;
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          justify-content: flex-start;
          gap: 10px;
          padding: 0;
          background: transparent;
          width: 100%;
          min-width: calc(var(--canto-cell-size) * 5 + clamp(6px, 2vw, 14px));
      }
      h2 {
          margin: 0;
          font-family: 'Bangers', cursive;
          letter-spacing: 1px;
          font-size: 1.4rem;
          color: #4b0082;
          text-align: left;
      }
      #cantos-grid {
          display: grid;
          grid-template-columns: repeat(5, var(--canto-cell-size));
          justify-content: flex-start;
          gap: 2px;
          font-family: 'Poppins', sans-serif;
          margin: 0;
          width: min(100%, calc(var(--canto-cell-size) * 5));
      }
      .canto-cell {
          width: var(--canto-cell-size);
          height: var(--canto-cell-size);
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 6px;
          background: rgba(255,255,255,0.92);
          color: #1f1f1f;
          font-size: 0.9rem;
          box-shadow: inset 0 0 2px rgba(0,0,0,0.2);
          font-family: 'Poppins', sans-serif;
          transition: transform 0.2s ease, background 0.2s ease, color 0.2s ease;
      }
      .canto-cell.encabezado {
          font-size: 1.18rem;
          color: #ff6600;
          text-shadow: 2px 2px 0 #000000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.25);
          background: radial-gradient(circle, #ffffff 0%, #ffffff 58%, var(--verde-canto));
          border-radius: 10px;
          font-weight: 700;
      }
      .canto-cell.cantado {
          background: radial-gradient(circle at center, rgba(255,255,255,0.75), rgba(0,200,83,0.95));
          color: #ffffff;
          font-weight: 700;
          text-shadow: 0 0 6px rgba(0,0,0,0.85);
          transform: scale(1.08);
      }
      .canto-cell.ultimo {
          box-shadow: 0 0 14px rgba(255,215,0,0.9);
          animation: focoUltimo 1.6s ease-in-out infinite;
      }
      #ultimo-canto {
          font-size: 0.78rem;
          color: var(--verde-canto);
          text-align: center;
          font-weight: 600;
          letter-spacing: 0.5px;
          display: flex;
          gap: 4px;
          align-items: center;
          justify-content: center;
          flex-wrap: wrap;
      }
      #ultimo-canto .ultimo-etiqueta {
          text-transform: uppercase;
          color: #1a1a1a;
      }
      #ultimo-canto .ultimo-total {
          color: var(--verde-canto);
      }
      #ultimo-canto .ultimo-numero {
          color: #0b4cc2;
          font-size: 1em;
          display: inline-flex;
          align-items: center;
          animation: focoUltimo 1.6s ease-in-out infinite;
      }
      #panel-columna-derecha {
          grid-area: carton;
          display: flex;
          flex-direction: column;
          align-items: stretch;
          justify-content: flex-start;
          gap: 0;
          margin: 0;
          padding: 0;
          width: 100%;
          min-height: 0;
      }
      .panel-columna-derecha__rejilla {
          display: grid;
          grid-template-columns: minmax(0, 1fr);
          align-items: stretch;
          justify-items: stretch;
          width: 100%;
          min-height: 0;
          margin: 0;
          padding: 0;
      }
      .panel-columna-derecha__destacado {
          display: flex;
          flex-direction: column;
          align-items: stretch;
          justify-content: flex-start;
      }
      .panel-columna-derecha__destacado > #carton-destacado {
          flex: 1 1 auto;
          width: 100%;
      }
      .panel-columna-derecha__modales {
          position: relative;
          width: 100%;
          margin-top: 6px;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: flex-start;
          gap: clamp(4px, 1vw, 10px);
      }
      .panel-columna-derecha__modales > * {
          width: 100%;
          max-width: 100%;
      }
      #carton-destacado {
          display: none;
          flex-direction: column;
          gap: 16px;
          align-items: stretch;
          justify-content: flex-start;
          padding: 0;
          width: 100%;
          max-width: 100%;
          justify-self: stretch;
          align-self: start;
          margin: 0;
          height: auto;
          overflow: visible;
          min-height: 0;
          --destacado-cell-size: clamp(42px, 8.8vw, 108px);
          --carton-principal-padding: clamp(6px, 1.2vw, 12px);
      }
      #carton-destacado.activo {
          display: flex;
      }
      #carton-destacado .carton-tabla thead th {
          cursor: default;
      }
      #carton-destacado .carton-box {
          width: 100%;
          max-width: 100%;
          margin: 0;
          display: flex;
          justify-content: center;
          align-items: stretch;
          perspective: 1200px;
          perspective-origin: 50% 50%;
      }
      #carton-destacado .carton-wrapper {
          position: relative;
          transform-style: preserve-3d;
          transform-origin: center center;
          transition: transform 0.6s ease;
          border-radius: 18px;
          background: linear-gradient(160deg, #087f23 0%, #f7f55d 100%);
          box-shadow: 0 16px 32px rgba(0,0,0,0.35);
          cursor: pointer;
          padding: 0;
          width: 100%;
          max-width: 100%;
          min-height: 0;
          display: flex;
          flex-direction: column;
          --carton-wrapper-altura: calc((var(--destacado-cell-size) * 6.2) + clamp(140px, 32vw, 240px));
      }
      #carton-destacado .carton-wrapper::before {
          content: '';
          display: block;
          padding-bottom: var(--carton-wrapper-altura);
          pointer-events: none;
      }
      #carton-destacado .carton-wrapper.flipped {
          transform: rotateY(180deg);
      }
      #carton-destacado .carton-wrapper.flipped .carton-front {
          pointer-events: none;
      }
      #carton-destacado .carton-wrapper.flipped .carton-back {
          pointer-events: auto;
      }
      #carton-destacado .carton-front,
      #carton-destacado .carton-back {
          position: absolute;
          inset: 0;
          display: flex;
          flex-direction: column;
          align-items: stretch;
          justify-content: flex-start;
          backface-visibility: hidden;
          border-radius: 14px;
          overflow: hidden;
          padding: 0;
          background: linear-gradient(#ffffff, #dcdcdc);
          box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
      }
      #carton-destacado .carton-front {
          gap: clamp(0px, 0.6vw, 8px);
          align-items: stretch;
          justify-content: center;
          min-height: 0;
          padding: clamp(4px, 1vw, 10px);
          box-sizing: border-box;
      }
      #carton-destacado .carton-front .carton-visual {
          width: 100%;
          display: grid;
          grid-template-rows: auto 1fr;
          align-items: stretch;
          justify-items: center;
          gap: clamp(0px, 0.4vw, 6px);
          flex: 1 1 auto;
          align-self: stretch;
          min-height: 0;
          padding: var(--carton-principal-padding, clamp(6px, 1.2vw, 12px));
          box-sizing: border-box;
          aspect-ratio: auto;
          position: relative;
          --principal-cell-size: min(
              var(--destacado-cell-size),
              max(
                  clamp(28px, 8vw, 36px),
                  calc((100% - (var(--carton-principal-padding) * 2)) / 5)
              )
          );
      }
      #carton-destacado .carton-front .carton-visual .carton-tabla {
          display: grid;
          grid-template-columns: repeat(5, minmax(0, var(--principal-cell-size, var(--cell-size))));
          grid-auto-rows: var(--principal-cell-size, var(--cell-size));
          width: min(100%, calc(var(--principal-cell-size, var(--cell-size)) * 5));
          max-width: calc(var(--principal-cell-size, var(--cell-size)) * 5);
          height: min(100%, calc(var(--principal-cell-size, var(--cell-size)) * 6.2));
          max-height: calc(var(--principal-cell-size, var(--cell-size)) * 6.2);
          margin: 0;
          align-self: stretch;
          justify-self: stretch;
      }
      #carton-destacado .carton-back {
          transform: rotateY(180deg);
          justify-content: flex-start;
          align-items: stretch;
      }
      #carton-destacado .carton-back img {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 82%;
          max-width: 260px;
          height: auto;
          opacity: 0.14;
          pointer-events: none;
      }
      #carton-destacado .carton-back-content {
          position: relative;
          z-index: 1;
          width: 100%;
          display: flex;
          flex-direction: column;
          align-items: stretch;
          justify-content: flex-start;
          gap: 10px;
          height: 100%;
      }
      #carton-destacado .carton-back-title {
          margin: 0;
          font-family: 'Bangers', cursive;
          font-size: clamp(1.1rem, 4.5vw, 1.5rem);
          color: #ffffff;
          text-shadow: 0 0 10px rgba(0,0,0,0.85), 0 0 18px rgba(0,0,0,0.6);
          letter-spacing: 1px;
          grid-column: 1 / -1;
          text-align: center;
      }
      #carton-destacado .carton-back-formas {
          display: flex;
          flex-direction: column;
          gap: 8px;
          width: 100%;
          align-items: stretch;
      }
      #carton-destacado .back-forma-line {
          font-family: 'Bangers', cursive;
          font-size: clamp(0.88rem, 3vw, 1.08rem);
          display: flex;
          align-items: center;
          justify-content: space-between;
          flex-wrap: wrap;
          gap: 6px;
          line-height: 1.05;
          width: 100%;
          text-shadow: 0 0 8px rgba(0,0,0,0.85), 0 0 16px rgba(0,0,0,0.55);
      }
      #carton-destacado .back-forma-line .back-forma-valor {
          font-size: clamp(1rem, 3.4vw, 1.25rem);
      }
      #carton-destacado .back-forma-line .back-forma-etiqueta {
          letter-spacing: 0.5px;
      }
      #carton-destacado .carton-back-total {
          margin-top: 4px;
          display: flex;
          align-items: baseline;
          justify-content: center;
          gap: 10px;
          font-family: 'Bangers', cursive;
          color: #ffffff;
          text-shadow: 0 0 12px rgba(0,0,0,0.85), 0 0 22px rgba(0,0,0,0.6);
      }
      #carton-destacado .carton-back-total-label {
          font-size: clamp(1.1rem, 3.8vw, 1.4rem);
          margin: 0;
      }
      #carton-destacado .carton-back-total-valor {
          font-size: clamp(1.6rem, 5vw, 2.2rem);
          margin: 0;
      }
      #panel-botones-formas {
          grid-area: botones;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-self: stretch;
          align-self: stretch;
          width: 100%;
          max-width: 100%;
          margin: 0;
          padding: 0;
          --panel-botones-ancho: auto;
          --panel-botones-minimo: 0px;
          --panel-botones-col-min: clamp(140px, 42vw, 220px);
          --panel-botones-escala: 1;
          --panel-botones-escala-limitada: clamp(0.5, var(--panel-botones-escala), 1);
          gap: calc(clamp(4px, 1vw, 10px) * var(--panel-botones-escala-limitada));
      }
      #panel-botones-formas:empty {
          display: none;
      }
      #panel-botones-formas.flotante {
          position: absolute;
          left: 50%;
          transform: translateX(-50%);
          top: calc(var(--panel-botones-top, 100%) + var(--panel-botones-separacion, 0px));
          margin: 0;
          padding: clamp(10px, 2.8vw, 16px);
          width: min(
              var(--panel-botones-ancho, clamp(210px, 80vw, 420px)),
              calc(100% - clamp(16px, 5vw, 32px))
          );
          max-width: clamp(210px, 80vw, 420px);
          border-radius: clamp(12px, 3.6vw, 18px);
          box-shadow: 0 10px 26px rgba(0,0,0,0.22);
          background: linear-gradient(135deg, rgba(255,255,255,0.96), rgba(245,245,245,0.92));
          backdrop-filter: blur(6px);
          border: 1px solid rgba(255,255,255,0.85);
          grid-area: auto;
          z-index: 30;
          gap: clamp(6px, 2vw, 14px);
      }
      #panel-botones-formas.flotante:empty {
          display: none;
      }
      #panel-botones-formas.flotante .panel-botones-formas__envoltorio,
      #panel-botones-formas.flotante .panel-botones-formas__grid {
          width: 100%;
      }
      #panel-botones-formas.flotante .carton-forma-accion {
          width: 100%;
      }
      .panel-botones-formas__envoltorio {
          display: flex;
          flex-direction: column;
          align-items: center;
          width: 100%;
          max-width: 100%;
          gap: calc(clamp(6px, 2vw, 14px) * var(--panel-botones-escala-limitada, 1));
      }
      .panel-botones-formas__grid {
          display: grid;
          width: 100%;
          max-width: 100%;
          gap: calc(clamp(6px, 2vw, 14px) * var(--panel-botones-escala-limitada, 1));
          justify-items: center;
      }
      .panel-botones-formas__grid > .carton-forma-accion {
          width: auto;
      }
      .carton-forma-accion {
          font-family: 'Bangers', cursive;
          font-size: clamp(0.62rem, calc(0.82rem * var(--panel-botones-escala-limitada, 1)), 1.05rem);
          padding: calc(4px * var(--panel-botones-escala-limitada, 1)) calc(10px * var(--panel-botones-escala-limitada, 1));
          border-radius: 999px;
          border: calc(2px * var(--panel-botones-escala-limitada, 1)) solid var(--forma-color-borde, rgba(0,0,0,0.2));
          color: #1f1f1f;
          background: linear-gradient(to bottom, var(--forma-color, #ffe082), #ffffff);
          box-shadow: 0 4px 10px rgba(0,0,0,0.18);
          cursor: pointer;
          transition: transform 0.2s ease, box-shadow 0.2s ease;
          text-align: center;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: calc(6px * var(--panel-botones-escala-limitada, 1));
          white-space: normal;
          width: auto;
          min-width: 0;
      }
      #panel-botones-formas .carton-forma-accion {
          align-self: center;
      }
      .carton-forma-accion .carton-forma-texto {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          line-height: 1.1;
      }
      .carton-forma-accion .carton-forma-contador {
          font-size: calc(0.9em * var(--panel-botones-escala-limitada, 1));
          font-weight: 700;
          color: var(--forma-color-contador, #1f1f1f);
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding-left: calc(6px * var(--panel-botones-escala-limitada, 1));
          min-width: calc(1.8em * var(--panel-botones-escala-limitada, 1));
      }
      .carton-forma-accion.con-ganadores {
          animation: zoomPulse 1.8s ease-in-out infinite;
      }
      .carton-forma-accion:hover,
      .carton-forma-accion:focus-visible {
          transform: translateY(-1px);
          box-shadow: 0 6px 16px rgba(0,0,0,0.22);
          outline: none;
      }
      #mis-cartones-section {
          display: flex;
          flex-direction: column;
          gap: 12px;
          margin-top: 6px;
          width: 100%;
          grid-area: mis-cartones;
      }
      #formas-mensaje {
          grid-area: mensaje;
          margin: 0;
          padding: 0;
          align-self: start;
          justify-self: stretch;
      }
      #mis-cartones-section h2 {
          text-align: center;
          margin: 0;
      }
      #mis-cartones-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
          gap: 12px;
          width: 100%;
          justify-items: center;
      }
      #mis-cartones-grid:empty {
          display: none;
      }
      .carton-visual {
          position: relative;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 4px;
          padding-top: 12px;
      }
      .carton-visual--mini {
          width: auto;
          background: transparent;
          box-shadow: none;
          border-radius: 0;
          padding: 12px 0 10px;
          box-sizing: border-box;
          cursor: pointer;
          transition: transform 0.18s ease, box-shadow 0.18s ease;
          margin: 0 auto;
      }
      .carton-visual--mini:focus-visible {
          outline: 3px solid rgba(255,215,0,0.45);
          outline-offset: 3px;
      }
      .carton-visual--mini.seleccionado {
          transform: translateY(-2px);
          outline: 3px solid rgba(255,215,0,0.5);
          outline-offset: 3px;
      }
      .carton-visual--mini.ganador .carton-tabla {
          box-shadow: 0 0 14px rgba(255,215,0,0.7);
      }
      .carton-visual--mini:hover {
          box-shadow: none;
      }
      .carton-visual--mini:hover .carton-tabla {
          transform: none;
      }
      .carton-visual--mini {
          gap: 2px;
          padding-top: 10px;
      }
      .carton-visual--principal {
          padding-top: 12px;
      }
      .carton-forma-leyenda {
          position: absolute;
          top: clamp(6px, 2vw, 16px);
          left: 50%;
          transform: translateX(-50%);
          background: rgba(255, 255, 255, 0.92);
          color: #333333;
          font-size: 0.55rem;
          font-weight: 600;
          letter-spacing: 0.8px;
          text-transform: uppercase;
          border-radius: 999px;
          padding: 2px 10px;
          white-space: nowrap;
          opacity: 0;
          transition: opacity 0.3s ease;
          box-shadow: 0 0 10px rgba(255, 215, 0, 0.75);
          border: 1px solid rgba(0,0,0,0.1);
          z-index: 2;
      }
      .carton-visual--principal .carton-forma-leyenda {
          font-size: 0.62rem;
          padding: 3px 12px;
      }
      .carton-forma-leyenda.visible {
          opacity: 1;
      }
      .carton-info {
          font-size: 0.72rem;
          color: var(--texto-primario);
          text-align: center;
          font-weight: 600;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 2px;
          line-height: 1.1;
      }
      .carton-info-numero {
          font-size: inherit;
      }
      .carton-info-tipo {
          font-size: 0.58rem;
          font-weight: 700;
          letter-spacing: 1px;
          text-transform: uppercase;
          margin-top: -2px;
      }
      .carton-info-tipo--pagado {
          color: #0aa128;
      }
      .carton-info-tipo--gratis {
          color: #1d4ed8;
      }
      .carton-visual--mini .carton-info {
          margin-top: 6px;
      }
      .carton-tabla {
          --cell-size: clamp(34px, 9vw, 72px);
          --bingo-encabezado-color: var(--color-bingo-pagado);
          width: min(100%, calc(var(--cell-size) * 5));
          max-width: calc(var(--cell-size) * 5);
          border-collapse: separate;
          border-spacing: 0;
          table-layout: fixed;
          background: linear-gradient(#ffffff, #dcdcdc);
          border-radius: 12px;
          overflow: hidden;
          box-shadow: 0 6px 15px rgba(0,0,0,0.25);
      }
      .carton-tabla[data-tipocarton="pagado"] {
          --bingo-encabezado-color: var(--color-bingo-pagado);
      }
      .carton-tabla[data-tipocarton="gratis"] {
          --bingo-encabezado-color: var(--color-bingo-gratis);
      }
      .carton-tabla thead th,
      .carton-tabla tbody td {
          width: var(--cell-size);
          height: var(--cell-size);
          aspect-ratio: 1 / 1;
          border: 2px solid rgba(90,90,90,0.45);
          text-align: center;
          font-weight: 700;
          color: #1a1a1a;
          padding: 0;
          position: relative;
          overflow: hidden;
          background: rgba(255,255,255,0.95);
          box-sizing: border-box;
      }
      .carton-tabla thead th > *,
      .carton-tabla tbody td > * {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 100%;
          height: 100%;
      }
      .carton-tabla thead th {
          font-size: calc(var(--cell-size) * 0.7);
          background: radial-gradient(circle, #ffffff 0%, #ffffff 60%, var(--bingo-encabezado-color));
          color: #ff6600;
          text-shadow: 2px 2px 0 #000000;
      }
      .carton-tabla thead th[role="button"] {
          cursor: pointer;
      }
      .carton-tabla thead th.forma-activa {
          background: radial-gradient(circle, rgba(var(--forma-rgb-vivo, var(--forma-rgb, 0, 120, 255)), 0.45) 0%, rgba(var(--forma-rgb, 0, 120, 255), 0.55) 60%, rgba(var(--forma-rgb, 0, 120, 255), 0.9) 100%);
          color: #ffffff;
          text-shadow: 0 0 10px rgba(0,0,0,0.85);
      }
      .carton-tabla thead th .encabezado-letra {
          display: inline-block;
          transition: transform 0.25s ease, letter-spacing 0.25s ease;
      }
      .carton-tabla thead th.forma-activa .encabezado-letra {
          transform: scale(1.05);
          letter-spacing: 1.5px;
      }
      .carton-tabla.ganador thead th .encabezado-letra {
          animation: zoomPulse 1.6s ease-in-out infinite;
      }
      .carton-tabla tbody td {
          font-size: calc(var(--cell-size) * 0.55);
          transition: background 0.4s ease, transform 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
      }
      .carton-tabla td.free {
          background: radial-gradient(circle, #ffbd4f, #ffe8b3);
          color: #4B0082;
          font-size: calc(var(--cell-size) * 0.62);
          display: flex;
          align-items: center;
          justify-content: center;
      }
      #carton-destacado .carton-tabla td.free.carton-flip-trigger {
          cursor: pointer;
          animation: zoomPulse 2s ease-in-out infinite;
      }
      #carton-destacado .carton-tabla td.free.carton-flip-trigger .cell-content {
          text-shadow: 0 0 8px rgba(255,255,255,0.9), 0 0 12px rgba(75,0,130,0.75);
      }
      .carton-tabla--principal td.free .cell-content.numero-carton {
          color: #1a1a1a;
          font-weight: 700;
          text-shadow: 0 0 6px rgba(255,255,255,0.9);
          letter-spacing: 0.5px;
          font-size: clamp(0.85rem, 2.4vw, 1.15rem);
          line-height: 1.05;
          word-break: keep-all;
      }
      .carton-tabla .estrella {
          font-size: 1.2em;
          line-height: 1;
          text-shadow: 0 0 4px rgba(0,0,0,0.3);
      }
      .carton-tabla .cell-content {
          line-height: 1;
          font-weight: inherit;
          width: 100%;
          height: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
      }
      .carton-tabla td.celda-cantada {
          background: radial-gradient(circle at center, rgba(0,200,83,0.32), rgba(0,200,83,0.96));
          color: #ffffff;
          box-shadow: inset 0 0 10px rgba(0,0,0,0.45);
          border-radius: 4px;
      }
      .carton-tabla td.celda-cantada .cell-content {
          text-shadow: 0 0 6px rgba(0,0,0,0.85);
      }
      .carton-tabla td.celda-forma-activa {
          color: inherit;
          border-color: rgba(var(--forma-rgb-vivo, var(--forma-rgb, 0, 120, 255)), 0.95);
          box-shadow: inset 0 0 0 4px rgba(var(--forma-rgb, 0, 120, 255), 0.28), 0 0 10px rgba(var(--forma-rgb-vivo, var(--forma-rgb, 0, 120, 255)), 0.55);
          border-radius: 4px;
      }
      .carton-tabla td.celda-forma-activa:not(.celda-forma-solo-borde) {
          background: radial-gradient(circle at center,
              rgba(var(--forma-rgb-vivo, var(--forma-rgb, 0, 120, 255)), 0.92) 0%,
              rgba(var(--forma-rgb, 0, 120, 255), 0.98) 45%,
              rgba(var(--forma-rgb, 0, 120, 255), 0.82) 100%);
          color: #ffffff;
      }
      .carton-tabla td.celda-forma-activa::before {
          content: '';
          position: absolute;
          inset: 2px;
          border-radius: inherit;
          pointer-events: none;
          background: radial-gradient(circle, rgba(var(--forma-rgb-vivo, var(--forma-rgb, 0, 120, 255)), 0.35) 0%, rgba(var(--forma-rgb, 0, 120, 255), 0.12) 40%, transparent 72%);
      }
      .carton-tabla td.celda-forma-activa .cell-content {
          position: relative;
          z-index: 1;
          animation: zoomPulse 1.4s ease-in-out infinite;
          text-shadow: 0 0 10px rgba(0,0,0,0.9);
      }
      .carton-tabla td.celda-forma-activa:not(.celda-forma-solo-borde) .cell-content {
          color: inherit;
      }
      .carton-tabla td.celda-forma-activa.celda-forma-solo-borde::before {
          display: none;
      }
      .carton-tabla td.celda-forma-activa.celda-forma-solo-borde .cell-content {
          animation: none;
      }
      .carton-tabla td.celda-forma-temporal {
          position: relative;
      }
      .carton-tabla td.celda-forma-temporal::after {
          content: '';
          position: absolute;
          inset: 0;
          background: radial-gradient(circle, rgba(var(--forma-rgb-vivo, var(--forma-rgb, 0, 120, 255)), 0.55) 0%, rgba(var(--forma-rgb, 0, 120, 255), 0.35) 55%, transparent 90%);
          animation: formaTemporalFade 3s ease forwards;
          pointer-events: none;
          border-radius: 4px;
      }
      .carton-tabla td.celda-forma-temporal .cell-content {
          position: relative;
          z-index: 1;
          text-shadow: 0 0 6px rgba(0,0,0,0.75);
      }
      .carton-tabla--principal {
          --cell-size: var(--principal-cell-size, clamp(40px, 16vw, 80px));
      }
      .carton-tabla--mini {
          --cell-size: clamp(20px, 7.2vw, 28px);
      }
      #carton-destacado .carton-tabla {
          width: min(100%, calc(var(--principal-cell-size, var(--cell-size)) * 5));
          max-width: calc(var(--principal-cell-size, var(--cell-size)) * 5);
          margin: 0 auto;
      }
      #carton-destacado .carton-tabla thead,
      #carton-destacado .carton-tabla tbody,
      #carton-destacado .carton-tabla tr {
          display: contents;
      }
      #carton-destacado .carton-tabla thead th,
      #carton-destacado .carton-tabla tbody td {
          min-height: 0;
          height: 100%;
          width: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
          aspect-ratio: 1 / 1;
      }
      #carton-destacado .carton-tabla--principal thead th {
          font-size: calc(var(--principal-cell-size, var(--cell-size)) * 0.78);
      }
      #carton-destacado .carton-tabla--principal tbody td {
          font-size: calc(var(--principal-cell-size, var(--cell-size)) * 0.6);
      }
      #carton-destacado .carton-tabla thead th > *,
      #carton-destacado .carton-tabla tbody td > * {
          width: 100%;
          height: 100%;
      }
      #carton-destacado .carton-visor-info {
          margin-top: 6px;
      }
      .carton-visual--mini .carton-tabla {
          width: min(100%, calc(var(--cell-size) * 5));
          max-width: calc(var(--cell-size) * 5);
          margin: 0 auto;
      }
      .carton-visor-info {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
          gap: 8px 14px;
          font-size: 0.72rem;
          font-weight: 600;
          color: var(--texto-primario);
          text-align: center;
          align-items: center;
          width: min(100%, 520px);
          margin: 6px auto 0;
          justify-items: center;
      }
      .carton-visor-forma {
          grid-column: auto;
          display: inline-flex;
          align-items: baseline;
          justify-content: center;
          gap: 4px;
          font-size: 0.74rem;
          font-weight: 600;
          letter-spacing: 0.4px;
          text-shadow: 0 0 6px rgba(255,255,255,0.85);
          width: 100%;
      }
      .carton-visor-forma-label {
          font-weight: 600;
          text-shadow: 0 0 6px rgba(255,255,255,0.9);
      }
      .carton-visor-forma-valor {
          font-weight: 700;
          text-shadow: 0 0 6px rgba(255,255,255,0.9);
      }
      .carton-visor-ganadores {
          grid-column: auto;
          font-size: 0.64rem;
          font-weight: 600;
          text-align: center;
          background: transparent;
          border: none;
          padding: 0;
          cursor: pointer;
          font-family: inherit;
          transition: transform 0.2s ease;
          text-shadow: 0 0 5px rgba(255,255,255,0.75);
          justify-self: center;
      }
      .carton-visor-ganadores:hover,
      .carton-visor-ganadores:focus-visible {
          transform: translateY(-1px);
          outline: none;
      }
      .carton-visor-ganadores:disabled {
          cursor: not-allowed;
          opacity: 0.55;
          transform: none;
      }
      .carton-visor-total-label {
          grid-column: 1 / -1;
          font-size: 0.78rem;
          font-weight: 700;
          color: #138a3d;
          text-transform: uppercase;
          text-shadow: 0 0 6px rgba(255,255,255,0.85);
          justify-self: center;
      }
      .carton-visor-total-valor {
          grid-column: 1 / -1;
          font-size: 1.18rem;
          font-weight: 700;
          color: #0f8a35;
          line-height: 1.2;
          text-shadow: 0 0 8px rgba(255,255,255,0.85);
          justify-self: center;
      }
      .mensaje {
          font-size: 0.85rem;
          color: var(--texto-secundario);
      }
      .mensaje:empty {
          display: none;
      }
      #cartones-mensaje,
      #formas-mensaje {
          text-align: center;
      }
      #resultados-contenedor {
          display: none;
      }
      #login-footer {
          margin: 30px 0 10px;
          text-align: center;
      }
      #fecha-hora, #derechos {
          font-size: 0.7rem;
          color: #000;
      }
      #derechos {
          font-size: 0.6rem;
      }
      .modal {
          position: fixed;
          inset: 0;
          background: rgba(0,0,0,0.8);
          display: none;
          align-items: center;
          justify-content: center;
          z-index: 100;
          padding: 20px;
          box-sizing: border-box;
      }
      .modal.activa {
          display: flex;
      }
      .modal-contenido {
          background: #fff;
          border-radius: 18px;
          padding: 18px;
          max-width: min(720px, calc(100vw - 32px));
          width: min(720px, calc(100vw - 32px));
          max-height: min(85vh, 640px);
          overflow-y: auto;
          box-shadow: 0 10px 25px rgba(0,0,0,0.3);
          display: flex;
          flex-direction: column;
          gap: 12px;
          box-sizing: border-box;
      }
      .modal-cerrar {
          align-self: flex-end;
          background: none;
          border: none;
          font-size: 1.4rem;
          cursor: pointer;
          color: #333;
      }
      #modal-ganadores-lista {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
          gap: 12px;
      }
      .ganador-card {
          background: linear-gradient(135deg, rgba(255,255,255,0.96), rgba(240,240,240,0.96));
          border-radius: 14px;
          padding: 14px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.18);
          display: grid;
          grid-template-columns: minmax(0, 1.45fr) minmax(0, 0.75fr);
          gap: 4px 14px;
          align-items: stretch;
      }
      .ganador-card-info {
          display: flex;
          flex-direction: column;
          gap: 8px;
          align-items: center;
          grid-column: 1 / 2;
          grid-row: 1 / 3;
      }
      .ganador-info {
          font-size: 0.8rem;
          color: var(--texto-primario);
          display: flex;
          flex-direction: column;
          gap: 3px;
          text-align: center;
      }
      .ganador-info strong {
          color: #4b0082;
          font-family: 'Bangers', cursive;
          letter-spacing: 0.5px;
      }
      .ganador-premios {
          grid-column: 2 / 3;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          gap: 12px;
      }
      .ganador-premio-item {
          display: flex;
          flex-direction: column;
          align-items: center;
          text-align: center;
          gap: 4px;
      }
      .ganador-premio-label {
          font-size: 0.78rem;
          font-weight: 600;
          color: #064d1f;
          text-transform: uppercase;
          letter-spacing: 0.6px;
      }
      .ganador-premio-monto {
          font-size: clamp(1.15rem, 3vw, 1.65rem);
          font-weight: 700;
          color: #0aa128;
          text-shadow: 0 0 10px rgba(0,0,0,0.25);
          animation: zoomPulse 1.7s ease-in-out infinite;
      }
      .ganador-premio-monto--cartones {
          color: #6a0dad;
          text-shadow: none;
      }
      .modal-mensaje {
          font-size: 0.85rem;
          color: var(--texto-secundario);
      }
      @keyframes zoomPulse {
          0% { transform: scale(1); }
          48% { transform: scale(1.24); }
          100% { transform: scale(1); }
      }
      @keyframes formaTemporalFade {
          0% { opacity: 0.95; }
          60% { opacity: 0.65; }
          100% { opacity: 0; }
      }
      @keyframes focoUltimo {
          0% { transform: scale(1); }
          45% { transform: scale(1.18); }
          100% { transform: scale(1); }
      }
      @media (min-width: 820px) {
          #panel-superior {
              grid-template-columns: minmax(0, 1fr) minmax(0, clamp(260px, 40vw, 560px));
              grid-template-areas:
                  "cantos carton"
                  "mensaje carton";
          }
          #cantos-panel {
              height: 100%;
          }
          #carton-destacado {
              max-width: none;
          }
      }
      @media (max-width: 819px) {
          #panel-superior {
              row-gap: clamp(6px, 2.4vw, 12px);
              column-gap: clamp(4px, 1.6vw, 10px);
              grid-template-columns: minmax(0, 1fr) minmax(0, clamp(210px, 52vw, 420px));
              grid-template-areas:
                  "cantos carton"
                  "mensaje carton";
              align-items: start;
              justify-items: stretch;
          }
          #cantos-panel {
              height: auto;
              align-self: start;
          }
          #carton-destacado {
              max-width: none;
              justify-self: stretch;
              align-items: stretch;
              align-self: start;
              height: auto;
              margin: 0;
          }
          #carton-destacado .carton-wrapper {
              padding: 0;
          }
          #carton-destacado .carton-front,
          #carton-destacado .carton-back {
              padding: 0;
              align-items: stretch;
          }
          #carton-destacado {
              --destacado-cell-size: clamp(30px, 11.6vw, 92px);
          }
      }

      @media (max-width: 768px) {
          :root {
              --canto-size: clamp(24px, 10vw, 34px);
              --mini-cell-size: clamp(18px, 6vw, 22px);
          }
          main {
              padding: 16px 10px 14px;
          }
          .back-btn {
              width: 38px;
              height: 38px;
              font-size: 1.15rem;
          }
          #carton-destacado .carton-tabla {
              max-width: calc(var(--cell-size) * 5);
          }
          #mis-cartones-grid {
              grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
              gap: 10px;
          }
          .carton-visual {
              padding-top: 12px;
          }
          .carton-visor-info {
              grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
              gap: 6px 10px;
          }
          .carton-visor-ganadores {
              font-size: 0.6rem;
          }
          #modal-ganadores-lista {
              grid-template-columns: 1fr;
          }
          .ganador-card {
              grid-template-columns: 1fr;
          }
      }
      @media (max-width: 480px) {
          #panel-superior {
              row-gap: clamp(8px, 3vw, 14px);
          }
      }
      @media (orientation: portrait) {
          #panel-superior {
              grid-template-columns: minmax(calc(var(--canto-cell-size) * 5 + clamp(6px, 2vw, 16px)), 1fr) minmax(var(--panel-columna-derecha-min, clamp(180px, 48vw, 420px)), clamp(240px, 68vw, 520px));
              grid-template-areas:
                  "cantos carton"
                  "mensaje carton";
              align-items: stretch;
              justify-items: stretch;
              column-gap: clamp(6px, 2vw, 16px);
              row-gap: clamp(6px, 2vw, 16px);
              padding-bottom: 0;
          }
          #cantos-panel {
              grid-area: cantos;
          }
          #carton-destacado {
              grid-area: carton;
              justify-self: stretch;
          }
          #formas-mensaje {
              grid-area: mensaje;
          }
          #panel-botones-formas {
              grid-area: botones;
              justify-self: stretch;
              align-self: stretch;
              align-items: center;
              width: 100%;
              max-width: 100%;
              margin: 0;
          }
          #panel-botones-formas.flotante-vertical {
              position: absolute;
              left: var(--panel-botones-left, 50%);
              top: calc(var(--panel-botones-top, 100%) + var(--panel-botones-separacion, 6px));
              transform: translateX(-50%);
              margin: 0;
              padding: 0;
              border: none;
              background: transparent;
              box-shadow: none;
              backdrop-filter: none;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: flex-start;
              gap: var(--panel-botones-gap, 4px);
              z-index: 40;
              pointer-events: auto;
              width: auto;
              max-width: 100%;
          }
          #panel-botones-formas.flotante-vertical:empty {
              display: none;
          }
          #panel-botones-formas.flotante-vertical .panel-botones-formas__envoltorio,
          #panel-botones-formas.flotante-vertical .panel-botones-formas__grid {
              width: auto;
              max-width: 100%;
              margin: 0;
              padding: 0;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: flex-start;
              gap: var(--panel-botones-gap, 4px);
          }
          #panel-botones-formas.flotante-vertical .panel-botones-formas__grid {
              align-items: center;
          }
          #panel-botones-formas.flotante-vertical .carton-forma-accion {
              flex: 0 0 auto;
              width: auto;
              min-width: 0;
              max-width: 100%;
              pointer-events: auto;
              white-space: nowrap;
              align-self: center;
          }
          #panel-botones-formas .carton-forma-accion {
              align-self: center;
          }
          #cantos-panel {
              width: 100%;
              min-width: 0;
          }
          #carton-destacado {
              justify-self: stretch;
              align-self: start;
              margin: 0;
              width: 100%;
              max-width: none;
              height: auto;
          }
          #carton-destacado .carton-box {
              margin: 0;
              width: 100%;
              max-width: 100%;
              align-items: flex-start;
          }
          #carton-destacado .carton-wrapper {
              width: 100%;
              max-width: 100%;
              padding: 0;
              display: grid;
              grid-template-columns: 1fr;
              grid-template-rows: auto;
              --carton-wrapper-altura: auto;
          }
          #carton-destacado .carton-wrapper::before {
              content: none;
          }
          #carton-destacado .carton-front,
          #carton-destacado .carton-back {
              inset: auto;
              padding: 0;
              position: relative;
              grid-area: 1 / 1 / 2 / 2;
              height: auto;
          }
          #carton-destacado .carton-front {
              gap: 0;
              padding: clamp(2px, 0.6vw, 2px);
              margin-bottom: 0;
              justify-content: flex-start;
          }
          #carton-destacado .carton-visual {
              gap: clamp(0px, 0.6vw, 3px);
              padding-top: clamp(4px, 1.2vw, 8px);
          }
          #carton-destacado .carton-front .carton-visual {
              --carton-principal-padding: clamp(2px, 0.6vw, 2px);
              gap: 0;
              padding: var(--carton-principal-padding);
              margin-bottom: 0;
              aspect-ratio: auto;
              justify-items: stretch;
              overflow: visible;
              grid-template-rows: min-content minmax(0, 1fr);
              align-content: stretch;
          }
          #carton-destacado .carton-front .carton-visual > * {
              margin: 0;
          }
          #carton-destacado .carton-front .carton-visual .carton-tabla {
              margin-bottom: 0;
              width: 100%;
              max-width: var(--carton-destacado-max-width);
              height: auto;
              max-height: none;
              aspect-ratio: 5 / 6;
              display: grid;
              grid-template-columns: repeat(5, 1fr);
              grid-template-rows: repeat(6, 1fr);
              grid-auto-flow: row;
              grid-auto-rows: 1fr;
              align-self: stretch;
              justify-self: center;
              margin-left: auto;
              margin-right: auto;
          }
          #carton-destacado .carton-front .carton-visual .carton-tabla > * {
              min-width: 0;
              min-height: 0;
          }
          #carton-destacado .carton-front .carton-visual .carton-tabla thead th,
          #carton-destacado .carton-front .carton-visual .carton-tabla tbody td {
              width: 100%;
              height: 100%;
          }
          #carton-destacado {
              --destacado-cell-size: clamp(40px, 14vw, 120px);
          }
        #carton-destacado .carton-back-content {
            margin: clamp(10px, 3vw, 18px) clamp(14px, 4vw, 22px);
            gap: clamp(8px, 2.6vw, 16px);
            align-items: stretch;
        }
        #carton-destacado .carton-back-title {
            margin: 0;
            text-align: center;
            align-self: stretch;
        }
        #carton-destacado .carton-back-formas {
            gap: clamp(6px, 2vw, 12px);
            align-items: stretch;
            width: 100%;
        }
        #carton-destacado .back-forma-line {
            justify-content: flex-start;
            align-items: baseline;
            gap: clamp(6px, 3vw, 14px);
            font-size: clamp(1rem, 4.4vw, 1.35rem);
            text-align: left;
        }
        #carton-destacado .carton-back-total {
            flex-direction: column;
            align-items: stretch;
            gap: clamp(2px, 1.6vw, 6px);
            text-align: center;
        }
        #carton-destacado .carton-back-total-label,
        #carton-destacado .carton-back-total-valor {
            display: block;
            width: 100%;
            text-align: center;
        }
        #carton-destacado .back-forma-line .back-forma-etiqueta,
        #carton-destacado .back-forma-line .back-forma-valor {
            text-align: left;
        }
            #carton-destacado .carton-front .carton-visual .carton-tabla {
                height: auto;
                max-height: none;
                justify-self: center;
                transform-origin: top center;
                transform: none;
                margin-left: auto;
                margin-right: auto;
            }
          #carton-destacado .carton-front .carton-visual .carton-tabla tbody td {
              aspect-ratio: 1 / 1;
          }
          #carton-destacado .carton-visor-info {
              margin-top: clamp(1px, 0.8vw, 5px);
              gap: clamp(2px, 1vw, 6px);
          }
          #cantos-panel,
          #formas-mensaje {
              width: 100%;
          }
          .modal {
              justify-content: flex-start;
              align-items: flex-start;
              padding: clamp(16px, 5vw, 28px);
          }
          .modal-contenido {
              margin-left: 0;
          }
      }
      @media (orientation: landscape) {
          #panel-superior {
              grid-template-columns: minmax(calc(var(--canto-cell-size) * 5 + clamp(6px, 1.6vw, 18px)), clamp(320px, 52vw, 580px)) minmax(var(--panel-columna-derecha-min, clamp(240px, 32vw, 520px)), clamp(340px, 48vw, 640px));
              grid-template-areas:
                  "cantos carton"
                  "mensaje carton";
              align-items: stretch;
              justify-items: stretch;
              column-gap: clamp(6px, 1.6vw, 18px);
              row-gap: clamp(6px, 1.2vw, 14px);
              padding-bottom: 0;
          }
          #panel-columna-derecha {
              padding-inline: clamp(12px, 3vw, 32px);
              box-sizing: border-box;
          }
          .panel-columna-derecha__destacado {
              align-items: center;
          }
          #cantos-panel {
              grid-area: cantos;
              width: 100%;
              min-width: 0;
          }
          #carton-destacado {
              grid-area: carton;
              justify-self: center;
              align-self: stretch;
              margin: 0 auto;
              --carton-destacado-max-width: clamp(320px, 46vw, 560px);
              width: min(100%, var(--carton-contenido-ancho, var(--carton-destacado-max-width)));
              max-width: var(--carton-contenido-ancho, var(--carton-destacado-max-width));
              align-items: center;
              --destacado-cell-size: clamp(40px, 11vw, 108px);
          }
          #carton-destacado .carton-box,
          #carton-destacado .carton-wrapper,
          #carton-destacado .carton-front,
          #carton-destacado .carton-back,
          #carton-destacado .carton-front .carton-visual,
          #carton-destacado .carton-visor-info {
              margin-left: auto;
              margin-right: auto;
              width: min(100%, var(--carton-contenido-ancho, 100%));
              max-width: var(--carton-contenido-ancho, 100%);
          }
          #carton-destacado .carton-box,
          #carton-destacado .carton-wrapper {
              min-width: 0;
              align-items: stretch;
          }
          #carton-destacado .carton-front .carton-visual {
              align-self: stretch;
              width: 100%;
              max-width: var(--carton-contenido-ancho, 100%);
              gap: clamp(0px, 0.6vw, 4px);
              padding: clamp(4px, 1vw, 8px);
              grid-template-rows: min-content minmax(0, 1fr);
              align-content: stretch;
              justify-items: stretch;
              overflow: visible;
          }
          #carton-destacado .carton-front,
          #carton-destacado .carton-back {
              min-height: var(--carton-contenido-alto, auto);
              overflow: visible;
              display: flex;
              flex-direction: column;
              align-items: stretch;
              justify-content: flex-start;
          }
          #carton-destacado .carton-front {
              gap: clamp(0px, 0.6vw, 4px);
              justify-content: flex-start;
          }
          #carton-destacado .carton-front .carton-visual > * {
              margin: 0;
          }
          #carton-destacado .carton-wrapper::before {
              padding-bottom: var(--carton-contenido-alto, var(--carton-wrapper-altura));
          }
          #carton-destacado .carton-front .carton-visual .carton-tabla {
              width: 100%;
              max-width: 100%;
              height: auto;
              max-height: none;
              display: grid;
              grid-template-columns: repeat(5, 1fr);
              grid-template-rows: repeat(6, 1fr);
              grid-auto-flow: row;
              grid-auto-rows: 1fr;
              aspect-ratio: 5 / 6;
              align-self: stretch;
              justify-self: center;
          }
          #carton-destacado .carton-front .carton-visual .carton-tabla > * {
              min-width: 0;
              min-height: 0;
          }
          #carton-destacado .carton-front .carton-visual .carton-tabla thead th,
          #carton-destacado .carton-front .carton-visual .carton-tabla tbody td {
              width: 100%;
              height: 100%;
          }
          #carton-destacado .carton-back-content {
              padding: clamp(12px, 3vw, 24px) clamp(16px, 4vw, 28px);
              gap: clamp(8px, 2vw, 16px);
              align-items: stretch;
          }
          #carton-destacado .carton-back-formas {
              gap: clamp(6px, 2vw, 12px);
              align-items: stretch;
              width: 100%;
          }
          #carton-destacado .back-forma-line {
              justify-content: flex-start;
              align-items: baseline;
              gap: clamp(6px, 2.8vw, 14px);
              text-align: left;
          }
          #carton-destacado .back-forma-line .back-forma-etiqueta,
          #carton-destacado .back-forma-line .back-forma-valor {
              text-align: left;
          }
          #carton-destacado .carton-back-title {
              font-size: clamp(0.92rem, 3vw, 1.18rem);
              line-height: 1.1;
          }
          #carton-destacado .carton-back-total-label {
              font-size: clamp(0.88rem, 2.6vw, 1.12rem);
              line-height: 1.1;
          }
          #carton-destacado .carton-back-total-valor {
              font-size: clamp(1.2rem, 3.4vw, 1.68rem);
              line-height: 1.05;
          }
          #carton-destacado .carton-tabla--principal td.free .cell-content.numero-carton {
              font-size: clamp(0.72rem, calc(var(--destacado-cell-size) * 0.22), 0.98rem);
              letter-spacing: 0.4px;
          }
          #carton-destacado .carton-back-total {
              flex-direction: column;
              align-items: stretch;
              gap: clamp(2px, 1.2vw, 6px);
              text-align: center;
          }
          #carton-destacado .carton-back-total-label,
          #carton-destacado .carton-back-total-valor {
              display: block;
              width: 100%;
              text-align: center;
          }
          #formas-mensaje {
              grid-area: mensaje;
              align-self: stretch;
          }
          #panel-botones-formas {
              grid-area: botones;
              justify-self: stretch;
              align-self: start;
              align-items: flex-start;
              width: 100%;
              max-width: 100%;
              margin: 0;
          }
          #panel-botones-formas.flotante-vertical {
              position: absolute;
              left: var(--panel-botones-left, 50%);
              top: calc(var(--panel-botones-top, 100%) + var(--panel-botones-separacion, 8px));
              transform: translateX(-50%);
              margin: 0;
              padding: 0;
              border: none;
              background: transparent;
              box-shadow: none;
              backdrop-filter: none;
              display: flex;
              flex-direction: row;
              flex-wrap: wrap;
              align-items: center;
              justify-content: center;
              gap: var(--panel-botones-gap, 6px);
              z-index: 40;
              pointer-events: auto;
              width: auto;
              max-width: min(100%, clamp(280px, 62vw, 540px));
          }
          #panel-botones-formas.flotante-vertical:empty {
              display: none;
          }
          #panel-botones-formas.flotante-vertical .panel-botones-formas__envoltorio,
          #panel-botones-formas.flotante-vertical .panel-botones-formas__grid {
              width: auto;
              max-width: 100%;
              margin: 0;
              padding: 0;
              display: flex;
              flex-direction: row;
              flex-wrap: wrap;
              align-items: center;
              justify-content: center;
              gap: var(--panel-botones-gap, 6px);
          }
          #panel-botones-formas.flotante-vertical .carton-forma-accion {
              flex: 0 0 auto;
              min-width: clamp(120px, 22vw, 220px);
              max-width: 100%;
              pointer-events: auto;
              white-space: nowrap;
          }
          #panel-botones-formas .carton-forma-accion {
              align-self: center;
          }
          #formas-mensaje {
              width: 100%;
          }
          #carton-destacado .carton-visor-info {
              margin-top: clamp(2px, 0.8vw, 6px);
              gap: clamp(3px, 1vw, 8px);
          }
          .modal {
              justify-content: flex-start;
              align-items: flex-start;
              padding: clamp(16px, 4.2vw, 28px);
          }
          .modal-contenido {
              margin-left: 0;
          }
      }
        @media (orientation: landscape) and (max-width: 900px) {
            :root {
                --canto-size: clamp(24px, 7vw, 34px);
                --mini-cell-size: clamp(18px, 4.8vw, 22px);
            }
            main {
                padding-top: 46px;
            }
            #panel-superior {
                column-gap: clamp(4px, 1.4vw, 12px);
                row-gap: clamp(6px, 1.2vw, 12px);
                grid-template-columns: minmax(calc(var(--canto-cell-size) * 5 + clamp(6px, 1.6vw, 16px)), 1fr) minmax(var(--panel-columna-derecha-min, clamp(220px, 44vw, 520px)), clamp(320px, 58vw, 560px));
                grid-template-areas:
                    "cantos carton"
                    "mensaje carton";
            }
            #panel-columna-derecha {
                margin-left: 0;
            }
            #carton-destacado {
                --carton-contenido-ancho: clamp(320px, 90vw, 520px);
                --carton-contenido-alto: clamp(320px, 78vh, 420px);
                --carton-principal-padding: clamp(4px, 1vw, 8px);
                margin-inline: auto;
            }
            #carton-destacado .carton-wrapper {
                --carton-wrapper-altura: var(--carton-contenido-alto);
            }
            #carton-destacado .carton-front,
            #carton-destacado .carton-back {
                border-radius: clamp(10px, 3vw, 16px);
            }
            #carton-destacado .carton-front {
                justify-content: center;
                padding: clamp(4px, 1vw, 8px);
            }
            #carton-destacado .carton-front .carton-visual {
                justify-content: center;
                padding: clamp(4px, 1vw, 8px);
                gap: clamp(0px, 0.6vw, 4px);
            }
            #carton-destacado .carton-tabla--principal thead th {
                font-size: calc(var(--principal-cell-size, var(--cell-size)) * 0.78);
            }
            #carton-destacado .carton-tabla--principal tbody td {
                font-size: calc(var(--principal-cell-size, var(--cell-size)) * 0.62);
            }
            #mis-cartones-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 8px;
            }
            #carton-destacado {
                --destacado-cell-size: clamp(40px, 10.4vw, 100px);
            }
        }
        @media (min-width: 900px) and (orientation: landscape) {
            #panel-superior {
                column-gap: clamp(6px, 1.4vw, 18px);
                row-gap: clamp(6px, 1.2vw, 14px);
                grid-template-columns: minmax(calc(var(--canto-cell-size) * 5 + clamp(6px, 1.4vw, 18px)), clamp(360px, 48vw, 640px)) minmax(var(--panel-columna-derecha-min, clamp(280px, 32vw, 560px)), clamp(360px, 44vw, 640px));
                grid-template-areas:
                    "cantos carton"
                    "mensaje carton";
            }
            #panel-columna-derecha {
                margin-left: 0;
            }
            #carton-destacado {
                --destacado-cell-size: clamp(46px, 7.4vw, 112px);
            }
            #carton-destacado .carton-tabla--principal thead th {
                font-size: calc(var(--principal-cell-size, var(--cell-size)) * 0.8);
            }
            #carton-destacado .carton-tabla--principal tbody td {
                font-size: calc(var(--principal-cell-size, var(--cell-size)) * 0.64);
            }
        }
  </style>
</head>
<body>
  <button id="volver-btn" class="menu-btn back-btn" aria-label="Volver">&#9664;</button>
  <main>
    <header id="sorteo-header">
      <div id="sorteo-resumen" class="sorteo-titulo-basico">Cargando sorteo en vivo...</div>
      <div id="sorteo-detalles"></div>
    </header>
    <section id="panel-superior">
      <div id="cantos-panel">
        <div id="cantos-grid"></div>
        <div id="ultimo-canto"></div>
      </div>
      <div id="formas-mensaje" class="mensaje"></div>
      <div id="panel-columna-derecha">
        <div class="panel-columna-derecha__rejilla panel-columna-derecha__destacado">
          <aside id="carton-destacado" aria-live="polite"></aside>
        </div>
        <div class="panel-columna-derecha__rejilla panel-columna-derecha__modales">
          <div id="panel-botones-formas" role="region" aria-label="Ganadores por forma"></div>
        </div>
      </div>
    </section>
    <section id="mis-cartones-section">
      <h2>MIS CARTONES EN EL SORTEO</h2>
      <div id="cartones-mensaje" class="mensaje"></div>
      <div id="mis-cartones-grid" aria-live="polite"></div>
    </section>
  </main>

  <div id="login-footer">
    <div id="fecha-hora"></div>
    <div id="derechos">Todos los derechos reservados  Hexaservice 2025</div>
  </div>

  <div id="modal-ganadores" class="modal">
    <div class="modal-contenido">
      <button class="modal-cerrar" id="modal-cerrar"></button>
      <h2 id="modal-titulo">Ganadores</h2>
      <div id="modal-subtitulo" class="mensaje"></div>
      <div id="modal-ganadores-lista"></div>
      <div id="modal-sin-ganadores" class="modal-mensaje"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-auth-compat.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/timezone.js"></script>
  <script>
  ensureAuth();
  initFechaHora('fecha-hora');

  const volverBtn = document.getElementById('volver-btn');
  volverBtn.addEventListener('click',()=>{window.location.href='player.html';});

  const cantosGridEl = document.getElementById('cantos-grid');
  const ultimoCantoEl = document.getElementById('ultimo-canto');
  const sorteoResumenEl = document.getElementById('sorteo-resumen');
  const sorteoDetallesEl = document.getElementById('sorteo-detalles');
  const panelSuperiorEl = document.getElementById('panel-superior');
  const cantosPanelEl = document.getElementById('cantos-panel');
  const panelBotonesFormasEl = document.getElementById('panel-botones-formas');
  const formasMensajeEl = document.getElementById('formas-mensaje');
  const misCartonesSectionEl = document.getElementById('mis-cartones-section');
  const misCartonesGridEl = document.getElementById('mis-cartones-grid');
  const cartonesMensajeEl = document.getElementById('cartones-mensaje');
  const cartonDestacadoEl = document.getElementById('carton-destacado');
  const modalGanadores = document.getElementById('modal-ganadores');
  const modalCerrarBtn = document.getElementById('modal-cerrar');
  const modalTituloEl = document.getElementById('modal-titulo');
  const modalSubtituloEl = document.getElementById('modal-subtitulo');
  const modalListaEl = document.getElementById('modal-ganadores-lista');
  const modalSinGanadoresEl = document.getElementById('modal-sin-ganadores');

  const FORM_COLORS = ['#90ee90', '#fffacd', '#add8e6', '#d8b0ff', '#ffcc99', '#f77fb3', '#9ad3bc', '#fecf6a'];
  const BINGO_LETRAS = ['B','I','N','G','O'];

  const cantoCellsMap = new Map();
  let cantosOrdenados = [];
  let cantosEtiquetas = [];
  let cantosIndiceMap = new Map();
  let formasActivas = [];
  let cartonesSorteo = new Map();
  let cartonesGanadoresPorForma = new Map();
  let formasPorCarton = new Map();
  let activeSorteo = null;
  let activeSorteoId = null;
  let usuarioActual = null;

  let cartonSeleccionadoId = null;
  const animacionesCartones = new Map();
  let cartonPrincipalInfo = null;
  let resaltadoTemporal = {timer:null, tablas:null, cartonId:null};
  let formaDestacadaSeleccionada = null;
  let evitarReaplicarFormaDestacada = false;

  let recalculoAlturaCartonProgramado = false;
  const actualizarAlturaBotonesRetrato = () => {
    if(!panelSuperiorEl || !panelBotonesFormasEl) return;
    requestAnimationFrame(() => {
      panelBotonesFormasEl.classList.remove('flotante-vertical');
      panelBotonesFormasEl.classList.remove('flotante');
      panelBotonesFormasEl.style.removeProperty('--panel-botones-left');
      panelBotonesFormasEl.style.removeProperty('--panel-botones-gap');
      panelBotonesFormasEl.style.removeProperty('width');
      panelBotonesFormasEl.style.removeProperty('max-width');
      panelSuperiorEl.style.removeProperty('--panel-botones-top');
      panelSuperiorEl.style.removeProperty('--panel-botones-separacion');
      panelSuperiorEl.style.removeProperty('--panel-botones-altura');
      panelSuperiorEl.style.removeProperty('--panel-columna-derecha-min');
    });
  };

  function actualizarAlturaCartonWrapper(wrapper){
    if(!wrapper) return;
    const enModoRetrato = window.matchMedia('(orientation: portrait)').matches;
    requestAnimationFrame(()=>{
      const valorPrevio=wrapper.style.getPropertyValue('--carton-wrapper-altura');
      const valorAlturaPrevio=wrapper.style.getPropertyValue('--carton-contenido-alto');
      const cartonBox=wrapper.parentElement;
      const cartonDestacadoContenedor=cartonDestacadoEl||wrapper.closest('#carton-destacado');
      const valorCeldaInline=cartonDestacadoContenedor?.style?.getPropertyValue('--destacado-cell-size')||'';
      const valorCeldaInlineNumero=valorCeldaInline?parseFloat(valorCeldaInline):NaN;
      if(enModoRetrato && cartonDestacadoContenedor && valorCeldaInline){
        cartonDestacadoContenedor.style.removeProperty('--destacado-cell-size');
      }
      wrapper.style.removeProperty('--carton-wrapper-altura');
      wrapper.style.removeProperty('--carton-contenido-alto');
      const estilos=getComputedStyle(wrapper);
      const alturaBase=parseFloat(estilos.getPropertyValue('--carton-wrapper-altura'))||0;
      const frente=wrapper.querySelector('.carton-front');
      const reverso=wrapper.querySelector('.carton-back');
      const elementosAltura=[cartonBox, cartonDestacadoContenedor];
      const valoresAlturaAnteriores=elementosAltura.map(el=>el?.style?.getPropertyValue('--carton-contenido-alto')||'');
      elementosAltura.forEach(el=>el?.style?.removeProperty('--carton-contenido-alto'));
      const estilosCartonDestacado=cartonDestacadoContenedor?getComputedStyle(cartonDestacadoContenedor):null;
      const tamanoCeldaActual=estilosCartonDestacado?parseFloat(estilosCartonDestacado.getPropertyValue('--destacado-cell-size')):NaN;
      const rectContenedor=cartonDestacadoContenedor?cartonDestacadoContenedor.getBoundingClientRect():null;
      const anchoFrente=frente?frente.getBoundingClientRect().width:0;
      if(anchoFrente>0){
        const anchoFinal=Math.ceil(anchoFrente);
        const anchoValor=`${anchoFinal}px`;
        wrapper.style.setProperty('--carton-contenido-ancho', anchoValor);
        if(cartonBox) cartonBox.style.setProperty('--carton-contenido-ancho', anchoValor);
        if(cartonDestacadoContenedor) cartonDestacadoContenedor.style.setProperty('--carton-contenido-ancho', anchoValor);
      }else{
        wrapper.style.removeProperty('--carton-contenido-ancho');
        if(cartonBox) cartonBox.style.removeProperty('--carton-contenido-ancho');
        if(cartonDestacadoContenedor) cartonDestacadoContenedor.style.removeProperty('--carton-contenido-ancho');
      }
      const altoFrente=frente?frente.scrollHeight:0;
      const altoReverso=reverso?reverso.scrollHeight:0;
      const alturaCalculada=Math.max(altoFrente, altoReverso, 0);
      let alturaDisponiblePaisaje=0;
      if(!enModoRetrato){
        const margenInferiorPaisaje=16;
        if(rectContenedor){
          alturaDisponiblePaisaje=Math.max(260, window.innerHeight - rectContenedor.top - margenInferiorPaisaje);
        }else{
          alturaDisponiblePaisaje=Math.max(260, Math.floor(window.innerHeight*0.85));
        }
      }
      if(!enModoRetrato && cartonDestacadoContenedor && alturaDisponiblePaisaje>0 && alturaCalculada>0){
        if(alturaCalculada>alturaDisponiblePaisaje+8 && tamanoCeldaActual && !Number.isNaN(tamanoCeldaActual)){
          const escalaBruta=alturaDisponiblePaisaje/alturaCalculada;
          const escalaLimitada=Math.max(0.6, Math.min(escalaBruta,1));
          const nuevoTamanoCelda=Math.max(32, Math.round(tamanoCeldaActual*escalaLimitada));
          if(!valorCeldaInline || Math.abs(nuevoTamanoCelda-(Number.isNaN(valorCeldaInlineNumero)?nuevoTamanoCelda:valorCeldaInlineNumero))>=1){
            cartonDestacadoContenedor.style.setProperty('--destacado-cell-size', `${nuevoTamanoCelda}px`);
            if(valorPrevio){
              wrapper.style.setProperty('--carton-wrapper-altura', valorPrevio);
            }
            if(valorAlturaPrevio){
              wrapper.style.setProperty('--carton-contenido-alto', valorAlturaPrevio);
            }
            elementosAltura.forEach((el,idx)=>{
              const valorPrevioAltura=valoresAlturaAnteriores[idx];
              if(!el) return;
              if(valorPrevioAltura){
                el.style.setProperty('--carton-contenido-alto', valorPrevioAltura);
              }else{
                el.style.removeProperty('--carton-contenido-alto');
              }
            });
            actualizarAlturaBotonesRetrato();
            requestAnimationFrame(()=>actualizarAlturaCartonWrapper(wrapper));
            return;
          }
        }else if(valorCeldaInline && alturaDisponiblePaisaje-alturaCalculada>40){
          cartonDestacadoContenedor.style.removeProperty('--destacado-cell-size');
          if(valorPrevio){
            wrapper.style.setProperty('--carton-wrapper-altura', valorPrevio);
          }
          if(valorAlturaPrevio){
            wrapper.style.setProperty('--carton-contenido-alto', valorAlturaPrevio);
          }
          elementosAltura.forEach((el,idx)=>{
            const valorPrevioAltura=valoresAlturaAnteriores[idx];
            if(!el) return;
            if(valorPrevioAltura){
              el.style.setProperty('--carton-contenido-alto', valorPrevioAltura);
            }else{
              el.style.removeProperty('--carton-contenido-alto');
            }
          });
          actualizarAlturaBotonesRetrato();
          requestAnimationFrame(()=>actualizarAlturaCartonWrapper(wrapper));
          return;
        }
      }
      if(alturaCalculada>0){
        const margenExtra=enModoRetrato?2:8;
        const alturaObjetivo=Math.max(0, Math.ceil(alturaCalculada+margenExtra));
        const alturaFinal=enModoRetrato?Math.max(alturaBase, alturaObjetivo):alturaObjetivo;
        wrapper.style.setProperty('--carton-wrapper-altura', `${alturaFinal}px`);
        const alturaValor=`${alturaFinal}px`;
        wrapper.style.setProperty('--carton-contenido-alto', alturaValor);
        elementosAltura.forEach(el=>el?.style?.setProperty('--carton-contenido-alto', alturaValor));
      }else{
        if(valorPrevio){
          wrapper.style.setProperty('--carton-wrapper-altura', valorPrevio);
        }else if(alturaBase){
          wrapper.style.setProperty('--carton-wrapper-altura', `${alturaBase}px`);
        }else{
          wrapper.style.removeProperty('--carton-wrapper-altura');
        }
        if(valorAlturaPrevio){
          wrapper.style.setProperty('--carton-contenido-alto', valorAlturaPrevio);
        }else{
          wrapper.style.removeProperty('--carton-contenido-alto');
        }
        elementosAltura.forEach((el,idx)=>{
          const valorPrevioAltura=valoresAlturaAnteriores[idx];
          if(!el) return;
          if(valorPrevioAltura){
            el.style.setProperty('--carton-contenido-alto', valorPrevioAltura);
          }else{
            el.style.removeProperty('--carton-contenido-alto');
          }
        });
      }
      actualizarAlturaBotonesRetrato();
    });
  }

  function programarRecalculoAlturaCarton(){
    if(recalculoAlturaCartonProgramado) return;
    recalculoAlturaCartonProgramado=true;
    requestAnimationFrame(()=>{
      recalculoAlturaCartonProgramado=false;
      const wrapperActual=cartonPrincipalInfo?.info?.wrapper;
      if(wrapperActual){
        actualizarAlturaCartonWrapper(wrapperActual);
      }
    });
  }

  window.addEventListener('resize', programarRecalculoAlturaCarton);
  window.addEventListener('orientationchange', programarRecalculoAlturaCarton);
  window.addEventListener('load', programarRecalculoAlturaCarton);
  window.addEventListener('resize', actualizarAlturaBotonesRetrato);
  window.addEventListener('orientationchange', actualizarAlturaBotonesRetrato);
  window.addEventListener('load', actualizarAlturaBotonesRetrato);

  let unsubscribeSorteos = null;
  let unsubscribeCantos = null;
  let unsubscribeFormas = null;
  let unsubscribeCartones = null;

  function limpiarBotonesFormas(){
    if(panelBotonesFormasEl){
      panelBotonesFormasEl.innerHTML='';
      actualizarAlturaBotonesRetrato();
      return;
    }
    if(!panelSuperiorEl) return;
    panelSuperiorEl.querySelectorAll('.carton-forma-accion[data-forma-boton="dinamico"]').forEach(boton=>boton.remove());
    actualizarAlturaBotonesRetrato();
  }

  function insertarBotonesFormas(botones){
    if(!cartonDestacadoEl || !Array.isArray(botones)) return;
    const botonesValidos=botones.filter(boton=>boton instanceof HTMLElement);
    if(panelBotonesFormasEl){
      panelBotonesFormasEl.innerHTML='';
      if(botonesValidos.length===0){
        actualizarAlturaBotonesRetrato();
        return;
      }
      const envoltorio=document.createElement('div');
      envoltorio.className='panel-botones-formas__envoltorio';
      const rejilla=document.createElement('div');
      rejilla.className='panel-botones-formas__grid';
      envoltorio.appendChild(rejilla);
      botonesValidos.forEach(boton=>{
        boton.dataset.formaBoton='dinamico';
        rejilla.appendChild(boton);
      });
      panelBotonesFormasEl.appendChild(envoltorio);
      actualizarAlturaBotonesRetrato();
      return;
    }
    if(!panelSuperiorEl) return;
    let referencia=cartonDestacadoEl;
    if(botonesValidos.length===0){
      actualizarAlturaBotonesRetrato();
      return;
    }
    const envoltorio=document.createElement('div');
    envoltorio.className='panel-botones-formas__envoltorio';
    const rejilla=document.createElement('div');
    rejilla.className='panel-botones-formas__grid';
    envoltorio.appendChild(rejilla);
    referencia.insertAdjacentElement('afterend', envoltorio);
    referencia=envoltorio;
    botonesValidos.forEach(boton=>{
      boton.dataset.formaBoton='dinamico';
      rejilla.appendChild(boton);
    });
    actualizarAlturaBotonesRetrato();
  }

  function crearGridCantos(){
    cantosGridEl.innerHTML='';
    cantoCellsMap.clear();
    BINGO_LETRAS.forEach(letra=>{
      const celda=document.createElement('div');
      celda.textContent=letra;
      celda.className='canto-cell encabezado';
      cantosGridEl.appendChild(celda);
    });
    for(let fila=0;fila<15;fila++){
      for(let col=0;col<5;col++){
        const numero=fila+1+col*15;
        const celda=document.createElement('div');
        celda.textContent=String(numero).padStart(2,'0');
        celda.dataset.numero=numero;
        celda.title=generarEtiquetaDesdeNumero(numero);
        celda.className='canto-cell';
        cantosGridEl.appendChild(celda);
        cantoCellsMap.set(numero,celda);
      }
    }
  }

  function obtenerColorParaForma(idx){
    const numero=Number(idx);
    if(Number.isFinite(numero) && numero>0){
      const posicion=(numero-1)%FORM_COLORS.length;
      return FORM_COLORS[posicion];
    }
    return FORM_COLORS[0];
  }

  function obtenerColorOscurecido(colorHex, factor=0.65){
    if(typeof colorHex!=='string') return '#2f2f2f';
    const limpio=colorHex.trim();
    const match=limpio.match(/^#?([0-9a-fA-F]{6})$/);
    if(!match) return limpio || '#2f2f2f';
    const hex=match[1];
    const ajustar=indice=>{
      const valor=parseInt(hex.slice(indice, indice+2),16);
      const reducido=Math.max(0, Math.min(255, Math.round(valor*factor)));
      return reducido.toString(16).padStart(2,'0');
    };
    return `#${ajustar(0)}${ajustar(2)}${ajustar(4)}`;
  }

  function normalizarTipoCarton(carton){
    const valorBruto = carton?.tipocarton ?? carton?.tipoCarton ?? carton?.tipo ?? carton?.categoria;
    const texto=String(valorBruto ?? '').trim().toLowerCase();
    if(['gratis','free','libre','sin costo','sin-costo','freebie'].includes(texto)){
      return 'gratis';
    }
    return 'pagado';
  }

  function normalizarPosicionesEntrada(posiciones){
    const lista=Array.isArray(posiciones)?posiciones:[];
    const resultado=[];
    lista.forEach(pos=>{
      if(!pos) return;
      const fila=Number(pos.r ?? pos.row ?? pos.fila);
      const col=Number(pos.c ?? pos.col ?? pos.columna);
      if(Number.isInteger(fila) && Number.isInteger(col)){
        resultado.push({r:fila, c:col});
      }
    });
    return resultado;
  }

  function obtenerPosicionesNormalizadas(forma){
    if(!forma) return [];
    if(Array.isArray(forma.posicionesNormalizadas) && forma.posicionesNormalizadas.length){
      return normalizarPosicionesEntrada(forma.posicionesNormalizadas);
    }
    if(Array.isArray(forma.posiciones) && forma.posiciones.length){
      return normalizarPosicionesEntrada(forma.posiciones);
    }
    return [];
  }

  function obtenerRgbTexto(hex, fallback='0,120,255'){
    const rgb=hexToRgb(hex);
    if(!rgb) return fallback;
    return `${rgb.r},${rgb.g},${rgb.b}`;
  }

  function obtenerRgbVivoTexto(hex){
    const rgb=hexToRgb(hex);
    if(!rgb) return null;
    const intensificar=valor=>Math.min(255, Math.round(valor*1.12 + 18));
    return `${intensificar(rgb.r)},${intensificar(rgb.g)},${intensificar(rgb.b)}`;
  }

  function actualizarEncabezadoForma(info, indice, colorHex){
    if(!info || !Array.isArray(info.letras)) return;
    const indiceNormalizado=Number(indice);
    const idxActivo=Number.isInteger(indiceNormalizado)?indiceNormalizado:null;
    info.letras.forEach((span, idx)=>{
      if(!span) return;
      const letraBase=BINGO_LETRAS[idx] || '';
      const th=span.closest('th');
      const activo=idxActivo===idx+1;
      span.textContent=letraBase;
      span.classList.toggle('encabezado-letra-activa', activo);
      if(th){
        th.classList.toggle('forma-activa', activo);
        th.setAttribute('aria-pressed', activo?'true':'false');
        if(activo && colorHex){
          const rgbBasico=obtenerRgbTexto(colorHex);
          const rgbVivo=obtenerRgbVivoTexto(colorHex) || rgbBasico;
          if(rgbBasico) th.style.setProperty('--forma-rgb', rgbBasico);
          if(rgbVivo) th.style.setProperty('--forma-rgb-vivo', rgbVivo);
        }else{
          th.style.removeProperty('--forma-rgb');
          th.style.removeProperty('--forma-rgb-vivo');
        }
      }
    });
  }

  function crearTablaCartonVisual(carton, modo='mini'){
    const contenedor=document.createElement('div');
    contenedor.className=`carton-visual carton-visual--${modo}`;
    const tipoCarton=normalizarTipoCarton(carton);
    contenedor.dataset.tipocarton=tipoCarton;
    const leyenda=document.createElement('div');
    leyenda.className='carton-forma-leyenda';
    contenedor.appendChild(leyenda);
    const tabla=document.createElement('table');
    tabla.className=`carton-tabla carton-tabla--${modo}`;
    tabla.dataset.tipocarton=tipoCarton;
    tabla.dataset.cartonId=carton.id||'';
    const esGanador=Array.isArray(carton.formasGanadas)&&carton.formasGanadas.length>0;
    if(esGanador){
      tabla.classList.add('ganador');
    }
    const thead=document.createElement('thead');
    const trHead=document.createElement('tr');
    BINGO_LETRAS.forEach(letra=>{
      const th=document.createElement('th');
      const spanLetra=document.createElement('span');
      spanLetra.className='encabezado-letra';
      spanLetra.textContent=letra;
      th.appendChild(spanLetra);
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    tabla.appendChild(thead);
    const tbody=document.createElement('tbody');
    const mapaValor=new Map();
    (carton.posiciones||[]).forEach(p=>{
      const fila=Number(p.r);
      const col=Number(p.c);
      if(Number.isInteger(fila) && Number.isInteger(col)){
        mapaValor.set(`${fila}-${col}`,p.valor);
      }
    });
    const celdas=new Map();
    const numeroCartonCentral=modo==='principal'?obtenerNumeroCarton(carton):null;
    for(let r=0;r<5;r++){
      const fila=document.createElement('tr');
      for(let c=0;c<5;c++){
        const td=document.createElement('td');
        td.dataset.pos=`${r}-${c}`;
        let cantada='0';
        if(r===2 && c===2){
          td.classList.add('free');
          const icono=document.createElement('span');
          icono.className='cell-content estrella';
          if(modo==='principal'){
            icono.classList.add('numero-carton');
            icono.textContent=numeroCartonCentral && numeroCartonCentral!=='--'?numeroCartonCentral:'';
          }else{
            icono.textContent='';
          }
          td.appendChild(icono);
        }else{
          const valor=mapaValor.get(`${r}-${c}`);
          const span=document.createElement('span');
          span.className='cell-content';
          if(valor!==undefined && valor!==null){
            const numero=Number(valor);
            const texto=Number.isFinite(numero)?String(numero).padStart(2,'0'):String(valor);
            span.textContent=texto;
            td.dataset.valor=numero;
            if(cantosIndiceMap.has(numero)){
              cantada='1';
              td.classList.add('celda-cantada');
            }
          }else{
            span.textContent='';
          }
          td.appendChild(span);
        }
        td.dataset.cantada=cantada;
        fila.appendChild(td);
        celdas.set(`${r}-${c}`,td);
      }
      tbody.appendChild(fila);
    }
    tabla.appendChild(tbody);
    contenedor.appendChild(tabla);
    return {contenedor, tabla, celdas, letras:Array.from(trHead.querySelectorAll('.encabezado-letra')), leyenda};
  }

  function obtenerNumeroCarton(carton){
    const bruto=carton.cartonNum ?? carton.Ncarton;
    if(bruto===undefined || bruto===null) return '--';
    const numero=Number(bruto);
    if(Number.isFinite(numero)){
      return String(numero).padStart(4,'0');
    }
    const texto=String(bruto).trim();
    return texto||'--';
  }

  function formatearInfoCarton(carton){
    const numero=obtenerNumeroCarton(carton);
    return `Cartn ${numero==='--'?'--':`#${numero}`}`;
  }

  function obtenerResumenGananciasCarton(carton, limiteFormas=5){
    const resultado={formas:[], total:0};
    if(!carton) return resultado;
    const gananciasPorForma=new Map();
    const lista=formasPorCarton.get(carton.id)||[];
    lista.forEach(item=>{
      const idx=Number(item?.forma?.idx);
      if(!Number.isFinite(idx)) return;
      const valor=obtenerCreditosForma(item.forma);
      if(!Number.isFinite(valor) || valor<=0) return;
      gananciasPorForma.set(idx,(gananciasPorForma.get(idx)||0)+valor);
    });
    for(let i=1;i<=limiteFormas;i++){
      const valor=gananciasPorForma.get(i)||0;
      resultado.formas.push({idx:i, valor});
      resultado.total+=valor;
    }
    return resultado;
  }

  function detenerAnimacionCarton(cartonId){
    const registro=animacionesCartones.get(cartonId);
    if(registro){
      if(registro.timer){
        clearTimeout(registro.timer);
      }
      if(Array.isArray(registro.tablas)){
        registro.tablas.forEach(aplicarResumenCarton);
      }
    }
    animacionesCartones.delete(cartonId);
  }

  function detenerTodasAnimaciones(){
    Array.from(animacionesCartones.keys()).forEach(detenerAnimacionCarton);
  }

  function aplicarResumenCarton(info){
    if(!info) return;
    info.celdas.forEach(celda=>{
      celda.classList.remove('forma-resaltada');
      celda.classList.remove('celda-forma-activa');
      celda.style.removeProperty('--forma-rgb');
      celda.style.removeProperty('--forma-rgb-vivo');
      if(celda.dataset.cantada==='1'){
        celda.classList.add('celda-cantada');
      }else{
        celda.classList.remove('celda-cantada');
      }
    });
    if(info.leyenda){
      info.leyenda.textContent='';
      info.leyenda.classList.remove('visible');
      info.leyenda.style.removeProperty('color');
      info.leyenda.style.removeProperty('border-color');
      info.leyenda.style.removeProperty('text-shadow');
    }
    if(info.letras){
      info.letras.forEach((span, idx)=>{
        if(!span) return;
        const th=span.closest('th');
        if(th){
          th.classList.remove('forma-activa');
          th.style.removeProperty('--forma-rgb');
          th.style.removeProperty('--forma-rgb-vivo');
          th.setAttribute('aria-pressed','false');
        }
        span.textContent=BINGO_LETRAS[idx] || '';
        span.classList.remove('encabezado-letra-activa');
      });
    }
    if(cartonPrincipalInfo && cartonPrincipalInfo.info===info){
      if(!evitarReaplicarFormaDestacada && Number.isInteger(cartonPrincipalInfo.formaActiva)){
        const idx=cartonPrincipalInfo.formaActiva;
        const forma=formasActivas.find(f=>Number(f.idx)===idx);
        const posiciones=obtenerPosicionesNormalizadas(forma);
        if(forma && posiciones.length){
          const color=obtenerColorParaForma(idx);
          actualizarEncabezadoForma(info, idx, color);
          aplicarFormaCarton(info,{
            posiciones,
            color,
            nombre:forma.nombre,
            indice:idx,
            mostrarLeyenda:false,
            resaltarTodas:true,
            soloBorde:true
          });
        }else{
          formaDestacadaSeleccionada=null;
          cartonPrincipalInfo.formaActiva=null;
          actualizarEncabezadoForma(info,null);
        }
      }else if(!Number.isInteger(cartonPrincipalInfo.formaActiva)){
        actualizarEncabezadoForma(info,null);
      }
    }
  }

  function aplicarFormaCarton(info, datosForma){
    if(!info || !datosForma) return;
    const rgbTexto=obtenerRgbTexto(datosForma.color);
    const rgbVivoTexto=obtenerRgbVivoTexto(datosForma.color) || rgbTexto;
    const posiciones=normalizarPosicionesEntrada(datosForma.posiciones || datosForma.posicionesNormalizadas || []);
    const resaltarTodas=datosForma.resaltarTodas===true;
    const soloBorde=datosForma.soloBorde===true;
    info.celdas.forEach(celda=>{
      celda.classList.remove('forma-resaltada');
      celda.classList.remove('celda-forma-activa');
      celda.classList.remove('celda-forma-solo-borde');
      celda.style.removeProperty('--forma-rgb');
      celda.style.removeProperty('--forma-rgb-vivo');
      if(celda.dataset.cantada==='1'){
        celda.classList.add('celda-cantada');
      }
    });
    posiciones.forEach(pos=>{
      const clave=`${pos.r}-${pos.c}`;
      const celda=info.celdas.get(clave);
      if(!celda || celda.classList.contains('free')) return;
      if(celda.dataset.cantada!=='1' && !resaltarTodas) return;
      celda.classList.add('celda-forma-activa');
      celda.classList.toggle('celda-forma-solo-borde', soloBorde);
      celda.style.setProperty('--forma-rgb',rgbTexto);
      celda.style.setProperty('--forma-rgb-vivo',rgbVivoTexto);
    });
    if(info.leyenda){
      if(datosForma.mostrarLeyenda===false){
        info.leyenda.textContent='';
        info.leyenda.classList.remove('visible');
        info.leyenda.style.removeProperty('color');
        info.leyenda.style.removeProperty('border-color');
        info.leyenda.style.removeProperty('text-shadow');
      }else{
        let etiqueta='Forma';
        if(datosForma.nombre && datosForma.nombre.trim().length){
          etiqueta=datosForma.nombre.trim();
        }else if(datosForma.indice!==undefined && datosForma.indice!==null){
          const indiceTexto=String(datosForma.indice).trim();
          etiqueta=`Forma ${indiceTexto.padStart(2,'0')}`;
        }
        const esPrincipal=info?.contenedor?.classList?.contains('carton-visual--principal');
        const leyendaTexto=esPrincipal && etiqueta?`Ganaste con ${etiqueta}`:etiqueta;
        info.leyenda.textContent=leyendaTexto;
        if(datosForma.color){
          info.leyenda.style.color=ajustarLuminosidad(datosForma.color,-0.5);
          info.leyenda.style.borderColor=ajustarLuminosidad(datosForma.color,-0.2);
          info.leyenda.style.textShadow='0 0 14px rgba(255, 235, 59, 0.9)';
        }
        info.leyenda.classList.add('visible');
      }
    }
  }

  function limpiarCeldasTemporales(info){
    if(!info) return;
    info.celdas.forEach(celda=>{
      celda.classList.remove('celda-forma-temporal');
      if(!celda.classList.contains('celda-forma-activa')){
        celda.style.removeProperty('--forma-rgb');
        celda.style.removeProperty('--forma-rgb-vivo');
      }
    });
  }

  function cancelarResaltadoTemporal(){
    if(resaltadoTemporal.timer){
      clearTimeout(resaltadoTemporal.timer);
      resaltadoTemporal.timer=null;
      if(resaltadoTemporal.tablas && cartonPrincipalInfo && cartonesSorteo.has(cartonPrincipalInfo.cartonId)){
        configurarAnimacionCarton(cartonesSorteo.get(cartonPrincipalInfo.cartonId),resaltadoTemporal.tablas);
      }
    }
    if(cartonPrincipalInfo && cartonPrincipalInfo.info){
      limpiarCeldasTemporales(cartonPrincipalInfo.info);
      aplicarResumenCarton(cartonPrincipalInfo.info);
    }
    resaltadoTemporal.tablas=null;
    resaltadoTemporal.cartonId=null;
  }

  function resaltarFormaTemporal(indice){
    if(!cartonPrincipalInfo || !cartonPrincipalInfo.info) return;
    const idx=Number(indice);
    if(!Number.isFinite(idx)) return;
    const forma=formasActivas.find(f=>Number(f.idx)===idx);
    const posiciones=obtenerPosicionesNormalizadas(forma);
    if(!forma || !posiciones.length) return;
    cancelarResaltadoTemporal();
    const info=cartonPrincipalInfo.info;
    aplicarResumenCarton(info);
    const colorBase=obtenerColorParaForma(idx);
    const rgbTexto=obtenerRgbTexto(colorBase);
    const rgbVivoTexto=obtenerRgbVivoTexto(colorBase) || rgbTexto;
    let tablasBackup=null;
    const animacionActual=animacionesCartones.get(cartonPrincipalInfo.cartonId);
    if(animacionActual){
      tablasBackup=Array.isArray(animacionActual.tablas)?animacionActual.tablas.slice():null;
      detenerAnimacionCarton(cartonPrincipalInfo.cartonId);
    }
    let hayCeldas=false;
    posiciones.forEach(pos=>{
      const celda=info.celdas.get(`${pos.r}-${pos.c}`);
      if(celda){
        celda.classList.add('celda-forma-temporal');
        celda.style.setProperty('--forma-rgb',rgbTexto);
        celda.style.setProperty('--forma-rgb-vivo',rgbVivoTexto);
        hayCeldas=true;
      }
    });
    if(!hayCeldas){
      if(tablasBackup && cartonesSorteo.has(cartonPrincipalInfo.cartonId)){
        configurarAnimacionCarton(cartonesSorteo.get(cartonPrincipalInfo.cartonId),tablasBackup);
      }
      return;
    }
    resaltadoTemporal.cartonId=cartonPrincipalInfo.cartonId;
    resaltadoTemporal.tablas=tablasBackup;
    resaltadoTemporal.timer=setTimeout(()=>{
      limpiarCeldasTemporales(info);
      aplicarResumenCarton(info);
      if(resaltadoTemporal.tablas && cartonesSorteo.has(cartonPrincipalInfo.cartonId)){
        configurarAnimacionCarton(cartonesSorteo.get(cartonPrincipalInfo.cartonId),resaltadoTemporal.tablas);
      }
      resaltadoTemporal.timer=null;
      resaltadoTemporal.tablas=null;
      resaltadoTemporal.cartonId=null;
    },3000);
  }

  function configurarEventosCartonPrincipal(carton,info){
    if(!carton || !info) return;
    cartonPrincipalInfo={cartonId:carton.id, info, formaActiva:formaDestacadaSeleccionada};
    const actualizarAccesibilidad=estado=>{
      if(info.wrapper){
        info.wrapper.setAttribute('aria-pressed', estado?'true':'false');
      }
    };
    const toggleFlip=(forzar=null)=>{
      if(!info.wrapper) return;
      const yaFlipped=info.wrapper.classList.contains('flipped');
      const proximo=typeof forzar==='boolean'?forzar:!yaFlipped;
      info.wrapper.classList.toggle('flipped', proximo);
      actualizarAccesibilidad(proximo);
      if(info.wrapper){
        info.wrapper.focus({preventScroll:true});
      }
    };
    if(info.wrapper){
      info.wrapper.tabIndex=0;
      info.wrapper.setAttribute('role','button');
      info.wrapper.setAttribute('aria-label','Ver resumen de ganancias del cartn');
      actualizarAccesibilidad(info.wrapper.classList.contains('flipped'));
      info.wrapper.addEventListener('click',evento=>{
        if(evento.target.closest('.carton-forma-accion')) return;
        toggleFlip();
      });
      info.wrapper.addEventListener('keydown',evento=>{
        if(evento.key==='Enter' || evento.key===' '){
          evento.preventDefault();
          toggleFlip();
        }
      });
    }
  }

  function configurarInteraccionFormasDestacadas(info){
    if(!info || !Array.isArray(info.letras)) return;
    info.letras.forEach((span, idx)=>{
      if(!span) return;
      const th=span.closest('th');
      if(!th) return;
      const formaIdx=idx+1;
      th.dataset.formaIdx=String(formaIdx);
      th.setAttribute('role','button');
      th.tabIndex=0;
      th.setAttribute('aria-pressed','false');
      th.setAttribute('aria-label',`Resaltar forma ${formaIdx}`);
      th.addEventListener('click',evento=>{
        evento.preventDefault();
        evento.stopPropagation();
        toggleFormaDestacada(formaIdx);
      });
      th.addEventListener('keydown',evento=>{
        if(evento.key==='Enter' || evento.key===' '){
          evento.preventDefault();
          evento.stopPropagation();
          toggleFormaDestacada(formaIdx);
        }
      });
    });
    actualizarEncabezadoForma(info,null);
  }

  function establecerFormaDestacada(indice){
    if(!cartonPrincipalInfo || !cartonPrincipalInfo.info) return;
    const idx=Number(indice);
    if(!Number.isInteger(idx)) return;
    const forma=formasActivas.find(f=>Number(f.idx)===idx);
    const posiciones=obtenerPosicionesNormalizadas(forma);
    if(!forma || !posiciones.length){
      limpiarFormaDestacada();
      return;
    }
    const info=cartonPrincipalInfo.info;
    const color=obtenerColorParaForma(idx);
    formaDestacadaSeleccionada=idx;
    cartonPrincipalInfo.formaActiva=idx;
    evitarReaplicarFormaDestacada=true;
    aplicarResumenCarton(info);
    evitarReaplicarFormaDestacada=false;
    actualizarEncabezadoForma(info, idx, color);
    aplicarFormaCarton(info,{
      posiciones,
      color,
      nombre:forma.nombre,
      indice:idx,
      mostrarLeyenda:false,
      resaltarTodas:true,
      soloBorde:true
    });
  }

  function limpiarFormaDestacada(){
    if(!cartonPrincipalInfo || !cartonPrincipalInfo.info) return;
    formaDestacadaSeleccionada=null;
    cartonPrincipalInfo.formaActiva=null;
    evitarReaplicarFormaDestacada=true;
    aplicarResumenCarton(cartonPrincipalInfo.info);
    evitarReaplicarFormaDestacada=false;
    actualizarEncabezadoForma(cartonPrincipalInfo.info,null);
  }

  function toggleFormaDestacada(indice){
    const idx=Number(indice);
    if(!Number.isInteger(idx)) return;
    if(formaDestacadaSeleccionada===idx){
      limpiarFormaDestacada();
    }else{
      establecerFormaDestacada(idx);
    }
  }

  function restaurarFormaDestacada(){
    if(!cartonPrincipalInfo || !cartonPrincipalInfo.info) return;
    if(!Number.isInteger(formaDestacadaSeleccionada)) return;
    establecerFormaDestacada(formaDestacadaSeleccionada);
  }

  function configurarAnimacionCarton(carton, tablasInfo){
    if(!carton || !Array.isArray(tablasInfo) || !tablasInfo.length) return;
    detenerAnimacionCarton(carton.id);
    tablasInfo.forEach(aplicarResumenCarton);
    const formasGanadas=Array.isArray(carton.formasGanadas)?carton.formasGanadas:[];
    const formasPreparadas=formasGanadas
      .map(item=>{
        const posiciones=obtenerPosicionesNormalizadas(item?.forma);
        if(!posiciones.length) return null;
        const idx=item?.forma?.idx ?? item?.idx;
        const nombre=item?.forma?.nombre ?? item?.nombre ?? '';
        return {
          posiciones,
          color:obtenerColorParaForma(idx),
          nombre,
          indice:idx,
          resaltarTodas:true
        };
      })
      .filter(Boolean);
    if(!formasPreparadas.length){
      return;
    }
    const secuencias=[];
    formasPreparadas.forEach(data=>{
      secuencias.push({tipo:'forma',data});
      secuencias.push({tipo:'resumen'});
    });
    if(!secuencias.length){
      return;
    }
    let indice=0;
    const registro={timer:null, tablas:tablasInfo};
    animacionesCartones.set(carton.id,registro);
    const ejecutar=()=>{
      if(!animacionesCartones.has(carton.id)) return;
      const actual=secuencias[indice];
      const duracion=actual.tipo==='forma'?3000:3000;
      if(actual.tipo==='forma'){
        tablasInfo.forEach(info=>aplicarFormaCarton(info,actual.data));
      }else{
        tablasInfo.forEach(aplicarResumenCarton);
      }
      registro.timer=setTimeout(()=>{
        indice=(indice+1)%secuencias.length;
        ejecutar();
      },duracion);
    };
    ejecutar();
  }

  crearGridCantos();

  function formatearFecha(fechaStr){
    if(!fechaStr) return '';
    const partes=fechaStr.split('-');
    if(partes.length===3){
      return `${partes[2]}/${partes[1]}/${partes[0]}`;
    }
    return fechaStr;
  }

  function normalizarNumero(valor){
    if(typeof valor==='number' && Number.isFinite(valor)) return valor;
    if(typeof valor==='string'){
      const texto=valor.trim();
      if(texto==='') return null;
      const match=texto.toUpperCase().match(/^([BINGO])[-\s]?0*(\d{1,2})$/);
      if(match){
        const numero=parseInt(match[2],10);
        if(Number.isFinite(numero)){
          return numero;
        }
      }
      const n=parseInt(texto,10);
      if(Number.isFinite(n)) return n;
    }
    return null;
  }

  function generarEtiquetaDesdeNumero(numero){
    if(!Number.isFinite(numero)) return '';
    const entero=Math.trunc(numero);
    if(entero<=0) return numero.toString();
    const indice=Math.min(BINGO_LETRAS.length-1, Math.max(0, Math.floor((entero-1)/15)));
    const letra=BINGO_LETRAS[indice];
    return `${letra}-${String(entero).padStart(2,'0')}`;
  }

  function obtenerEtiquetaCanto(valor){
    if(typeof valor==='string'){
      const texto=valor.trim();
      if(texto){
        const match=texto.toUpperCase().match(/^([BINGO])[-\s]?0*(\d{1,2})$/);
        if(match){
          const letra=match[1];
          const numero=parseInt(match[2],10);
          if(Number.isFinite(numero)){
            return `${letra}-${String(numero).padStart(2,'0')}`;
          }
        }
      }
    }
    const numero=normalizarNumero(valor);
    if(numero===null) return '';
    return generarEtiquetaDesdeNumero(numero);
  }

  function colorConTransparencia(hex,alpha){
    if(!hex) return `rgba(255,255,255,${alpha})`;
    let valor=hex.replace('#','');
    if(valor.length===3){
      valor=valor.split('').map(c=>c+c).join('');
    }
    const num=parseInt(valor,16);
    if(Number.isNaN(num)) return `rgba(255,255,255,${alpha})`;
    const r=(num>>16)&255;
    const g=(num>>8)&255;
    const b=num&255;
    return `rgba(${r},${g},${b},${alpha})`;
  }

  function hexToRgb(hex){
    if(!hex) return null;
    let valor=hex.replace('#','');
    if(valor.length===3){
      valor=valor.split('').map(c=>c+c).join('');
    }
    if(valor.length!==6) return null;
    const num=parseInt(valor,16);
    if(Number.isNaN(num)) return null;
    return {
      r:(num>>16)&255,
      g:(num>>8)&255,
      b:num&255
    };
  }

  function ajustarLuminosidad(hex,porcentaje){
    const rgb=hexToRgb(hex);
    if(!rgb) return hex || '#ffffff';
    const factor=Math.max(-1, Math.min(1, porcentaje));
    const ajustar=valor=>{
      if(factor>=0){
        return Math.round(valor+(255-valor)*factor);
      }
      return Math.round(valor+(valor*factor));
    };
    const r=ajustar(rgb.r);
    const g=ajustar(rgb.g);
    const b=ajustar(rgb.b);
    return `rgb(${r}, ${g}, ${b})`;
  }

  function formatearCreditos(valor){
    const numero=Number(valor);
    if(!Number.isFinite(numero)) return '0';
    return numero.toLocaleString('es-ES', {maximumFractionDigits: 0});
  }

  function formatearHoraAmPm(valor){
    const texto=String(valor ?? '').trim();
    if(!texto) return '';
    const match=texto.match(/^(\d{1,2})(?::(\d{2}))?(?::(\d{2}))?\s*(am|pm)?$/i);
    if(match){
      let horas=parseInt(match[1],10);
      if(Number.isNaN(horas)) return texto;
      const minutos=(match[2]??'00').padStart(2,'0');
      const segundos=match[3]?match[3].padStart(2,'0'):null;
      let sufijo=match[4]?match[4].toUpperCase():'';
      if(!sufijo){
        sufijo=horas>=12?'PM':'AM';
        horas=horas%12 || 12;
      }else{
        horas=(horas%12)||12;
      }
      const base=String(horas).padStart(2,'0');
      const segmentoSegundos=segundos?`:${segundos}`:'';
      return `${base}:${minutos}${segmentoSegundos} ${sufijo}`;
    }
    const partes=texto.split(':');
    if(partes.length>=2){
      const horas=parseInt(partes[0],10);
      if(!Number.isNaN(horas)){
        const minutos=partes[1];
        const segundos=partes.length>2?partes[2]:'';
        const sufijo=horas>=12?'PM':'AM';
        const hora12=(horas%12)||12;
        const segSegmento=segundos?`:${segundos.padStart(2,'0')}`:'';
        return `${String(hora12).padStart(2,'0')}:${minutos.padStart(2,'0')}${segSegmento} ${sufijo}`;
      }
    }
    return texto;
  }

  function obtenerTotalCreditosSorteo(){
    if(!activeSorteo) return 0;
    const posiblesClaves=['totalPremios','totalpremios','premioTotal','premio','total_premios'];
    for(const clave of posiblesClaves){
      const valor=Number(activeSorteo[clave]);
      if(Number.isFinite(valor) && valor>0){
        return valor;
      }
    }
    const valorCarton=Number(activeSorteo.valorCarton ?? activeSorteo.valor);
    const jugados=Number(activeSorteo.cartonesjugando ?? activeSorteo.cartonesJugando ?? activeSorteo.cartones);
    if(Number.isFinite(valorCarton) && valorCarton>0 && Number.isFinite(jugados) && jugados>0){
      return valorCarton*jugados;
    }
    return 0;
  }

  function obtenerCreditosForma(forma){
    if(!forma) return 0;
    const posiblesClaves=['premioCreditos','premiocreditos','creditos','premio','premioValor'];
    for(const clave of posiblesClaves){
      const valor=Number(forma[clave]);
      if(Number.isFinite(valor) && valor>0){
        return valor;
      }
    }
    const porcentaje=Number(forma.porcentaje ?? forma.porcentajePremio ?? forma.porcentajepremio);
    if(Number.isFinite(porcentaje) && porcentaje>0){
      const total=obtenerTotalCreditosSorteo();
      if(total>0){
        return Math.round(total*porcentaje/100);
      }
    }
    return 0;
  }

  function actualizarHeader(){
    if(!activeSorteo){
      sorteoResumenEl.className='sorteo-titulo-basico';
      sorteoResumenEl.textContent='No hay sorteos en vivo en este momento.';
      sorteoDetallesEl.innerHTML='';
      return;
    }
    const {nombre='',fecha='',tipo='',hora=''}=activeSorteo;
    const claseTitulo=['sorteo-titulo-basico'];
    const tipoNormalizado=(tipo||'').toLowerCase();
    if(tipoNormalizado.includes('especial')){
      claseTitulo.push('sorteo-titulo-especial');
    }else if(tipoNormalizado.includes('diario')){
      claseTitulo.push('sorteo-titulo-diario');
    }
    sorteoResumenEl.className=claseTitulo.join(' ');
    sorteoResumenEl.textContent=nombre||'Sorteo en vivo';
    const partes=[];
    if(tipo){
      let claseTipo='detalle-tipo';
      if(tipoNormalizado.includes('especial')){
        claseTipo+=' detalle-tipo-especial';
      }else if(tipoNormalizado.includes('diario')){
        claseTipo+=' detalle-tipo-diario';
      }
      partes.push(`<span class="detalle-item"><span class="${claseTipo}">${tipo}</span></span>`);
    }
    if(fecha){
      partes.push(`<span class="detalle-item"><span class="detalle-label">Fecha:</span><span class="detalle-valor fecha">${formatearFecha(fecha)}</span></span>`);
    }
    if(hora){
      const horaFormateada=formatearHoraAmPm(hora);
      const horaMostrar=horaFormateada || hora;
      partes.push(`<span class="detalle-item"><span class="detalle-label">Hora:</span><span class="detalle-valor hora">${horaMostrar}</span></span>`);
    }
    sorteoDetallesEl.innerHTML=partes.join(' ');
  }

  function renderCantos(){
    if(!cantoCellsMap.size) crearGridCantos();
    cantoCellsMap.forEach(celda=>{
      celda.classList.remove('cantado','ultimo');
    });
    ultimoCantoEl.textContent='';
    const total=cantosOrdenados.length;
    cantosOrdenados.forEach((num,idx)=>{
      const celda=cantoCellsMap.get(num);
      if(celda){
        celda.classList.add('cantado');
        if(idx===total-1){
          celda.classList.add('ultimo');
        }
      }
    });
    if(total){
      const etiqueta=cantosEtiquetas[total-1] || generarEtiquetaDesdeNumero(cantosOrdenados[total-1]);
      ultimoCantoEl.innerHTML=`<span class="ultimo-etiqueta">ltimo</span><span class="ultimo-total">(${total})</span>: <span class="ultimo-numero">${etiqueta}</span>`;
    }else{
      ultimoCantoEl.textContent='An no se han registrado cantos.';
    }
  }

  function limpiarPanelFormas(){
    if(formasMensajeEl){
      formasMensajeEl.textContent='';
    }
    limpiarBotonesFormas();
  }

  function limpiarCartonesRenderizados(){
    if(misCartonesGridEl){
      misCartonesGridEl.innerHTML='';
    }
  }

  function renderFormas(){
    limpiarPanelFormas();
    if(!formasActivas.length){
      if(formasMensajeEl){
        formasMensajeEl.textContent='No hay formas registradas para este sorteo.';
      }
      return;
    }
    if(formasMensajeEl){
      formasMensajeEl.textContent='';
    }
  }

  function renderCartonesJugador(){
    detenerTodasAnimaciones();
    limpiarCartonesRenderizados();
    cartonDestacadoEl.innerHTML='';
    cartonDestacadoEl.classList.remove('activo');
    cartonDestacadoEl.style.removeProperty('--carton-contenido-ancho');
    cartonDestacadoEl.style.removeProperty('--carton-contenido-alto');
    limpiarBotonesFormas();
    const lista=Array.from(cartonesSorteo.values()).filter(c=>c.userId===(usuarioActual?usuarioActual.uid:null));
    if(!lista.length){
      cartonesMensajeEl.textContent='No tienes cartones participando en este sorteo.';
      cartonSeleccionadoId=null;
      cartonPrincipalInfo=null;
      formaDestacadaSeleccionada=null;
      return;
    }
    cartonesMensajeEl.textContent='';
    const decorados=lista.map(carton=>{
      const formasGanadas=formasPorCarton.get(carton.id)||[];
      const primerPaso=formasGanadas.length?Math.min(...formasGanadas.map(f=>f.paso)):Infinity;
      return {...carton, formasGanadas, primerPaso};
    });
    decorados.sort((a,b)=>{
      const aGan=a.formasGanadas.length>0;
      const bGan=b.formasGanadas.length>0;
      if(aGan!==bGan) return aGan?-1:1;
      if(aGan && bGan){
        if(a.primerPaso!==b.primerPaso) return a.primerPaso-b.primerPaso;
      }
      const numA=a.cartonNum ?? a.Ncarton ?? Number.MAX_SAFE_INTEGER;
      const numB=b.cartonNum ?? b.Ncarton ?? Number.MAX_SAFE_INTEGER;
      return numA-numB;
    });
    if(!cartonSeleccionadoId || !decorados.some(c=>c.id===cartonSeleccionadoId)){
      cartonSeleccionadoId=decorados[0].id;
      formaDestacadaSeleccionada=null;
    }
    const tablasPorCarton=new Map();
    const registrarTabla=(cartonId,info)=>{
      if(!info) return;
      if(!tablasPorCarton.has(cartonId)) tablasPorCarton.set(cartonId,[]);
      tablasPorCarton.get(cartonId).push(info);
    };
    const fragment=document.createDocumentFragment();
    decorados.forEach(carton=>{
      const tablaInfo=crearTablaCartonVisual(carton,'mini');
      aplicarResumenCarton(tablaInfo);
      registrarTabla(carton.id,tablaInfo);
      const contenedor=tablaInfo.contenedor;
      contenedor.dataset.cartonId=carton.id||'';
      contenedor.classList.remove('ganador','seleccionado');
      if(carton.formasGanadas.length){
        contenedor.classList.add('ganador');
      }
      if(carton.id===cartonSeleccionadoId){
        contenedor.classList.add('seleccionado');
      }
      contenedor.setAttribute('role','button');
      contenedor.setAttribute('tabindex','0');
      const info=document.createElement('div');
      info.className='carton-info';
      const numeroDiv=document.createElement('div');
      numeroDiv.className='carton-info-numero';
      numeroDiv.textContent=formatearInfoCarton(carton);
      info.appendChild(numeroDiv);
      const tipoCarton=normalizarTipoCarton(carton);
      const tipoDiv=document.createElement('div');
      tipoDiv.className=`carton-info-tipo carton-info-tipo--${tipoCarton}`;
      tipoDiv.textContent=tipoCarton==='gratis'?'GRATIS':'PAGADO';
      info.appendChild(tipoDiv);
      contenedor.appendChild(info);
      contenedor.addEventListener('click',()=>{
        if(cartonSeleccionadoId!==carton.id){
          cartonSeleccionadoId=carton.id;
          formaDestacadaSeleccionada=null;
          renderCartonesJugador();
        }
      });
      contenedor.addEventListener('keydown',evento=>{
        if((evento.key==='Enter'||evento.key===' ') && cartonSeleccionadoId!==carton.id){
          evento.preventDefault();
          cartonSeleccionadoId=carton.id;
          formaDestacadaSeleccionada=null;
          renderCartonesJugador();
        }
      });
      fragment.appendChild(contenedor);
    });
    if(misCartonesGridEl){
      misCartonesGridEl.appendChild(fragment);
    }
    cancelarResaltadoTemporal();
    cartonPrincipalInfo=null;
    const seleccionado=decorados.find(c=>c.id===cartonSeleccionadoId);
    if(seleccionado){
      const tablaInfoPrincipal=crearTablaCartonVisual(seleccionado,'principal');
      aplicarResumenCarton(tablaInfoPrincipal);
      registrarTabla(seleccionado.id,tablaInfoPrincipal);
      const resumenGanancias=obtenerResumenGananciasCarton(seleccionado,5);
      const cartonBox=document.createElement('div');
      cartonBox.className='carton-box';
      const cartonWrapper=document.createElement('div');
      cartonWrapper.className='carton-wrapper';
      cartonBox.appendChild(cartonWrapper);
      const cartonFront=document.createElement('div');
      cartonFront.className='carton-front';
      cartonWrapper.appendChild(cartonFront);
      cartonFront.appendChild(tablaInfoPrincipal.contenedor);
      const cartonBack=document.createElement('div');
      cartonBack.className='carton-back';
      cartonWrapper.appendChild(cartonBack);
      const backContent=document.createElement('div');
      backContent.className='carton-back-content';
      cartonBack.appendChild(backContent);
      const backTitle=document.createElement('h3');
      backTitle.className='carton-back-title';
      backTitle.textContent='GANANCIAS DEL CARTN';
      backContent.appendChild(backTitle);
      const formasContenedor=document.createElement('div');
      formasContenedor.className='carton-back-formas';
      backContent.appendChild(formasContenedor);
      const botonesFormas=[];
      for(let idx=1; idx<=5; idx++){
        const datosForma=resumenGanancias.formas.find(f=>Number(f.idx)===idx) || {idx, valor:0};
        const forma=formasActivas.find(f=>Number(f.idx)===idx) || {idx};
        const colorForma=obtenerColorParaForma(idx);
        const infoGanadores=cartonesGanadoresPorForma.get(idx) || {cartones:[]};
        const totalGanadores=Array.isArray(infoGanadores.cartones)?infoGanadores.cartones.length:0;
        const linea=document.createElement('div');
        linea.className='back-forma-line';
        linea.style.color=colorForma;
        linea.innerHTML=
          `<span class="back-forma-etiqueta">FORMA ${String(idx).padStart(2,'0')}:</span>`+
          `<span class="back-forma-valor">${formatearCreditos(datosForma.valor||0)}</span>`;
        formasContenedor.appendChild(linea);
        const boton=document.createElement('button');
        boton.type='button';
        boton.className='carton-forma-accion';
        boton.dataset.formaIdx=String(idx).padStart(2,'0');
        const textoBoton=document.createElement('span');
        textoBoton.className='carton-forma-texto';
        textoBoton.textContent=`GANADORES F${idx}`;
        const contadorBoton=document.createElement('span');
        contadorBoton.className='carton-forma-contador';
        contadorBoton.textContent=String(totalGanadores);
        boton.appendChild(textoBoton);
        boton.appendChild(contadorBoton);
        boton.style.setProperty('--forma-color', colorForma);
        const colorOscurecido=obtenerColorOscurecido(colorForma,0.7);
        boton.style.setProperty('--forma-color-borde', colorOscurecido);
        boton.style.setProperty('--forma-color-contador', obtenerColorOscurecido(colorForma,0.55));
        boton.dataset.totalGanadores=String(totalGanadores);
        boton.classList.toggle('con-ganadores', totalGanadores>0);
        const referenciaNombre=forma && forma.nombre?`, ${forma.nombre}`:'';
        const descripcionGanadores=totalGanadores===1?'1 cartn ganador':`${totalGanadores} cartones ganadores`;
        boton.setAttribute('aria-label',`Ver cartones ganadores de la forma ${String(idx).padStart(2,'0')}${referenciaNombre}, ${descripcionGanadores}`);
        const tituloBase=forma && forma.nombre?`Ganadores ${forma.nombre}`:`Ganadores Forma ${String(idx).padStart(2,'0')}`;
        boton.title=`${tituloBase} (${descripcionGanadores})`;
        boton.addEventListener('click',evento=>{
          evento.stopPropagation();
          abrirModalGanadores(forma);
        });
        botonesFormas.push(boton);
      }
      const totalContenedor=document.createElement('div');
      totalContenedor.className='carton-back-total';
      const totalLabel=document.createElement('span');
      totalLabel.className='carton-back-total-label';
      totalLabel.textContent='TOTAL GANADO CARTN:';
      const totalValor=document.createElement('span');
      totalValor.className='carton-back-total-valor';
      totalValor.textContent=formatearCreditos(resumenGanancias.total);
      totalContenedor.appendChild(totalLabel);
      totalContenedor.appendChild(totalValor);
      backContent.appendChild(totalContenedor);
      const backLogo=document.createElement('img');
      backLogo.src='https://i.imgur.com/twjhNtZ.png';
      backLogo.alt='Logo HexaBingo';
      cartonBack.appendChild(backLogo);
      insertarBotonesFormas(botonesFormas);
      cartonDestacadoEl.appendChild(cartonBox);
      tablaInfoPrincipal.wrapper=cartonWrapper;
      tablaInfoPrincipal.cartonBack=cartonBack;
      tablaInfoPrincipal.celdaCentral=tablaInfoPrincipal.celdas.get('2-2');
      cartonDestacadoEl.classList.add('activo');
      configurarEventosCartonPrincipal(seleccionado,tablaInfoPrincipal);
      configurarInteraccionFormasDestacadas(tablaInfoPrincipal);
      restaurarFormaDestacada();
      actualizarAlturaCartonWrapper(cartonWrapper);
      programarRecalculoAlturaCarton();
    }
    decorados.forEach(carton=>{
      const tablas=tablasPorCarton.get(carton.id)||[];
      configurarAnimacionCarton(carton,tablas);
    });
  }

  function abrirModalGanadores(forma){
    if(!forma) return;
    const info=cartonesGanadoresPorForma.get(forma.idx);
    const ganadores=info&&Array.isArray(info.cartones)?info.cartones:[];
    modalTituloEl.textContent=`Ganadores Forma ${String(forma.idx).padStart(2,'0')}`;
    modalSubtituloEl.textContent=forma.nombre?forma.nombre:'';
    modalListaEl.innerHTML='';
    modalSinGanadoresEl.textContent='';
    if(!ganadores.length){
      modalSinGanadoresEl.textContent='An no hay cartones ganadores para esta forma.';
    }else{
      const ordenados=ganadores.slice().sort((a,b)=>{
        const pasoA=(formasPorCarton.get(a.id)||[]).find(f=>f.forma.idx===forma.idx)?.paso??Infinity;
        const pasoB=(formasPorCarton.get(b.id)||[]).find(f=>f.forma.idx===forma.idx)?.paso??Infinity;
        if(pasoA!==pasoB) return pasoA-pasoB;
        const numA=a.cartonNum ?? a.Ncarton ?? Number.MAX_SAFE_INTEGER;
        const numB=b.cartonNum ?? b.Ncarton ?? Number.MAX_SAFE_INTEGER;
        return numA-numB;
      });
      const premioFormaTotal=obtenerCreditosForma(forma);
      const totalGanadores=ordenados.length;
      const premioIndividual=totalGanadores>0?Math.floor(premioFormaTotal/totalGanadores):0;
      const cartonesGratisForma=Number(forma?.cartonesGratis ?? forma?.cartones ?? 0);
      ordenados.forEach(carton=>{
        const card=document.createElement('div');
        card.className='ganador-card';
        const infoCol=document.createElement('div');
        infoCol.className='ganador-card-info';
        const cartonExtendido={...carton, formasGanadas:[{forma}]};
        const tablaInfo=crearTablaCartonVisual(cartonExtendido,'mini');
        aplicarResumenCarton(tablaInfo);
        aplicarFormaCarton(tablaInfo,{
          posiciones:obtenerPosicionesNormalizadas(forma),
          color:obtenerColorParaForma(forma.idx),
          nombre:forma.nombre,
          indice:forma.idx,
          mostrarLeyenda:false,
          resaltarTodas:true
        });
        infoCol.appendChild(tablaInfo.contenedor);
        const infoBox=document.createElement('div');
        infoBox.className='ganador-info';
        const numero=(carton.cartonNum ?? carton.Ncarton ?? '').toString();
        infoBox.innerHTML=`<strong>Cartn ${numero?`#${numero.padStart(4,'0')}`:'--'}</strong>`+
          `<span>Alias: ${carton.alias || 'Sin alias'}</span>`+
          `<span>Tipo: ${(carton.tipocarton||'Pagado').toUpperCase()}</span>`;
        infoCol.appendChild(infoBox);
        card.appendChild(infoCol);
        const premiosCol=document.createElement('div');
        premiosCol.className='ganador-premios';

        const creditosItem=document.createElement('div');
        creditosItem.className='ganador-premio-item';
        const premioLabel=document.createElement('div');
        premioLabel.className='ganador-premio-label';
        premioLabel.textContent='CRDITOS GANADOS:';
        const premioMonto=document.createElement('div');
        premioMonto.className='ganador-premio-monto';
        premioMonto.textContent=formatearCreditos(premioIndividual);
        creditosItem.appendChild(premioLabel);
        creditosItem.appendChild(premioMonto);
        premiosCol.appendChild(creditosItem);

        const cartonesGratisValor=Number.isFinite(cartonesGratisForma) && cartonesGratisForma>0?cartonesGratisForma:0;
        if(cartonesGratisValor>0){
          const cartonesItem=document.createElement('div');
          cartonesItem.className='ganador-premio-item';
          const cartonesLabel=document.createElement('div');
          cartonesLabel.className='ganador-premio-label';
          cartonesLabel.textContent='CARTONES GRATIS:';
          const cartonesValor=document.createElement('div');
          cartonesValor.className='ganador-premio-monto ganador-premio-monto--cartones';
          cartonesValor.textContent=formatearCreditos(cartonesGratisValor);
          cartonesItem.appendChild(cartonesLabel);
          cartonesItem.appendChild(cartonesValor);
          premiosCol.appendChild(cartonesItem);
        }

        card.appendChild(premiosCol);
        modalListaEl.appendChild(card);
      });
    }
    modalGanadores.classList.add('activa');
  }

  function cerrarModal(){
    modalGanadores.classList.remove('activa');
  }

  modalCerrarBtn.addEventListener('click',cerrarModal);
  modalGanadores.addEventListener('click',e=>{
    if(e.target===modalGanadores) cerrarModal();
  });

  function calcularGanadores(){
    cartonesGanadoresPorForma=new Map();
    formasPorCarton=new Map();
    cantosIndiceMap=new Map();
    cantosOrdenados.forEach((num,idx)=>{
      if(!cantosIndiceMap.has(num)) cantosIndiceMap.set(num,idx);
    });
    if(!formasActivas.length || !cartonesSorteo.size || !cantosOrdenados.length){
      renderFormas();
      renderCartonesJugador();
      return;
    }
    formasActivas.forEach(forma=>{
      const posiciones=obtenerPosicionesNormalizadas(forma);
      if(!posiciones.length) return;
      let mejorPaso=Infinity;
      const ganadores=[];
      cartonesSorteo.forEach(carton=>{
        let valido=true;
        let maxPaso=-1;
        for(const pos of posiciones){
          const valor=carton.valorPorPos.get(`${pos.r}-${pos.c}`);
          if(valor===undefined){
            valido=false;
            break;
          }
          const idx=cantosIndiceMap.get(valor);
          if(idx===undefined){
            valido=false;
            break;
          }
          if(idx>maxPaso) maxPaso=idx;
        }
        if(!valido) return;
        if(maxPaso<mejorPaso){
          mejorPaso=maxPaso;
          ganadores.length=0;
          ganadores.push(carton);
        }else if(maxPaso===mejorPaso){
          ganadores.push(carton);
        }
      });
      cartonesGanadoresPorForma.set(forma.idx,{forma,cartones:ganadores,paso:mejorPaso});
      ganadores.forEach(carton=>{
        if(!formasPorCarton.has(carton.id)) formasPorCarton.set(carton.id,[]);
        formasPorCarton.get(carton.id).push({forma,paso:mejorPaso});
      });
    });
    formasPorCarton.forEach(lista=>{
      lista.sort((a,b)=>{
        if(a.paso!==b.paso) return a.paso-b.paso;
        return (a.forma.idx||0)-(b.forma.idx||0);
      });
    });
    renderFormas();
    renderCartonesJugador();
  }

  function procesarCantos(data){
    const lista=Array.isArray(data)?data:[];
    const normalizados=[];
    const etiquetas=[];
    lista.forEach(val=>{
      const n=normalizarNumero(val);
      if(n!==null){
        normalizados.push(n);
        const etiqueta=obtenerEtiquetaCanto(val);
        etiquetas.push(etiqueta || generarEtiquetaDesdeNumero(n));
      }
    });
    cantosOrdenados=normalizados;
    cantosEtiquetas=etiquetas;
    renderCantos();
    calcularGanadores();
  }

  function procesarFormas(snapshot){
    const arr=[];
    snapshot.forEach(doc=>{
      const data=doc.data()||{};
      const idx=Number(data.idx||data.indice||arr.length+1);
      const posiciones=Array.isArray(data.posiciones)?data.posiciones:[];
      const normalizadas=posiciones
        .map(p=>({r:Number(p.r),c:Number(p.c)}))
        .filter(p=>Number.isInteger(p.r)&&Number.isInteger(p.c));
      arr.push({
        id:doc.id,
        idx,
        nombre:data.nombre||'',
        premioImagen:data.premioImagen||data.imagen||'',
        posicionesNormalizadas:normalizadas,
        porcentaje:Number(data.porcentaje ?? data.porcentajePremio ?? data.porcentajepremio ?? 0) || 0,
        premioCreditos:Number(data.premioCreditos ?? data.premiocreditos ?? data.creditos ?? data.premio ?? 0) || 0
      });
    });
    arr.sort((a,b)=>(a.idx||0)-(b.idx||0));
    formasActivas=arr;
    calcularGanadores();
  }

  function procesarCartones(snapshot){
    const mapa=new Map();
    snapshot.forEach(doc=>{
      const data=doc.data()||{};
      const posicionesRaw=Array.isArray(data.posiciones)?data.posiciones:[];
      const posiciones=posicionesRaw
        .map(p=>({r:Number(p.r),c:Number(p.c),valor:normalizarNumero(p.valor ?? p.numero ?? p.value)}))
        .filter(p=>Number.isInteger(p.r)&&Number.isInteger(p.c)&&p.valor!==null);
      const valorPorPos=new Map();
      posiciones.forEach(p=>{
        valorPorPos.set(`${p.r}-${p.c}`,p.valor);
      });
      mapa.set(doc.id,{
        id:doc.id,
        sorteoId:data.sorteoId,
        userId:data.userId||'',
        alias:data.alias||'',
        cartonNum:data.cartonNum,
        Ncarton:data.Ncarton,
        tipocarton:data.tipocarton||'pagado',
        posiciones,
        valorPorPos
      });
    });
    cartonesSorteo=mapa;
    calcularGanadores();
  }

  function suscribirCantos(){
    if(unsubscribeCantos){
      unsubscribeCantos();
      unsubscribeCantos=null;
    }
    if(!activeSorteoId) return;
    unsubscribeCantos=db.collection('cantos').doc(activeSorteoId).onSnapshot(doc=>{
      const datos=doc.exists?(doc.data()?.numeros||[]):[];
      procesarCantos(datos);
    },err=>console.error('Error escuchando cantos',err));
  }

  function suscribirFormas(){
    if(unsubscribeFormas){
      unsubscribeFormas();
      unsubscribeFormas=null;
    }
    if(!activeSorteoId) return;
    unsubscribeFormas=db.collection('formas').where('sorteoId','==',activeSorteoId).onSnapshot(procesarFormas,err=>{
      console.error('Error escuchando formas',err);
    });
  }

  function suscribirCartones(){
    if(unsubscribeCartones){
      unsubscribeCartones();
      unsubscribeCartones=null;
    }
    if(!activeSorteoId) return;
    unsubscribeCartones=db.collection('CartonJugado').where('sorteoId','==',activeSorteoId).onSnapshot(procesarCartones,err=>{
      console.error('Error escuchando cartones',err);
    });
  }

  function seleccionarSorteo(activos){
    if(!activos.length){
      activeSorteo=null;
      activeSorteoId=null;
      actualizarHeader();
      if(unsubscribeCantos){unsubscribeCantos();unsubscribeCantos=null;}
      if(unsubscribeFormas){unsubscribeFormas();unsubscribeFormas=null;}
      if(unsubscribeCartones){unsubscribeCartones();unsubscribeCartones=null;}
      procesarCantos([]);
      formasActivas=[];
      renderFormas();
      cartonesSorteo=new Map();
      renderCartonesJugador();
      return;
    }
    const existente=activeSorteoId?activos.find(s=>s.id===activeSorteoId):null;
    const elegido=existente||activos[0];
    const cambio=activeSorteoId!==elegido.id;
    activeSorteo=elegido;
    activeSorteoId=elegido.id;
    actualizarHeader();
    if(cambio){
      procesarCantos([]);
      formasActivas=[];
      renderFormas();
      cartonesSorteo=new Map();
      renderCartonesJugador();
      suscribirCantos();
      suscribirFormas();
      suscribirCartones();
    }
  }

  function iniciarSorteosListener(){
    if(unsubscribeSorteos){
      unsubscribeSorteos();
      unsubscribeSorteos=null;
    }
    unsubscribeSorteos=db.collection('sorteos').where('estado','==','Jugando').onSnapshot(snapshot=>{
      const lista=[];
      snapshot.forEach(doc=>{
        const data=doc.data()||{};
        lista.push({id:doc.id,...data});
      });
      lista.sort((a,b)=>{
        const fechaA=(a.fecha||'');
        const fechaB=(b.fecha||'');
        if(fechaA!==fechaB) return fechaA.localeCompare(fechaB);
        return (a.hora||'').localeCompare(b.hora||'');
      });
      seleccionarSorteo(lista);
    },err=>{
      console.error('Error escuchando sorteos en juego',err);
    });
  }

  initFirebase()
    .then(()=>{
      auth.onAuthStateChanged(user=>{
        if(!user){
          window.location.href='index.html';
          return;
        }
        usuarioActual=user;
        iniciarSorteosListener();
      });
    })
    .catch(err=>{
      console.error('No se pudo inicializar Firebase',err);
      alert('Error inicializando la aplicacin.');
    });
  </script>
</body>
</html>
