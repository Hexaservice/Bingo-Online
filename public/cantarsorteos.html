<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cantar Sorteo</title>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --texto-primario: #1f1f1f;
      --texto-secundario: #4b4b4b;
      --color-bingo-pagado: #00c853;
      --color-bingo-gratis: #1d4ed8;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(rgba(255,255,255,0.7), rgba(255,255,255,0.7)),
                  url('https://img.freepik.com/vectores-premium/padrao-sem-costura-com-simbolos-de-dolar-e-porcentagem_637741-777.jpg');
      background-repeat: repeat;
      background-size: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      text-align: center;
      padding: 10px 5px 40px;
      box-sizing: border-box;
      margin: 0;
    }
    h1 {
      font-family: 'Bangers', cursive;
      color: white;
      text-shadow: 0 0 12px #1e3aa8;
      margin: 5px 0 10px 0;
      font-size: 2rem;
    }
    .menu-btn {
      width: 250px;
      height: 60px;
      font-family: 'Bangers', cursive;
      font-size: 1.4rem;
      background: rgba(0, 170, 255, 0.8);
      color: white;
      border: 4px solid #FFD700;
      border-radius: 10px;
      text-shadow: 2px 2px 4px #000;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
    }
    .menu-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(255,215,0,0.8); }
    .menu-btn:active { transform: scale(0.95); box-shadow: 0 0 5px rgba(255,215,0,0.8); }
    #salir-btn {
      position: fixed;
      top: 5px;
      left: 5px;
      width: 120px;
      height: 40px;
      background: orange;
      border: 4px solid orange;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      font-size: 1.2rem;
    }
    #salir-btn .label { font-size: 1.1rem; }
    @media (orientation: portrait) {
      #salir-btn { width: 40px; }
      #salir-btn .label { display: none; }
      #detalle-container { margin-left: 5px; margin-right: 5px; }
    }
    #sorteo-btn {
      width: 240px;
      font-size: 1.1rem;
      padding: 6px 10px;
      text-align: center;
      border: 3px solid #FFD700;
      border-radius: 10px;
      background: linear-gradient(#dddddd, #ffffff);
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-transform: uppercase;
      color: #000;
      font-family: 'Bangers', cursive;
      text-shadow: 1px 1px 2px #fff;
    }
    #sorteo-btn.diario { background: linear-gradient(#008000,#ffffff); }
    #sorteo-btn.especial { background: linear-gradient(#ff8800,#ffffff); }
    #sorteo-btn.finalizado { background: linear-gradient(#444,#bbbbbb); color: #fff; }
    #sorteo-btn.jugando { background: linear-gradient(#6a0dad,#ffffff); color: #fff; }
    .sorteo-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      margin-bottom: 10px;
    }
    #fecha-hora-sorteo {
      display: flex;
      justify-content: center;
      width: 100%;
      font-family: 'Bangers', cursive;
      font-size: 1rem;
    }
    #tabla-fechas {
      border-collapse: collapse;
      margin: 0 auto;
    }
    #tabla-fechas td {
      border: none;
      padding: 2px 6px;
      vertical-align: middle;
      white-space: nowrap;
    }
    #tabla-fechas .celda-icono {
      width: 34px;
      text-align: right;
      padding: 2px 0;
    }
    #tabla-fechas .celda-icono.placeholder {
      visibility: hidden;
    }
    #tabla-fechas .celda-valor {
      text-align: left;
      padding-left: 4px;
    }
    #tabla-fechas .celda-valor[colspan="2"] {
      padding-left: 6px;
    }
    #tabla-fechas .celda-icono span,
    #tabla-fechas .celda-icono img {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
    }
    #tabla-fechas .celda-icono img {
      width: 24px;
      height: 24px;
    }
    .icono-emoji {
      font-size: 1.2rem;
      line-height: 1;
    }
    #tabla-fechas .fila-fecha.oculta {
      display: none;
    }
    .valor-programado,
    .valor-actual,
    .valor-cierre {
      font-size: 1.05rem;
    }
    #tabla-fechas .fila-datos-sorteo td {
      background-color: #ffffff;
    }
    #tabla-fechas .fila-datos-sorteo td:first-child {
      border-top-left-radius: 6px;
      border-bottom-left-radius: 6px;
    }
    #tabla-fechas .fila-datos-sorteo td:last-child {
      border-top-right-radius: 6px;
      border-bottom-right-radius: 6px;
    }
    #tabla-fechas .fila-datos-sorteo .celda-valor span {
      display: inline-block;
    }
    @keyframes pulso-destacado {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }
    .fila-datos-sorteo.en-animacion .celda-icono span,
    .fila-datos-sorteo.en-animacion .celda-valor span {
      animation: pulso-destacado 1.6s ease-in-out infinite;
    }
    .valor-programado {
      font-family: 'Bangers', cursive;
      color: #0f2a0f;
      text-shadow: 0 0 3px rgba(255,255,255,0.85);
      letter-spacing: 1px;
      font-weight: 600;
    }
    .valor-actual {
      font-family: 'Bangers', cursive;
      color: #0b4dda;
      font-weight: 600;
      letter-spacing: 1px;
      text-shadow: 0 0 4px rgba(255,255,255,0.9);
    }
    .valor-cierre {
      font-family: 'Bangers', cursive;
      color: #ffffff;
      font-weight: 600;
      text-shadow: 0 0 6px rgba(0,0,0,0.9);
      letter-spacing: 1px;
    }
    .resaltado-actual {
      text-shadow: 0 0 4px rgba(255,255,255,0.95);
    }
    .estado-tiempo {
      transition: color 0.3s ease, text-shadow 0.3s ease, filter 0.3s ease;
    }
    .estado-tiempo-futuro {
      filter: brightness(1);
    }
    .estado-tiempo-proximo {
      color: #f57c00;
      text-shadow: 0 0 4px rgba(255,255,255,0.85);
    }
    .estado-tiempo-pasado-lejano {
      color: #f57c00;
      text-shadow: 0 0 4px rgba(255,255,255,0.85);
    }
    .estado-tiempo-actual {
      color: #0b4dda;
      text-shadow: 0 0 4px rgba(255,255,255,0.9);
    }
    .estado-tiempo-pasado {
      color: #b71c1c;
      text-shadow: 0 0 6px rgba(0,0,0,0.6);
    }
    .estado-tiempo-sin-dato {
      color: #4a4a4a;
      text-shadow: none;
      filter: brightness(0.9);
    }
    .estado-tiempo-finalizado {
      color: #8b4513;
      text-shadow: 0 0 6px rgba(0,0,0,0.45);
    }
    .datos-sorteo {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      justify-content: center;
      margin-top: 5px;
      font-family: 'Bangers', cursive;
    }
    #premio-repartir {
      color: white;
      font-family: 'Bangers', cursive;
      font-size: 1.6rem;
      text-shadow: 0 0 10px #004488;
      display: flex;
      gap: 6px;
      align-items: center;
    }
    #premio-valor { text-shadow: 0 0 10px #004488; }
    #stats-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    #valor-carton, #cartones-jugando {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #fff;
      text-shadow: 0 0 6px #003300;
      font-size: 1.3rem;
    }
    #valor-carton span.valor, #cartones-jugando span.valor { font-size: 1.6rem; }
    #cartones-jugando span.extra { color: #00008b; text-shadow: 0 0 6px #fff; }
    #detalle-container {
      border: 2px solid #013220;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(0,60,0,0.85), rgba(255,255,255,0.95));
      padding: 15px 14px 20px;
      margin: 16px 8px 0;
      width: min(360px, calc(100% - 16px));
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
      transition: background 0.3s ease;
    }
    #detalle-container.estado-sellado {
      background: linear-gradient(135deg, #c0c0c0, #ffffff);
    }
    #detalle-container.estado-pdf {
      background: linear-gradient(135deg, #3ba74d, #ffffff);
    }
    #detalle-container.estado-jugando {
      background: linear-gradient(135deg, #7f3fbf, #ffffff);
    }
    #detalle-container.estado-finalizado {
      background: linear-gradient(135deg, #8b4513, #ffffff);
    }
    #sorteo-nombre {
      font-size: 1rem;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 0 6px #000;
      margin-bottom: 6px;
    }
    #estado-actual {
      font-family: 'Bangers', cursive;
      font-size: 1.1rem;
      color: #111;
      text-shadow: 0 0 4px rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
      width: 100%;
    }
    #estado-actual .estado-etiqueta {
      letter-spacing: 1px;
    }
    .estado-etiqueta { text-transform: uppercase; }
    .estado-badge {
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 1rem;
      letter-spacing: 1px;
    }
    .tipo-estado {
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 1.05rem;
      text-shadow: 0 0 4px rgba(255,255,255,0.85);
    }
    .tipo-estado.diario { color: #0f8b0f; }
    .tipo-estado.especial { color: #ff8c00; }
    .tipo-estado.default { color: #1e3aa8; }
    .estado-badge.activo { background: rgba(0,128,0,0.15); color: #0f8b0f; border: 1px solid rgba(15,139,15,0.5); }
    .estado-badge.sellado { background: rgba(110,110,110,0.2); color: #444; border: 1px solid rgba(110,110,110,0.5); }
    .estado-badge.jugando { background: rgba(106,13,173,0.15); color: #6a0dad; border: 1px solid rgba(106,13,173,0.4); animation: zoomInOut 1.2s ease-in-out infinite; }
    .estado-badge.finalizado { background: rgba(30,30,30,0.1); color: #000; border: 1px solid rgba(0,0,0,0.4); }
    #resumen-sorteo {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-family: 'Poppins', sans-serif;
      color: #0b1d0b;
      font-weight: 600;
      align-items: center;
    }
    #resumen-sorteo div { display: flex; justify-content: center; gap: 12px; align-items: center; flex-wrap: wrap; font-size: 0.95rem; }
    #tipo-sorteo span { white-space: nowrap; text-transform: uppercase; }
    #acciones-sorteo {
      margin-top: 14px;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 12px;
      flex-wrap: wrap;
    }
    #modo-toggle-container {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      background: rgba(255,255,255,0.55);
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.08);
      flex-shrink: 0;
      margin-left: 4px;
    }
    #modo-manual-estado {
      font-family: 'Bangers', cursive;
      font-size: 0.85rem;
      color: #0b1d0b;
      text-shadow: 0 0 4px rgba(255,255,255,0.9);
      white-space: nowrap;
    }
    .modo-switch {
      position: relative;
      display: inline-block;
      width: 42px;
      height: 22px;
    }
    .modo-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .modo-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background-color: #c9c9c9;
      border-radius: 34px;
      transition: background-color 0.3s ease;
      box-shadow: inset 0 0 4px rgba(0,0,0,0.3);
    }
    .modo-slider:before {
      position: absolute;
      content: '';
      height: 16px;
      width: 16px;
      left: 3px;
      bottom: 3px;
      background-color: #ffffff;
      border-radius: 50%;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .modo-switch input:checked + .modo-slider {
      background: linear-gradient(135deg, #06b406, #8bff8b);
    }
    .modo-switch input:checked + .modo-slider:before {
      transform: translateX(18px);
    }
    .estado-btn {
      width: 52px;
      height: 52px;
      border-radius: 12px;
      border: 3px solid #FFD700;
      background: linear-gradient(#0a8800,#ffffff);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0,0,0,0.4);
      transition: transform 0.2s;
      position: relative;
    }
    .estado-btn:hover { transform: scale(1.05); }
    #sellar-btn { background: linear-gradient(#707070,#d9d9d9); }
    #pdf-btn {
      background: linear-gradient(165deg, #b71c1c 0%, #ff6f60 55%, #ff1744 100%);
      border-color: #ffe082;
      box-shadow: 0 6px 14px rgba(183, 28, 28, 0.35);
    }
    #jugar-btn { background: linear-gradient(#4b0082,#ffffff); }
    #finalizar-btn { background: linear-gradient(#8b0000,#ffffff); }
    .estado-btn img,
    .estado-btn svg { width: 24px; height: 24px; }
    #pdf-btn .pdf-btn-icon {
      width: 30px;
      height: 30px;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,0.35));
    }
    #pdf-btn .pdf-floating-icon {
      position: absolute;
      top: -24px;
      right: -6px;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 30%, #ffffff 0%, #fff5f5 60%, #ffd8d9 100%);
      border: 2px solid rgba(211, 47, 47, 0.35);
      box-shadow: 0 8px 16px rgba(211, 47, 47, 0.28);
      display: none;
      align-items: center;
      justify-content: center;
      transform-origin: center;
      pointer-events: none;
    }
    #pdf-btn .pdf-floating-icon svg {
      width: 18px;
      height: 22px;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
    }
    #pdf-btn.pdf-disponible .pdf-floating-icon {
      display: flex;
      animation: pdfFloat 3.4s ease-in-out infinite, pdfGlow 2.8s ease-in-out infinite;
    }
    @keyframes pdfFloat {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
    @keyframes pdfGlow {
      0% { box-shadow: 0 10px 20px rgba(211, 47, 47, 0.28), 0 0 0 rgba(255, 255, 255, 0); }
      50% { box-shadow: 0 12px 26px rgba(211, 47, 47, 0.4), 0 0 16px rgba(255, 255, 255, 0.65); }
      100% { box-shadow: 0 10px 20px rgba(211, 47, 47, 0.28), 0 0 0 rgba(255, 255, 255, 0); }
    }
    @keyframes zoomPulse {
      0% { transform: scale(1); }
      48% { transform: scale(1.18); }
      100% { transform: scale(1); }
    }
    @keyframes formaTemporalFade {
      0% { opacity: 0.95; }
      60% { opacity: 0.65; }
      100% { opacity: 0; }
    }
    #sellar-btn .stop-icon {
      font-family: 'Bangers', cursive;
      font-size: 0.95rem;
      letter-spacing: 1px;
      color: #ffffff;
    }
    #tabla-cantos-wrapper {
      margin: 16px 8px 0;
      width: min(360px, calc(100% - 16px));
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    #panel-ganadores-formas {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      justify-content: center;
      align-items: stretch;
      gap: 6px;
      width: 100%;
      padding: 4px 0;
    }
    #panel-ganadores-formas:empty {
      min-height: 0;
    }
    #panel-ganadores-formas .carton-forma-accion {
      --panel-botones-escala-limitada: 1;
      min-width: 0;
    }
    .carton-forma-accion {
      font-family: 'Bangers', cursive;
      font-size: clamp(0.95rem, 3.1vw, 1.4rem);
      padding: 0 12px;
      border-radius: 999px;
      border: 2px solid var(--forma-color-borde, rgba(0,0,0,0.2));
      color: #1f1f1f;
      background: linear-gradient(to bottom, var(--forma-color, #ffe082), #ffffff);
      box-shadow: 0 4px 10px rgba(0,0,0,0.18);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      white-space: nowrap;
      width: 100%;
      height: 30px;
      min-height: 30px;
      line-height: 30px;
    }
    .carton-forma-accion .carton-forma-texto {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1.1;
      letter-spacing: 0.5px;
      font-size: 1em;
      flex: 0 0 auto;
    }
    .carton-forma-accion .carton-forma-contador {
      font-size: 1.1em;
      font-weight: 700;
      color: var(--forma-color-contador, #1f1f1f);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding-left: 0;
      min-width: 0;
    }
    .carton-forma-accion.con-ganadores {
      animation: zoomPulse 1.8s ease-in-out infinite;
    }
    .carton-forma-accion:hover,
    .carton-forma-accion:focus-visible {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.22);
      outline: none;
    }
    .carton-forma-accion:disabled {
      opacity: 0.65;
      cursor: default;
      animation: none;
    }
    #tabla-cantos-container {
      width: 100%;
      border-radius: 12px;
      padding: 10px;
      background: linear-gradient(145deg, rgba(255,255,255,0.85), rgba(200,255,200,0.9));
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      transition: filter 0.3s ease, opacity 0.3s ease;
    }
    #tabla-cantos-container.disabled {
      filter: grayscale(0.9);
      opacity: 0.75;
    }
    #tabla-cantos-container.bloqueado {
      filter: none;
      opacity: 1;
    }
    #tabla-cantos {
      width: 100%;
      border-collapse: separate;
      border-spacing: 6px;
      text-align: center;
      font-family: 'Bangers', cursive;
      table-layout: fixed;
    }
    #tabla-cantos th,
    #tabla-cantos td {
      width: 20%;
    }
    #tabla-cantos thead th {
      font-size: 1.4rem;
      color: #0a5c0a;
      text-shadow: 0 0 6px #fff;
    }
    .canto-cell {
      border-radius: 10px;
      padding: 8px 4px;
      font-size: 1.1rem;
      background: linear-gradient(160deg, rgba(240,255,240,0.95), rgba(180,235,180,0.9));
      border: 2px solid rgba(15,90,15,0.5);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .canto-cell:hover {
      transform: scale(1.05);
      box-shadow: 0 0 6px rgba(0,128,0,0.6);
    }
    .canto-cell.selected {
      background: radial-gradient(circle at center, rgba(0,200,0,0.85), rgba(255,255,0,0.9));
      color: #083108;
      box-shadow: 0 0 8px rgba(255,255,0,0.8);
      transform: scale(1.03);
    }
    .canto-texto {
      display: inline-flex;
      align-items: baseline;
      justify-content: center;
      gap: 4px;
      width: 100%;
    }
    .canto-letra {
      font-size: 1.2rem;
    }
    .canto-numero {
      font-size: 1.6rem;
      font-weight: 700;
      line-height: 1;
    }
    .canto-cell.no-jugado {
      background: linear-gradient(160deg, rgba(70,70,70,0.92), rgba(25,25,25,0.95));
      border-color: rgba(255,255,255,0.45);
      box-shadow: 0 0 8px rgba(0,0,0,0.4);
    }
    .canto-cell.no-jugado .canto-letra {
      color: #f3f3f3;
      text-shadow: 0 0 6px rgba(0,0,0,0.85);
    }
    .canto-cell.no-jugado .canto-numero {
      color: #ffffff;
      text-shadow: 0 0 6px rgba(0,0,0,0.9), 0 0 12px rgba(0,0,0,0.85);
    }
    .canto-cell.selected.no-jugado {
      background: radial-gradient(circle at center, rgba(120,120,120,0.9), rgba(35,35,35,0.95));
      color: #ffffff;
    }
    .canto-cell.selected.no-jugado .canto-letra,
    .canto-cell.selected.no-jugado .canto-numero {
      color: #ffffff;
      text-shadow: 0 0 6px rgba(0,0,0,0.9), 0 0 14px rgba(0,0,0,0.8);
    }
    #tabla-cantos-container.disabled .canto-cell,
    #tabla-cantos-container.bloqueado .canto-cell {
      pointer-events: none;
      cursor: default;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.75);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      padding: 12px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 6px;
      width: min(420px, 90vw);
      max-height: 80vh;
      overflow-y: auto;
      font-family: 'Poppins', sans-serif;
    }
    .modal.modal-ganadores {
      inset: 0;
      padding: 20px;
      box-sizing: border-box;
      background: rgba(0,0,0,0.8);
      z-index: 1600;
    }
    .modal.modal-ganadores.activa {
      display: flex;
    }
    .modal-ganadores .modal-contenido {
      background: #fff;
      border-radius: 18px;
      padding: 18px;
      max-width: min(720px, calc(100vw - 32px));
      width: min(720px, calc(100vw - 32px));
      max-height: min(85vh, 640px);
      overflow-y: auto;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-sizing: border-box;
    }
    .modal-ganadores .modal-cerrar {
      align-self: flex-end;
      background: none;
      border: none;
      font-size: 1.4rem;
      cursor: pointer;
      color: #333;
    }
    #modal-ganadores-lista {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }
    .modal-mensaje {
      font-size: 0.85rem;
      color: var(--texto-secundario);
      text-align: center;
    }
    .ganador-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.96), rgba(240,240,240,0.96));
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.18);
      display: grid;
      grid-template-columns: minmax(0, 1.45fr) minmax(0, 0.75fr);
      grid-template-rows: auto auto;
      gap: 4px 14px;
      align-items: flex-start;
    }
    .ganador-card-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      grid-column: 1 / 2;
      grid-row: 1 / 3;
    }
    .ganador-info {
      font-size: 0.8rem;
      color: var(--texto-primario);
      display: flex;
      flex-direction: column;
      gap: 3px;
      text-align: center;
    }
    .ganador-info strong {
      color: #4b0082;
      font-family: 'Bangers', cursive;
      letter-spacing: 0.5px;
    }
    .ganador-premio-label {
      grid-column: 2 / 3;
      grid-row: 1 / 2;
      font-size: 0.78rem;
      font-weight: 600;
      color: #064d1f;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      text-align: center;
      align-self: flex-start;
    }
    .ganador-premio-monto {
      grid-column: 2 / 3;
      grid-row: 2 / 3;
      font-size: clamp(1.15rem, 3vw, 1.65rem);
      font-weight: 700;
      color: #0aa128;
      text-shadow: 0 0 10px rgba(0,0,0,0.25);
      text-align: center;
      align-self: flex-start;
      animation: zoomPulse 1.7s ease-in-out infinite;
    }
    .carton-visual {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding-top: 12px;
    }
    .carton-visual--mini {
      width: auto;
      background: transparent;
      box-shadow: none;
      border-radius: 0;
      padding: 12px 0 10px;
      box-sizing: border-box;
      margin: 0 auto;
    }
    .carton-forma-leyenda {
      position: absolute;
      top: clamp(6px, 2vw, 16px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.92);
      color: #333333;
      font-size: 0.55rem;
      font-weight: 600;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      border-radius: 999px;
      padding: 2px 10px;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.3s ease;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.75);
      border: 1px solid rgba(0,0,0,0.1);
      z-index: 2;
    }
    .carton-forma-leyenda.visible {
      opacity: 1;
    }
    .carton-tabla {
      --cell-size: clamp(34px, 9vw, 72px);
      --bingo-encabezado-color: var(--color-bingo-pagado);
      width: min(100%, calc(var(--cell-size) * 5));
      max-width: calc(var(--cell-size) * 5);
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed;
      background: linear-gradient(#ffffff, #dcdcdc);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 15px rgba(0,0,0,0.25);
    }
    .carton-tabla[data-tipocarton="pagado"] {
      --bingo-encabezado-color: var(--color-bingo-pagado);
    }
    .carton-tabla[data-tipocarton="gratis"] {
      --bingo-encabezado-color: var(--color-bingo-gratis);
    }
    .carton-tabla thead th,
    .carton-tabla tbody td {
      width: var(--cell-size);
      height: var(--cell-size);
      aspect-ratio: 1 / 1;
      border: 2px solid rgba(90,90,90,0.45);
      text-align: center;
      font-weight: 700;
      color: #1a1a1a;
      padding: 0;
      position: relative;
      overflow: hidden;
      background: rgba(255,255,255,0.95);
      box-sizing: border-box;
    }
    .carton-tabla thead th > *,
    .carton-tabla tbody td > * {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }
    .carton-tabla thead th {
      font-size: calc(var(--cell-size) * 0.7);
      background: radial-gradient(circle, #ffffff 0%, #ffffff 60%, var(--bingo-encabezado-color));
      color: #ff6600;
      text-shadow: 2px 2px 0 #000000;
    }
    .carton-tabla thead th .encabezado-letra {
      display: inline-block;
      transition: transform 0.25s ease, letter-spacing 0.25s ease;
    }
    .carton-tabla.ganador thead th .encabezado-letra {
      animation: zoomPulse 1.6s ease-in-out infinite;
    }
    .carton-tabla tbody td {
      font-size: calc(var(--cell-size) * 0.55);
      transition: background 0.4s ease, transform 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
    }
    .carton-tabla td.free {
      background: radial-gradient(circle, #ffbd4f, #ffe8b3);
      color: #4B0082;
      font-size: calc(var(--cell-size) * 0.62);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .carton-tabla .cell-content {
      line-height: 1;
      font-weight: inherit;
    }
    .carton-tabla td.celda-cantada {
      background: radial-gradient(circle at center, rgba(0,200,83,0.32), rgba(0,200,83,0.96));
      color: #ffffff;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.45);
      border-radius: 4px;
    }
    .carton-tabla td.celda-cantada .cell-content {
      text-shadow: 0 0 6px rgba(0,0,0,0.85);
    }
    .carton-tabla td.celda-forma-activa {
      color: inherit;
      border-color: rgba(var(--forma-rgb-vivo, var(--forma-rgb, 0, 120, 255)), 0.95);
      box-shadow: inset 0 0 0 4px rgba(var(--forma-rgb, 0, 120, 255), 0.28), 0 0 10px rgba(var(--forma-rgb-vivo, var(--forma-rgb, 0, 120, 255)), 0.55);
      border-radius: 4px;
    }
    .carton-tabla td.celda-forma-activa:not(.celda-forma-solo-borde) {
      background: radial-gradient(circle at center,
          rgba(var(--forma-rgb-vivo, var(--forma-rgb, 0, 120, 255)), 0.92) 0%,
          rgba(var(--forma-rgb, 0, 120, 255), 0.98) 45%,
          rgba(var(--forma-rgb, 0, 120, 255), 0.82) 100%);
      color: #ffffff;
    }
    .carton-tabla td.celda-forma-activa::before {
      content: '';
      position: absolute;
      inset: 2px;
      border-radius: inherit;
      pointer-events: none;
      background: radial-gradient(circle, rgba(var(--forma-rgb-vivo, var(--forma-rgb, 0, 120, 255)), 0.35) 0%, rgba(var(--forma-rgb, 0, 120, 255), 0.12) 40%, transparent 72%);
    }
    .carton-tabla td.celda-forma-activa .cell-content {
      position: relative;
      z-index: 1;
      animation: zoomPulse 1.4s ease-in-out infinite;
      text-shadow: 0 0 10px rgba(0,0,0,0.9);
    }
    .carton-tabla td.celda-forma-activa:not(.celda-forma-solo-borde) .cell-content {
      color: inherit;
    }
    .carton-tabla td.celda-forma-activa.celda-forma-solo-borde::before {
      display: none;
    }
    .carton-tabla td.celda-forma-activa.celda-forma-solo-borde .cell-content {
      animation: none;
    }
    .carton-tabla td.celda-forma-temporal {
      position: relative;
    }
    .carton-tabla td.celda-forma-temporal::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle, rgba(var(--forma-rgb-vivo, var(--forma-rgb, 0, 120, 255)), 0.55) 0%, rgba(var(--forma-rgb, 0, 120, 255), 0.35) 55%, transparent 90%);
      animation: formaTemporalFade 3s ease forwards;
      pointer-events: none;
      border-radius: 4px;
    }
    .carton-tabla--mini {
      --cell-size: clamp(20px, 7.2vw, 28px);
    }
    .confirm-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
      z-index: 1200;
    }
    .confirm-modal.activo { display: flex; }
    .pdf-confirm-box {
      background: #ffffff;
      border-radius: 14px;
      padding: 24px 20px;
      max-width: 360px;
      width: 100%;
      text-align: center;
      box-shadow: 0 12px 28px rgba(0,0,0,0.35);
      font-family: 'Poppins', sans-serif;
    }
    .pdf-confirm-box h3 {
      margin: 0 0 12px 0;
      font-family: 'Bangers', cursive;
      font-size: 1.5rem;
      color: #0b5394;
    }
    .pdf-confirm-box p {
      margin: 0;
      font-size: 1rem;
      color: #1a1a1a;
    }
    .canto-confirm-box {
      max-width: 340px;
      padding-top: 28px;
      padding-bottom: 28px;
    }
    .canto-confirm-mensaje {
      font-family: 'Bangers', cursive;
      font-size: 1.5rem;
      color: #0b5394;
      text-shadow: 0 0 6px rgba(255,255,255,0.8);
      margin-bottom: 12px;
    }
    #canto-confirm-valor {
      font-family: 'Bangers', cursive;
      font-size: 3rem;
      font-weight: 700;
      color: #1e3aa8;
      text-shadow: 0 0 10px rgba(0,0,0,0.2);
      margin: 0 0 18px;
      text-transform: uppercase;
    }
    .pdf-confirm-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-top: 18px;
    }
    .canto-confirm-actions button {
      font-size: 1.1rem;
      min-width: 130px;
    }
    .pdf-confirm-actions button {
      padding: 8px 18px;
      border-radius: 10px;
      border: 3px solid #FFD700;
      font-family: 'Bangers', cursive;
      font-size: 1rem;
      cursor: pointer;
      background: linear-gradient(#008c3a, #66d17a);
      color: #ffffff;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.4);
      box-shadow: 0 0 8px rgba(0,0,0,0.25);
      min-width: 110px;
    }
    .pdf-confirm-actions button.secundario {
      background: linear-gradient(#9c9c9c, #e0e0e0);
      color: #222;
    }
    .sorteo-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 10px 12px 52px 12px;
      border-radius: 10px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    .sorteo-item:hover { border-color: #1e90ff; box-shadow: 0 4px 12px rgba(0,0,0,0.18); transform: translateY(-1px); }
    .sorteo-item.activo { background: linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(15,157,88,0.95)); color: #0c3f1d; }
    .sorteo-item.inactivo { background: linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(198,40,40,0.92)); color: #4f0909; }
    .sorteo-item.sellado { background: linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(168,168,168,0.95)); color: #1f1f1f; }
    .sorteo-item.jugando { background: linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(106,13,173,0.92)); color: #2d0f44; }
    .sorteo-item.finalizado { background: linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(139,69,19,0.92)); color: #40210a; }
    .sorteo-item.seleccionado {
      box-shadow: 0 0 0 3px rgba(30,144,255,0.6);
      transform: translateY(-1px);
    }
    .sorteo-header {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      font-weight: 700;
      font-size: 1rem;
      gap: 8px;
      padding-right: 70px;
    }
    .sorteo-header .titulo {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .tipo-tag {
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.8px;
      padding: 1px 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.85);
    }
    .tipo-tag.diario { color: #0d7a28; border: 1px solid rgba(13,122,40,0.4); }
    .tipo-tag.especial { color: #ff7b00; border: 1px solid rgba(255,123,0,0.4); }
    .sorteo-detalle {
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 0.85rem;
      flex-wrap: wrap;
    }
    .sorteo-detalle span { display: inline-flex; align-items: center; gap: 4px; }
    .cierre-hora {
      font-weight: 700;
      color: #0b4dda;
      text-shadow: 0 0 4px rgba(255,255,255,0.6);
    }
    .sorteo-extra {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.82rem;
      color: inherit;
      text-align: left;
    }
    .extra-premio {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 8px;
    }
    .extra-premio-main {
      font-weight: 700;
      color: #ffffff;
      text-shadow: 0 0 6px #072968;
    }
    .extra-premio-subtotales {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.7rem;
    }
    .forma-subtotal {
      font-weight: 700;
      text-shadow: 0 0 6px rgba(255,255,255,0.9), 0 0 12px rgba(255,255,255,0.8);
    }
    .forma-subtotal.forma1 { color: #1b8f3a; }
    .forma-subtotal.forma2 { color: #b8860b; }
    .forma-subtotal.forma3 { color: #1160c9; }
    .forma-subtotal.forma4 { color: #6a0dad; }
    .forma-subtotal.forma5 { color: #d2691e; }
    .extra-cartones,
    .extra-cantos { font-weight: 700; display: flex; align-items: center; gap: 4px; }
    .extra-cartones-pagos {
      color: #6a0dad;
      text-shadow: 0 0 4px rgba(255,255,255,0.9);
    }
    .extra-cartones-gratis {
      color: #001f54;
      text-shadow: 0 0 4px rgba(255,255,255,0.9);
    }
    .extra-cartones-mas {
      font-weight: 700;
      color: #ffffff;
      text-shadow: 0 0 4px rgba(0,0,0,0.3);
    }
    .extra-cantos-valor {
      color: #0db050;
      text-shadow: 0 0 4px rgba(255,215,0,0.9);
    }
    .extra-premio-main .valor-premio,
    .extra-cartones span,
    .extra-cantos span { font-weight: 700; }

    .sorteo-corner-info {
      position: absolute;
      right: 10px;
      bottom: 10px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      pointer-events: none;
    }

    .corner-cantos {
      font-family: 'Bangers', cursive;
      font-size: 1.2rem;
      color: #ffffff;
      text-shadow: 0 0 6px rgba(96,0,128,0.9), 0 0 14px rgba(128,0,192,0.8);
      letter-spacing: 1px;
    }

    .corner-cantos-valor {
      color: #ffffff;
      text-shadow: 0 0 8px rgba(96,0,128,0.95), 0 0 16px rgba(128,0,192,0.85);
    }

    .corner-estado {
      font-family: 'Bangers', cursive;
      font-size: 1rem;
      text-transform: uppercase;
      background: rgba(255,255,255,0.85);
      padding: 2px 10px;
      border-radius: 999px;
      color: #111;
      box-shadow: 0 0 6px rgba(0,0,0,0.15);
      letter-spacing: 1px;
    }

    .corner-estado.activo { color: #0f8b0f; }
    .corner-estado.inactivo { color: #c62828; }
    .corner-estado.sellado { color: #555555; }
    .corner-estado.jugando { color: #6a0dad; }
    .corner-estado.finalizado { color: #8b4513; }

    .corner-cantos.jugando {
      animation: zoomInOut 1.2s ease-in-out infinite;
    }
    .attention { animation: zoomInOut 1s infinite; }
    @keyframes zoomInOut { 0%,100% { transform: scale(1); } 50% { transform: scale(1.15); } }
    #mensaje-area {
      margin-top: 10px;
      font-family: 'Poppins', sans-serif;
      color: #111;
      font-size: 0.9rem;
      background: rgba(255,255,255,0.6);
      padding: 6px 10px;
      border-radius: 8px;
      max-width: 480px;
    }
    #footer {
      margin-top: auto;
      font-size: 0.7rem;
      color: #000;
      text-align: center;
    }
    #footer #derechos { font-size: 0.6rem; }
  </style>
</head>
<body>
  <button id="salir-btn" class="menu-btn"><span class="tri">&#9664;</span><span class="label">Salir</span></button>
  <h1>CANTAR SORTEO</h1>
  <section id="sorteo-section">
    <div class="sorteo-info">
      <button id="sorteo-btn">Selecciona Sorteo</button>
      <div id="fecha-hora-sorteo">
        <table id="tabla-fechas">
          <tbody>
            <tr id="fila-cierre" class="fila-fecha oculta">
              <td class="celda-icono placeholder">
                <span class="icono-emoji" aria-hidden="true">📅</span>
              </td>
              <td class="celda-valor">
                <span id="fecha-cierre" class="valor-cierre estado-tiempo"></span>
              </td>
              <td class="celda-icono placeholder">
                <span class="icono-emoji" aria-hidden="true">⏰</span>
              </td>
              <td class="celda-valor">
                <span id="hora-cierre" class="valor-cierre estado-tiempo"></span>
              </td>
            </tr>
            <tr id="fila-programada" class="fila-fecha fila-datos-sorteo">
              <td class="celda-icono">
                <span class="icono-emoji" aria-hidden="true">📅</span>
              </td>
              <td class="celda-valor">
                <span id="fecha-programada" class="valor-programado estado-tiempo"></span>
              </td>
              <td class="celda-icono">
                <span class="icono-emoji" aria-hidden="true">⏰</span>
              </td>
              <td class="celda-valor">
                <span id="hora-programada" class="valor-programado estado-tiempo"></span>
              </td>
            </tr>
            <tr class="fila-fecha">
              <td class="celda-icono placeholder">
                <span class="icono-emoji" aria-hidden="true">📅</span>
              </td>
              <td class="celda-valor">
                <span id="fecha-actual" class="valor-actual resaltado-actual estado-tiempo"></span>
              </td>
              <td class="celda-icono placeholder">
                <span class="icono-emoji" aria-hidden="true">⏰</span>
              </td>
              <td class="celda-valor">
                <span id="hora-actual" class="valor-actual resaltado-actual estado-tiempo"></span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="datos-sorteo">
      <div id="premio-repartir"><span>PREMIO A REPARTIR:</span> <span id="premio-valor">0</span></div>
      <div id="stats-row">
        <div id="valor-carton"><span>💵</span> Cartón: <span class="valor" id="valor-carton-valor">0</span></div>
        <div id="cartones-jugando">
          <img src="https://cdn-icons-png.flaticon.com/32/5065/5065890.png" class="carton-icon" alt="Cartón" style="width:28px;height:28px;">
          Jugando: <span class="valor" id="cartones-jugando-valor">0</span>
          <span class="extra">+</span>
          <span class="valor extra" id="cartones-gratis-jugando">0</span>
        </div>
      </div>
    </div>
  </section>
  <section id="detalle-container">
    <div id="sorteo-nombre">Selecciona un sorteo para ver los detalles</div>
    <div id="estado-actual">
      <span id="tipo-estado" class="tipo-estado"></span>
      <span class="estado-etiqueta">ESTADO:</span>
      <span id="estado-valor" class="estado-badge">-</span>
      <div id="modo-toggle-container">
        <label class="modo-switch" title="Cambiar modo Manual/Validado">
          <input type="checkbox" id="modo-manual-switch" aria-label="Interruptor de modo manual">
          <span class="modo-slider"></span>
        </label>
        <span id="modo-manual-estado">Validado</span>
      </div>
    </div>
    <div id="resumen-sorteo">
      <div id="tipo-sorteo"></div>
    </div>
    <div id="acciones-sorteo">
      <button id="sellar-btn" class="estado-btn" title="Sellar sorteo">
        <span class="stop-icon">STOP</span>
      </button>
      <button id="pdf-btn" class="estado-btn" title="Generar PDF">
        <svg class="pdf-btn-icon" viewBox="0 0 48 48" role="img" aria-label="Documento PDF">
          <defs>
            <linearGradient id="pdfIconGradient" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#ffffff" />
              <stop offset="100%" stop-color="#ffebee" />
            </linearGradient>
          </defs>
          <path d="M14 4h18l8 8v28a4 4 0 0 1-4 4H14a4 4 0 0 1-4-4V8a4 4 0 0 1 4-4z" fill="url(#pdfIconGradient)" stroke="#d32f2f" stroke-width="2" stroke-linejoin="round"></path>
          <path d="M32 4v8h8" fill="#ffffff" stroke="#d32f2f" stroke-width="2" stroke-linejoin="round"></path>
          <rect x="14" y="22" width="20" height="16" rx="3" fill="#d32f2f"></rect>
          <text x="24" y="33" text-anchor="middle" font-family="'Poppins', sans-serif" font-weight="700" font-size="11" fill="#ffffff" letter-spacing="1">PDF</text>
        </svg>
        <span class="pdf-floating-icon" aria-hidden="true">
          <svg viewBox="0 0 36 40" role="img" aria-hidden="true">
            <defs>
              <linearGradient id="pdfFloatGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="#ffffff" />
                <stop offset="100%" stop-color="#ffe9eb" />
              </linearGradient>
            </defs>
            <path d="M11 2h12l7 7v23a4 4 0 0 1-4 4H11a4 4 0 0 1-4-4V6a4 4 0 0 1 4-4z" fill="url(#pdfFloatGradient)" stroke="#e53935" stroke-width="2" stroke-linejoin="round"></path>
            <path d="M23 2v7h7" fill="#ffffff" stroke="#e53935" stroke-width="2" stroke-linejoin="round"></path>
            <rect x="11" y="18" width="14" height="10" rx="2" fill="#e53935"></rect>
            <path d="M14 23l3 3 6-6" fill="none" stroke="#ffffff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </span>
      </button>
      <button id="jugar-btn" class="estado-btn" title="Cambiar a Jugando">
        <img src="https://api.iconify.design/mdi/slot-machine.svg?color=white" alt="Jugar">
      </button>
      <button id="finalizar-btn" class="estado-btn" title="Finalizar sorteo">
        <img src="https://api.iconify.design/mdi/flag-checkered.svg?color=white" alt="Finalizar">
      </button>
    </div>
  </section>
  <section id="tabla-cantos-wrapper">
    <div id="panel-ganadores-formas" role="group" aria-label="Ganadores por forma"></div>
    <div id="tabla-cantos-container" class="disabled"></div>
  </section>
  <div id="modal-ganadores" class="modal modal-ganadores" role="dialog" aria-modal="true" aria-labelledby="modal-ganadores-titulo" aria-hidden="true">
    <div class="modal-contenido">
      <button id="modal-ganadores-cerrar" class="modal-cerrar" type="button" aria-label="Cerrar">✖</button>
      <h2 id="modal-ganadores-titulo">Ganadores</h2>
      <div id="modal-ganadores-subtitulo" class="mensaje"></div>
      <div id="modal-ganadores-lista"></div>
      <div id="modal-ganadores-sin" class="modal-mensaje"></div>
    </div>
  </div>
  <div id="mensaje-area">Selecciona un sorteo para administrar su estado.</div>
  <div id="footer">
    <div id="fecha-hora"></div>
    <div id="derechos">Todos los derechos reservados ® Hexaservice 2025</div>
  </div>
  <div id="sorteos-modal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation();">
      <h3 style="text-align:center;font-family:'Bangers',cursive;color:#1e3aa8;margin:0 0 6px 0;">Sorteos Disponibles</h3>
      <div id="sorteos-list" style="display:flex;flex-direction:column;gap:6px;"></div>
    </div>
  </div>
  <div id="canto-confirm-modal" class="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="canto-confirm-mensaje">
    <div class="pdf-confirm-box canto-confirm-box">
      <p id="canto-confirm-mensaje" class="canto-confirm-mensaje">¿Este es el Canto a guardar?</p>
      <div id="canto-confirm-valor"></div>
      <div class="pdf-confirm-actions canto-confirm-actions">
        <button id="canto-confirm-aceptar">Aceptar</button>
        <button id="canto-confirm-cancelar" class="secundario">Cancelar</button>
      </div>
    </div>
  </div>
  <div id="pdf-confirm-modal" class="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="pdf-confirm-title">
    <div class="pdf-confirm-box">
      <h3 id="pdf-confirm-title">Guardar PDF</h3>
      <p>¿Ya se guardó el archivo PDF de este sorteo?</p>
      <div class="pdf-confirm-actions">
        <button id="pdf-confirm-si">Sí</button>
        <button id="pdf-confirm-no" class="secundario">No</button>
      </div>
    </div>
  </div>
  <div id="estado-confirm-modal" class="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="estado-confirm-title">
    <div class="pdf-confirm-box">
      <h3 id="estado-confirm-title">Confirmar acción</h3>
      <p id="estado-confirm-mensaje">¿Deseas continuar con esta acción?</p>
      <div class="pdf-confirm-actions">
        <button id="estado-confirm-si">Sí</button>
        <button id="estado-confirm-no" class="secundario">No</button>
      </div>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-auth-compat.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/timezone.js"></script>
  <script>
  ensureAuth('Administrador');
  initServerTime().then(()=>{
    inicializarFechaHoraFooter();
    iniciarActualizacionesActuales();
  });

  let sorteos = [];
  let currentSorteoId = null;
  let currentSorteoData = null;
  let sorteoUnsub = null;

  const btnSorteo = document.getElementById('sorteo-btn');
  const fechaProgramadaEl = document.getElementById('fecha-programada');
  const horaProgramadaEl = document.getElementById('hora-programada');
  const fechaActualValorEl = document.getElementById('fecha-actual');
  const horaActualValorEl = document.getElementById('hora-actual');
  const filaProgramada = document.getElementById('fila-programada');
  const filaCierre = document.getElementById('fila-cierre');
  const fechaCierreEl = document.getElementById('fecha-cierre');
  const horaCierreEl = document.getElementById('hora-cierre');
  const premioEl = document.getElementById('premio-valor');
  const valorCartonEl = document.getElementById('valor-carton-valor');
  const cartonesPagosEl = document.getElementById('cartones-jugando-valor');
  const cartonesGratisEl = document.getElementById('cartones-gratis-jugando');
  const detalleContainer = document.getElementById('detalle-container');
  const sorteoNombreEl = document.getElementById('sorteo-nombre');
  const estadoActualEl = document.getElementById('estado-actual');
  const estadoValorEl = document.getElementById('estado-valor');
  const tipoEstadoEl = document.getElementById('tipo-estado');
  const tipoEl = document.getElementById('tipo-sorteo');
  const mensajeEl = document.getElementById('mensaje-area');
  const sellarBtn = document.getElementById('sellar-btn');
  const pdfBtn = document.getElementById('pdf-btn');
  const pdfFloatingIcon = pdfBtn ? pdfBtn.querySelector('.pdf-floating-icon') : null;
  const jugarBtn = document.getElementById('jugar-btn');
  const finalizarBtn = document.getElementById('finalizar-btn');
  const modoManualSwitch = document.getElementById('modo-manual-switch');
  const modoManualEstadoEl = document.getElementById('modo-manual-estado');
  const tablaCantosContainer = document.getElementById('tabla-cantos-container');
  const panelGanadoresEl = document.getElementById('panel-ganadores-formas');
  const modalGanadoresEl = document.getElementById('modal-ganadores');
  const modalGanadoresCerrarBtn = document.getElementById('modal-ganadores-cerrar');
  const modalGanadoresTituloEl = document.getElementById('modal-ganadores-titulo');
  const modalGanadoresSubtituloEl = document.getElementById('modal-ganadores-subtitulo');
  const modalGanadoresListaEl = document.getElementById('modal-ganadores-lista');
  const modalGanadoresSinEl = document.getElementById('modal-ganadores-sin');
  const cantoCeldas = new Map();
  let cantosSeleccionados = new Set();
  let cantosUnsub = null;
  const sorteoCookieDefaultKey = 'cantarsorteos_default';
  let sorteoCookieKey = sorteoCookieDefaultKey;
  let restauracionPendiente = false;
  let pdfDestinoUrl = '';
  let promesaCargaSorteos = null;
  let verificacionAutomaticaPromesa = null;
  let ultimaCargaSorteos = 0;
  const INTERVALO_CACHE_SORTEOS_MS = 30000;
  const TAM_MAX_CONSULTA_IN = 10;
  let modoManual = false;
  let infoTiempoSorteo = {
    fecha: null,
    fechaCierre: null,
    hora: null,
    horaCierre: null
  };
  const clasesEstadoTiempo = [
    'estado-tiempo-futuro',
    'estado-tiempo-proximo',
    'estado-tiempo-actual',
    'estado-tiempo-pasado',
    'estado-tiempo-pasado-lejano',
    'estado-tiempo-sin-dato'
  ];
  const setClasesEstadoTiempo = new Set(clasesEstadoTiempo);
  const CLASE_TIEMPO_PASADO_LEJANO = 'estado-tiempo-pasado-lejano';
  const MILISEGUNDOS_EN_DIA = 24 * 60 * 60 * 1000;
  const MINUTOS_EN_DIA = 24 * 60;
  const estadoConfirmModal = document.getElementById('estado-confirm-modal');
  const estadoConfirmMensajeEl = document.getElementById('estado-confirm-mensaje');
  const estadoConfirmSiBtn = document.getElementById('estado-confirm-si');
  const estadoConfirmNoBtn = document.getElementById('estado-confirm-no');
  let cantoConfirmModal = document.getElementById('canto-confirm-modal');
  let cantoConfirmMensajeEl = document.getElementById('canto-confirm-mensaje');
  let cantoConfirmValorEl = document.getElementById('canto-confirm-valor');
  let cantoConfirmAceptarBtn = document.getElementById('canto-confirm-aceptar');
  let cantoConfirmCancelarBtn = document.getElementById('canto-confirm-cancelar');
  let resolverConfirmacionEstado = null;
  let resolverConfirmacionCanto = null;
  let resolverAuthListo = null;
  const authListoPromesa = new Promise(resolve=>{ resolverAuthListo = resolve; });
  const FORM_COLORS = ['#90ee90', '#fffacd', '#add8e6', '#d8b0ff', '#ffcc99', '#f77fb3', '#9ad3bc', '#fecf6a'];
  const BINGO_LETRAS = ['B','I','N','G','O'];
  const botonesFormas = new Map();
  let formasActivas = [];
  let formasBaseResumen = [];
  let formasPorCarton = new Map();
  let cartonesSorteo = new Map();
  let cartonesGanadoresPorForma = new Map();
  let cantosOrdenados = [];
  let cantosIndiceMap = new Map();
  let formasUnsub = null;
  let cartonesUnsub = null;
  let cartonesDatosListos = false;

  function manejarAceptarConfirmacionCanto(){
    cerrarConfirmacionCanto(true);
  }

  function manejarCancelarConfirmacionCanto(){
    cerrarConfirmacionCanto(false);
  }

  function manejarFondoConfirmacionCanto(evento){
    if(evento.target === cantoConfirmModal){
      cerrarConfirmacionCanto(false);
    }
  }

  function asegurarModalConfirmacionCanto(){
    cantoConfirmModal = document.getElementById('canto-confirm-modal');
    cantoConfirmMensajeEl = document.getElementById('canto-confirm-mensaje');
    cantoConfirmValorEl = document.getElementById('canto-confirm-valor');
    cantoConfirmAceptarBtn = document.getElementById('canto-confirm-aceptar');
    cantoConfirmCancelarBtn = document.getElementById('canto-confirm-cancelar');

    if(cantoConfirmAceptarBtn){
      cantoConfirmAceptarBtn.removeEventListener('click', manejarAceptarConfirmacionCanto);
      cantoConfirmAceptarBtn.addEventListener('click', manejarAceptarConfirmacionCanto);
    }
    if(cantoConfirmCancelarBtn){
      cantoConfirmCancelarBtn.removeEventListener('click', manejarCancelarConfirmacionCanto);
      cantoConfirmCancelarBtn.addEventListener('click', manejarCancelarConfirmacionCanto);
    }
    if(cantoConfirmModal){
      cantoConfirmModal.removeEventListener('click', manejarFondoConfirmacionCanto);
      cantoConfirmModal.addEventListener('click', manejarFondoConfirmacionCanto);
    }
  }

  function completarConfirmacionEstado(valor){
    if(estadoConfirmModal){
      estadoConfirmModal.classList.remove('activo');
    }
    const resolver = resolverConfirmacionEstado;
    resolverConfirmacionEstado = null;
    if(typeof resolver === 'function'){
      resolver(valor);
    }
  }

  function mostrarConfirmacionEstado(mensaje){
    if(!estadoConfirmModal){
      return Promise.resolve(window.confirm(mensaje));
    }
    if(estadoConfirmMensajeEl){
      estadoConfirmMensajeEl.textContent = mensaje;
    }
    if(estadoConfirmModal){
      estadoConfirmModal.classList.add('activo');
    }
    const foco = estadoConfirmSiBtn || estadoConfirmNoBtn;
    if(foco){
      foco.focus();
    }
    return new Promise(resolve => {
      resolverConfirmacionEstado = resolve;
    });
  }

  function preguntarAccionEstado(mensaje){
    if(estadoConfirmModal){
      return mostrarConfirmacionEstado(mensaje);
    }
    return Promise.resolve(window.confirm(mensaje));
  }

  function cerrarConfirmacionCanto(valor){
    if(cantoConfirmModal){
      cantoConfirmModal.classList.remove('activo');
    }
    if(cantoConfirmValorEl){
      cantoConfirmValorEl.textContent = '';
    }
    const resolver = resolverConfirmacionCanto;
    resolverConfirmacionCanto = null;
    if(typeof resolver === 'function'){
      resolver(valor === true);
    }
  }

  function mostrarConfirmacionCanto(clave){
    let modalExistente = document.getElementById('canto-confirm-modal');
    if(!modalExistente){
      modalExistente = document.createElement('div');
      modalExistente.id = 'canto-confirm-modal';
      modalExistente.className = 'confirm-modal';
      modalExistente.setAttribute('role', 'dialog');
      modalExistente.setAttribute('aria-modal', 'true');
      modalExistente.setAttribute('aria-labelledby', 'canto-confirm-mensaje');
      modalExistente.innerHTML = `
        <div class="pdf-confirm-box canto-confirm-box">
          <p id="canto-confirm-mensaje" class="canto-confirm-mensaje">¿Este es el Canto a guardar?</p>
          <div id="canto-confirm-valor"></div>
          <div class="pdf-confirm-actions canto-confirm-actions">
            <button id="canto-confirm-aceptar">Aceptar</button>
            <button id="canto-confirm-cancelar" class="secundario">Cancelar</button>
          </div>
        </div>`;
      document.body.appendChild(modalExistente);
    }
    cantoConfirmModal = modalExistente;
    asegurarModalConfirmacionCanto();
    if(!cantoConfirmModal || !cantoConfirmMensajeEl || !cantoConfirmValorEl){
      return Promise.resolve(false);
    }
    if(cantoConfirmMensajeEl){
      cantoConfirmMensajeEl.textContent = '¿Este es el Canto a guardar?';
    }
    if(cantoConfirmValorEl){
      cantoConfirmValorEl.textContent = clave;
    }
    cantoConfirmModal.classList.add('activo');
    const foco = cantoConfirmAceptarBtn || cantoConfirmCancelarBtn;
    if(foco){ foco.focus(); }
    return new Promise(resolve=>{
      resolverConfirmacionCanto = resolve;
    });
  }

  function setCookie(name, value){
    try {
      document.cookie = `${name}=${encodeURIComponent(value)};path=/;max-age=31536000`;
    } catch (err) {
      console.warn('No fue posible establecer la cookie para el sorteo seleccionado.', err);
    }
    try {
      localStorage.setItem(name, value);
    } catch (err) {
      console.warn('No fue posible almacenar el sorteo seleccionado en localStorage.', err);
    }
  }

  function getCookie(name){
    try {
      const match = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/[.$?*|{}()\[\]\\\/\+^]/g, '\\$&') + '=([^;]*)'));
      if(match){
        return decodeURIComponent(match[1]);
      }
    } catch (err) {
      console.warn('No fue posible leer la cookie del sorteo seleccionado.', err);
    }
    try {
      return localStorage.getItem(name);
    } catch (err) {
      console.warn('No fue posible recuperar el sorteo seleccionado desde localStorage.', err);
      return null;
    }
  }

  function deleteCookie(name){
    try {
      document.cookie = `${name}=;path=/;max-age=0`;
    } catch (err) {
      console.warn('No fue posible eliminar la cookie del sorteo seleccionado.', err);
    }
    try {
      localStorage.removeItem(name);
    } catch (err) {
      console.warn('No fue posible eliminar el sorteo seleccionado de localStorage.', err);
    }
  }

  function limpiarSorteoSeleccionado(){
    if(sorteoCookieKey){
      deleteCookie(sorteoCookieKey);
    }
    if(sorteoCookieKey !== sorteoCookieDefaultKey){
      deleteCookie(sorteoCookieDefaultKey);
    }
  }

  async function verificarSorteoPersistidoAlEntrar(opciones = {}){
    const mostrarFallback = opciones.mostrarFallback === true;
    const esperarCargaActiva = opciones.esperarCargaActiva !== false;
    if(verificacionAutomaticaPromesa){
      return verificacionAutomaticaPromesa;
    }
    verificacionAutomaticaPromesa = (async()=>{
      if(esperarCargaActiva && promesaCargaSorteos){
        try {
          await promesaCargaSorteos.catch(()=>{});
        } catch (err) {
          console.warn('No se pudo completar la carga previa al restaurar el sorteo guardado.', err);
        }
      }
      if(!Array.isArray(sorteos) || !sorteos.length){
        if(mostrarFallback){
          restauracionPendiente = false;
          try {
            mostrarDatos();
          } catch (err) {
            console.error('Error mostrando los datos al no encontrar un sorteo previo.', err);
          }
        }
        return false;
      }
      let restaurado = false;
      try {
        restaurado = intentarRestaurarSorteo();
      } catch (err) {
        console.error('Error intentando restaurar el sorteo guardado.', err);
        restaurado = false;
      }
      if(!restaurado && mostrarFallback){
        restauracionPendiente = false;
        try {
          mostrarDatos();
        } catch (err) {
          console.error('Error mostrando los datos luego de intentar restaurar el sorteo.', err);
        }
      }
      return restaurado;
    })();
    try {
      return await verificacionAutomaticaPromesa;
    } finally {
      verificacionAutomaticaPromesa = null;
    }
  }

  function obtenerSorteoActivoMasReciente(){
    if(!Array.isArray(sorteos) || !sorteos.length) return null;
    const prioridadEstado = { jugando: 0, activo: 1, sellado: 2, finalizado: 3 };
    let candidato = null;
    sorteos.forEach(registro=>{
      if(!registro || !registro.id) return;
      if(!esSorteoVisible(registro)) return;
      const estado = (registro.estado || '').toString().toLowerCase();
      if(estado === 'inactivo' || estado === 'archivado') return;
      const prioridad = Object.prototype.hasOwnProperty.call(prioridadEstado, estado)
        ? prioridadEstado[estado]
        : 4;
      const fechaReferencia = obtenerFechaSorteo(registro)
        || obtenerFechaDesdeValor(registro.fecha)
        || obtenerFechaDesdeValor(registro.fechacierre);
      const tiempo = (fechaReferencia instanceof Date && !isNaN(fechaReferencia.getTime()))
        ? fechaReferencia.getTime()
        : Number.NEGATIVE_INFINITY;
      if(!candidato){
        candidato = { registro, prioridad, tiempo };
        return;
      }
      if(prioridad < candidato.prioridad
        || (prioridad === candidato.prioridad && tiempo > candidato.tiempo)
        || (prioridad === candidato.prioridad && tiempo === candidato.tiempo
          && (registro.nombre || '').toString().localeCompare((candidato.registro.nombre || '').toString()) < 0)){
        candidato = { registro, prioridad, tiempo };
      }
    });
    return candidato ? candidato.registro : null;
  }

  function restaurarSorteoMasReciente(){
    const candidato = obtenerSorteoActivoMasReciente();
    if(!candidato) return false;
    seleccionarSorteo(candidato.id);
    return true;
  }

  function esSorteoVisible(info){
    if(!info) return false;
    const condicionTexto = (info.condicion ?? info['condición'] ?? '').toString().trim().toUpperCase();
    return condicionTexto === 'VISIBLE';
  }

  function guardarSorteoSeleccionado(info){
    if(!sorteoCookieKey || !info) return;
    let payload;
    let referencia = null;
    if(typeof info === 'string'){
      if(!info) return;
      referencia = sorteos.find(s=>s.id===info) || null;
      if(!referencia || !esSorteoVisible(referencia)){
        limpiarSorteoSeleccionado();
        return;
      }
      payload = { id: info, tipo: referencia.tipo || '' };
    }else{
      const id = info.id || '';
      if(!id) return;
      if(!esSorteoVisible(info)){
        limpiarSorteoSeleccionado();
        return;
      }
      payload = { id, tipo: info.tipo || '' };
    }
    setCookie(sorteoCookieKey, JSON.stringify(payload));
    if(sorteoCookieKey !== sorteoCookieDefaultKey){
      setCookie(sorteoCookieDefaultKey, JSON.stringify(payload));
    }
  }

  function intentarRestaurarSorteo(){
    if(!sorteoCookieKey){
      restauracionPendiente = false;
      return restaurarSorteoMasReciente();
    }
    let guardado = getCookie(sorteoCookieKey);
    if((!guardado || guardado === 'undefined') && sorteoCookieKey !== sorteoCookieDefaultKey){
      const respaldoGeneral = getCookie(sorteoCookieDefaultKey);
      if(respaldoGeneral && respaldoGeneral !== 'undefined'){
        setCookie(sorteoCookieKey, respaldoGeneral);
        guardado = respaldoGeneral;
      }
    }
    if(!guardado){
      restauracionPendiente = false;
      return restaurarSorteoMasReciente();
    }
    let idRestaurar = guardado;
    try {
      const data = JSON.parse(guardado);
      if(data && typeof data === 'object'){
        idRestaurar = data.id || '';
      }
    } catch (err) {
      idRestaurar = guardado;
    }
    if(!idRestaurar){
      restauracionPendiente = false;
      return restaurarSorteoMasReciente();
    }
    if(!sorteos || !sorteos.length){
      return false;
    }
    if(idRestaurar === currentSorteoId){
      restauracionPendiente = false;
      return true;
    }
    const existe = sorteos.find(s=>s.id===idRestaurar);
    if(!existe || !esSorteoVisible(existe)){
      limpiarSorteoSeleccionado();
      restauracionPendiente = false;
      return restaurarSorteoMasReciente();
    }
    seleccionarSorteo(idRestaurar);
    restauracionPendiente = false;
    return true;
  }

  let authListenerRegistrado = false;

  function registrarObservadorAuth(){
    if(authListenerRegistrado) return;
    authListenerRegistrado = true;
    initFirebase()
      .then(()=>{
        if(!auth || typeof auth.onAuthStateChanged !== 'function'){
          throw new Error('Firebase Auth no está disponible.');
        }
        auth.onAuthStateChanged(async user=>{
          if(!user){
            sorteoCookieKey = sorteoCookieDefaultKey;
            restauracionPendiente = false;
            if(resolverAuthListo){ resolverAuthListo(); resolverAuthListo = null; }
            return;
          }
          const nuevoKey = `cantarsorteos_${user.email.replace(/[^\w]/g,'_')}`;
          if(!getCookie(nuevoKey)){
            const general = getCookie(sorteoCookieDefaultKey);
            if(general){
              setCookie(nuevoKey, general);
            }
          }
          sorteoCookieKey = nuevoKey;
          restauracionPendiente = true;
          try {
            await verificarSorteoPersistidoAlEntrar({ mostrarFallback: false });
          } catch (err) {
            console.error('No se pudo restaurar el sorteo tras la autenticación.', err);
          }
          if(resolverAuthListo){ resolverAuthListo(); resolverAuthListo = null; }
        });
      })
      .catch(err=>{
        console.error('No se pudo registrar el observador de autenticación.', err);
        if(mensajeEl){
          mensajeEl.textContent = 'No se pudo validar la sesión actual. Recarga la página.';
        }
        if(resolverAuthListo){ resolverAuthListo(); resolverAuthListo = null; }
      });
  }

  registrarObservadorAuth();

  inicializarPanelGanadores();
  if(modalGanadoresCerrarBtn){
    modalGanadoresCerrarBtn.addEventListener('click', cerrarModalGanadores);
  }
  if(modalGanadoresEl){
    modalGanadoresEl.addEventListener('click', manejarClickModalGanadores);
  }
  document.addEventListener('keydown', manejarTeclaModalGanadores);

  document.getElementById('salir-btn').addEventListener('click',()=>{ window.location.href='admin.html'; });
  btnSorteo.addEventListener('click', abrirModalSorteos);
  sellarBtn.addEventListener('click', sellarSorteo);
  pdfBtn.addEventListener('click', abrirPDF);
  if(pdfFloatingIcon){
    pdfFloatingIcon.addEventListener('click', manejarClickPdfAlmacenado);
  }
  jugarBtn.addEventListener('click', cambiarAJugando);
  finalizarBtn.addEventListener('click', finalizarSorteo);
  if(modoManualSwitch){
    modoManualSwitch.addEventListener('change', ()=>{
      modoManual = modoManualSwitch.checked;
      actualizarEstadoModo();
    });
    actualizarEstadoModo();
  }
  construirTablaCantos();
  if(cantoConfirmAceptarBtn){
    cantoConfirmAceptarBtn.addEventListener('click', manejarAceptarConfirmacionCanto);
  }
  if(cantoConfirmCancelarBtn){
    cantoConfirmCancelarBtn.addEventListener('click', manejarCancelarConfirmacionCanto);
  }
  if(cantoConfirmModal){
    cantoConfirmModal.addEventListener('click', manejarFondoConfirmacionCanto);
  }
  if(estadoConfirmSiBtn){
    estadoConfirmSiBtn.addEventListener('click', ()=>completarConfirmacionEstado(true));
  }
  if(estadoConfirmNoBtn){
    estadoConfirmNoBtn.addEventListener('click', ()=>completarConfirmacionEstado(false));
  }
  if(estadoConfirmModal){
    estadoConfirmModal.addEventListener('click', evento=>{
      if(evento.target === estadoConfirmModal){
        completarConfirmacionEstado(false);
      }
    });
  }
  document.addEventListener('keydown', evento=>{
    if(evento.key === 'Escape'){
      let cerrado = false;
      if(cantoConfirmModal && cantoConfirmModal.classList.contains('activo')){
        cerrarConfirmacionCanto(false);
        cerrado = true;
      }
      if(estadoConfirmModal && estadoConfirmModal.classList.contains('activo')){
        completarConfirmacionEstado(false);
        cerrado = true;
      }
      if(cerrado){
        evento.preventDefault();
      }
    }
  });

  function obtenerServerTime(){
    if(typeof window !== 'undefined' && window.serverTime) return window.serverTime;
    if(typeof serverTime !== 'undefined') return serverTime;
    return null;
  }

  function getServerNow(){
    const st = obtenerServerTime();
    return new Date(Date.now() + (st?.diferencia || 0));
  }

  function esModoManual(){
    return modoManual === true;
  }

  function actualizarEstadoModo(){
    if(modoManualEstadoEl){
      modoManualEstadoEl.textContent = modoManual ? 'Manual' : 'Validado';
    }
  }

  function actualizarValoresActuales(){
    if(!fechaActualValorEl || !horaActualValorEl) return;
    try {
      const st = obtenerServerTime();
      const diferencia = st?.diferencia || 0;
      const ahora = new Date(Date.now() + diferencia);
      const zona = st?.zonaIana;
      const opcionesFecha = { day: '2-digit', month: '2-digit', year: 'numeric' };
      const opcionesHora = { hour: '2-digit', minute: '2-digit', hour12: true };
      if(zona){
        opcionesFecha.timeZone = zona;
        opcionesHora.timeZone = zona;
      }
      const fechaFormatter = new Intl.DateTimeFormat('es-ES', opcionesFecha);
      const horaFormatter = new Intl.DateTimeFormat('en-US', opcionesHora);
      const fechaStr = fechaFormatter.format(ahora);
      const horaStr = horaFormatter.format(ahora).toUpperCase();
      fechaActualValorEl.textContent = fechaStr;
      horaActualValorEl.textContent = horaStr;
      actualizarColoresFechas(ahora);
    } catch (err) {
      console.error('Error actualizando fecha y hora actuales', err);
    }
  }

  function inicializarFechaHoraFooter(){
    const footerEl = document.getElementById('fecha-hora');
    if(!footerEl) return;
    function renderFooter(){
      try {
        const st = obtenerServerTime();
        const diferencia = st?.diferencia || 0;
        const ahora = new Date(Date.now() + diferencia);
        const locale = st?.locale || 'es-ES';
        const zona = st?.zonaIana;
        const opcionesFecha = { year: 'numeric', month: 'long', day: 'numeric' };
        const opcionesHora = { hour: '2-digit', minute: '2-digit', hour12: true };
        if(zona){
          opcionesFecha.timeZone = zona;
          opcionesHora.timeZone = zona;
        }
        const fechaStr = ahora.toLocaleDateString(locale, opcionesFecha);
        let horaStr = ahora.toLocaleTimeString(locale, opcionesHora);
        horaStr = horaStr
          .replace(/\s*a\.?\s*m\.?/gi, ' AM')
          .replace(/\s*p\.?\s*m\.?/gi, ' PM');
        footerEl.textContent = '';
        const fragment = document.createDocumentFragment();
        if(st?.Pais){
          const paisSpan = document.createElement('span');
          paisSpan.className = 'pais-actual';
          paisSpan.textContent = `${st.Pais} |`;
          fragment.appendChild(paisSpan);
          fragment.appendChild(document.createTextNode(' '));
        }
        const fechaSpan = document.createElement('span');
        fechaSpan.className = 'fecha-actual-texto';
        fechaSpan.textContent = fechaStr;
        fragment.appendChild(fechaSpan);
        fragment.appendChild(document.createTextNode(' '));
        const horaSpan = document.createElement('span');
        horaSpan.className = 'hora-actual-texto';
        horaSpan.textContent = horaStr;
        fragment.appendChild(horaSpan);
        footerEl.appendChild(fragment);
      } catch (error) {
        console.error('Error actualizando fecha y hora del footer', error);
      }
    }
    renderFooter();
    setInterval(renderFooter, 1000);
  }

  function iniciarActualizacionesActuales(){
    actualizarValoresActuales();
    setInterval(actualizarValoresActuales, 1000);
    setInterval(()=>actualizarColoresFechas(), 15000);
  }

  function construirTablaCantos(){
    if(!tablaCantosContainer) return;
    tablaCantosContainer.innerHTML = '';
    cantoCeldas.clear();
    const tabla = document.createElement('table');
    tabla.id = 'tabla-cantos';
    const thead = document.createElement('thead');
    const headRow = document.createElement('tr');
    const letras = ['B','I','N','G','O'];
    letras.forEach(letra=>{
      const th = document.createElement('th');
      th.textContent = letra;
      headRow.appendChild(th);
    });
    thead.appendChild(headRow);
    tabla.appendChild(thead);
    const tbody = document.createElement('tbody');
    for(let fila=0; fila<15; fila++){
      const tr = document.createElement('tr');
      letras.forEach((letra, idx)=>{
        const base = idx * 15 + 1;
        const numero = base + fila;
        const numeroTexto = numero.toString().padStart(2,'0');
        const clave = `${letra}-${numeroTexto}`;
        const td = document.createElement('td');
        td.className = 'canto-cell';
        td.dataset.key = clave;
        td.dataset.numero = String(numero);
        const wrapper = document.createElement('span');
        wrapper.className = 'canto-texto';
        const letraSpan = document.createElement('span');
        letraSpan.className = 'canto-letra';
        letraSpan.textContent = `${letra}-`;
        const numeroSpan = document.createElement('span');
        numeroSpan.className = 'canto-numero';
        numeroSpan.textContent = numeroTexto;
        wrapper.appendChild(letraSpan);
        wrapper.appendChild(numeroSpan);
        td.appendChild(wrapper);
        td.addEventListener('click', ()=>manejarCantoClick(clave));
        cantoCeldas.set(clave, td);
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }
    tabla.appendChild(tbody);
    tablaCantosContainer.appendChild(tabla);
  }

  async function manejarCantoClick(clave){
    if(!currentSorteoId || !currentSorteoData) return;
    if(tablaCantosContainer.classList.contains('disabled')) return;
    if(tablaCantosContainer.classList.contains('bloqueado')) return;
    if(cantosSeleccionados.has(clave)) return;
    const confirmar = await mostrarConfirmacionCanto(clave);
    if(!confirmar) return;
    try {
      await db.collection('cantos').doc(currentSorteoId).set({
        numeros: firebase.firestore.FieldValue.arrayUnion(clave),
        actualizado: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      mensajeEl.textContent = `Se registró la jugada ${clave}.`;
    } catch (err) {
      console.error('Error registrando canto', err);
      alert('No fue posible registrar el canto.');
    }
  }

  function actualizarCantosSeleccionados(lista){
    const valores = Array.isArray(lista) ? lista : [];
    cantosSeleccionados = new Set(valores.map(v=>{
      const texto = (v ?? '').toString();
      return texto.toUpperCase();
    }));
    cantoCeldas.forEach((celda, clave)=>{
      if(cantosSeleccionados.has(clave)) celda.classList.add('selected');
      else celda.classList.remove('selected');
    });
    procesarCantos(valores);
  }

  function obtenerFormaPorIndice(indice){
    const idxNumero = Number(indice);
    if(!Number.isFinite(idxNumero)) return null;
    return formasActivas.find(f=>Number(f.idx)===idxNumero) || null;
  }

  function inicializarPanelGanadores(){
    if(!panelGanadoresEl) return;
    panelGanadoresEl.innerHTML = '';
    botonesFormas.clear();
    for(let idx = 1; idx <= 5; idx++){
      const boton = document.createElement('button');
      boton.type = 'button';
      boton.className = 'carton-forma-accion';
      boton.dataset.formaIdx = String(idx);
      const texto = document.createElement('span');
      texto.className = 'carton-forma-texto';
      texto.textContent = `GF${idx}`;
      const contador = document.createElement('span');
      contador.className = 'carton-forma-contador';
      contador.textContent = '0';
      boton.appendChild(texto);
      boton.appendChild(contador);
      boton.addEventListener('click',()=>{
        abrirModalGanadoresPorIndice(idx);
      });
      panelGanadoresEl.appendChild(boton);
      botonesFormas.set(idx, { boton, textoEl: texto, contadorEl: contador });
    }
    actualizarBotonesFormas();
  }

  function obtenerColorOscurecido(colorHex, factor = 0.65){
    if(typeof colorHex !== 'string') return '#2f2f2f';
    const limpio = colorHex.trim();
    const match = limpio.match(/^#?([0-9a-fA-F]{6})$/);
    if(!match) return limpio || '#2f2f2f';
    const hex = match[1];
    const ajustar = indice=>{
      const valor = parseInt(hex.slice(indice, indice+2), 16);
      const reducido = Math.max(0, Math.min(255, Math.round(valor * factor)));
      return reducido.toString(16).padStart(2,'0');
    };
    return `#${ajustar(0)}${ajustar(2)}${ajustar(4)}`;
  }

  function obtenerColorParaForma(idx){
    const numero = Number(idx);
    if(Number.isFinite(numero) && numero > 0){
      const posicion = (numero - 1) % FORM_COLORS.length;
      return FORM_COLORS[posicion];
    }
    return FORM_COLORS[0];
  }

  function obtenerResumenForma(indice){
    const idxNumero = Number(indice);
    if(!Number.isFinite(idxNumero)) return null;
    const activa = formasActivas.find(f=>Number(f.idx)===idxNumero);
    if(activa) return activa;
    return formasBaseResumen.find(f=>Number(f.idx)===idxNumero) || null;
  }

  function actualizarBotonesFormas(){
    if(!botonesFormas.size) return;
    botonesFormas.forEach((refs, idx)=>{
      if(!refs) return;
      const forma = obtenerResumenForma(idx);
      const infoGanadores = cartonesGanadoresPorForma.get(idx) || {};
      const totalGanadores = Array.isArray(infoGanadores.cartones) ? infoGanadores.cartones.length : 0;
      const color = obtenerColorParaForma(idx);
      refs.textoEl.textContent = `GF${idx}`;
      refs.contadorEl.textContent = String(totalGanadores);
      refs.boton.dataset.totalGanadores = String(totalGanadores);
      refs.boton.style.setProperty('--forma-color', color);
      refs.boton.style.setProperty('--forma-color-borde', obtenerColorOscurecido(color, 0.7));
      refs.boton.style.setProperty('--forma-color-contador', obtenerColorOscurecido(color, 0.55));
      refs.boton.classList.toggle('con-ganadores', totalGanadores > 0);
      const nombreForma = forma?.nombre ? `, ${forma.nombre}` : '';
      const descripcion = totalGanadores === 1 ? '1 cartón ganador' : `${totalGanadores} cartones ganadores`;
      refs.boton.setAttribute('aria-label', `Ver cartones ganadores de la forma ${String(idx).padStart(2,'0')}${nombreForma}, ${descripcion}`);
      refs.boton.title = `GF${idx}${nombreForma} (${descripcion})`;
    });
  }

  function normalizarNumero(valor){
    if(typeof valor === 'number' && Number.isFinite(valor)) return valor;
    if(typeof valor === 'string'){
      const texto = valor.trim();
      if(!texto) return null;
      const match = texto.toUpperCase().match(/^([BINGO])[-\s]?0*(\d{1,2})$/);
      if(match){
        const numero = parseInt(match[2], 10);
        if(Number.isFinite(numero)){
          return numero;
        }
      }
      const numeroPlano = parseInt(texto, 10);
      if(Number.isFinite(numeroPlano)) return numeroPlano;
    }
    return null;
  }

  function sincronizarFormasBase(formas){
    const lista = Array.isArray(formas) ? formas : [];
    formasBaseResumen = lista
      .map(item=>{
        const idx = Number(item?.idx ?? item?.indice);
        if(!Number.isFinite(idx)) return null;
        const posicionesNorm = Array.isArray(item.posicionesNormalizadas) ? item.posicionesNormalizadas : [];
        return {
          idx,
          nombre: item?.nombre || '',
          porcentaje: Number(item?.porcentaje ?? item?.porcentajePremio ?? 0) || 0,
          premioCreditos: Number(item?.premioCreditos ?? item?.premiocreditos ?? item?.creditos ?? 0) || 0,
          posicionesNormalizadas: posicionesNorm
            .map(pos=>({ r: Number(pos?.r ?? pos?.row ?? pos?.fila), c: Number(pos?.c ?? pos?.col ?? pos?.columna) }))
            .filter(pos=>Number.isInteger(pos.r) && Number.isInteger(pos.c))
        };
      })
      .filter(Boolean)
      .sort((a,b)=>(a.idx||0)-(b.idx||0));
    if(!formasActivas.length){
      formasActivas = formasBaseResumen.map(base=>({ ...base }));
    }else{
      const mapa = new Map(formasActivas.map(f=>[Number(f.idx), { ...f }]));
      formasBaseResumen.forEach(base=>{
        const existente = mapa.get(base.idx) || {};
        mapa.set(base.idx, { ...existente, ...base });
      });
      formasActivas = Array.from(mapa.values()).sort((a,b)=>(a.idx||0)-(b.idx||0));
    }
    actualizarBotonesFormas();
  }

  function obtenerPosicionesForma(forma){
    if(!forma) return [];
    const lista = Array.isArray(forma.posicionesNormalizadas) ? forma.posicionesNormalizadas : forma.posiciones;
    if(!Array.isArray(lista)) return [];
    return lista
      .map(pos=>({ r: Number(pos?.r ?? pos?.row ?? pos?.fila), c: Number(pos?.c ?? pos?.col ?? pos?.columna) }))
      .filter(pos=>Number.isInteger(pos.r) && Number.isInteger(pos.c));
  }

  function procesarFormas(snapshot){
    const mapa = new Map();
    if(snapshot && typeof snapshot.forEach === 'function'){
      snapshot.forEach(doc=>{
        const data = doc.data() || {};
        const idx = Number(data?.idx ?? data?.indice);
        if(!Number.isFinite(idx)) return;
        const posicionesRaw = Array.isArray(data.posiciones) ? data.posiciones : data.posicionesNormalizadas;
        const posiciones = Array.isArray(posicionesRaw)
          ? posicionesRaw
              .map(pos=>({ r: Number(pos?.r ?? pos?.row ?? pos?.fila), c: Number(pos?.c ?? pos?.col ?? pos?.columna) }))
              .filter(pos=>Number.isInteger(pos.r) && Number.isInteger(pos.c))
          : [];
        const base = obtenerResumenForma(idx) || {};
        mapa.set(idx, {
          ...base,
          id: doc.id,
          idx,
          nombre: data?.nombre || base?.nombre || '',
          porcentaje: Number(data?.porcentaje ?? data?.porcentajePremio ?? base?.porcentaje ?? 0) || 0,
          premioCreditos: Number(data?.premioCreditos ?? data?.premiocreditos ?? data?.creditos ?? base?.premioCreditos ?? 0) || 0,
          posicionesNormalizadas: posiciones
        });
      });
    }
    formasBaseResumen.forEach(base=>{
      if(!mapa.has(base.idx)){
        mapa.set(base.idx, { ...base });
      }else{
        const actual = mapa.get(base.idx);
        mapa.set(base.idx, { ...base, ...actual });
      }
    });
    formasActivas = Array.from(mapa.values()).sort((a,b)=>(a.idx||0)-(b.idx||0));
    calcularGanadores();
  }

  function detenerFormas(){
    if(formasUnsub){
      formasUnsub();
      formasUnsub = null;
    }
  }

  function escucharFormas(id){
    detenerFormas();
    if(!id){
      formasActivas = formasBaseResumen.map(base=>({ ...base }));
      calcularGanadores();
      return;
    }
    formasUnsub = db.collection('formas')
      .where('sorteoId', '==', id)
      .onSnapshot(procesarFormas, err=>console.error('Error escuchando formas', err));
  }

  function procesarCartones(snapshot){
    const mapa = new Map();
    if(snapshot && typeof snapshot.forEach === 'function'){
      snapshot.forEach(doc=>{
        const data = doc.data() || {};
        const posicionesRaw = Array.isArray(data.posiciones) ? data.posiciones : [];
        const posiciones = [];
        const valorPorPos = new Map();
        posicionesRaw.forEach(pos=>{
          const fila = Number(pos?.r ?? pos?.row ?? pos?.fila);
          const col = Number(pos?.c ?? pos?.col ?? pos?.columna);
          const valor = normalizarNumero(pos?.valor ?? pos?.numero ?? pos?.value);
          if(Number.isInteger(fila) && Number.isInteger(col) && valor !== null){
            posiciones.push({ r: fila, c: col, valor });
            valorPorPos.set(`${fila}-${col}`, valor);
          }
        });
        mapa.set(doc.id, {
          id: doc.id,
          sorteoId: data?.sorteoId || '',
          userId: data?.userId || data?.usuarioId || '',
          alias: data?.alias || data?.aliascarton || data?.aliasCarton || '',
          cartonNum: data?.cartonNum ?? data?.Ncarton ?? data?.carton ?? null,
          tipocarton: data?.tipocarton ?? data?.tipoCarton ?? data?.tipo ?? '',
          posiciones,
          valorPorPos
        });
      });
    }
    cartonesSorteo = mapa;
    cartonesDatosListos = true;
    actualizarNumerosNoJugados();
    calcularGanadores();
  }

  function detenerCartones(){
    if(cartonesUnsub){
      cartonesUnsub();
      cartonesUnsub = null;
    }
    cartonesSorteo = new Map();
    cartonesDatosListos = false;
    actualizarNumerosNoJugados();
    calcularGanadores();
  }

  function escucharCartones(id){
    detenerCartones();
    if(!id){
      cartonesSorteo = new Map();
      actualizarNumerosNoJugados();
      calcularGanadores();
      return;
    }
    cartonesUnsub = db.collection('CartonJugado')
      .where('sorteoId', '==', id)
      .onSnapshot(procesarCartones, err=>console.error('Error escuchando cartones', err));
  }

  function procesarCantos(lista){
    const entradas = Array.isArray(lista) ? lista : [];
    const normalizados = [];
    entradas.forEach(item=>{
      const numero = normalizarNumero(item);
      if(numero !== null) normalizados.push(numero);
    });
    cantosOrdenados = normalizados;
    cantosIndiceMap = new Map();
    normalizados.forEach((numero, idx)=>{
      if(!cantosIndiceMap.has(numero)){
        cantosIndiceMap.set(numero, idx);
      }
    });
    calcularGanadores();
  }

  function obtenerCreditosForma(forma){
    if(!forma) return 0;
    const directo = Number(forma?.premioCreditos ?? forma?.premiocreditos ?? forma?.creditos);
    if(Number.isFinite(directo) && directo > 0) return Math.round(directo);
    const porcentaje = Number(forma?.porcentaje ?? forma?.porcentajePremio ?? 0);
    const totalPremios = Number(currentSorteoData?.totalPremios) || 0;
    if(totalPremios > 0 && porcentaje > 0){
      return Math.round(totalPremios * (porcentaje / 100));
    }
    return 0;
  }

  function calcularGanadores(){
    cartonesGanadoresPorForma = new Map();
    formasPorCarton = new Map();
    if(!formasActivas.length || !cartonesSorteo.size || !cantosOrdenados.length){
      actualizarBotonesFormas();
      return;
    }
    formasActivas.forEach(forma=>{
      const idx = Number(forma?.idx);
      if(!Number.isFinite(idx)) return;
      const posiciones = obtenerPosicionesForma(forma);
      if(!posiciones.length){
        cartonesGanadoresPorForma.set(idx, { forma, cartones: [] });
        return;
      }
      let mejorPaso = Infinity;
      const ganadores = [];
      cartonesSorteo.forEach(carton=>{
        let valido = true;
        let maxPaso = -1;
        for(const pos of posiciones){
          const valor = carton.valorPorPos.get(`${pos.r}-${pos.c}`);
          if(valor === undefined){
            valido = false;
            break;
          }
          const paso = cantosIndiceMap.get(valor);
          if(paso === undefined){
            valido = false;
            break;
          }
          if(paso > maxPaso) maxPaso = paso;
        }
        if(!valido) return;
        if(maxPaso < mejorPaso){
          mejorPaso = maxPaso;
          ganadores.length = 0;
          ganadores.push(carton);
        } else if(maxPaso === mejorPaso){
          ganadores.push(carton);
        }
      });
      cartonesGanadoresPorForma.set(idx, { forma, cartones: ganadores, paso: mejorPaso });
      ganadores.forEach(carton=>{
        if(!formasPorCarton.has(carton.id)) formasPorCarton.set(carton.id, []);
        formasPorCarton.get(carton.id).push({ forma, paso: mejorPaso });
      });
    });
    formasPorCarton.forEach(lista=>{
      lista.sort((a,b)=>{
        if(a.paso !== b.paso) return a.paso - b.paso;
        return (Number(a.forma?.idx) || 0) - (Number(b.forma?.idx) || 0);
      });
    });
    actualizarBotonesFormas();
  }

  function actualizarNumerosNoJugados(){
    if(!cantoCeldas.size){
      return;
    }
    if(!cartonesDatosListos){
      cantoCeldas.forEach(celda=>celda.classList.remove('no-jugado'));
      return;
    }
    const numerosUsados = new Set();
    cartonesSorteo.forEach(carton=>{
      carton.valorPorPos.forEach(valor=>{
        if(Number.isFinite(valor)) numerosUsados.add(valor);
      });
    });
    cantoCeldas.forEach(celda=>{
      const numero = Number(celda.dataset.numero);
      if(!Number.isFinite(numero)){
        celda.classList.remove('no-jugado');
        return;
      }
      if(numerosUsados.has(numero)) celda.classList.remove('no-jugado');
      else celda.classList.add('no-jugado');
    });
  }

  function normalizarTipoCarton(carton){
    const texto = (carton?.tipocarton ?? carton?.tipoCarton ?? carton?.tipo ?? '').toString().trim().toLowerCase();
    if(['gratis','free','libre','sin costo','sin-costo','freebie'].includes(texto)){
      return 'gratis';
    }
    return 'pagado';
  }

  function obtenerNumeroCarton(carton){
    const bruto = carton?.cartonNum ?? carton?.Ncarton ?? carton?.carton;
    if(bruto === undefined || bruto === null) return '--';
    const numero = Number(bruto);
    if(Number.isFinite(numero)){
      return String(numero).padStart(4,'0');
    }
    const texto = String(bruto).trim();
    return texto || '--';
  }

  function formatearNumeroCarton(carton){
    const numero = obtenerNumeroCarton(carton);
    return numero === '--' ? '--' : `#${numero}`;
  }

  function obtenerPasoFormaCarton(cartonId, formaIdx){
    const lista = formasPorCarton.get(cartonId);
    if(!Array.isArray(lista)) return Infinity;
    const registro = lista.find(item=>Number(item?.forma?.idx) === Number(formaIdx));
    return registro ? (Number(registro.paso) || 0) : Infinity;
  }

  function hexToRgb(hex){
    if(typeof hex !== 'string') return null;
    let valor = hex.replace('#','').trim();
    if(valor.length === 3){
      valor = valor.split('').map(c=>c+c).join('');
    }
    if(valor.length !== 6) return null;
    const numero = parseInt(valor, 16);
    if(Number.isNaN(numero)) return null;
    return {
      r: (numero >> 16) & 255,
      g: (numero >> 8) & 255,
      b: numero & 255
    };
  }

  function obtenerRgbTexto(hex, fallback = '0,120,255'){
    const rgb = hexToRgb(hex);
    if(!rgb) return fallback;
    return `${rgb.r},${rgb.g},${rgb.b}`;
  }

  function obtenerRgbVivoTexto(hex){
    const rgb = hexToRgb(hex);
    if(!rgb) return null;
    const intensificar = valor=>Math.min(255, Math.round(valor * 1.12 + 18));
    return `${intensificar(rgb.r)},${intensificar(rgb.g)},${intensificar(rgb.b)}`;
  }

  function normalizarPosicionesEntrada(posiciones){
    const lista = Array.isArray(posiciones) ? posiciones : [];
    const resultado = [];
    lista.forEach(pos=>{
      if(!pos) return;
      const fila = Number(pos?.r ?? pos?.row ?? pos?.fila);
      const col = Number(pos?.c ?? pos?.col ?? pos?.columna);
      if(Number.isInteger(fila) && Number.isInteger(col)){
        resultado.push({ r: fila, c: col });
      }
    });
    return resultado;
  }

  function obtenerPosicionesNormalizadas(forma){
    if(!forma) return [];
    if(Array.isArray(forma.posicionesNormalizadas) && forma.posicionesNormalizadas.length){
      return normalizarPosicionesEntrada(forma.posicionesNormalizadas);
    }
    if(Array.isArray(forma.posiciones) && forma.posiciones.length){
      return normalizarPosicionesEntrada(forma.posiciones);
    }
    return obtenerPosicionesForma(forma);
  }

  function actualizarEncabezadoForma(info, indice, colorHex){
    if(!info || !Array.isArray(info.letras)) return;
    const indiceNormalizado = Number(indice);
    const idxActivo = Number.isInteger(indiceNormalizado) ? indiceNormalizado : null;
    info.letras.forEach((span, idx)=>{
      if(!span) return;
      const letraBase = BINGO_LETRAS[idx] || '';
      const th = span.closest('th');
      const activo = idxActivo === idx + 1;
      span.textContent = activo ? `F${idx + 1}` : letraBase;
      span.classList.toggle('encabezado-letra-activa', activo);
      if(th){
        th.classList.toggle('forma-activa', activo);
        th.setAttribute('aria-pressed', activo ? 'true' : 'false');
        if(activo && colorHex){
          const rgbBasico = obtenerRgbTexto(colorHex);
          const rgbVivo = obtenerRgbVivoTexto(colorHex) || rgbBasico;
          th.style.setProperty('--forma-rgb', rgbBasico);
          th.style.setProperty('--forma-rgb-vivo', rgbVivo);
        }else{
          th.style.removeProperty('--forma-rgb');
          th.style.removeProperty('--forma-rgb-vivo');
        }
      }
    });
  }

  function crearTablaCartonVisual(carton, modo = 'mini'){
    const contenedor = document.createElement('div');
    contenedor.className = `carton-visual carton-visual--${modo}`;
    const tipoCarton = normalizarTipoCarton(carton);
    contenedor.dataset.tipocarton = tipoCarton;
    const leyenda = document.createElement('div');
    leyenda.className = 'carton-forma-leyenda';
    contenedor.appendChild(leyenda);
    const tabla = document.createElement('table');
    tabla.className = `carton-tabla carton-tabla--${modo}`;
    tabla.dataset.tipocarton = tipoCarton;
    tabla.dataset.cartonId = carton.id || '';
    const esGanador = Array.isArray(carton.formasGanadas) && carton.formasGanadas.length > 0;
    if(esGanador){
      tabla.classList.add('ganador');
    }
    const thead = document.createElement('thead');
    const trHead = document.createElement('tr');
    BINGO_LETRAS.forEach(letra=>{
      const th = document.createElement('th');
      const spanLetra = document.createElement('span');
      spanLetra.className = 'encabezado-letra';
      spanLetra.textContent = letra;
      th.appendChild(spanLetra);
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    tabla.appendChild(thead);
    const tbody = document.createElement('tbody');
    const mapaValor = new Map();
    if(Array.isArray(carton.posiciones)){
      carton.posiciones.forEach(p=>{
        const fila = Number(p.r);
        const col = Number(p.c);
        const valor = p.valor;
        if(Number.isInteger(fila) && Number.isInteger(col) && valor !== undefined && valor !== null){
          mapaValor.set(`${fila}-${col}`, valor);
        }
      });
    }else if(carton.valorPorPos instanceof Map){
      carton.valorPorPos.forEach((valor, clave)=>{
        if(valor !== undefined && valor !== null){
          mapaValor.set(clave, valor);
        }
      });
    }
    const celdas = new Map();
    const numeroCartonCentral = modo === 'principal' ? obtenerNumeroCarton(carton) : null;
    for(let r = 0; r < 5; r++){
      const fila = document.createElement('tr');
      for(let c = 0; c < 5; c++){
        const td = document.createElement('td');
        td.dataset.pos = `${r}-${c}`;
        let cantada = '0';
        if(r === 2 && c === 2){
          td.classList.add('free');
          const icono = document.createElement('span');
          icono.className = 'cell-content estrella';
          if(modo === 'principal'){
            icono.classList.add('numero-carton');
            icono.textContent = numeroCartonCentral && numeroCartonCentral !== '--' ? numeroCartonCentral : '★';
          }else{
            icono.textContent = '★';
          }
          td.appendChild(icono);
        }else{
          const valor = mapaValor.get(`${r}-${c}`);
          const span = document.createElement('span');
          span.className = 'cell-content';
          if(valor !== undefined && valor !== null){
            const numero = Number(valor);
            const texto = Number.isFinite(numero) ? String(numero).padStart(2,'0') : String(valor);
            span.textContent = texto;
            td.dataset.valor = numero;
            if(Number.isFinite(numero) && cantosIndiceMap.has(numero)){
              cantada = '1';
              td.classList.add('celda-cantada');
            }
          }else{
            span.textContent = '—';
          }
          td.appendChild(span);
        }
        td.dataset.cantada = cantada;
        fila.appendChild(td);
        celdas.set(`${r}-${c}`, td);
      }
      tbody.appendChild(fila);
    }
    tabla.appendChild(tbody);
    contenedor.appendChild(tabla);
    return { contenedor, tabla, celdas, letras: Array.from(trHead.querySelectorAll('.encabezado-letra')), leyenda };
  }

  function aplicarResumenCarton(info){
    if(!info) return;
    info.celdas.forEach(celda=>{
      celda.classList.remove('forma-resaltada', 'celda-forma-activa', 'celda-forma-solo-borde', 'celda-forma-temporal');
      celda.style.removeProperty('--forma-rgb');
      celda.style.removeProperty('--forma-rgb-vivo');
      if(celda.dataset.cantada === '1'){
        celda.classList.add('celda-cantada');
      }else{
        celda.classList.remove('celda-cantada');
      }
    });
    if(info.leyenda){
      info.leyenda.textContent = '';
      info.leyenda.classList.remove('visible');
      info.leyenda.style.removeProperty('color');
      info.leyenda.style.removeProperty('border-color');
      info.leyenda.style.removeProperty('text-shadow');
    }
    if(info.letras){
      info.letras.forEach((span, idx)=>{
        if(!span) return;
        const th = span.closest('th');
        span.textContent = BINGO_LETRAS[idx] || '';
        span.classList.remove('encabezado-letra-activa');
        if(th){
          th.classList.remove('forma-activa');
          th.style.removeProperty('--forma-rgb');
          th.style.removeProperty('--forma-rgb-vivo');
          th.setAttribute('aria-pressed', 'false');
        }
      });
    }
  }

  function aplicarFormaCarton(info, datosForma){
    if(!info || !datosForma) return;
    const colorBase = datosForma.color || '#0078ff';
    const rgbBase = obtenerRgbTexto(colorBase);
    const rgbVivo = obtenerRgbVivoTexto(colorBase) || rgbBase;
    const posiciones = normalizarPosicionesEntrada(datosForma.posiciones || datosForma.posicionesNormalizadas || []);
    const resaltarTodas = datosForma.resaltarTodas === true;
    info.celdas.forEach(celda=>{
      celda.classList.remove('celda-forma-activa', 'celda-forma-solo-borde', 'celda-forma-temporal');
      if(celda.dataset.cantada === '1'){
        celda.classList.add('celda-cantada');
      }else{
        celda.classList.remove('celda-cantada');
      }
      celda.style.removeProperty('--forma-rgb');
      celda.style.removeProperty('--forma-rgb-vivo');
    });
    posiciones.forEach(pos=>{
      const clave = `${pos.r}-${pos.c}`;
      const celda = info.celdas.get(clave);
      if(!celda || celda.classList.contains('free')) return;
      if(celda.dataset.cantada !== '1' && !resaltarTodas) return;
      celda.classList.add('celda-forma-activa');
      if(datosForma.soloBorde) celda.classList.add('celda-forma-solo-borde');
      celda.style.setProperty('--forma-rgb', rgbBase);
      celda.style.setProperty('--forma-rgb-vivo', rgbVivo);
    });
    if(info.leyenda){
      if(datosForma.mostrarLeyenda === false){
        info.leyenda.textContent = '';
        info.leyenda.classList.remove('visible');
      }else{
        let etiqueta = 'Forma';
        if(datosForma.nombre && datosForma.nombre.trim().length){
          etiqueta = datosForma.nombre.trim();
        }else if(datosForma.indice !== undefined && datosForma.indice !== null){
          etiqueta = `Forma ${String(datosForma.indice).padStart(2,'0')}`;
        }
        info.leyenda.textContent = etiqueta;
        info.leyenda.style.color = colorBase;
        info.leyenda.classList.add('visible');
      }
    }
    if(Number.isFinite(Number(datosForma.indice))){
      actualizarEncabezadoForma(info, datosForma.indice, colorBase);
    }
  }

  function renderCartonGanador(carton, forma){
    const color = obtenerColorParaForma(forma?.idx || 1);
    const card = document.createElement('article');
    card.className = 'ganador-card';
    const infoCol = document.createElement('div');
    infoCol.className = 'ganador-card-info';
    const cartonExtendido = { ...carton, formasGanadas: [{ forma }] };
    const tablaInfo = crearTablaCartonVisual(cartonExtendido, 'mini');
    aplicarResumenCarton(tablaInfo);
    const posicionesForma = obtenerPosicionesNormalizadas(forma);
    if(posicionesForma.length){
      aplicarFormaCarton(tablaInfo, {
        posiciones: posicionesForma,
        color,
        nombre: forma?.nombre,
        indice: forma?.idx,
        mostrarLeyenda: false,
        resaltarTodas: true
      });
    }
    infoCol.appendChild(tablaInfo.contenedor);
    const infoBox = document.createElement('div');
    infoBox.className = 'ganador-info';
    const numeroCarton = obtenerNumeroCarton(carton);
    infoBox.innerHTML = `<strong>Cartón ${numeroCarton === '--' ? '--' : `#${numeroCarton}`}</strong>`+
      `<span>Alias: ${carton?.alias ? carton.alias : 'Sin alias'}</span>`+
      `<span>Tipo: ${normalizarTipoCarton(carton).toUpperCase()}</span>`;
    infoCol.appendChild(infoBox);
    card.appendChild(infoCol);
    const premio = obtenerCreditosForma(forma);
    const totalGanadores = Math.max(1, (cartonesGanadoresPorForma.get(Number(forma?.idx))?.cartones?.length) || 1);
    const montoIndividual = premio > 0 ? Math.floor(premio / totalGanadores) : 0;
    const premioLabel = document.createElement('div');
    premioLabel.className = 'ganador-premio-label';
    premioLabel.textContent = 'Créditos ganados';
    card.appendChild(premioLabel);
    const premioMonto = document.createElement('div');
    premioMonto.className = 'ganador-premio-monto';
    premioMonto.textContent = formatearNumero(montoIndividual);
    card.appendChild(premioMonto);
    return card;
  }

  function abrirModalGanadoresPorIndice(indice){
    if(!modalGanadoresEl || !modalGanadoresTituloEl || !modalGanadoresListaEl) return;
    const idxNumero = Number(indice);
    if(!Number.isFinite(idxNumero)) return;
    const registro = cartonesGanadoresPorForma.get(idxNumero);
    const forma = registro?.forma || obtenerResumenForma(idxNumero) || { idx: idxNumero };
    const nombreForma = forma?.nombre ? forma.nombre : '';
    modalGanadoresTituloEl.textContent = `Ganadores Forma ${String(idxNumero).padStart(2,'0')}`;
    modalGanadoresSubtituloEl.textContent = nombreForma;
    modalGanadoresListaEl.innerHTML = '';
    modalGanadoresSinEl.textContent = '';
    const ganadores = registro?.cartones ? [...registro.cartones] : [];
    if(!ganadores.length){
      modalGanadoresSinEl.textContent = forma?.nombre ? 'Aún no hay cartones ganadores para esta forma.' : 'Esta forma no está configurada para el sorteo.';
    }else{
      ganadores.sort((a,b)=>{
        const pasoA = obtenerPasoFormaCarton(a.id, idxNumero);
        const pasoB = obtenerPasoFormaCarton(b.id, idxNumero);
        if(pasoA !== pasoB) return pasoA - pasoB;
        const numeroA = Number(a?.cartonNum ?? a?.Ncarton);
        const numeroB = Number(b?.cartonNum ?? b?.Ncarton);
        if(Number.isFinite(numeroA) && Number.isFinite(numeroB)) return numeroA - numeroB;
        if(Number.isFinite(numeroA)) return -1;
        if(Number.isFinite(numeroB)) return 1;
        return (a.id || '').localeCompare(b.id || '');
      });
      ganadores.forEach(carton=>{
        modalGanadoresListaEl.appendChild(renderCartonGanador(carton, forma));
      });
    }
    modalGanadoresEl.classList.add('activa');
    modalGanadoresEl.setAttribute('aria-hidden', 'false');
    modalGanadoresCerrarBtn?.focus({ preventScroll: true });
  }

  function cerrarModalGanadores(){
    if(!modalGanadoresEl) return;
    modalGanadoresEl.classList.remove('activa');
    modalGanadoresEl.setAttribute('aria-hidden', 'true');
  }

  function manejarClickModalGanadores(event){
    if(event.target === modalGanadoresEl){
      cerrarModalGanadores();
    }
  }

  function manejarTeclaModalGanadores(event){
    if(event.key === 'Escape' && modalGanadoresEl?.classList?.contains('activa')){
      cerrarModalGanadores();
    }
  }

  function reiniciarDatosJuego(){
    formasActivas = [];
    formasBaseResumen = [];
    formasPorCarton = new Map();
    cartonesSorteo = new Map();
    cartonesGanadoresPorForma = new Map();
    cantosOrdenados = [];
    cantosIndiceMap = new Map();
    cartonesDatosListos = false;
    cantoCeldas.forEach(celda=>celda.classList.remove('no-jugado'));
    actualizarBotonesFormas();
  }

  function detenerCantos(){
    if(cantosUnsub){
      cantosUnsub();
      cantosUnsub = null;
    }
  }

  function escucharCantos(id){
    detenerCantos();
    if(!id){
      actualizarCantosSeleccionados([]);
      return;
    }
    const ref = db.collection('cantos').doc(id);
    cantosUnsub = ref.onSnapshot(doc=>{
      if(!doc.exists){
        actualizarCantosSeleccionados([]);
        if(currentSorteoData) currentSorteoData.cantos = [];
        return;
      }
      const data = doc.data() || {};
      const numeros = Array.isArray(data.numeros) ? data.numeros : [];
      actualizarCantosSeleccionados(numeros);
      if(currentSorteoData){
        currentSorteoData.cantos = numeros;
      }
      const idx = sorteos.findIndex(s=>s.id===id);
      if(idx>=0){
        sorteos[idx].cantos = numeros;
      }
    }, err=>console.error('Error escuchando cantos', err));
  }

  function actualizarTablaEstado(){
    if(!tablaCantosContainer) return;
    const estado = (currentSorteoData?.estado || '').toString().toLowerCase();
    const esFinalizado = estado === 'finalizado';
    const habilitado = estado === 'jugando';
    tablaCantosContainer.classList.toggle('disabled', !habilitado && !esFinalizado);
    tablaCantosContainer.classList.toggle('bloqueado', esFinalizado);
  }

  function asegurarCampoPdf(id, data){
    if(!id || !data) return;
    if(typeof data.pdf === 'undefined' || data.pdf === null || data.pdf === ''){
      db.collection('sorteos').doc(id).set({ pdf: 'no' }, { merge: true }).catch(err=>{
        console.error('Error estableciendo pdf predeterminado', err);
      });
      data.pdf = 'no';
    }
    if(id === currentSorteoId){
      const urlPdf = typeof data.pdfUrl === 'string' ? data.pdfUrl.trim() : '';
      pdfDestinoUrl = urlPdf;
      if(currentSorteoData){
        currentSorteoData.pdfUrl = urlPdf;
      }
    }
  }

  function obtenerFechaDesdeValor(valor){
    if(!valor) return null;
    if(valor instanceof Date) return valor;
    if(typeof valor === 'object' && typeof valor.toDate === 'function'){ return valor.toDate(); }
    if(typeof valor !== 'string') return null;
    const limpio = valor.trim();
    if(!limpio) return null;
    if(limpio.includes('/')){
      const [dia, mes, anio] = limpio.split('/').map(num=>parseInt(num,10));
      if([dia, mes, anio].some(n=>isNaN(n))) return null;
      return new Date(anio, (mes||1)-1, dia||1);
    }
    if(limpio.includes('-')){
      const [anio, mes, dia] = limpio.split('-').map(num=>parseInt(num,10));
      if([dia, mes, anio].some(n=>isNaN(n))) return null;
      return new Date(anio, (mes||1)-1, dia||1);
    }
    const timestamp = Date.parse(limpio);
    if(!isNaN(timestamp)) return new Date(timestamp);
    return null;
  }

  function obtenerHoraDesdeValor(valor){
    if(!valor) return null;
    if(valor instanceof Date){
      return { hora: valor.getHours(), minuto: valor.getMinutes() };
    }
    if(typeof valor === 'object' && typeof valor.seconds === 'number'){
      const fecha = new Date(valor.seconds * 1000);
      return { hora: fecha.getHours(), minuto: fecha.getMinutes() };
    }
    if(typeof valor !== 'string') return null;
    let texto = valor.trim().toLowerCase();
    if(!texto) return null;
    let sufijo = null;
    if(/a\s*\.?m\.?/.test(texto)) sufijo = 'am';
    if(/p\s*\.?m\.?/.test(texto)) sufijo = 'pm';
    texto = texto.replace(/[^0-9:]/g, '');
    if(!texto) return null;
    if(!/[0-9]/.test(texto)) return null;
    if(!texto.includes(':') && /^\d+$/.test(texto)){
      if(texto.length === 3){
        texto = `0${texto}`;
      }
      if(texto.length === 4){
        texto = `${texto.slice(0,2)}:${texto.slice(2,4)}`;
      } else if(texto.length > 4){
        return null;
      }
    }
    const partes = texto.split(':');
    if(partes.length === 0 || partes.length > 2) return null;
    const horasTextoCompleto = partes[0] || '';
    if(horasTextoCompleto.length > 2) return null;
    const horasTexto = horasTextoCompleto || '0';
    let minutosTexto = partes[1] || '';
    if(minutosTexto.length > 2) return null;
    if(!minutosTexto && partes.length > 1){
      minutosTexto = '0';
    }
    const horas = parseInt(horasTexto, 10);
    const minutos = parseInt(minutosTexto || '0', 10);
    if(!isFinite(horas) || !isFinite(minutos)) return null;
    if(minutos < 0 || minutos > 59) return null;
    let hora24 = horas;
    if(sufijo === 'pm'){
      if(hora24 < 0 || hora24 > 12) return null;
      if(hora24 < 12) hora24 += 12;
    } else if(sufijo === 'am'){
      if(hora24 < 0 || hora24 > 12) return null;
      if(hora24 === 12) hora24 = 0;
    }
    if(sufijo === null && (hora24 < 0 || hora24 > 23)) return null;
    if(sufijo !== null && (hora24 < 0 || hora24 > 23)) return null;
    return { hora: hora24, minuto: minutos };
  }

  function formatearFecha(valor){
    const fecha = obtenerFechaDesdeValor(valor);
    if(!fecha || isNaN(fecha.getTime())) return '';
    const dia = String(fecha.getDate()).padStart(2,'0');
    const mes = String(fecha.getMonth()+1).padStart(2,'0');
    const anio = fecha.getFullYear();
    return `${dia}/${mes}/${anio}`;
  }

  function formatearHora(valor){
    const horaInfo = obtenerHoraDesdeValor(valor);
    if(!horaInfo) return '';
    const { hora, minuto } = horaInfo;
    const sufijo = hora >= 12 ? 'pm' : 'am';
    const hora12 = hora % 12 || 12;
    return `${hora12.toString().padStart(2,'0')}:${minuto.toString().padStart(2,'0')} ${sufijo}`;
  }

  function obtenerTextoFechaPreferido(...valores){
    for(const valor of valores){
      if(typeof valor === 'undefined' || valor === null) continue;
      const texto = formatearFecha(valor);
      if(texto) return texto;
    }
    return 'la fecha indicada';
  }

  function obtenerTextoHoraPreferido(...valores){
    for(const valor of valores){
      if(typeof valor === 'undefined' || valor === null) continue;
      const texto = formatearHora(valor);
      if(texto) return texto.toUpperCase();
    }
    return 'la hora indicada';
  }

  const formatoNumeroES = new Intl.NumberFormat('es-ES');

  function formatearNumero(valor){
    const numero = Number(valor) || 0;
    return formatoNumeroES.format(Math.round(numero));
  }

  function obtenerValorHoraCierre(sorteo){
    if(!sorteo) return null;
    const claves=['horacierre','horaCierre','hora_cierre','cierre','cierreHora','cierrehora'];
    for(const clave of claves){
      const valor=sorteo?.[clave];
      if(valor===undefined || valor===null || valor==='') continue;
      if(typeof valor==='string'){
        const texto=valor.trim();
        if(!texto) continue;
        if(!/[0-9]:/.test(texto) && !/[ap]\.?m\.?/i.test(texto) && /^\d+$/.test(texto)){
          continue;
        }
        return texto;
      }
      return valor;
    }
    return null;
  }

  function obtenerFechaCierre(data){
    if(!data) return null;
    return obtenerFechaDesdeValor(data.fechacierre ?? data.fecha);
  }

  function obtenerFechaHoraCierre(data){
    if(!data) return null;
    const fechaBase = obtenerFechaCierre(data);
    if(!fechaBase || isNaN(fechaBase.getTime())) return null;
    const valorHora=obtenerValorHoraCierre(data);
    if(valorHora){
      const info=obtenerHoraDesdeValor(valorHora);
      if(info){
        return construirFechaHoraEnZona(fechaBase, info);
      }
      if(valorHora instanceof Date && !isNaN(valorHora.getTime())){
        const infoDesdeFecha = obtenerHoraDesdeValor(valorHora);
        if(infoDesdeFecha){
          return construirFechaHoraEnZona(fechaBase, infoDesdeFecha);
        }
        return new Date(valorHora.getTime());
      }
    }
    const minutosFallback=parseInt(data.cierreMinutos ?? data.cierre ?? data.cierreminutos,10);
    if(!isNaN(minutosFallback)){
      const fechaSorteo=obtenerFechaSorteo(data);
      if(fechaSorteo && !isNaN(fechaSorteo.getTime())){
        return new Date(fechaSorteo.getTime()-minutosFallback*60000);
      }
    }
    return null;
  }

  function obtenerTextoHoraCierre(data){
    const valor=obtenerValorHoraCierre(data);
    if(valor){
      const texto=formatearHora(valor);
      if(texto) return texto;
    }
    const minutos=parseInt(data?.cierreMinutos ?? data?.cierre ?? data?.cierreminutos,10);
    if(!isNaN(minutos)) return `${minutos} min.`;
    return '';
  }

  function generarSubtotalesFormas(formas, totalPremios){
    if(!Array.isArray(formas) || !formas.length) return '';
    const totales = [];
    const premioBase = Number(totalPremios) || 0;
    formas.forEach(forma=>{
      const idx = parseInt(forma.idx, 10);
      const porcentaje = parseFloat(forma.porcentaje);
      if(!idx || isNaN(porcentaje) || porcentaje <= 0) return;
      const subtotal = premioBase > 0 ? (premioBase * (porcentaje / 100)) : 0;
      const clase = `forma${Math.min(idx,5)}`;
      totales.push(`<span class="forma-subtotal ${clase}">F${idx}: ${formatearNumero(subtotal)}</span>`);
    });
    return totales.join(' ');
  }

  function obtenerFechaSorteo(data){
    if(!data) return null;
    const fechaBase = obtenerFechaDesdeValor(data.fecha);
    const horaInfo = obtenerHoraDesdeValor(data.hora);
    if(!fechaBase || !horaInfo) return null;
    return construirFechaHoraEnZona(fechaBase, horaInfo);
  }

  function truncarFecha(fecha){
    if(!(fecha instanceof Date) || isNaN(fecha.getTime())) return null;
    return new Date(fecha.getFullYear(), fecha.getMonth(), fecha.getDate());
  }

  function compararFechasCalendario(a, b){
    const fechaA = truncarFecha(a);
    const fechaB = truncarFecha(b);
    if(!fechaA || !fechaB) return null;
    const tiempoA = fechaA.getTime();
    const tiempoB = fechaB.getTime();
    if(tiempoA === tiempoB) return 0;
    return tiempoA < tiempoB ? -1 : 1;
  }

  function construirFechaHoraEnZona(fechaBase, horaInfo){
    if(!(fechaBase instanceof Date) || isNaN(fechaBase.getTime())) return null;
    if(!horaInfo || typeof horaInfo.hora === 'undefined' || typeof horaInfo.minuto === 'undefined') return null;
    const horaNumero = Number(horaInfo.hora);
    const minutoNumero = Number(horaInfo.minuto);
    if(!isFinite(horaNumero) || !isFinite(minutoNumero)) return null;
    const provisional = new Date(fechaBase.getFullYear(), fechaBase.getMonth(), fechaBase.getDate(), horaNumero, minutoNumero, 0, 0);
    const zona = obtenerServerTime()?.zonaIana;
    if(!zona) return provisional;
    try {
      const baseUtc = Date.UTC(fechaBase.getFullYear(), fechaBase.getMonth(), fechaBase.getDate(), horaNumero, minutoNumero, 0, 0);
      const fechaReferencia = new Date(baseUtc);
      const formatter = new Intl.DateTimeFormat('en-US', {
        timeZone: zona,
        hour12: false,
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      const partes = formatter.formatToParts(fechaReferencia);
      const obtenerParte = (tipo)=> partes.find(parte=>parte.type===tipo)?.value;
      const yearZona = Number(obtenerParte('year'));
      const mesZona = Number(obtenerParte('month'));
      const diaZona = Number(obtenerParte('day'));
      const horaZona = Number(obtenerParte('hour'));
      const minutoZona = Number(obtenerParte('minute'));
      const segundoZona = Number(obtenerParte('second'));
      if([yearZona, mesZona, diaZona, horaZona, minutoZona].some(valor=>!isFinite(valor))){
        return provisional;
      }
      const calculadoUtc = Date.UTC(yearZona, (mesZona || 1) - 1, diaZona || 1, horaZona, minutoZona, isFinite(segundoZona) ? segundoZona : 0, 0);
      const diferencia = calculadoUtc - baseUtc;
      return new Date(baseUtc - diferencia);
    } catch (error) {
      return provisional;
    }
  }

  function compararHoraActualConInfo(actual, horaInfo){
    if(!(actual instanceof Date) || isNaN(actual.getTime()) || !horaInfo) return null;
    const horaNumero = Number(horaInfo.hora);
    const minutoNumero = Number(horaInfo.minuto);
    if(isNaN(horaNumero) || isNaN(minutoNumero)) return null;
    const zona = obtenerServerTime()?.zonaIana;
    let horasActual = actual.getHours();
    let minutosActual = actual.getMinutes();
    if(zona){
      try {
        const partes = new Intl.DateTimeFormat('en-US', { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: zona }).formatToParts(actual);
        const parteHora = partes.find(({ type }) => type === 'hour');
        const parteMinuto = partes.find(({ type }) => type === 'minute');
        const horaZona = Number(parteHora?.value);
        const minutoZona = Number(parteMinuto?.value);
        if(!isNaN(horaZona) && !isNaN(minutoZona)){
          horasActual = horaZona;
          minutosActual = minutoZona;
        }
      } catch (error) {
        // Ignorar y mantener los valores locales
      }
    }
    const minutosActualTotales = (horasActual * 60) + minutosActual;
    const minutosReferencia = (horaNumero * 60) + minutoNumero;
    if(minutosActualTotales === minutosReferencia) return 0;
    return minutosActualTotales < minutosReferencia ? -1 : 1;
  }

  function calcularDiferenciaEnDias(ahora, referencia){
    if(!(ahora instanceof Date) || isNaN(ahora.getTime())) return null;
    if(!(referencia instanceof Date) || isNaN(referencia.getTime())) return null;
    return (ahora.getTime() - referencia.getTime()) / MILISEGUNDOS_EN_DIA;
  }

  function construirFechaConHora(fechaBase, horaInfo){
    return construirFechaHoraEnZona(fechaBase, horaInfo);
  }

  function calcularDiferenciaEnMinutos(ahora, fechaReferencia, horaInfo){
    if(!(ahora instanceof Date) || isNaN(ahora.getTime())) return null;
    if(!(fechaReferencia instanceof Date) || isNaN(fechaReferencia.getTime())) return null;
    let fechaObjetivo = fechaReferencia;
    if(horaInfo){
      const combinada = construirFechaHoraEnZona(fechaReferencia, horaInfo);
      if(combinada instanceof Date && !isNaN(combinada.getTime())){
        fechaObjetivo = combinada;
      }
    }
    return (ahora.getTime() - fechaObjetivo.getTime()) / 60000;
  }

  function aplicarEstadoTiempo(elemento, estado){
    if(!elemento) return;
    elemento.classList.remove(...clasesEstadoTiempo);
    if(estado && setClasesEstadoTiempo.has(estado)){
      elemento.classList.add(estado);
    }
  }

  function estadoFechaRespectoAhora(fechaReferencia, ahora, opciones = {}){
    if(!(fechaReferencia instanceof Date) || isNaN(fechaReferencia.getTime())){
      return 'estado-tiempo-sin-dato';
    }
    const comparacion = compararFechasCalendario(ahora, fechaReferencia);
    if(comparacion === null) return 'estado-tiempo-sin-dato';
    const diferenciaDias = calcularDiferenciaEnDias(ahora, fechaReferencia);
    const esPasadoLejano = typeof diferenciaDias === 'number' && diferenciaDias >= 1;
    if(opciones.validacionesActivas){
      if(comparacion < 0) return 'estado-tiempo-futuro';
      if(esPasadoLejano) return CLASE_TIEMPO_PASADO_LEJANO;
      if(opciones.actualSoloCuandoMayor){
        return comparacion >= 0 ? 'estado-tiempo-actual' : 'estado-tiempo-futuro';
      }
      return 'estado-tiempo-actual';
    }
    if(comparacion < 0) return 'estado-tiempo-futuro';
    if(comparacion > 0) return esPasadoLejano ? CLASE_TIEMPO_PASADO_LEJANO : 'estado-tiempo-pasado';
    return 'estado-tiempo-proximo';
  }

  function estadoHoraRespectoAhora(fechaReferencia, horaInfo, ahora, opciones = {}){
    if(!horaInfo || typeof horaInfo.hora !== 'number' || typeof horaInfo.minuto !== 'number'){
      return 'estado-tiempo-sin-dato';
    }
    const diferenciaMinutos = calcularDiferenciaEnMinutos(ahora, fechaReferencia, horaInfo);
    const esPasadoLejano = typeof diferenciaMinutos === 'number' && diferenciaMinutos >= MINUTOS_EN_DIA;
    let comparacionFecha = null;
    if(fechaReferencia instanceof Date && !isNaN(fechaReferencia.getTime())){
      comparacionFecha = compararFechasCalendario(ahora, fechaReferencia);
      if(opciones.validacionesActivas){
        if(comparacionFecha < 0) return 'estado-tiempo-futuro';
        if(esPasadoLejano) return CLASE_TIEMPO_PASADO_LEJANO;
        if(comparacionFecha > 0) return 'estado-tiempo-actual';
      } else {
        if(comparacionFecha < 0) return 'estado-tiempo-futuro';
        if(comparacionFecha > 0) return esPasadoLejano ? CLASE_TIEMPO_PASADO_LEJANO : 'estado-tiempo-pasado';
      }
    }
    const comparacionHora = compararHoraActualConInfo(ahora, horaInfo);
    if(comparacionHora === null) return 'estado-tiempo-sin-dato';
    if(opciones.validacionesActivas){
      if(comparacionHora < 0) return 'estado-tiempo-futuro';
      if(comparacionHora === 0){
        return opciones.actualCuandoCoincide ? 'estado-tiempo-actual' : 'estado-tiempo-futuro';
      }
      if(esPasadoLejano) return CLASE_TIEMPO_PASADO_LEJANO;
      return 'estado-tiempo-actual';
    }
    if(esPasadoLejano) return CLASE_TIEMPO_PASADO_LEJANO;
    const mismoDia = comparacionFecha === 0 || comparacionFecha === null;
    if(comparacionHora < 0) return mismoDia ? 'estado-tiempo-proximo' : 'estado-tiempo-futuro';
    if(comparacionHora === 0) return 'estado-tiempo-actual';
    return 'estado-tiempo-pasado';
  }

  function aplicarResaltadoTiempo(elemento, resaltar){
    if(!elemento) return;
    if(resaltar) elemento.classList.add('resaltado-actual');
    else elemento.classList.remove('resaltado-actual');
  }

  function actualizarAnimacionFilaProgramada(){
    if(!filaProgramada) return;
    const estadoActual = (currentSorteoData && currentSorteoData.estado) ? currentSorteoData.estado.toString().toLowerCase() : '';
    const estaJugando = estadoActual === 'jugando';
    const fechaEnAzul = fechaProgramadaEl && fechaProgramadaEl.classList.contains('estado-tiempo-actual');
    const horaEnAzul = horaProgramadaEl && horaProgramadaEl.classList.contains('estado-tiempo-actual');
    filaProgramada.classList.toggle('en-animacion', Boolean(estaJugando && fechaEnAzul && horaEnAzul));
  }

  function actualizarVisibilidadFilaCierre(fechaTexto, horaTexto){
    if(!filaCierre) return;
    const fechaValida = typeof fechaTexto === 'string' ? fechaTexto.trim() : '';
    const horaValida = typeof horaTexto === 'string' ? horaTexto.trim() : '';
    const hayValor = Boolean(fechaValida || horaValida);
    filaCierre.classList.toggle('oculta', !hayValor);
  }

  function actualizarColoresFechas(ahoraParam){
    const ahora = (ahoraParam instanceof Date && !isNaN(ahoraParam.getTime())) ? ahoraParam : (getServerNow() || new Date());
    const esFinalizado = currentSorteoData && (currentSorteoData.estado || '').toString().toLowerCase() === 'finalizado';
    [fechaProgramadaEl, horaProgramadaEl, fechaCierreEl, horaCierreEl].forEach(elemento=>{
      if(elemento){
        elemento.classList.toggle('estado-tiempo-finalizado', Boolean(esFinalizado));
      }
    });
    if(!(ahora instanceof Date) || isNaN(ahora.getTime())){
      aplicarResaltadoTiempo(fechaProgramadaEl, false);
      aplicarResaltadoTiempo(horaProgramadaEl, false);
      aplicarResaltadoTiempo(fechaCierreEl, false);
      aplicarResaltadoTiempo(horaCierreEl, false);
      aplicarEstadoTiempo(fechaProgramadaEl, 'estado-tiempo-sin-dato');
      aplicarEstadoTiempo(horaProgramadaEl, 'estado-tiempo-sin-dato');
      aplicarEstadoTiempo(fechaCierreEl, 'estado-tiempo-sin-dato');
      aplicarEstadoTiempo(horaCierreEl, 'estado-tiempo-sin-dato');
      aplicarEstadoTiempo(fechaActualValorEl, 'estado-tiempo-actual');
      aplicarEstadoTiempo(horaActualValorEl, 'estado-tiempo-actual');
      actualizarAnimacionFilaProgramada();
      return;
    }

    const validacionesActivas = true; // Las validaciones visuales aplican en ambos modos
    const opcionesFechaProgramada = validacionesActivas ? { validacionesActivas: true, actualSoloCuandoMayor: true } : undefined;
    const opcionesHoraProgramada = validacionesActivas ? { validacionesActivas: true } : undefined;
    const opcionesFechaCierre = validacionesActivas ? { validacionesActivas: true, actualSoloCuandoMayor: true } : undefined;
    const opcionesHoraCierre = validacionesActivas ? { validacionesActivas: true, actualCuandoCoincide: true } : undefined;

    let estadoFechaProgramada = estadoFechaRespectoAhora(infoTiempoSorteo.fecha, ahora, opcionesFechaProgramada);
    let estadoHoraProgramada = estadoHoraRespectoAhora(infoTiempoSorteo.fecha, infoTiempoSorteo.hora, ahora, opcionesHoraProgramada);
    let estadoFechaCierre = estadoFechaRespectoAhora(infoTiempoSorteo.fechaCierre, ahora, opcionesFechaCierre);
    const referenciaHoraCierre = infoTiempoSorteo.fechaCierre || infoTiempoSorteo.fecha;
    let estadoHoraCierre = estadoHoraRespectoAhora(referenciaHoraCierre, infoTiempoSorteo.horaCierre, ahora, opcionesHoraCierre);

    if(estadoFechaProgramada === CLASE_TIEMPO_PASADO_LEJANO || estadoHoraProgramada === CLASE_TIEMPO_PASADO_LEJANO){
      estadoFechaProgramada = CLASE_TIEMPO_PASADO_LEJANO;
      estadoHoraProgramada = CLASE_TIEMPO_PASADO_LEJANO;
    }
    if(estadoFechaCierre === CLASE_TIEMPO_PASADO_LEJANO || estadoHoraCierre === CLASE_TIEMPO_PASADO_LEJANO){
      estadoFechaCierre = CLASE_TIEMPO_PASADO_LEJANO;
      estadoHoraCierre = CLASE_TIEMPO_PASADO_LEJANO;
    }

    aplicarEstadoTiempo(fechaProgramadaEl, estadoFechaProgramada);
    aplicarEstadoTiempo(horaProgramadaEl, estadoHoraProgramada);
    aplicarEstadoTiempo(fechaCierreEl, estadoFechaCierre);
    aplicarEstadoTiempo(horaCierreEl, estadoHoraCierre);
    aplicarEstadoTiempo(fechaActualValorEl, 'estado-tiempo-actual');
    aplicarEstadoTiempo(horaActualValorEl, 'estado-tiempo-actual');

    const resaltarFechaSorteo = validacionesActivas
      ? estadoFechaProgramada === 'estado-tiempo-actual'
      : (estadoFechaProgramada !== 'estado-tiempo-futuro' && estadoFechaProgramada !== 'estado-tiempo-sin-dato');

    const resaltarHoraSorteo = validacionesActivas
      ? estadoHoraProgramada === 'estado-tiempo-actual'
      : (estadoHoraProgramada === 'estado-tiempo-actual' || estadoHoraProgramada === 'estado-tiempo-pasado' || estadoHoraProgramada === CLASE_TIEMPO_PASADO_LEJANO);

    const resaltarFechaCierre = validacionesActivas
      ? estadoFechaCierre === 'estado-tiempo-actual'
      : (estadoFechaCierre !== 'estado-tiempo-futuro' && estadoFechaCierre !== 'estado-tiempo-sin-dato');

    const resaltarHoraCierre = validacionesActivas
      ? estadoHoraCierre === 'estado-tiempo-actual'
      : (estadoHoraCierre === 'estado-tiempo-actual' || estadoHoraCierre === 'estado-tiempo-pasado' || estadoHoraCierre === CLASE_TIEMPO_PASADO_LEJANO);

    aplicarResaltadoTiempo(fechaProgramadaEl, resaltarFechaSorteo);
    aplicarResaltadoTiempo(horaProgramadaEl, resaltarHoraSorteo);
    aplicarResaltadoTiempo(fechaCierreEl, resaltarFechaCierre);
    aplicarResaltadoTiempo(horaCierreEl, resaltarHoraCierre);

    actualizarAnimacionFilaProgramada();
  }

  function obtenerNombreSorteoActual(){
    return (currentSorteoData && currentSorteoData.nombre) ? currentSorteoData.nombre : 'este sorteo';
  }

  function actualizarAnimaciones(){
    [sellarBtn, pdfBtn, jugarBtn, finalizarBtn].forEach(btn=>btn.classList.remove('attention'));
    actualizarBotones();
    if(!currentSorteoData) return;
    const estadoLower = (currentSorteoData.estado || '').toString().toLowerCase();
    const pdfEstado = (currentSorteoData.pdf || '').toString().toLowerCase();
    if(estadoLower === 'activo'){
      sellarBtn.classList.add('attention');
    } else if(estadoLower === 'sellado'){
      if(pdfEstado === 'si') jugarBtn.classList.add('attention');
      else pdfBtn.classList.add('attention');
    } else if(estadoLower === 'jugando'){
      finalizarBtn.classList.add('attention');
    }
  }

  function actualizarEstadoVisual(estado){
    const estadoTexto = (estado || '-').toString().toUpperCase();
    const estadoNormalizado = (estado || '').toString().toLowerCase();
    let clase = '';
    if(estadoNormalizado === 'activo') clase = 'activo';
    else if(estadoNormalizado === 'sellado') clase = 'sellado';
    else if(estadoNormalizado === 'jugando') clase = 'jugando';
    else if(estadoNormalizado === 'finalizado') clase = 'finalizado';
    if(estadoValorEl){
      estadoValorEl.textContent = estadoTexto;
      estadoValorEl.className = ['estado-badge', clase].filter(Boolean).join(' ');
    }
  }

  function actualizarBotones(){
    if(!currentSorteoData){
      [sellarBtn, pdfBtn, jugarBtn, finalizarBtn].forEach(btn=>btn.disabled=true);
      pdfBtn.classList.remove('pdf-disponible');
      return;
    }
    const estado = (currentSorteoData.estado || '').toLowerCase();
    const pdfEstado = (currentSorteoData.pdf || '').toString().toLowerCase();

    sellarBtn.disabled = estado !== 'activo';
    pdfBtn.disabled = estado !== 'sellado';
    jugarBtn.disabled = estado !== 'sellado' || pdfEstado !== 'si';
    finalizarBtn.disabled = estado !== 'jugando';
    pdfBtn.classList.toggle('pdf-disponible', pdfEstado === 'si');
  }

  function mostrarDatos(){
    if(!currentSorteoData){
      btnSorteo.textContent = 'Selecciona Sorteo';
      if(fechaProgramadaEl) fechaProgramadaEl.textContent = '';
      if(horaProgramadaEl) horaProgramadaEl.textContent = '';
      if(fechaCierreEl) fechaCierreEl.textContent = '';
      if(horaCierreEl) horaCierreEl.textContent = '';
      actualizarVisibilidadFilaCierre('', '');
      premioEl.textContent = '0';
      valorCartonEl.textContent = '0';
      cartonesPagosEl.textContent = '0';
      cartonesGratisEl.textContent = '0';
      sorteoNombreEl.textContent = 'Selecciona un sorteo para ver los detalles';
      actualizarEstadoVisual(null);
      if(tipoEstadoEl){
        tipoEstadoEl.textContent = '';
        tipoEstadoEl.className = 'tipo-estado';
      }
      tipoEl.innerHTML = '';
      if(detalleContainer) detalleContainer.classList.remove('estado-sellado','estado-pdf','estado-jugando','estado-finalizado');
      mensajeEl.textContent = 'Selecciona un sorteo para administrar su estado.';
      [sellarBtn, pdfBtn, jugarBtn, finalizarBtn].forEach(btn=>btn.disabled=true);
      pdfBtn.classList.remove('pdf-disponible');
      actualizarAnimaciones();
      actualizarCantosSeleccionados([]);
      actualizarTablaEstado();
      reiniciarDatosJuego();
      infoTiempoSorteo = { fecha: null, fechaCierre: null, hora: null, horaCierre: null };
      actualizarColoresFechas();
      return;
    }
    const data = currentSorteoData;
    sincronizarFormasBase(data.formas || []);
    btnSorteo.textContent = data.nombre || 'Sorteo';
    btnSorteo.classList.remove('diario','especial','jugando','finalizado');
    const estadoActual = data.estado || '';
    const tipoActual = (data.tipo || '').toLowerCase();
    const esDiario = tipoActual.includes('diario');
    const esEspecial = tipoActual.includes('especial') || tipoActual.includes('espacial');
    if(estadoActual === 'Jugando') btnSorteo.classList.add('jugando');
    else if(estadoActual === 'Finalizado') btnSorteo.classList.add('finalizado');
    else if(esDiario) btnSorteo.classList.add('diario');
    else if(esEspecial) btnSorteo.classList.add('especial');
    if(detalleContainer){
      detalleContainer.classList.remove('estado-sellado','estado-pdf','estado-jugando','estado-finalizado');
      const estadoLower = estadoActual.toLowerCase();
      const pdfEstado = (data.pdf || '').toString().toLowerCase();
      if(estadoLower === 'finalizado') detalleContainer.classList.add('estado-finalizado');
      else if(estadoLower === 'jugando') detalleContainer.classList.add('estado-jugando');
      else if(pdfEstado === 'si') detalleContainer.classList.add('estado-pdf');
      else if(estadoLower === 'sellado') detalleContainer.classList.add('estado-sellado');
    }
    const fechaSorteoBase = obtenerFechaDesdeValor(data.fecha);
    const fechaProgramadaCompleta = obtenerFechaSorteo(data);
    const fechaCierreBase = obtenerFechaDesdeValor(data.fechacierre ?? data.fecha);
    const horaSorteoInfo = obtenerHoraDesdeValor(data.hora);
    const valorHoraCierre = obtenerValorHoraCierre(data);
    let fechaHoraCierreCompleta = obtenerFechaHoraCierre(data);
    if(
      fechaHoraCierreCompleta instanceof Date &&
      !isNaN(fechaHoraCierreCompleta.getTime()) &&
      fechaProgramadaCompleta instanceof Date &&
      !isNaN(fechaProgramadaCompleta.getTime()) &&
      fechaHoraCierreCompleta.getTime() > fechaProgramadaCompleta.getTime()
    ){
      fechaHoraCierreCompleta = new Date(fechaProgramadaCompleta.getTime());
    }
    let horaCierreInfo = obtenerHoraDesdeValor(valorHoraCierre);
    if(!horaCierreInfo && fechaHoraCierreCompleta instanceof Date && !isNaN(fechaHoraCierreCompleta.getTime())){
      horaCierreInfo = obtenerHoraDesdeValor(fechaHoraCierreCompleta);
    }
    if(fechaProgramadaEl) fechaProgramadaEl.textContent = fechaSorteoBase ? formatearFecha(fechaSorteoBase) : '';
    if(horaProgramadaEl) horaProgramadaEl.textContent = data.hora ? formatearHora(data.hora) : '';
    let textoFechaCierre = '';
    if(fechaCierreEl){
      textoFechaCierre = fechaCierreBase ? formatearFecha(fechaCierreBase) : '';
      fechaCierreEl.textContent = textoFechaCierre;
    }
    let textoHoraCierre = '';
    if(horaCierreEl){
      if(valorHoraCierre){
        textoHoraCierre = formatearHora(valorHoraCierre);
      } else if(fechaHoraCierreCompleta instanceof Date && !isNaN(fechaHoraCierreCompleta.getTime())){
        textoHoraCierre = formatearHora(fechaHoraCierreCompleta);
      }
      horaCierreEl.textContent = textoHoraCierre;
    }
    actualizarVisibilidadFilaCierre(textoFechaCierre, textoHoraCierre);
    premioEl.textContent = Math.round(data.totalPremios || 0);
    valorCartonEl.textContent = data.valorCarton || 0;
    cartonesPagosEl.textContent = data.cartonesjugando || 0;
    cartonesGratisEl.textContent = data.cartonesgratisjugando || 0;
    sorteoNombreEl.textContent = data.nombre || '';
    actualizarEstadoVisual(data.estado);
    if(tipoEstadoEl){
      let tipoMostrar = '';
      if(esEspecial) tipoMostrar = 'ESPECIAL';
      else if(esDiario) tipoMostrar = 'DIARIO';
      const clases = ['tipo-estado'];
      if(esEspecial) clases.push('especial');
      else if(esDiario) clases.push('diario');
      tipoEstadoEl.className = clases.join(' ');
      tipoEstadoEl.textContent = tipoMostrar;
    }
    tipoEl.innerHTML = '';
    infoTiempoSorteo = {
      fecha: fechaSorteoBase instanceof Date && !isNaN(fechaSorteoBase.getTime()) ? fechaSorteoBase : null,
      fechaCierre: fechaCierreBase instanceof Date && !isNaN(fechaCierreBase.getTime()) ? fechaCierreBase : null,
      hora: horaSorteoInfo || null,
      horaCierre: horaCierreInfo || null
    };
    actualizarColoresFechas();
    mensajeEl.textContent = '';
    actualizarBotones();
    actualizarAnimaciones();
    actualizarTablaEstado();
  }

  async function asegurarDbListo(){
    if(db){
      return db;
    }
    if(typeof initFirebase === 'function'){
      await initFirebase();
    }
    if(!db){
      throw new Error('Firestore no se inicializó correctamente.');
    }
    return db;
  }

  function crearLotes(arreglo, tamano){
    if(!Array.isArray(arreglo) || arreglo.length === 0){
      return [];
    }
    const valorTamano = Math.max(1, tamano | 0);
    const lotes = [];
    for(let i = 0; i < arreglo.length; i += valorTamano){
      lotes.push(arreglo.slice(i, i + valorTamano));
    }
    return lotes;
  }

  async function cargarCantosPorLotes(ids, registrosMap){
    if(!Array.isArray(ids) || !ids.length) return;
    if(!db) return;
    const lotes = crearLotes(ids, TAM_MAX_CONSULTA_IN);
    const fieldPathId = firebase.firestore.FieldPath.documentId();
    const consultas = lotes.map(lote=>{
      if(!Array.isArray(lote) || !lote.length) return Promise.resolve();
      return db.collection('cantos')
        .where(fieldPathId, 'in', lote)
        .get()
        .then(snap=>{
          snap.forEach(doc=>{
            const registro = registrosMap.get(doc.id);
            if(!registro) return;
            const dataCantos = doc.data() || {};
            registro.cantos = Array.isArray(dataCantos.numeros) ? dataCantos.numeros : [];
          });
        })
        .catch(err=>{
          console.error('Error cargando cantos en lote', err);
        });
    });
    await Promise.allSettled(consultas);
    ids.forEach(id=>{
      const registro = registrosMap.get(id);
      if(registro && !Array.isArray(registro.cantos)){
        registro.cantos = [];
      }
    });
  }

  async function cargarFormasPorLotes(ids, registrosMap){
    if(!Array.isArray(ids) || !ids.length) return;
    if(!db) return;
    const lotes = crearLotes(ids, TAM_MAX_CONSULTA_IN);
    const consultas = lotes.map(lote=>{
      if(!Array.isArray(lote) || !lote.length) return Promise.resolve();
      return db.collection('formas')
        .where('sorteoId', 'in', lote)
        .get()
        .then(snap=>{
          const agrupado = new Map();
          snap.forEach(doc=>{
            const dataForma = doc.data() || {};
            const sorteoId = dataForma.sorteoId || '';
            if(!sorteoId) return;
            if(!agrupado.has(sorteoId)){
              agrupado.set(sorteoId, []);
            }
            const arr = agrupado.get(sorteoId);
            arr.push({
              idx: dataForma.idx || dataForma.indice || arr.length + 1,
              nombre: dataForma.nombre || '',
              porcentaje: dataForma.porcentaje ?? dataForma.porcentajePremio ?? 0,
              cartonesGratis: dataForma.cartonesGratis ?? (dataForma.cartones || 0)
            });
          });
          agrupado.forEach((arr, sorteoId)=>{
            arr.sort((a,b)=>(parseInt(a.idx,10)||0)-(parseInt(b.idx,10)||0));
            const registro = registrosMap.get(sorteoId);
            if(registro){
              registro.formas = arr;
            }
          });
        })
        .catch(err=>{
          console.error('Error cargando formas en lote', err);
        });
    });
    await Promise.allSettled(consultas);
    ids.forEach(id=>{
      const registro = registrosMap.get(id);
      if(registro && !Array.isArray(registro.formas)){
        registro.formas = [];
      }
    });
  }

  async function cargarSorteos(opciones = {}){
    const forzar = opciones.forzar === true;
    const ahora = Date.now();
    if(!forzar){
      if(promesaCargaSorteos){
        return promesaCargaSorteos;
      }
      const usoCacheValido = sorteos.length && (ahora - ultimaCargaSorteos) < INTERVALO_CACHE_SORTEOS_MS;
      if(usoCacheValido){
        if(restauracionPendiente || (!currentSorteoId && sorteos.length)){
          await verificarSorteoPersistidoAlEntrar({ mostrarFallback: false, esperarCargaActiva: false });
        }
        return sorteos;
      }
    }
    const ejecucion = (async()=>{
      try {
        await asegurarDbListo();
        const snap = await db.collection('sorteos').get();
        const pendientesPdf = [];
        const registrosMap = new Map();
        snap.forEach(doc=>{
          const d = doc.data() || {};
          const condicionRaw = (d?.condicion || '').toString().trim().toUpperCase();
          if(condicionRaw === 'ARCHIVADO') return;
          const registro = { id: doc.id, ...d, pdf: d.pdf || 'no', cantos: [], formas: [] };
          registro.condicion = condicionRaw || 'VISIBLE';
          registro.nombre = registro.nombre || 'Sorteo';
          registro.estado = registro.estado || 'Activo';
          registro.fecha = registro.fecha || '';
          registro.fechacierre = registro.fechacierre || registro.fecha || '';
          registro.hora = registro.hora || '';
          registro.tipo = registro.tipo || '';
          registro.valorCarton = registro.valorCarton || 0;
          registro.cartonesjugando = registro.cartonesjugando || 0;
          registro.cartonesgratisjugando = registro.cartonesgratisjugando || 0;
          registro.totalPremios = registro.totalPremios || 0;
          if((registro.horacierre === undefined || registro.horacierre === null || registro.horacierre==='') && registro.cierre){
            registro.horacierre = registro.cierre;
          }
          registrosMap.set(doc.id, registro);
          if(typeof d.pdf === 'undefined' || d.pdf === null || d.pdf === ''){
            pendientesPdf.push(doc.id);
          }
        });
        sorteos = Array.from(registrosMap.values());
        if(pendientesPdf.length){
          Promise.allSettled(pendientesPdf.map(id=>
            db.collection('sorteos').doc(id).set({ pdf: 'no' }, { merge: true })
          )).catch(err=>console.error('Error asegurando pdf en sorteos', err));
        }
        const idsSorteos = Array.from(registrosMap.keys());
        const cargasDetalles = [];
        if(idsSorteos.length){
          cargasDetalles.push(cargarCantosPorLotes(idsSorteos, registrosMap));
          cargasDetalles.push(cargarFormasPorLotes(idsSorteos, registrosMap));
        }
        if(cargasDetalles.length){
          Promise.allSettled(cargasDetalles).then(()=>{
            if(!currentSorteoId) return;
            const actualizado = sorteos.find(s=>s.id===currentSorteoId);
            if(!actualizado) return;
            if(currentSorteoData){
              currentSorteoData = { ...currentSorteoData, ...actualizado };
              if(Array.isArray(actualizado.cantos)){ currentSorteoData.cantos = [...actualizado.cantos]; }
            }
            mostrarDatos();
          }).catch(err=>console.error('Error finalizando carga de sorteos', err));
        }
        if(restauracionPendiente || (!currentSorteoId && sorteos.length)){
          await verificarSorteoPersistidoAlEntrar({ mostrarFallback: false, esperarCargaActiva: false });
        }
        ultimaCargaSorteos = Date.now();
      } catch (err) {
        console.error('Error cargando sorteos', err);
        throw err;
      }
      return sorteos;
    })();
    promesaCargaSorteos = ejecucion;
    ejecucion.finally(()=>{
      promesaCargaSorteos = null;
    });
    return ejecucion;
  }

  async function abrirModalSorteos(){
    try {
      await cargarSorteos();
    } catch (err) {
      console.error('No se pudieron cargar los sorteos al abrir el selector', err);
      mensajeEl.textContent = 'No se pudieron cargar los sorteos. Inténtalo nuevamente.';
      return;
    }
    if(!sorteos.length){
      mensajeEl.textContent = 'No hay sorteos disponibles en este momento.';
      return;
    }
    mensajeEl.textContent = '';
    const cont = document.getElementById('sorteos-list');
    cont.innerHTML = '';
    const estadoOrden = { jugando: 0, sellado: 1, activo: 2, finalizado: 3 };
    const ahora = getServerNow() || new Date();
    const referencia = ahora instanceof Date && !isNaN(ahora.getTime()) ? ahora : new Date();
    const unicos = [];
    const vistos = new Set();
    sorteos.forEach(reg=>{
      if(!reg || !reg.id || vistos.has(reg.id)) return;
      vistos.add(reg.id);
      unicos.push(reg);
    });
    const ordenados = unicos.sort((a,b)=>{
      const estadoA = (a.estado || '').toString().toLowerCase();
      const estadoB = (b.estado || '').toString().toLowerCase();
      const prioridadA = estadoOrden.hasOwnProperty(estadoA) ? estadoOrden[estadoA] : 4;
      const prioridadB = estadoOrden.hasOwnProperty(estadoB) ? estadoOrden[estadoB] : 4;
      if(prioridadA !== prioridadB) return prioridadA - prioridadB;
      const fechaA = obtenerFechaSorteo(a);
      const fechaB = obtenerFechaSorteo(b);
      const diffA = fechaA ? Math.abs(fechaA - referencia) : Number.MAX_SAFE_INTEGER;
      const diffB = fechaB ? Math.abs(fechaB - referencia) : Number.MAX_SAFE_INTEGER;
      if(diffA !== diffB) return diffA - diffB;
      if(fechaA && fechaB && fechaA.getTime() !== fechaB.getTime()) return fechaA - fechaB;
      return (a.nombre || '').localeCompare(b.nombre || '');
    });
    const idSeleccionActual = currentSorteoId;
    let itemSeleccionado = null;
    ordenados.forEach((s, idx)=>{
      const div = document.createElement('div');
      const estadoLower = (s.estado || '').toString().toLowerCase().replace(/\s+/g,'-');
      div.className = ['sorteo-item', estadoLower].filter(Boolean).join(' ');
      div.dataset.sorteoId = s.id;
      const header = document.createElement('div');
      header.className = 'sorteo-header';
      const tipoTexto = (s.tipo || '').toString().toLowerCase();
      let tipoEtiqueta = '';
      if(tipoTexto.includes('especial')) tipoEtiqueta = '<span class="tipo-tag especial">ESPECIAL</span>';
      else if(tipoTexto.includes('diario')) tipoEtiqueta = '<span class="tipo-tag diario">DIARIO</span>';
      const nombreMostrar = (s.nombre || 'Sorteo').toString();
      const estadoMostrar = (s.estado || '-').toString();
      header.innerHTML = `<span class="titulo">${idx+1}. ${nombreMostrar}${tipoEtiqueta ? ` ${tipoEtiqueta}` : ''}</span>`;
      div.appendChild(header);
      const detalle = document.createElement('div');
      detalle.className = 'sorteo-detalle';
      const fechaTexto = s.fecha ? `<span class="detalle-fecha">📅 ${formatearFecha(s.fecha)}</span>` : '';
      const cierreTexto = obtenerTextoHoraCierre(s);
      const cierreHtml = cierreTexto ? `<span class="cierre-hora">CIERRE: ${cierreTexto}</span>` : '';
      const horaBase = s.hora ? `⏰ ${formatearHora(s.hora)}` : '';
      let horaTexto = '';
      if(horaBase){
        horaTexto = `<span class="detalle-hora">${horaBase}${cierreHtml ? ` ${cierreHtml}` : ''}</span>`;
      } else if(cierreHtml){
        horaTexto = `<span class="detalle-hora">${cierreHtml}</span>`;
      }
      detalle.innerHTML = [fechaTexto, horaTexto].filter(Boolean).join(' ');
      div.appendChild(detalle);
      const extra = document.createElement('div');
      extra.className = 'sorteo-extra';
      const cantosRegistrados = Array.isArray(s.cantos) ? s.cantos.length : 0;
      const totalPremios = Number(s.totalPremios) || 0;
      const subtotalesHtml = generarSubtotalesFormas(s.formas, totalPremios);
      const cartonesPagos = formatearNumero(s.cartonesjugando || 0);
      const cartonesGratis = formatearNumero(s.cartonesgratisjugando || 0);
      const cantosTexto = formatearNumero(cantosRegistrados);
      extra.innerHTML = `
        <div class="extra-premio">
          <span class="extra-premio-main">Premio: <span class="valor-premio">${formatearNumero(totalPremios)}</span></span>
          ${subtotalesHtml ? `<span class="extra-premio-subtotales">${subtotalesHtml}</span>` : ''}
        </div>
        <div class="extra-cartones">
          Cartones: <span class="extra-cartones-pagos">${cartonesPagos}</span>
          <span class="extra-cartones-mas">+</span>
          <span class="extra-cartones-gratis">${cartonesGratis}</span>
        </div>
      `;
      div.appendChild(extra);
      const corner = document.createElement('div');
      corner.className = 'sorteo-corner-info';
      const cornerCantos = document.createElement('div');
      cornerCantos.className = 'corner-cantos';
      cornerCantos.innerHTML = `Cantos: <span class="corner-cantos-valor">${cantosTexto}</span>`;
      if(estadoLower === 'jugando'){
        cornerCantos.classList.add('jugando');
      }
      const cornerEstado = document.createElement('div');
      cornerEstado.className = ['corner-estado', estadoLower].filter(Boolean).join(' ');
      cornerEstado.textContent = estadoMostrar;
      corner.appendChild(cornerCantos);
      corner.appendChild(cornerEstado);
      div.appendChild(corner);
      if(idSeleccionActual && idSeleccionActual === s.id){
        div.classList.add('seleccionado');
        itemSeleccionado = div;
      }
      div.addEventListener('click',()=>{
        seleccionarSorteo(s.id);
        document.getElementById('sorteos-modal').style.display = 'none';
      });
      cont.appendChild(div);
    });
    if(itemSeleccionado){
      setTimeout(()=>{
        try {
          itemSeleccionado.scrollIntoView({ block: 'center' });
        } catch (err) {
          console.warn('No fue posible centrar el sorteo seleccionado en la lista.', err);
        }
      }, 0);
    }
    document.getElementById('sorteos-modal').style.display = 'flex';
  }

  function escucharSorteo(id){
    if(sorteoUnsub){ sorteoUnsub(); sorteoUnsub = null; }
    const ref = db.collection('sorteos').doc(id);
    sorteoUnsub = ref.onSnapshot(doc=>{
      if(!doc.exists){
        limpiarSorteoSeleccionado();
        currentSorteoData = null;
        mostrarDatos();
        detenerCantos();
        detenerFormas();
        detenerCartones();
        return;
      }
      const cantosPrevios = currentSorteoData?.cantos || sorteos.find(s=>s.id===doc.id)?.cantos || [];
      currentSorteoData = { id: doc.id, ...doc.data(), cantos: cantosPrevios };
      if(currentSorteoData){
        currentSorteoData.condicion = (currentSorteoData.condicion || currentSorteoData['condición'] || '').toString().trim().toUpperCase() || 'VISIBLE';
      }
      asegurarCampoPdf(doc.id, currentSorteoData);
      const idx = sorteos.findIndex(s=>s.id===doc.id);
      if(idx>=0){
        const cantosExistentes = sorteos[idx].cantos || [];
        sorteos[idx] = { ...sorteos[idx], ...doc.data(), cantos: cantosExistentes };
        sorteos[idx].condicion = (sorteos[idx].condicion || sorteos[idx]['condición'] || '').toString().trim().toUpperCase() || 'VISIBLE';
      }
      guardarSorteoSeleccionado(currentSorteoData);
      mostrarDatos();
    }, err=>console.error('Error escuchando sorteo', err));
  }

  function seleccionarSorteo(id){
    if(!id) return;
    currentSorteoId = id;
    restauracionPendiente = false;
    const encontrado = sorteos.find(s=>s.id===id);
    currentSorteoData = encontrado ? { ...encontrado } : null;
    reiniciarDatosJuego();
    if(currentSorteoData){
      currentSorteoData.condicion = (currentSorteoData.condicion || currentSorteoData['condición'] || '').toString().trim().toUpperCase() || 'VISIBLE';
      guardarSorteoSeleccionado(currentSorteoData);
      asegurarCampoPdf(currentSorteoId, currentSorteoData);
      actualizarCantosSeleccionados(currentSorteoData.cantos || []);
    } else {
      actualizarCantosSeleccionados([]);
    }
    escucharSorteo(id);
    escucharCantos(id);
    escucharFormas(id);
    escucharCartones(id);
    mostrarDatos();
  }

  // Pruebas manuales: se cambió la zona horaria del navegador a "America/Bogota" y "Europe/Madrid"
  // para verificar que el botón de sellado solo se habilita una vez superada la hora oficial de cierre.
  async function sellarSorteo(){
    if(!currentSorteoId || !currentSorteoData){ alert('Selecciona un sorteo primero.'); return; }
    const estadoActual = (currentSorteoData.estado || '').toString().toLowerCase();
    if(estadoActual === 'sellado'){ alert('El sorteo ya está sellado.'); return; }
    if(estadoActual === 'jugando' || estadoActual === 'finalizado'){
      alert('El sorteo ya se encuentra en una fase posterior.');
      return;
    }

    if(esModoManual()){
      const ahoraManual = getServerNow() || new Date();
      const fechaHoraCierreManual = obtenerFechaHoraCierre(currentSorteoData);
      if(fechaHoraCierreManual instanceof Date && !isNaN(fechaHoraCierreManual.getTime()) && ahoraManual < fechaHoraCierreManual){
        const fechaTexto = obtenerTextoFechaPreferido(currentSorteoData.fechacierre, fechaHoraCierreManual, currentSorteoData.fecha);
        const horaTexto = obtenerTextoHoraPreferido(currentSorteoData.horacierre, fechaHoraCierreManual, currentSorteoData.hora);
        alert(`Aun no se puede sellar el sorteo debe ser despues de ${fechaTexto} a las ${horaTexto}`);
        return;
      }
      const confirmarManual = await preguntarAccionEstado('¿Deseas sellar el sorteo seleccionado?');
      if(!confirmarManual) return;
      await ejecutarSellado({ confirmadoManual: true, confirmado: true });
      return;
    }

    if(estadoActual !== 'activo'){
      alert('El sorteo debe estar en estado Activo para poder ser sellado.');
      return;
    }

    const fechaProgramada = obtenerFechaSorteo(currentSorteoData);
    const fechaCierreBase = obtenerFechaCierre(currentSorteoData);
    const fechaHoraCierreOriginal = obtenerFechaHoraCierre(currentSorteoData);
    const valorHoraCierre = obtenerValorHoraCierre(currentSorteoData);
    const ahora = getServerNow() || new Date();
    const fechaProgramadaValida = fechaProgramada instanceof Date && !isNaN(fechaProgramada.getTime());
    const fechaCierreValida = fechaCierreBase instanceof Date && !isNaN(fechaCierreBase.getTime());
    let fechaHoraCierreNormalizada = fechaHoraCierreOriginal;
    if(fechaHoraCierreNormalizada instanceof Date && fechaProgramadaValida && fechaHoraCierreNormalizada.getTime() > fechaProgramada.getTime()){
      fechaHoraCierreNormalizada = new Date(fechaProgramada.getTime());
    }
    const fechaHoraCierreValida = fechaHoraCierreNormalizada instanceof Date && !isNaN(fechaHoraCierreNormalizada.getTime());
    let horaCierreInfo = infoTiempoSorteo?.horaCierre || obtenerHoraDesdeValor(valorHoraCierre);
    if(!horaCierreInfo && fechaHoraCierreValida){
      horaCierreInfo = obtenerHoraDesdeValor(fechaHoraCierreNormalizada);
    }

    const horaCierreValida = horaCierreInfo && !isNaN(Number(horaCierreInfo.hora)) && !isNaN(Number(horaCierreInfo.minuto));
    const candidatosCierre = [];
    if(fechaCierreValida){
      candidatosCierre.push({
        tipoMensaje: 'cierre',
        fechaCalendario: fechaCierreBase,
        obtenerFechaHora: ()=> horaCierreValida ? construirFechaConHora(fechaCierreBase, horaCierreInfo) : null,
        obtenerDiferencia: ()=> horaCierreValida ? calcularDiferenciaEnMinutos(ahora, fechaCierreBase, horaCierreInfo) : null
      });
    } else if(fechaProgramadaValida){
      candidatosCierre.push({
        tipoMensaje: 'sorteo',
        fechaCalendario: fechaProgramada,
        obtenerFechaHora: ()=> horaCierreValida ? construirFechaConHora(fechaProgramada, horaCierreInfo) : null,
        obtenerDiferencia: ()=> horaCierreValida ? calcularDiferenciaEnMinutos(ahora, fechaProgramada, horaCierreInfo) : null
      });
    }
    if(fechaHoraCierreValida){
      const tipoFallback = fechaCierreValida ? 'cierre' : 'sorteo';
      candidatosCierre.push({
        tipoMensaje: tipoFallback,
        fechaCalendario: fechaHoraCierreNormalizada,
        obtenerFechaHora: ()=> new Date(fechaHoraCierreNormalizada.getTime()),
        obtenerDiferencia: ()=> (ahora.getTime() - fechaHoraCierreNormalizada.getTime()) / 60000
      });
    }

    let evaluacionCierre = null;
    for(const candidato of candidatosCierre){
      let fechaHoraEvaluacion = null;
      if(typeof candidato.obtenerFechaHora === 'function'){
        try {
          fechaHoraEvaluacion = candidato.obtenerFechaHora();
        } catch (error) {
          fechaHoraEvaluacion = null;
        }
      }
      if(!(fechaHoraEvaluacion instanceof Date) || isNaN(fechaHoraEvaluacion.getTime())){
        continue;
      }
      let diferenciaMinutos = null;
      if(typeof candidato.obtenerDiferencia === 'function'){
        try {
          diferenciaMinutos = candidato.obtenerDiferencia();
        } catch (error) {
          diferenciaMinutos = null;
        }
      }
      if(typeof diferenciaMinutos !== 'number' || isNaN(diferenciaMinutos)){
        diferenciaMinutos = (ahora.getTime() - fechaHoraEvaluacion.getTime()) / 60000;
      }
      if(typeof diferenciaMinutos !== 'number' || isNaN(diferenciaMinutos)){
        continue;
      }
      evaluacionCierre = {
        tipoMensaje: candidato.tipoMensaje,
        fechaCalendario: candidato.fechaCalendario,
        fechaHoraEvaluacion,
        diferenciaMinutos
      };
      break;
    }

    if(!evaluacionCierre){
      const confirmarSinFecha = await preguntarAccionEstado('No se pudo determinar la fecha programada del sorteo. ¿Deseas sellarlo de todos modos?');
      if(!confirmarSinFecha) return;
      await ejecutarSellado({ confirmado: true });
      return;
    }

    const fechaComparacionBase = evaluacionCierre.fechaCalendario instanceof Date && !isNaN(evaluacionCierre.fechaCalendario.getTime())
      ? evaluacionCierre.fechaCalendario
      : evaluacionCierre.fechaHoraEvaluacion;
    const comparacionCalendario = compararFechasCalendario(ahora, fechaComparacionBase);
    if(comparacionCalendario === null){
      alert('No se pudo determinar la fecha actual para validar el cierre.');
      return;
    }
    if(evaluacionCierre.diferenciaMinutos < 0){
      if(comparacionCalendario < 0){
        if(evaluacionCierre.tipoMensaje === 'cierre'){
          alert('Aún no es la fecha de cierre del sorteo, no puede ser Sellado');
        } else {
          alert('Aún no es la fecha del sorteo, no puede ser Sellado');
        }
      } else {
        alert('Hoy es el día del sorteo pero aún no ha llegado la hora de cierre');
      }
      return;
    }

    const confirmarSellado = await preguntarAccionEstado('¿Estas seguro de Sellar el sorteo?');
    if(!confirmarSellado) return;

    await ejecutarSellado({ confirmado: true });
  }

  async function ejecutarSellado(opciones = {}){
    const confirmadoManual = opciones.confirmadoManual === true;
    const confirmado = opciones.confirmado === true;
    if(esModoManual() && !confirmadoManual){
      const confirmar = await preguntarAccionEstado('¿Deseas sellar el sorteo seleccionado?');
      if(!confirmar) return false;
    }
    if(!confirmado && !confirmadoManual){
      const confirmarSellado = await preguntarAccionEstado('¿Estas seguro de Sellar el sorteo?');
      if(!confirmarSellado) return false;
    }
    try {
      await db.collection('sorteos').doc(currentSorteoId).update({ estado: 'Sellado', pdf: 'no' });
      mensajeEl.textContent = 'El sorteo fue sellado correctamente.';
      sellarBtn.classList.remove('attention');
      return true;
    } catch (err) {
      console.error('Error sellando sorteo', err);
      alert('No fue posible sellar el sorteo.');
      return false;
    }
  }

  function sincronizarDatosPdf(datos = {}){
    const estadoBruto = (datos.pdf || '').toString().toLowerCase();
    const estadoNormalizado = estadoBruto === 'si' ? 'si' : 'no';
    const urlPdf = typeof datos.pdfUrl === 'string' ? datos.pdfUrl.trim() : '';

    if(currentSorteoData){
      currentSorteoData.pdf = estadoNormalizado;
      currentSorteoData.pdfUrl = urlPdf;
    }
    const idx = sorteos.findIndex(s=>s.id===currentSorteoId);
    if(idx>=0){
      sorteos[idx] = { ...sorteos[idx], pdf: estadoNormalizado, pdfUrl: urlPdf };
    }
    pdfDestinoUrl = urlPdf;
    guardarSorteoSeleccionado(currentSorteoData);
    actualizarBotones();
    actualizarAnimaciones();
    mostrarDatos();

    return { estado: estadoNormalizado, url: urlPdf };
  }

  async function abrirPDF(){
    if(!currentSorteoId || !currentSorteoData){ alert('Selecciona un sorteo primero.'); return; }
    const estadoActual = (currentSorteoData.estado || '').toString().toLowerCase();
    if(estadoActual !== 'sellado'){
      if(esModoManual()){
        alert('Para generar el archivo PDF de sellado el sorteo debe estar Sellado primero');
      } else {
        alert('Aún no has sellado el sorteo, no se puede generar el PDF');
      }
      return;
    }

    try {
      const docRef = await db.collection('sorteos').doc(currentSorteoId).get();
      if(!docRef.exists){
        alert('No fue posible obtener la información del sorteo seleccionado.');
        return;
      }
      const datos = docRef.data() || {};
      const { estado: pdfEstadoNormalizado } = sincronizarDatosPdf(datos);

      if(pdfEstadoNormalizado === 'no'){
        try {
          const destinoUrl = new URL('pdfsorteo.html', window.location.href);
          destinoUrl.searchParams.set('s', currentSorteoId);
          window.location.assign(destinoUrl.toString());
        } catch (err) {
          const fallback = `pdfsorteo.html?s=${encodeURIComponent(currentSorteoId)}`;
          window.location.href = fallback;
        }
        return;
      }

      alert('El documento pdf ya fue generado para este sorteo');
    } catch (error) {
      console.error('Error consultando el estado del PDF', error);
      alert('Ocurrió un error al consultar el estado del documento PDF.');
    }
  }

  async function manejarClickPdfAlmacenado(evento){
    evento.preventDefault();
    evento.stopPropagation();
    if(!currentSorteoId || !currentSorteoData){
      alert('Selecciona un sorteo primero.');
      return;
    }

    let urlActual = (currentSorteoData.pdfUrl || pdfDestinoUrl || '').toString().trim();
    if(!urlActual){
      try {
        const docRef = await db.collection('sorteos').doc(currentSorteoId).get();
        if(docRef.exists){
          const datos = docRef.data() || {};
          const { url } = sincronizarDatosPdf(datos);
          urlActual = url.toString().trim();
        }
      } catch (error) {
        console.error('Error obteniendo la URL del PDF almacenado', error);
      }
    }

    if(!urlActual){
      alert('No hay un archivo PDF almacenado para este sorteo.');
      return;
    }

    try {
      const ventana = window.open(urlActual, '_blank', 'noopener');
      if(!ventana){
        window.location.assign(urlActual);
      }
    } catch (err) {
      try {
        window.location.assign(urlActual);
      } catch (fallbackError) {
        window.location.href = urlActual;
      }
    }
  }

  async function cambiarAJugando(){
    if(!currentSorteoId || !currentSorteoData){ alert('Selecciona un sorteo primero.'); return; }
    const estadoActual = (currentSorteoData.estado || '').toString().toLowerCase();
    if(estadoActual === 'jugando'){ alert('El sorteo ya está en estado Jugando.'); return; }
    if(estadoActual === 'finalizado'){ alert('El sorteo ya finalizó.'); return; }
    if(estadoActual !== 'sellado'){
      alert('El sorteo debe estar Sellado para iniciar el juego.');
      return;
    }
    const pdfEstado = (currentSorteoData.pdf || '').toString().toLowerCase();
    if(pdfEstado !== 'si'){
      if(esModoManual()){
        alert('Debes generar el PDF antes de iniciar el juego.');
      } else {
        alert('Aún no has generado el pdf de las jugadas, antes de cantar las jugadas debes generar, descargar y compartir el pdf de cierre de jugadas');
      }
      return;
    }

    if(esModoManual()){
      const fechaJuego = obtenerFechaSorteo(currentSorteoData);
      if(fechaJuego instanceof Date && !isNaN(fechaJuego.getTime())){
        const ahoraManual = getServerNow() || new Date();
        if(ahoraManual < fechaJuego){
          const fechaTexto = obtenerTextoFechaPreferido(currentSorteoData.fecha, fechaJuego);
          const horaTexto = obtenerTextoHoraPreferido(currentSorteoData.hora, fechaJuego);
          alert(`Aun no se puede Jugar el sorteo debe ser despues de ${fechaTexto} a las ${horaTexto}`);
          return;
        }
      }
      const confirmarManual = await preguntarAccionEstado('¿Deseas cambiar el estado del sorteo a "Jugando"?');
      if(!confirmarManual) return;
      await actualizarEstadoJugando({ confirmadoManual: true, confirmado: true });
      return;
    }

    const fechaProgramada = obtenerFechaSorteo(currentSorteoData);
    if(!fechaProgramada || isNaN(fechaProgramada.getTime())){
      alert('No se pudo determinar la fecha y hora programada del sorteo.');
      return;
    }

    const ahora = getServerNow() || new Date();
    const comparacionFecha = compararFechasCalendario(ahora, fechaProgramada);
    if(comparacionFecha === null){
      alert('No se pudo determinar la fecha actual para validar el inicio.');
      return;
    }
    if(comparacionFecha < 0){
      alert('Aún no es la fecha del sorteo, no puedes iniciar el juego.');
      return;
    }
    if(comparacionFecha === 0 && ahora < fechaProgramada){
      alert('Aún no ha llegado la hora programada para iniciar el juego.');
      return;
    }

    const nombre = obtenerNombreSorteoActual();
    const confirmar = await preguntarAccionEstado(`¿Deseas iniciar el juego del sorteo: ${nombre}?`);
    if(!confirmar) return;

    await actualizarEstadoJugando({ confirmado: true });
  }

  async function actualizarEstadoJugando(opciones = {}){
    const confirmadoManual = opciones.confirmadoManual === true;
    const confirmado = opciones.confirmado === true;
    if(esModoManual() && !confirmadoManual){
      const confirmar = await preguntarAccionEstado('¿Deseas cambiar el estado del sorteo a "Jugando"?');
      if(!confirmar) return false;
    }
    if(!confirmado && !confirmadoManual){
      const confirmarGeneral = await preguntarAccionEstado('¿Deseas cambiar el estado del sorteo a "Jugando"?');
      if(!confirmarGeneral) return false;
    }
    try {
      await db.collection('sorteos').doc(currentSorteoId).update({ estado: 'Jugando' });
      mensajeEl.textContent = 'El sorteo cambió a estado Jugando.';
      jugarBtn.classList.remove('attention');
      return true;
    } catch (err) {
      console.error('Error cambiando a Jugando', err);
      alert('No fue posible cambiar el estado a Jugando.');
      return false;
    }
  }

  async function finalizarSorteo(){
    if(!currentSorteoId || !currentSorteoData){ alert('Selecciona un sorteo primero.'); return; }
    if((currentSorteoData.estado || '').toLowerCase() !== 'jugando'){
      alert('El sorteo debe estar en estado Jugando para finalizar.');
      return;
    }
    const nombre = obtenerNombreSorteoActual();
    const confirmar = await preguntarAccionEstado(`¿Estas seguro de Finalizar el sorteo: ${nombre}?`);
    if(!confirmar) return;
    try {
      await db.collection('sorteos').doc(currentSorteoId).update({ estado: 'Finalizado' });
      mensajeEl.textContent = 'El sorteo fue finalizado correctamente.';
      finalizarBtn.classList.remove('attention');
    } catch (err) {
      console.error('Error finalizando sorteo', err);
      alert('No fue posible finalizar el sorteo.');
    }
  }

  async function inicializar(){
    let primerIntentoFallido = false;
    let mensajePostCarga = '';
    const esperaAuth = authListoPromesa.catch(()=>{});
    try {
      await initFirebase();
      await esperaAuth;
      await cargarSorteos();
    } catch (err) {
      primerIntentoFallido = true;
      console.error('Error inicializando los sorteos', err);
      mensajeEl.textContent = 'No se pudieron cargar los sorteos en el primer intento. Reintentando...';
    }
    if(primerIntentoFallido){
      try {
        await initFirebase();
        await esperaAuth;
        await cargarSorteos({ forzar: true });
        mensajePostCarga = 'Los sorteos se cargaron tras un reintento.';
      } catch (reintentoErr) {
        console.error('Error recargando los sorteos tras fallo inicial', reintentoErr);
        mensajeEl.textContent = 'No se pudieron cargar los sorteos. Refresca la página o inténtalo más tarde.';
        return;
      }
    }
    await verificarSorteoPersistidoAlEntrar({ mostrarFallback: true });
    if(mensajePostCarga){
      mensajeEl.textContent = mensajePostCarga;
    }
  }

  setInterval(actualizarAnimaciones, 15000);

  inicializar();
  </script>
</body>
</html>
