<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jugar Cart√≥n</title>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(rgba(255,255,255,0.7), rgba(255,255,255,0.7)),
                  url('https://img.freepik.com/vetores-premium/padrao-sem-costura-com-simbolos-de-dolar-e-porcentagem_637741-777.jpg');
      background-repeat: repeat;
      background-size: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      text-align: center;
      padding-top: 5px;
    }
    h1#titulo{
      font-family:'Bangers',cursive;
      color:white;
      text-shadow:0 0 10px darkorange;
      margin:5px 0 10px 0;
      font-size:2rem;
    }
    .menu-btn{
      width:250px;
      height:60px;
      font-family:'Bangers',cursive;
      font-size:1.4rem;
      background:rgba(0,170,255,0.8);
      color:white;
      border:4px solid #FFD700;
      border-radius:10px;
      text-shadow:2px 2px 4px #000;
      text-transform:uppercase;
      cursor:pointer;
      transition:transform 0.3s,box-shadow 0.3s,background 0.3s;
    }
    .menu-btn:hover{ transform:scale(1.05); box-shadow:0 0 15px rgba(255,215,0,0.8); }
    .menu-btn:active{ transform:scale(0.95); box-shadow:0 0 5px rgba(255,215,0,0.8); }
    .back-btn{
      position:fixed;
      top:5px;
      left:5px;
      width:120px;
      height:40px;
      background:orange;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:5px;
      font-size:1.2rem;
    }
    @media (orientation:portrait){
      #volver-btn{width:40px;}
      #volver-btn .label{display:none;}
    }
    #sorteo-btn{
      width:240px;
      font-size:1.1rem;
      padding:5px 10px;
      text-align:center;
      border:2px solid gray;
      border-radius:5px;
      background:linear-gradient(#dddddd,#ffffff);
      cursor:pointer;
      white-space:nowrap;
      overflow:hidden;
    }
    #sorteo-btn.diario{background:linear-gradient(#00aa00,#ffffff);}
    #sorteo-btn.especial{background:linear-gradient(#ff8800,#ffffff);}
    .sorteo-diario{color:green;}
    .sorteo-especial{color:orange;}
    .sorteo-sellado{color:gray;}
    .sorteo-jugando{color:purple;}
    @keyframes zoomInOut{0%,100%{transform:scale(1);}50%{transform:scale(1.1);}}
    .sorteo-jugando span,.sorteo-jugando .sorteo-detalle{display:inline-block;animation:zoomInOut 1s infinite;transform-origin:left center;}
    .sorteo-info{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap;}
    .sellado-overlay{
      position:fixed;
      inset:0;
      background:rgba(8,18,42,0.74);
      display:none;
      align-items:center;
      justify-content:center;
      padding:24px;
      z-index:1200;
    }
    .sellado-overlay.visible{display:flex;}
    body.sellado-modal-activo{overflow:hidden;}
    .sellado-modal-card{
      width:min(420px,90%);
      background:linear-gradient(165deg,#b71c1c 0%,#ff6f60 55%,#ff1744 100%);
      border:4px solid #ffe082;
      border-radius:18px;
      box-shadow:0 22px 45px rgba(0,0,0,0.45);
      padding:clamp(22px,4vw,32px);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:clamp(12px,2.6vw,20px);
      text-align:center;
      color:#ffffff;
      position:relative;
      overflow:hidden;
    }
    .sellado-modal-card::after{
      content:'';
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 30% 25%,rgba(255,255,255,0.28),transparent 55%);
      pointer-events:none;
    }
    .sellado-modal-icono{
      font-family:'Bangers',cursive;
      font-size:clamp(2.2rem,6vw,3rem);
      letter-spacing:2px;
      text-shadow:0 4px 10px rgba(0,0,0,0.35);
      z-index:1;
    }
    .sellado-aviso{
      margin:0;
      font-family:'Poppins',sans-serif;
      font-weight:600;
      line-height:1.5;
      z-index:1;
    }
    .sellado-aviso p{margin:0;font-size:clamp(1rem,3.4vw,1.1rem);}
    .sellado-linea-principal{font-size:clamp(1.05rem,3.6vw,1.2rem);letter-spacing:0.4px;}
    .sellado-linea-secundaria{font-size:clamp(1rem,3.2vw,1.1rem);}
    .sellado-destino{display:block;font-size:clamp(1.35rem,4vw,1.6rem);font-weight:700;color:#ffde59;text-transform:uppercase;margin:4px 0;}
    .sellado-destino strong{font-family:'Bangers',cursive;letter-spacing:1.2px;color:#fff;text-shadow:0 2px 6px rgba(0,0,0,0.35);}
    .sellado-enfasis{font-weight:700;color:#ffde59;}
    .sellado-cerrar-btn{
      border:3px solid #ffe082;
      border-radius:12px;
      background:#ffffff;
      color:#b71c1c;
      font-family:'Bangers',cursive;
      font-size:clamp(1.1rem,3.4vw,1.4rem);
      padding:10px 28px;
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:1px;
      box-shadow:0 6px 18px rgba(0,0,0,0.35);
      transition:transform 0.25s ease,box-shadow 0.25s ease;
      z-index:1;
    }
    .sellado-cerrar-btn:hover{transform:scale(1.05);box-shadow:0 10px 24px rgba(0,0,0,0.4);}
    .sellado-cerrar-btn:active{transform:scale(0.95);}
    #fecha-hora-sorteo{display:flex;flex-wrap:wrap;align-items:flex-start;justify-content:center;gap:12px;font-family:'Poppins',sans-serif;text-transform:none;}
    #fecha-hora-sorteo .fecha-col{display:flex;flex-direction:column;align-items:flex-start;gap:2px;min-width:120px;}
    #fecha-hora-sorteo .sorteo-line{display:flex;align-items:center;gap:4px;font-weight:600;font-size:1rem;}
    #fecha-hora-sorteo .actual-line{font-size:0.7rem;color:#0b5394;font-weight:600;display:block;margin-top:-2px;}
    #fecha-hora-sorteo .cal-icon,#fecha-hora-sorteo .clock-icon{font-size:1.1rem;}
    .datos-sorteo{display:flex;flex-direction:column;align-items:center;gap:4px;justify-content:center;margin-top:2px;flex-wrap:wrap;font-family:'Bangers',cursive;}
    #sorteo-section{margin-bottom:5px;}
    .datos-sorteo div{font-weight:bold;font-size:1.2rem;}
    #valor-carton span,#cartones-jugando span{font-size:1.5rem;}
    #valor-carton-valor,#premio-valor{animation:pulse 1s infinite;display:inline-block;}
    #cartones-jugando-valor,#carton-num,#gratis-plus,#cartones-gratis-jugando{animation:wiggle 1s infinite;display:inline-block;}
    #cartones-gratis-jugando{color:#00008b;}
    #valor-carton{color:green;display:flex;align-items:center;gap:5px;}
    #cartones-jugando{color:purple;display:flex;align-items:center;gap:5px;}
    #gratis-plus{font-weight:bold;color:black;font-family:'Bangers',cursive;}
    #stats-row{display:flex;justify-content:center;align-items:center;gap:20px;}
    .billete-icon{font-size:1.5rem;}
    .carton-icon{width:24px;height:24px;}
    #premio-repartir{color:white;font-family:'Bangers',cursive;font-size:1.8rem;text-shadow:0 0 10px #004400;position:relative;}
    #forma-nombre{font-family:'Bangers',cursive;color:#4B0082;font-size:1rem;text-shadow:0 0 5px #fff;text-align:center;visibility:hidden;min-height:8px;margin:0;}
    .wallet-row{display:flex;align-items:center;gap:5px;margin:3px 0;font-size:1rem;font-weight:bold;}
    #creditos-label,#gratis-label{font-family:'Bangers',cursive;font-size:1.5rem;text-shadow:0 0 5px green;display:inline-block;animation:pulse 1s infinite;}
    #gratis-label{color:#4b0082;text-shadow:0 0 5px #fff;}
    #creditos-label{color:#333;text-shadow:0 0 5px green;}
    .credit-icon{color:white;font-weight:bold;text-shadow:0 0 5px lime;}
    .action-btn{
      font-family:'Bangers',cursive;
      background:linear-gradient(#0a8800,#ffffff);
      color:white;
      border:3px solid #FFD700;
      border-radius:8px;
      text-shadow:2px 2px 4px #000;
      cursor:pointer;
    }
    #info-cartones-ver{background:linear-gradient(purple,#00008b);}
    #jugados-btn-container{position:absolute;bottom:5px;right:50px;}
    #ver-jugados-btn{width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:linear-gradient(purple,#ffffff);border:3px solid #FFD700;border-radius:8px;cursor:pointer;position:relative;}
    #jugados-count{position:absolute;top:-8px;left:-8px;background:purple;color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-family:'Bangers',cursive;z-index:10;}
    #jugados-gratis-count{position:absolute;top:-8px;right:-8px;background:#00008b;color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-family:'Bangers',cursive;z-index:10;}
    #limpiar-btn{width:40px;height:40px;display:flex;align-items:center;justify-content:center;position:absolute;bottom:5px;right:95px;background:linear-gradient(gray,#ffffff);border:3px solid #FFD700;border-radius:8px;cursor:pointer;}
    #azar-btn{width:40px;height:40px;display:flex;align-items:center;justify-content:center;position:absolute;bottom:5px;right:140px;background:linear-gradient(#ffffff,#dddddd);border:3px solid #FFD700;border-radius:8px;cursor:pointer;}
    #ir-billetera-btn{width:40px;height:40px;font-size:1.2rem;display:flex;align-items:center;justify-content:center;position:absolute;bottom:5px;right:5px;margin-left:0;}
    #jugar-carton-btn{width:200px;height:40px;font-size:1.2rem;display:flex;align-items:center;justify-content:center;margin:10px auto;}
    .carton-box{display:flex;justify-content:center;margin:0 auto 8px;perspective:1000px;}
    .carton-wrapper{position:relative;transform-style:preserve-3d;transition:transform 0.6s;border-radius:16px;padding:6px;background:linear-gradient(green,yellow);box-shadow:0 0 15px rgba(0,0,0,0.5);}
    .carton-wrapper.flipped{transform:rotateY(180deg);}
    .carton-wrapper.flipped .carton{pointer-events:none;}
    .carton-wrapper.flipped .carton-back{pointer-events:auto;}
    .carton{margin:0;border-collapse:separate;border-spacing:0;background:linear-gradient(#ffffff,#cccccc);border-radius:10px;table-layout:fixed;backface-visibility:hidden;}
    .carton th,.carton td{background:transparent;border:2px solid gray;width:60px;height:60px;aspect-ratio:1/1;text-align:center;font-weight:bold;padding:0 3px;margin:0;box-sizing:border-box;}
    .carton th{font-size:2.5rem;color:#ff6600;background:radial-gradient(circle,#ffffff,#ffffff 60%,#00aa00);text-shadow:2px 2px 0 #000;}
    .forma-header{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;font-family:'Bangers',cursive;font-size:0.8rem;line-height:1;text-shadow:1px 1px 0 #000;}
    .carton td{cursor:pointer;font-size:1.8rem;text-shadow:0 0 3px green;}
    .carton td.free{background:radial-gradient(circle,#ffffff,#ffff00);display:flex;align-items:center;justify-content:center;font-size:1.2rem;color:#4B0082;}
    .carton td.error{border:2px solid red;}
    .carton-back{position:absolute;top:0;left:0;right:0;bottom:0;border-radius:10px;backface-visibility:hidden;transform:rotateY(180deg);background:linear-gradient(white,gray);display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:5px;overflow:hidden;}
    .carton-back img{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:80%;height:auto;opacity:0.15;object-fit:contain;pointer-events:none;z-index:0;}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;z-index:1000;}
    .modal-content{background:#fff;padding:10px;border-radius:10px;display:flex;flex-direction:column;align-items:flex-start;gap:5px;width:max-content;}
    #sorteos-list div{display:block;font-weight:bold;font-size:1rem;cursor:pointer;font-family:'Poppins',sans-serif;margin-bottom:2px;}
    #sorteos-list .sorteo-index{display:inline-block;width:30px;margin-right:2px;}
    #sorteos-list div .sorteo-detalle{display:flex;align-items:center;gap:4px;font-size:0.6rem;font-weight:normal;pointer-events:none;color:inherit;font-family:'Poppins',sans-serif;margin-top:-2px;padding-left:30px;}
    #sorteos-list div .hora-cierre{color:#ff0000;}
    #number-modal-title{font-size:0.8rem;text-align:center;width:100%;text-shadow:0 0 5px blue;margin-bottom:5px;font-family:'Poppins',sans-serif;}
    #number-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;justify-items:center;}
    #number-grid div{width:60px;height:60px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;text-shadow:0 0 5px green;cursor:pointer;}
    #jugados-content,#cartones-content{width:max-content;max-width:100%;margin:auto;max-height:80vh;align-items:center;position:relative;padding:5px;box-sizing:border-box;display:flex;flex-direction:column;}
    #jugados-grid,#cartones-grid{display:grid;grid-template-columns:repeat(2,auto);gap:8px;justify-items:center;overflow-y:auto;flex-grow:1;min-height:0;}
    #jugados-nombre-sorteo,#cargar-jugado-btn,#editar-jugado-btn,#cartones-titulo,#cargar-guardado-btn,#editar-guardado-btn{flex-shrink:0;}
    .close-icon{position:absolute;top:5px;right:5px;cursor:pointer;font-size:1.2rem;}
    .mini-carton-box{display:flex;flex-direction:column;align-items:center;cursor:pointer;}
    .mini-carton-box.selected{outline:3px solid blue;}
    .mini-index,.mini-num{padding:1px 3px;background:rgba(255,255,255,0.8);border-radius:3px;font-weight:bold;font-size:0.7rem;margin:2px 0;text-align:center;}
    .mini-index{color:#000;}
    .mini-num{color:purple;}
    .mini-carton-wrapper{background:linear-gradient(green,yellow);padding:3px;border-radius:10px;box-shadow:0 0 5px rgba(0,0,0,0.5);}
    .mini-carton{border-collapse:separate;border-spacing:0;background:linear-gradient(#ffffff,#cccccc);border-radius:8px;}
    .mini-carton th,.mini-carton td{border:1px solid gray;width:20px;height:20px;text-align:center;font-weight:bold;font-size:0.6rem;aspect-ratio:1/1;}
    .mini-carton th{font-size:0.8rem;color:#ff6600;background:radial-gradient(circle,#ffffff,#ffffff 60%,#00aa00);text-shadow:1px 1px 0 #000;}
    .mini-carton-wrapper.gratis{background:linear-gradient(#0000ff,yellow);}
    .mini-carton-wrapper.gratis .mini-carton th{background:radial-gradient(circle,#ffffff,#ffffff 60%,#0000ff);}
    #cargar-jugado-btn,#cargar-guardado-btn,#editar-jugado-btn,#editar-guardado-btn{font-size:1.2rem;padding:10px 20px;}
    .editar-btn{background:linear-gradient(blue,white);color:white;}
    .eliminar-btn{background:linear-gradient(brown,white);width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;}
    .modal-buttons{display:flex;gap:10px;margin-top:10px;}
    .no-cartones{grid-column:1/-1;font-family:'Bangers',cursive;font-size:1rem;text-align:center;}
    @keyframes pulse{0%{transform:scale(1);}50%{transform:scale(1.2);}100%{transform:scale(1);}}
    @keyframes wiggle{0%{transform:translateX(0);}33%{transform:translateX(5px);}66%{transform:translateX(-5px);}100%{transform:translateX(0);}}
    #player-container{position:relative;border:2px solid green;border-radius:10px;background:linear-gradient(135deg,#d3d3d3,#ffffff);padding:10px;margin:10px auto 0;width:100%;max-width:320px;box-sizing:border-box;transition:background 0.3s ease,border-color 0.3s ease;}
    #alias-row{display:flex;align-items:center;justify-content:center;gap:5px;}
    #alias-jugador{font-size:1.2rem;padding:5px;text-align:center;border-radius:5px;border:1px solid #ccc;width:220px;color:orange;}
    #editar-alias{background:none;border:none;color:#4B0082;font-size:1.5rem;cursor:pointer;border-radius:5px;text-shadow:0 0 4px #fff,0 0 8px #fff;}
    #guardar-carton-btn{background:none;border:none;font-size:1.4rem;cursor:pointer;margin-left:5px;display:none;}
    #nombre-carton{display:none;padding:5px;border-radius:5px;border:1px solid #ccc;}
    .guardar-row{justify-content:center;}
    #mis-cartones-icon{width:24px;height:24px;cursor:pointer;}
    #mis-cartones-btn-container{position:relative;display:inline-block;margin-left:5px;}
    #guardados-count{position:absolute;top:-8px;right:-8px;background:#006400;color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-family:'Bangers',cursive;z-index:10;}
    #carton-num{font-family:'Bangers',cursive;text-shadow:0 0 5px green;}
    #login-footer{margin-top:20px;}
    #fecha-hora,#derechos{font-size:0.7rem;text-align:center;color:#000;}
    #derechos{font-size:0.6rem;}
    .info-line{font-family:'Bangers',cursive;font-size:1.5rem;text-align:center;}
    .text-forma-gratis{font-family:'Bangers',cursive;font-weight:bold;color:purple;font-size:1.1rem;text-align:center;}
    #premios-titulo,#info-cartones-titulo,#back-premios-titulo{font-size:1.1rem;text-align:center;font-family:'Bangers',cursive;}
    #premios-modal .modal-content,#info-cartones-modal .modal-content{align-items:center;}
    #info-cartones-aceptar,#premios-aceptar{font-size:1.2rem;padding:8px 20px;}
    .text-premio-total{font-family:'Bangers',cursive;color:white;font-size:1.5rem;text-align:center;}
    .text-premio-total div{ text-shadow:0 0 4px darkgreen; }
    .valor-total{font-size:3rem;text-shadow:0 0 4px darkgreen;animation:pulse 1s infinite;}
    #premios-formas,#back-premios-formas{display:flex;flex-direction:column;gap:8px;width:100%;box-sizing:border-box;}
    #back-premios-formas{gap:4px;align-items:flex-start;}
    .premio-row{display:flex;align-items:center;gap:12px;justify-content:flex-start;font-family:'Bangers',cursive;font-weight:bold;margin-bottom:0;padding:8px 10px;border-radius:12px;background:rgba(255,255,255,0.85);box-shadow:0 2px 6px rgba(0,0,0,0.15);flex-wrap:wrap;}
    .premio-mini-box{display:flex;flex-direction:column;align-items:center;gap:4px;flex-shrink:0;}
    .premio-mini-box .forma-mini-etiqueta{font-size:0.75rem;background:linear-gradient(90deg,#4B0082,#00008b);color:#fff;padding:2px 6px;border-radius:6px;text-shadow:0 0 4px #000;font-family:'Bangers',cursive;}
    .premio-mini-box .mini-carton-wrapper{padding:2px;border-radius:10px;box-shadow:0 0 4px rgba(0,0,0,0.25);background:linear-gradient(#0a8800,#f5f5a5);}
    .forma-carton-wrapper{display:inline-flex;}
    .premio-mini-box .mini-carton{border-radius:8px;}
    .premio-mini-box .mini-carton th,.premio-mini-box .mini-carton td{border-width:1px;}
    .premio-info{display:flex;flex-direction:column;gap:4px;align-items:flex-start;font-family:'Poppins',sans-serif;font-weight:600;color:#333;min-width:140px;}
    .premio-info .premio-valor{font-size:1.1rem;font-family:'Bangers',cursive;text-shadow:0 0 6px #fff,0 0 10px #fff;}
    .premio-info .cartones-valor{font-size:1rem;font-family:'Bangers',cursive;text-shadow:0 0 6px #fff,0 0 10px #fff;}
    .premio-info .forma-nombre{font-family:'Poppins',sans-serif;font-weight:600;font-size:0.75rem;color:#4B0082;text-shadow:none;margin-top:2px;}
    .premio-row.solo-texto{flex-direction:column;align-items:flex-start;gap:4px;}
    .premio-row.solo-texto .premio-info{gap:2px;min-width:auto;}
    .premio-row.solo-texto .premio-info .forma-titulo{font-family:'Bangers',cursive;font-size:1rem;text-shadow:0 0 6px #fff,0 0 10px #fff;}
    .back-forma-line{font-family:'Bangers',cursive;font-size:1.05rem;display:flex;align-items:center;flex-wrap:wrap;gap:6px;width:100%;text-shadow:0 0 6px #fff,0 0 10px #fff;}
    .back-forma-line .back-forma-separador{flex:1 1 auto;border-bottom:1px dashed transparent;}
    .back-forma-line span{display:inline-block;text-shadow:inherit;}
    .back-forma-line .back-forma-valor,.back-forma-line .back-forma-cartones{font-size:1.2rem;}
    .back-forma-nombre{font-family:'Poppins',sans-serif;font-size:0.7rem;font-weight:600;text-shadow:0 0 4px #fff,0 0 8px #fff;align-self:flex-start;margin-top:-4px;margin-bottom:6px;}
    #back-premios-content{display:flex;flex-direction:column;align-items:center;position:relative;z-index:1;}
    @media (max-width:480px){#fecha-hora-sorteo .fecha-col{align-items:center;text-align:center;}}
  </style>
</head>
<body>
  <button id="volver-btn" class="menu-btn back-btn"><span class="tri">&#9664;</span><span class="label">Volver</span></button>
  <h1 id="titulo">JUGAR CART√ìN</h1>
  <section id="sorteo-section">
    <div class="sorteo-info">
      <button id="sorteo-btn">Selecciona Sorteo</button>
      <div id="fecha-hora-sorteo">
        <div class="fecha-col">
          <div id="fecha-sorteo" class="sorteo-line"></div>
          <div id="fecha-actual" class="actual-line"></div>
        </div>
        <div class="fecha-col">
          <div id="hora-sorteo" class="sorteo-line"></div>
          <div id="hora-actual" class="actual-line"></div>
        </div>
      </div>
    </div>
    <div class="datos-sorteo">
      <div id="premio-repartir"><span id="premio-label">Premio a Repartir:</span> <span id="premio-valor">0</span></div>
      <div id="stats-row">
        <div id="valor-carton"><span class="billete-icon">üíµ</span> Cart√≥n: <span id="valor-carton-valor">0</span></div>
        <div id="cartones-jugando"><img src="https://cdn-icons-png.flaticon.com/32/5065/5065890.png" class="carton-icon" alt="Cart√≥n"> Jugando: <span id="cartones-jugando-valor">0</span> <span id="gratis-plus">+</span> <span id="cartones-gratis-jugando">0</span></div>
      </div>
    </div>
  </section>
  <section id="alias-section">
    <div id="player-container">
      <div id="alias-row">
        <input type="text" id="alias-jugador" readonly placeholder="Alias">
        <button id="editar-alias" onclick="window.location.href='perfil.html'">&#9998;</button>
      </div>
        <div class="wallet-row"><strong><span class="credit-icon">$</span> Cr√©ditos:</strong> <span id="creditos-label">0</span></div>
        <div class="wallet-row"><strong><img src="https://cdn-icons-png.flaticon.com/32/5065/5065890.png" class="carton-icon" alt="Cart√≥n"> gratis:</strong> <span id="gratis-label">0</span></div>
        <button id="azar-btn" class="action-btn" title="Cargar jugadas al azar"><img src="https://api.iconify.design/mdi/dice-5.svg" class="carton-icon" alt="Azar"></button>
        <button id="limpiar-btn" class="action-btn" title="Limpiar cart√≥n"><img src="https://api.iconify.design/mdi/broom.svg" class="carton-icon" alt="Limpiar"></button>
      <div id="jugados-btn-container">
        <button id="ver-jugados-btn" class="action-btn" title="Cartones jugados"><img src="https://cdn-icons-png.flaticon.com/32/5065/5065890.png" class="carton-icon" alt="cart√≥n"></button>
        <span id="jugados-count" style="display:none;">0</span>
        <span id="jugados-gratis-count" style="display:none;">0</span>
      </div>
      <button id="ir-billetera-btn" class="action-btn" onclick="window.location.href='billetera.html'" title="Recargar Billetera">üëõ</button>
    </div>
    <div id="forma-nombre"></div>
    <div class="carton-box">
      <div class="carton-wrapper" id="carton-wrapper">
        <table class="carton">
          <thead>
            <tr><th>B</th><th>I</th><th>N</th><th>G</th><th>O</th></tr>
          </thead>
          <tbody id="bingo-board"></tbody>
        </table>
        <div class="carton-back">
          <div id="back-premios-content">
            <h2 id="back-premios-titulo"></h2>
            <div id="back-premios-total" class="text-premio-total"></div>
            <div id="back-premios-formas"></div>
          </div>
          <img src="https://i.imgur.com/twjhNtZ.png" alt="logo">
        </div>
      </div>
    </div>
    <div class="wallet-row guardar-row"><label><input type="checkbox" id="guardar-check"><span id="guardar-titulo"> Guardar cart√≥n</span></label><input type="text" id="nombre-carton" placeholder="Nombra el Cart√≥n"><button id="guardar-carton-btn" title="Guardar cart√≥n">üíæ</button><div id="mis-cartones-btn-container"><img id="mis-cartones-icon" class="carton-icon" src="https://cdn-icons-png.flaticon.com/32/5065/5065890.png" alt="Mis Cartones" title="Mis Cartones"><span id="guardados-count" style="display:none;">0</span></div></div>
    <button id="jugar-carton-btn" class="action-btn">JUGAR CART√ìN</button>
  </section>
  <div id="login-footer">
    <div id="fecha-hora"></div>
    <div id="derechos">Todos los derechos reservados ¬Æ Hexaservice 2025</div>
  </div>
  <div id="number-modal" class="modal" onclick="this.style.display='none'">
    <div id="number-modal-content" class="modal-content" onclick="event.stopPropagation();">
      <div id="number-modal-title">Elige tu jugada</div>
      <div id="number-grid"></div>
    </div>
  </div>
  <div id="cartones-modal" class="modal" onclick="this.style.display='none'">
      <div id="cartones-content" class="modal-content" onclick="event.stopPropagation();">
          <span id="cartones-close" class="close-icon">‚úñ</span>
          <h2 id="cartones-titulo">Mis Cartones</h2>
          <div id="cartones-grid"></div>
          <div id="cartones-buttons" class="modal-buttons">
            <button id="editar-guardado-btn" class="action-btn editar-btn">Editar</button>
            <button id="cargar-guardado-btn" class="action-btn">Cargar cart√≥n</button>
            <button id="borrar-guardado-btn" class="action-btn eliminar-btn" title="Borrar cart√≥n">üóëÔ∏è</button>
          </div>
      </div>
  </div>
  <div id="sorteos-modal" class="modal" onclick="this.style.display='none'">
      <div id="sorteos-list" class="modal-content" onclick="event.stopPropagation();"></div>
  </div>
  <div id="jugados-modal" class="modal" onclick="this.style.display='none'">
      <div id="jugados-content" class="modal-content" onclick="event.stopPropagation();">
          <span id="jugados-close" class="close-icon">‚úñ</span>
          <h2 id="jugados-nombre-sorteo"></h2>
          <div id="jugados-grid"></div>
          <div id="jugados-buttons" class="modal-buttons">
            <button id="editar-jugado-btn" class="action-btn editar-btn">Editar</button>
            <button id="cargar-jugado-btn" class="action-btn">Cargar cart√≥n</button>
          </div>
      </div>
  </div>
  <div id="info-cartones-modal" class="modal" onclick="this.style.display='none'">
      <div class="modal-content" onclick="event.stopPropagation();">
          <h2 id="info-cartones-titulo"></h2>
          <div id="info-cartones-jugando" class="info-line"></div>
          <div id="info-cartones-gratis" class="info-line"></div>
          <div class="modal-buttons">
            <button id="info-cartones-ver" class="action-btn">Ver Cartones</button>
            <button id="info-cartones-aceptar" class="action-btn">Aceptar</button>
          </div>
      </div>
  </div>
  <div id="premios-modal" class="modal" onclick="this.style.display='none'">
      <div class="modal-content" onclick="event.stopPropagation();">
          <h2 id="premios-titulo"></h2>
          <div id="premios-total" class="text-premio-total"></div>
          <div id="premios-formas"></div>
          <button id="premios-aceptar" class="action-btn">Aceptar</button>
      </div>
  </div>
  <div id="sellado-overlay" class="sellado-overlay" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="sellado-modal-card">
          <span class="sellado-modal-icono" aria-hidden="true">‚õî</span>
          <div id="sellado-aviso" class="sellado-aviso" role="alert" aria-live="assertive"></div>
          <button id="sellado-cerrar-btn" type="button" class="sellado-cerrar-btn">Aceptar</button>
      </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-auth-compat.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/timezone.js"></script>
  <script src="js/estadoSorteos.js"></script>
  <script>
  ensureAuth();
  initServerTime();
  iniciarControlSorteos();

  const ranges=[[1,15],[16,30],[31,45],[46,60],[61,75]];
const board=document.getElementById('bingo-board');
let currentCell=null;
let sorteoInterval=null;
let currentSorteo=null;
let currentSorteoNombre='';
let currentSorteoTipo='';
let currentSorteoEstado='';
let cartonesGuardados={};
let sorteosActivos=[];
let seleccionadoJugado=null;
let seleccionadoGuardado=null;
let consultando=false;
let cookieKey='';
let sorteoCookieKey='';
let fechaActualInterval=null;
let formasSorteo=[];
let formaActiva=0;
let premioActual=0;
let maxCartonesGratis=0;
let cartonesJugando=0;
let cartonesGratisJugando=0;
const formColors=['#90ee90','#fffacd','#add8e6','#d8b0ff','#ffcc99'];
const formGlows=['#006400','#b8860b','#00008b','#4b0082','#8b4513'];
let editandoTipo=null;
let editandoId=null;
const selladoOverlay=document.getElementById('sellado-overlay');
const selladoCerrarBtn=document.getElementById('sellado-cerrar-btn');

if(selladoCerrarBtn){
  selladoCerrarBtn.addEventListener('click',ocultarMensajeSellado);
}
if(selladoOverlay){
  selladoOverlay.addEventListener('click',event=>{
    if(event.target===selladoOverlay){
      ocultarMensajeSellado();
    }
  });
}

function setCookie(name,value){document.cookie=`${name}=${encodeURIComponent(value)};path=/;max-age=31536000`;}
function deleteCookie(name){document.cookie=`${name}=;path=/;max-age=0`;}
function getCookie(name){const m=document.cookie.match(new RegExp('(?:^|; )'+name+'=([^;]*)'));return m?decodeURIComponent(m[1]):null;}
function normalizarMeridiano(texto){return (texto||'').replace(/\s*a\.?\s*m\.?/ig,' AM').replace(/\s*p\.?\s*m\.?/ig,' PM');}
function actualizarFechaHoraActual(){
  const fechaActualEl=document.getElementById('fecha-actual');
  if(fechaActualEl){
    try{fechaActualEl.textContent=fechaServidor();}catch(e){fechaActualEl.textContent='';}
  }
  const horaActualEl=document.getElementById('hora-actual');
  if(horaActualEl){
    try{horaActualEl.textContent=normalizarMeridiano(horaServidor());}catch(e){horaActualEl.textContent='';}
  }
}
function iniciarActualizacionFechaActual(){
  actualizarFechaHoraActual();
  if(fechaActualInterval) clearInterval(fechaActualInterval);
  fechaActualInterval=setInterval(actualizarFechaHoraActual,1000);
}
function ocultarMensajeSellado(){
  const aviso=document.getElementById('sellado-aviso');
  if(aviso){
    aviso.innerHTML='';
    aviso.classList.remove('visible');
    aviso.setAttribute('aria-hidden','true');
  }
  if(selladoOverlay){
    selladoOverlay.classList.remove('visible');
    selladoOverlay.setAttribute('aria-hidden','true');
  }
  document.body.classList.remove('sellado-modal-activo');
}
function mostrarMensajeSellado(nombre){
  const aviso=document.getElementById('sellado-aviso');
  const destino=nombre&&nombre.trim()?nombre.trim():'este sorteo';
  const mensaje=`Ya NO se pueden jugar cartones en: ${destino} ya que est√° SELLADO, elije otro sorteo disponible.`;
  if(aviso){
    const destinoSeguro=destino
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
    aviso.innerHTML=`<p class="sellado-linea-principal">Ya <span class="sellado-enfasis">NO</span> se pueden jugar cartones en:</p><p class="sellado-destino"><strong>${destinoSeguro}</strong></p><p class="sellado-linea-secundaria">ya que est√° <span class="sellado-enfasis">SELLADO</span>, elije otro sorteo disponible.</p>`;
    aviso.classList.add('visible');
    aviso.setAttribute('aria-hidden','false');
  }
  if(selladoOverlay){
    selladoOverlay.classList.add('visible');
    selladoOverlay.setAttribute('aria-hidden','false');
  }
  document.body.classList.add('sellado-modal-activo');
  return mensaje;
}
function guardarSorteoSeleccionado(s){
  if(!sorteoCookieKey||!s) return;
  setCookie(sorteoCookieKey,JSON.stringify({id:s.id||'',tipo:s.tipo||''}));
}
async function restaurarSorteoSeleccionado(){
  if(!sorteoCookieKey) return false;
  const raw=getCookie(sorteoCookieKey);
  if(!raw) return false;
  try{
    const data=JSON.parse(raw);
    if(!data||!data.id) return false;
    let encontrado=sorteosActivos.find(s=>s.id===data.id);
    if(encontrado){
      await seleccionarSorteo(encontrado);
      return true;
    }
    const doc=await db.collection('sorteos').doc(data.id).get();
    if(doc.exists){
      const d=doc.data();
      encontrado={
        id:doc.id,
        nombre:d?.nombre||'Sorteo',
        fecha:d?.fecha||'',
        hora:d?.hora||'',
        horacierre:obtenerHoraCierre(d||{}),
        tipo:d?.tipo||'',
        estado:d?.estado||''
      };
      sorteosActivos.push(encontrado);
      await seleccionarSorteo(encontrado);
      return true;
    }
    deleteCookie(sorteoCookieKey);
  }catch(e){
    console.warn('No se pudo restaurar el sorteo seleccionado',e);
    deleteCookie(sorteoCookieKey);
  }
  return false;
}
function saveToCookie(){
  if(!cookieKey||consultando) return;
  const posiciones=[];
  document.querySelectorAll('#bingo-board td').forEach(td=>{
    if(td.classList.contains('free')) return;
    const val=td.dataset.value;
    if(val) posiciones.push({r:parseInt(td.dataset.row),c:parseInt(td.dataset.col),valor:val});
  });
  setCookie(cookieKey,JSON.stringify({posiciones}));
}
function loadFromCookie(){
  if(!cookieKey) return;
  const raw=getCookie(cookieKey);
  if(!raw) return;
  try{
    const data=JSON.parse(raw);
    if(data.posiciones) setBoardFromPosiciones(data.posiciones);
  }catch(e){}
}

async function cargarFormasSorteo(){
  formasSorteo=[];
  if(!currentSorteo) return;
  try{
    const snap=await db.collection('formas').where('sorteoId','==',currentSorteo).get();
    snap.forEach(doc=>formasSorteo.push(doc.data()));
  }catch(e){console.warn('No se pudieron cargar las formas');}
}

function resetForma(){
  formaActiva=0;
  document.querySelectorAll('.carton th').forEach((th,i)=>{
    th.innerHTML='BINGO'[i];
    th.style.background='radial-gradient(circle,#ffffff,#ffffff 60%,#00aa00)';
    th.style.textShadow='2px 2px 0 #000';
  });
  document.querySelectorAll('#bingo-board td').forEach(td=>{td.style.background='';});
  document.getElementById('premio-label').textContent='Premio a Repartir:';
  document.getElementById('premio-valor').style.textShadow='0 0 10px #004400';
  const pr=document.getElementById('premio-repartir');
  pr.style.textShadow='0 0 10px #004400';
  document.getElementById('forma-nombre').style.visibility='hidden';
  actualizarDatosSorteo();
}

function toggleForma(idx){
  if(!currentSorteo) return;
  if(formaActiva===idx){resetForma();return;}
  resetForma();
  const forma=formasSorteo.find(f=>f.idx===idx);
  if(!forma) return;
  formaActiva=idx;
  const th=document.querySelectorAll('.carton th')[idx-1];
  th.innerHTML=`<div class="forma-header">Forma<br>${idx}</div>`;
  th.style.background=`radial-gradient(circle,#ffffff,#ffffff 60%,${formGlows[idx-1]})`;
  th.style.textShadow='1px 1px 0 #000';
  forma.posiciones&&forma.posiciones.forEach(p=>{
    const td=document.querySelector(`#bingo-board td[data-row="${p.r}"][data-col="${p.c}"]`);
    if(td) td.style.background=formColors[idx-1];
  });
  const pr=document.getElementById('premio-repartir');
  const pv=document.getElementById('premio-valor');
  const pl=document.getElementById('premio-label');
  const nombre=document.getElementById('forma-nombre');
  const porcentaje=parseFloat(forma.porcentaje)||0;
  pl.textContent='PREMIO DE FORMA:';
  pr.style.textShadow=`0 0 10px ${formGlows[idx-1]}`;
  pv.style.textShadow=`0 0 10px ${formGlows[idx-1]}`;
  nombre.textContent=forma.nombre||'';
  nombre.style.textShadow=`0 0 5px ${formGlows[idx-1]}`;
  const wrapper=document.getElementById('carton-wrapper');
  nombre.style.visibility=wrapper.classList.contains('flipped')?'hidden':'visible';
  pv.textContent=Math.round(premioActual*porcentaje/100);
}

  function flipCard(){
    const wrapper=document.getElementById('carton-wrapper');
    const flipped=wrapper.classList.contains('flipped');
    const start=flipped?180:0;
    const end=flipped?0:180;
    wrapper.animate([
      {transform:`rotateY(${start}deg) scale(1)`},
      {transform:`rotateY(${(start+end)/2}deg) scale(1.1)`},
      {transform:`rotateY(${end}deg) scale(1)`}
    ],{duration:600,easing:'ease-in-out'}).onfinish=()=>{
      wrapper.style.transform=`rotateY(${end}deg)`;
      wrapper.classList.toggle('flipped');
      const nombre=document.getElementById('forma-nombre');
      const isFlipped=wrapper.classList.contains('flipped');
      if(isFlipped||formaActiva===0){
        nombre.style.visibility='hidden';
      }else{
        nombre.style.visibility='visible';
      }
    };
  }

  function createBoard(){
    for(let r=0;r<5;r++){
      const tr=document.createElement('tr');
      for(let c=0;c<5;c++){
        const td=document.createElement('td');
        td.dataset.row=r; td.dataset.col=c;
        if(r===2 && c===2){
          td.classList.add('free');
          const span=document.createElement('span');
          span.id='carton-num';
          span.textContent='0';
          td.appendChild(span);
          td.addEventListener('click',flipCard);
        }else{
          td.addEventListener('click',()=>openModal(td));
        }
        tr.appendChild(td);
      }
      board.appendChild(tr);
    }
    document.querySelector('.carton-back').addEventListener('click',flipCard);
  }

  function openModal(cell){
    currentCell=cell;
    const col=parseInt(cell.dataset.col);
    const [start,end]=ranges[col];
    const grid=document.getElementById('number-grid');
    grid.innerHTML='';
    for(let i=start;i<=end;i++){
      const div=document.createElement('div');
      div.textContent=i;
      div.addEventListener('click',()=>selectNumber(i));
      grid.appendChild(div);
    }
    document.getElementById('number-modal').style.display='flex';
  }

  function selectNumber(num){
    if(!currentCell) return;
    currentCell.textContent=num;
    currentCell.dataset.value=num;
    document.getElementById('number-modal').style.display='none';
    validateBoard();
    saveToCookie();
  }

    function validateBoard(checkEmpty=false){
      let cols=[[],[],[],[],[]];
      let ok=true;
      document.querySelectorAll('#bingo-board td').forEach(td=>{
        const col=parseInt(td.dataset.col);
        if(td.classList.contains('free')) return;
        const val=td.dataset.value||'';
        const duplicate=val!=='' && cols[col].includes(val);
        const empty=val==='';
        if(duplicate || (checkEmpty && empty)){
          td.classList.add('error');
          ok=false;
        }else{
          td.classList.remove('error');
          if(val!=='') cols[col].push(val);
        }
      });
      return ok;
    }

  function limpiarcarton(){
    document.querySelectorAll('#bingo-board td').forEach(td=>{
      if(td.classList.contains('free')) return;
      td.dataset.value='';
      td.textContent='';
      td.classList.remove('error');
    });
    const wrapper=document.getElementById('carton-wrapper');
    wrapper.classList.remove('flipped');
    wrapper.style.transform='';
    const numEl=document.getElementById('carton-num');
    numEl.style.animation='';
    consultando=false;
    seleccionadoJugado=null;
    resetForma();
    saveToCookie();
  }

  function setBoard(carton){
    document.querySelectorAll('#bingo-board td').forEach(td=>{
      if(td.classList.contains('free')) return;
      const r=parseInt(td.dataset.row);
      const c=parseInt(td.dataset.col);
      const val=carton[r][c]||'';
      td.dataset.value=val;
      td.textContent=val;
    });
    validateBoard();
  }

  function cargarAzar(){
    limpiarcarton();
    for(let c=0;c<5;c++){
      const [start,end]=ranges[c];
      const nums=[];
      for(let n=start;n<=end;n++) nums.push(n);
      for(let i=nums.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[nums[i],nums[j]]=[nums[j],nums[i]];}
      for(let r=0;r<5;r++){
        if(r===2&&c===2) continue;
        const td=document.querySelector(`#bingo-board td[data-row="${r}"][data-col="${c}"]`);
        const val=nums.pop();
        td.dataset.value=val;
        td.textContent=val;
      }
    }
    validateBoard();
    saveToCookie();
  }

  async function actualizarDatosSorteo(){
    if(!currentSorteo) return;
    const sorteoRef=db.collection('sorteos').doc(currentSorteo);
    const doc=await sorteoRef.get();
    if(!doc.exists) return;
    const data=doc.data();
  const valor=data.valorCarton||0;
  const jug=data.cartonesjugando||0;
  const gratisJug=data.cartonesgratisjugando||0;
  maxCartonesGratis=parseInt(data.maxcartongratis||0);
  const premio=data.totalPremios||0;
  premioActual=premio;
  cartonesJugando=jug;
  cartonesGratisJugando=gratisJug;
  document.getElementById('valor-carton-valor').textContent=valor;
  document.getElementById('cartones-jugando-valor').textContent=jug;
  document.getElementById('cartones-gratis-jugando').textContent=gratisJug;
  const gratisLabel=document.getElementById('gratis-label');
  if(gratisJug>=maxCartonesGratis && maxCartonesGratis>0 && parseInt(gratisLabel.textContent)>0){
    gratisLabel.style.color='red';
    gratisLabel.style.animation='none';
  }else{
    gratisLabel.style.color='';
    gratisLabel.style.animation='';
  }
  const pv=document.getElementById('premio-valor');
  if(formaActiva>0){
    const f=formasSorteo.find(x=>x.idx===formaActiva);
    const por=parseFloat(f&&f.porcentaje)||0;
    pv.textContent=Math.round(premioActual*por/100);
  }else{
    pv.textContent=Math.round(premioActual);
  }
  const numEl=document.getElementById('carton-num');
    if(numEl && !consultando){
      numEl.textContent=(jug+gratisJug+1).toString().padStart(4,'0');
    }
  renderPremios('back-premios');
  }

  async function actualizarCartonesJugador(){
    const elPag=document.getElementById('jugados-count');
    const elGratis=document.getElementById('jugados-gratis-count');
    const user=auth.currentUser;
    if(!user||!currentSorteo){
      if(elPag){elPag.textContent='0';elPag.style.display='none';}
      if(elGratis){elGratis.textContent='0';elGratis.style.display='none';}
      return;
    }
    const snap=await db.collection('CartonJugado').where('userId','==',user.uid).where('sorteoId','==',currentSorteo).get();
    let pagados=0,gratis=0;
    snap.forEach(doc=>{ const t=doc.data().tipocarton; if(t==='gratis') gratis++; else pagados++; });
    if(elPag){elPag.textContent=pagados;elPag.style.display=pagados>0?'flex':'none';}
    if(elGratis){elGratis.textContent=gratis;elGratis.style.display=gratis>0?'flex':'none';}
  }

  function iniciarIntervalo(){
    if(sorteoInterval) clearInterval(sorteoInterval);
    sorteoInterval=setInterval(actualizarDatosSorteo,10000);
    actualizarDatosSorteo();
  }

  function formatearFecha(f){ if(!f) return ''; const [y,m,d]=f.split('-'); return `${d}/${m}/${y}`; }
  function normalizarHoraValor(valor){
    if(valor===undefined || valor===null) return '';
    if(typeof valor==='object'){
      if(valor instanceof Date){
        return `${String(valor.getHours()).padStart(2,'0')}:${String(valor.getMinutes()).padStart(2,'0')}`;
      }
      if(typeof valor.seconds==='number'){
        const fecha=new Date(valor.seconds*1000);
        return `${String(fecha.getHours()).padStart(2,'0')}:${String(fecha.getMinutes()).padStart(2,'0')}`;
      }
      if(typeof valor.toDate==='function'){
        const fecha=valor.toDate();
        if(fecha instanceof Date && !Number.isNaN(fecha.getTime())){
          return `${String(fecha.getHours()).padStart(2,'0')}:${String(fecha.getMinutes()).padStart(2,'0')}`;
        }
      }
    }
    if(typeof valor==='string'){
      const texto=valor.trim();
      if(!texto) return '';
      const match=texto.match(/(\d{1,2})[:.](\d{2})/);
      if(!match) return '';
      let horas=parseInt(match[1],10);
      const minutos=parseInt(match[2],10);
      if(Number.isNaN(horas)||Number.isNaN(minutos)) return '';
      const lower=texto.toLowerCase();
      if(lower.includes('pm') && horas<12) horas+=12;
      if(lower.includes('am') && horas===12) horas=0;
      return `${String(horas).padStart(2,'0')}:${String(minutos).padStart(2,'0')}`;
    }
    if(typeof valor==='number' && Number.isFinite(valor)){
      const horas=Math.floor(valor/100);
      const minutos=valor%100;
      if(horas>=0 && horas<24 && minutos>=0 && minutos<60){
        return `${String(horas).padStart(2,'0')}:${String(minutos).padStart(2,'0')}`;
      }
    }
    return '';
  }
  function formatearHora(h){
    const normalizado=normalizarHoraValor(h);
    if(!normalizado) return '';
    const [hh,mm]=normalizado.split(':');
    let n=parseInt(hh,10);
    if(Number.isNaN(n)) return '';
    const ampm=n>=12?'PM':'AM';
    n=n%12||12;
    return `${String(n).padStart(2,'0')}:${mm} ${ampm}`;
  }
  function obtenerHoraCierre(d){
    if(!d) return '';
    const claves=['horacierre','horaCierre','hora_cierre','cierre','cierreHora','cierrehora'];
    for(const clave of claves){
      const hora=normalizarHoraValor(d[clave]);
      if(hora) return hora;
    }
    const cierreMin=parseInt(d?.cierreMinutos,10);
    if(!Number.isNaN(cierreMin) && cierreMin>0){
      const fecha=d?.fecha;
      const horaInicio=normalizarHoraValor(d?.hora);
      if(fecha && horaInicio){
        const partesFecha=fecha.split('-').map(n=>parseInt(n,10));
        if(partesFecha.length===3 && partesFecha.every(n=>!Number.isNaN(n))){
          const [anio,mes,dia]=partesFecha;
          const [hInicio,mInicio]=horaInicio.split(':').map(n=>parseInt(n,10));
          if(![anio,mes,dia,hInicio,mInicio].some(n=>Number.isNaN(n))){
            const sorteoDate=new Date(anio,mes-1,dia,hInicio,mInicio,0,0);
            if(!Number.isNaN(sorteoDate.getTime())){
              const cierreDate=new Date(sorteoDate.getTime()-cierreMin*60000);
              const hh=String(cierreDate.getHours()).padStart(2,'0');
              const mm=String(cierreDate.getMinutes()).padStart(2,'0');
              return `${hh}:${mm}`;
            }
          }
        }
      }
    }
    return '';
  }

  async function seleccionarSorteo(s){
    resetForma();
    currentSorteo=s.id;
    currentSorteoNombre=s.nombre;
    currentSorteoTipo=s.tipo;
    currentSorteoEstado=s.estado||'';
    ocultarMensajeSellado();
    const btn=document.getElementById('sorteo-btn');
    btn.textContent=s.nombre;
    btn.classList.remove('diario','especial');
    if(s.tipo==='Sorteo Diario'){ btn.classList.add('diario'); }
    else if(s.tipo==='Sorteo Especial'){ btn.classList.add('especial'); }
    btn.style.fontSize = s.nombre.length>20?'0.8rem':'1.1rem';
    document.getElementById('fecha-sorteo').innerHTML=`<span class="cal-icon">üìÖ</span> ${formatearFecha(s.fecha)}`;
    const horaTexto=formatearHora(s.hora);
    document.getElementById('hora-sorteo').innerHTML=horaTexto?`<span class="clock-icon">‚è∞</span> ${horaTexto}`:'';
    actualizarFechaHoraActual();
    const jugarBtn=document.getElementById('jugar-carton-btn');
    if(s.estado==='Sellado' || s.estado==='Jugando') jugarBtn.disabled=true; else jugarBtn.disabled=false;
    if(s.estado==='Sellado'){
      const mensaje=mostrarMensajeSellado(s.nombre||'este sorteo');
      alert(mensaje);
    }
    actualizarFondoCarton();
    guardarSorteoSeleccionado(s);
    await cargarFormasSorteo();
    await actualizarDatosSorteo();
    iniciarIntervalo();
    actualizarCartonesJugador();
  }

  function abrirSorteosModal(){
    const list=document.getElementById('sorteos-list');
    list.innerHTML='';
    sorteosActivos.forEach((s,i)=>{
      const div=document.createElement('div');
      div.className = s.estado==='Sellado' ? 'sorteo-sellado'
                    : s.estado==='Jugando' ? 'sorteo-jugando'
                    : (s.tipo==='Sorteo Diario' ? 'sorteo-diario' : 'sorteo-especial');
      const indexSpan=document.createElement('span');
      indexSpan.className='sorteo-index';
      indexSpan.textContent=`${i+1}-`;
      div.appendChild(indexSpan);
      const nombreSpan=document.createElement('span');
      nombreSpan.textContent=s.nombre;
      div.appendChild(nombreSpan);
      const detalle=document.createElement('div');
      detalle.className='sorteo-detalle';
      const horaCierreTexto=formatearHora(s.horacierre);
      const cierreHtml=horaCierreTexto?`<span class=\"clock-icon\">‚è∞</span><span class=\"hora-cierre\">${horaCierreTexto}</span>`:'';
      const horaInicioTexto=formatearHora(s.hora);
      const inicioHtml=horaInicioTexto?`<span class=\"clock-icon\">‚è∞</span><span>${horaInicioTexto}</span>`:'';
      detalle.innerHTML=`<span class=\"cal-icon\">üìÖ</span><span>${formatearFecha(s.fecha)}</span>${cierreHtml}${inicioHtml}`;
      div.appendChild(detalle);
      div.addEventListener('click',()=>{
        if(s.estado==='Jugando') window.location.href='juegoactivo.html';
        else { seleccionarSorteo(s); document.getElementById('sorteos-modal').style.display='none'; }
      });
      list.appendChild(div);
    });
    document.getElementById('sorteos-modal').style.display='flex';
  }

  async function cargarSorteosActivos(){
    sorteosActivos=[];
    await actualizarEstadosSorteos();
    try{
      const snap=await db.collection('sorteos').where('estado','in',['Activo','Sellado','Jugando']).get();
      snap.forEach(doc=>{
        const d=doc.data();
        sorteosActivos.push({id:doc.id,nombre:d.nombre,fecha:d.fecha,hora:d.hora,horacierre:obtenerHoraCierre(d),tipo:d.tipo,estado:d.estado});
      });
    }catch(e){ console.warn('No se pudieron cargar sorteos'); }
  }

  async function enviarDatos(){
    const alias=document.getElementById('alias-jugador').value.trim();
    const user=auth.currentUser;
    if(alias===''||!user){ alert('Por favor, ingresa tu Alias.'); return; }
    if(!validateBoard(true)){ alert('Debes llenar las celdas vac√≠as del crat√≥n primero'); return; }
    if(!currentSorteo){ alert('Debes selecionar primero un sorteo'); abrirSorteosModal(); return; }
    if(consultando){
      alert('Este cart√≥n ya est√° jugando y no se puede jugar nuevamente.');
      limpiarcarton();
      return;
    }

    const billeteraRef=db.collection('Billetera').doc(user.email);
    const billeteraDoc=await billeteraRef.get();
    let creditos=billeteraDoc.data().creditos||0;
    let gratis=billeteraDoc.data().CartonesGratis||0;

    const sorteoRef=db.collection('sorteos').doc(currentSorteo);
    const sorteoDoc=await sorteoRef.get();
    const sorteoData=sorteoDoc.data();
    currentSorteoEstado=sorteoData?.estado||currentSorteoEstado;
    if(currentSorteoEstado==='Sellado'){
      const mensaje=mostrarMensajeSellado(currentSorteoNombre||sorteoData?.nombre||'este sorteo');
      alert(mensaje);
      return;
    }

    const posiciones=[];
    document.querySelectorAll('#bingo-board td').forEach(td=>{
      const r=parseInt(td.dataset.row);
      const c=parseInt(td.dataset.col);
      if(!(r===2&&c===2)) posiciones.push({r,c,valor:td.dataset.value||''});
    });
    const firmaActual=generarFirmaPosiciones(posiciones);

    const jugadosJugador=await db.collection('CartonJugado')
      .where('sorteoId','==',currentSorteo)
      .where('userId','==',user.uid)
      .get();
    let cartonDuplicado=false;
    jugadosJugador.forEach(doc=>{
      const firmaDoc=generarFirmaPosiciones(doc.data()?.posiciones||[]);
      if(firmaDoc===firmaActual) cartonDuplicado=true;
    });
    if(cartonDuplicado){
      alert(`No se puede jugar este cart√≥n, ya que en este sorteo ${currentSorteoNombre} estas jugando uno id√©ntico`);
      return;
    }

    const ncarton=document.getElementById('carton-num').textContent.toString();
    const dup=await db.collection('CartonJugado').where('sorteoId','==',currentSorteo).where('Ncarton','==',ncarton).get();
    if(!dup.empty){
      alert('Este n√∫mero de cart√≥n ya fue jugado en este sorteo.');
      return;
    }

    const valor=Number(sorteoData.valorCarton||0);
    const jugActual=sorteoData.cartonesjugando||0;
    const gratisJugando=sorteoData.cartonesgratisjugando||0;
    const maxGratis=sorteoData.maxcartongratis||0;
    const cartonNum=jugActual+gratisJugando+1;
    const vars=await db.collection('Variablesglobales').doc('Parametros').get();
    const porcentaje=Number(vars.data().porcentaje||0);
    const porcentajesu=Number(vars.data().porcentajesu||0);
    let jugarGratis=false;
    let nuevoCreditos=creditos;
    let nuevoGratis=gratis;
    let porcentajeVal=0, porcentajeSuVal=0, paraPremio=0;
    if(gratis>0){
      if(gratisJugando < maxGratis){
        jugarGratis=true;
        nuevoGratis=gratis-1;
        const gl=document.getElementById('gratis-label');
        gl.style.color='';
        gl.style.animation='';
      }else{
        const gl=document.getElementById('gratis-label');
        gl.style.color='red';
        gl.style.animation='none';
        if(creditos>=valor){
          nuevoCreditos=creditos-valor;
          porcentajeVal=valor*porcentaje/100;
          porcentajeSuVal=valor*porcentajesu/100;
          paraPremio=valor-porcentajeVal-porcentajeSuVal;
        }else{
          alert('No tienes cr√©ditos suficientes.');
          return;
        }
      }
    }else if(creditos>=valor){
      nuevoCreditos=creditos-valor;
      porcentajeVal=valor*porcentaje/100;
      porcentajeSuVal=valor*porcentajesu/100;
      paraPremio=valor-porcentajeVal-porcentajeSuVal;
    }else{
      alert('No tienes cr√©ditos suficientes.');
      return;
    }
    if(jugarGratis){
      await billeteraRef.update({CartonesGratis:nuevoGratis});
      document.getElementById('gratis-label').textContent=nuevoGratis;
      await sorteoRef.update({
        cartonesgratisjugando: firebase.firestore.FieldValue.increment(1)
      });
    }else{
      await billeteraRef.update({creditos:nuevoCreditos});
      document.getElementById('creditos-label').textContent=nuevoCreditos;
      await sorteoRef.update({
        cartonesjugando: firebase.firestore.FieldValue.increment(1),
        totalPremios: firebase.firestore.FieldValue.increment(paraPremio),
        totalporcentaje: firebase.firestore.FieldValue.increment(porcentajeVal),
        totalporcentajesu: firebase.firestore.FieldValue.increment(porcentajeSuVal)
      });
    }
    await initServerTime();
    await db.collection('CartonJugado').add({
      userId:user.uid,
      alias:alias,
      sorteoId:currentSorteo,
      cartonNum:cartonNum,
      Ncarton:ncarton,
      tipocarton:jugarGratis?'gratis':'pagado',
      posiciones:posiciones,
      fecha:fechaServidor(),
      hora:horaServidor()
    });
    await actualizarDatosSorteo();
    await actualizarCartonesJugador();
    alert('Jugada de Cart√≥n enviada correctamente.');
    limpiarcarton();
  }

  async function confirmarCompra(){
    const user=auth.currentUser;
    if(!user){
      alert('Por favor, inicia sesi√≥n.');
      return;
    }
    if(!validateBoard(true)){
      alert('Debes llenar las celdas vac√≠as del crat√≥n primero');
      return;
    }
    if(!currentSorteo){
      alert('Debes selecionar primero un sorteo');
      abrirSorteosModal();
      return;
    }
    const billeteraDoc=await db.collection('Billetera').doc(user.email).get();
    const creditos=billeteraDoc.data().creditos||0;
    const gratis=billeteraDoc.data().CartonesGratis||0;
    const sorteoDoc=await db.collection('sorteos').doc(currentSorteo).get();
    const sorteoData=sorteoDoc.data();
    currentSorteoEstado=sorteoData?.estado||currentSorteoEstado;
    if(currentSorteoEstado==='Sellado'){
      const mensaje=mostrarMensajeSellado(currentSorteoNombre||sorteoData?.nombre||'este sorteo');
      alert(mensaje);
      return;
    }
    const valor=Number(sorteoData.valorCarton||0);
    const gratisJugando=sorteoData.cartonesgratisjugando||0;
    const maxGratis=sorteoData.maxcartongratis||0;
    let mensaje='';
    let continuar=false;
    if(gratis>0 && gratisJugando<maxGratis){
      mensaje=`¬øEstas seguro de jugar el cart√≥n?\nEstar√°s usando uno de tus cartones gratis disponible`;
      continuar=true;
    }else if(gratis>0 && gratisJugando>=maxGratis){
      if(creditos>=valor){
        mensaje=`¬øEstas seguro de jugar el cart√≥n?\nTienes cartones gratis, pero ya se llego al m√°ximo permitido para este sorteo. se descontaran de tus creditos: ${valor} por el valor del cart√≥n`;
        continuar=true;
      }else{
        mensaje=`No tienes cr√©ditos ni cartones gratis disponibles\nEntra en tu billetera para solicitar dep√≥sitos que hayas realizado desde tu banco. El valor para el cart√≥n de este sorteo es: ${valor}`;
      }
    }else if(gratis<=0){
      if(creditos>=valor){
        mensaje=`¬øEstas seguro de jugar el cart√≥n?\nNo tienes cartones gratis, se descontaran de tus cr√©ditos: ${valor} por el valor del cart√≥n`;
        continuar=true;
      }else{
        mensaje=`No tienes cr√©ditos ni cartones gratis disponibles\nEntra en tu billetera para solicitar dep√≥sitos que hayas realizado desde tu banco. El valor para el cart√≥n de este sorteo es: ${valor}`;
      }
    }
    if(continuar){
      if(await confirm(mensaje)){
        await enviarDatos();
      }
    }else{
      alert(mensaje);
    }
  }

  async function guardarCarton(){
    const check=document.getElementById('guardar-check');
    const nombre=document.getElementById('nombre-carton').value.trim();
    if(!check.checked || nombre===''){
      alert('Debes colocar un nombre para guardar tu cart√≥n');
      return;
    }
      if(!validateBoard(true)){alert('Corrige los errores antes de guardar.');return;}
    if(consultando){alert('Este cart√≥n ya est√° jugando y no se puede jugar nuevamente.');limpiarcarton();return;}
    const user=auth.currentUser;
    const alias=document.getElementById('alias-jugador').value.trim();
    const posiciones=[];
    document.querySelectorAll('#bingo-board td').forEach(td=>{
      const r=parseInt(td.dataset.row);const c=parseInt(td.dataset.col);
      if(!(r===2&&c===2)) posiciones.push({r,c,valor:td.dataset.value||''});
    });
    await db.collection('CartonGuardado').add({userId:user.uid,alias,nombre,posiciones});
    await cargarCartonesGuardados();
    alert('Cart√≥n guardado');
    const checkEl=document.getElementById('guardar-check');
    checkEl.checked=false;
    document.getElementById('nombre-carton').value='';
    checkEl.dispatchEvent(new Event('change'));
  }

  async function cargarCartonesGuardados(){
    const user=auth.currentUser;
    if(!user) return;
    cartonesGuardados={};
    const snap=await db.collection('CartonGuardado').where('userId','==',user.uid).get();
    snap.forEach(doc=>{cartonesGuardados[doc.id]=doc.data();});
    const gc=document.getElementById('guardados-count');
    gc.textContent=snap.size;
    gc.style.display=snap.size>0?'flex':'none';
  }

  function abrirCartonesModal(){
    const grid=document.getElementById('cartones-grid');
    grid.innerHTML='';
    seleccionadoGuardado=null;
    const btnCargar=document.getElementById('cargar-guardado-btn');
    const btnEditar=document.getElementById('editar-guardado-btn');
    const btnBorrar=document.getElementById('borrar-guardado-btn');
    const botones=document.getElementById('cartones-buttons');
    const entries=Object.entries(cartonesGuardados);
    if(entries.length===0){
      grid.innerHTML='<div class="no-cartones">No has guardado ning√∫n cart√≥n en tu men√∫</div>';
      botones.style.display='none';
      document.getElementById('cartones-modal').style.display='flex';
      return;
    }
    botones.style.display='flex';
    btnCargar.disabled=true;
    btnEditar.disabled=true;
    btnBorrar.disabled=true;
    entries.forEach(([id,data],index)=>{
      const box=document.createElement('div');
      box.className='mini-carton-box';
      box.addEventListener('click',()=>{
        document.querySelectorAll('#cartones-grid .mini-carton-box').forEach(b=>b.classList.remove('selected'));
        box.classList.add('selected');
        seleccionadoGuardado={id, posiciones:data.posiciones, nombre:data.nombre||''};
        btnCargar.disabled=false;
        btnEditar.disabled=false;
        btnBorrar.disabled=false;
      });
      const idx=document.createElement('div');
      idx.className='mini-index';
      idx.textContent=`N¬∞ ${index+1}`;
      box.appendChild(idx);
      const wrap=document.createElement('div');
      wrap.className='mini-carton-wrapper';
      wrap.appendChild(crearMiniCarton(data.posiciones));
      box.appendChild(wrap);
      const nombre=document.createElement('div');
      nombre.className='mini-num';
      nombre.textContent=data.nombre||'Cart√≥n';
      box.appendChild(nombre);
      grid.appendChild(box);
    });
    document.getElementById('cartones-modal').style.display='flex';
  }

  async function cargarCartonGuardado(){
    if(!seleccionadoGuardado) return;
    if(await confirm('¬øDesea cargar el cart√≥n seleccionado? Se sobreescribir√°n las jugadas actuales.')){
      desactivarModoEdicion();
      setBoardFromPosiciones(seleccionadoGuardado.posiciones);
      document.getElementById('cartones-modal').style.display='none';
      saveToCookie();
    }
  }

  function actualizarFondoCarton(){
    const back=document.querySelector('.carton-back');
    const player=document.getElementById('player-container');
    let color='#808080';
    const baseGradient='linear-gradient(135deg,#d3d3d3,#ffffff)';
    let borde='#0b8a2a';
    if(currentSorteoTipo==='Sorteo Diario'){
      color='#0a8800';
    }else if(currentSorteoTipo==='Sorteo Especial'){
      color='#ff8800';
      borde='#ff8800';
    }else{
      borde='#0b8a2a';
    }
    if(back) back.style.background=`linear-gradient(white,${color})`;
    if(player){
      player.style.background=baseGradient;
      player.style.borderColor=borde;
    }
  }

  function renderPremios(prefijo){
    const titulo=document.getElementById(`${prefijo}-titulo`);
    if(titulo){
      titulo.innerHTML=`<span style="color:blue;">PREMIOS A REPARTIR EN SORTEO:</span><br><span id="${prefijo}-nombre-sorteo">${currentSorteoNombre}</span>`;
      const nombre=document.getElementById(`${prefijo}-nombre-sorteo`);
      if(nombre) nombre.style.color=currentSorteoTipo==='Sorteo Diario'?'green':'orange';
    }
    const totalDiv=document.getElementById(`${prefijo}-total`);
    if(totalDiv){
      totalDiv.innerHTML=`<div>CREDITOS TOTALES A REPARTIR:</div><div class="valor-total">${Math.round(premioActual)}</div>`;
    }
    const cont=document.getElementById(`${prefijo}-formas`);
    if(cont){
      cont.innerHTML='';
      if(formasSorteo.length===0){
        const vacio=document.createElement('div');
        vacio.className='no-cartones';
        vacio.textContent='No hay formas registradas para este sorteo.';
        cont.appendChild(vacio);
        return;
      }
      formasSorteo
        .slice()
        .sort((a,b)=>a.idx-b.idx)
        .forEach(f=>{
          const premioForma=Math.round(premioActual*parseFloat(f.porcentaje||0)/100);
          const color=formGlows[(f.idx-1)%formGlows.length]||'#0a8800';
          const cartonesAsignados=f.cartones ?? f.cartonesGratis ?? 0;
          const esBack=prefijo==='back-premios';

          if(esBack){
            const linea=document.createElement('div');
            linea.className='back-forma-line';
            linea.style.color=color;
            linea.style.textShadow='0 0 6px #fff, 0 0 12px #fff';
            linea.innerHTML=`<span class="back-forma-etiqueta">PREMIO FORMA ${String(f.idx).padStart(2,'0')}: </span>`+
              `<span class="back-forma-valor">${premioForma}</span>`+
              `<span class="back-forma-separador"></span>`+
              `<span class="back-forma-cartones-label">CARTONES:</span>`+
              `<span class="back-forma-cartones">${cartonesAsignados}</span>`;
            cont.appendChild(linea);
            if(f.nombre){
              const nombreLinea=document.createElement('div');
              nombreLinea.className='back-forma-nombre';
              nombreLinea.style.color=color;
              nombreLinea.style.textShadow='0 0 4px #fff, 0 0 8px #fff';
              nombreLinea.textContent=f.nombre;
              cont.appendChild(nombreLinea);
            }
            return;
          }

          const fila=document.createElement('div');
          fila.className='premio-row';
          const miniBox=document.createElement('div');
          miniBox.className='premio-mini-box';
          const etiqueta=document.createElement('div');
          etiqueta.className='forma-mini-etiqueta';
          etiqueta.textContent=`Forma ${String(f.idx).padStart(2,'0')}`;
          miniBox.appendChild(etiqueta);
          const miniWrapper=document.createElement('div');
          miniWrapper.className='mini-carton-wrapper';
          miniWrapper.classList.add('forma-carton-wrapper');
          miniWrapper.style.background=`linear-gradient(${color},#ffffff)`;
          const posiciones=Array.isArray(f.posiciones)?f.posiciones:[];
          miniWrapper.appendChild(crearMiniCarton(posiciones));
          miniBox.appendChild(miniWrapper);
          fila.appendChild(miniBox);

          const info=document.createElement('div');
          info.className='premio-info';
          const premioLinea=document.createElement('div');
          premioLinea.style.color=color;
          premioLinea.innerHTML=`Premio: <span class=\"premio-valor\">${premioForma}</span>`;
          info.appendChild(premioLinea);
          const cartLinea=document.createElement('div');
          cartLinea.style.color=color;
          cartLinea.innerHTML=`Cartones: <span class=\"cartones-valor\">${cartonesAsignados}</span>`;
          info.appendChild(cartLinea);
          if(f.nombre){
            const nombreDiv=document.createElement('div');
            nombreDiv.className='forma-nombre';
            nombreDiv.textContent=f.nombre;
            info.appendChild(nombreDiv);
          }
          fila.appendChild(info);
          cont.appendChild(fila);
        });
    }
  }

  function mostrarCartonesJugandoModal(){
    if(!currentSorteo){
      alert('Debes selecionar primero un sorteo');
      abrirSorteosModal();
      return;
    }
    const titulo=document.getElementById('info-cartones-titulo');
    titulo.innerHTML=`<span style="color:purple;">CARTONES JUGANDO SORTEO:</span><br><span id="info-cartones-nombre">${currentSorteoNombre}</span>`;
    const infoNombre=document.getElementById('info-cartones-nombre');
    infoNombre.style.color=currentSorteoTipo==='Sorteo Diario'?'green':'orange';
    const cj=document.getElementById('info-cartones-jugando');
    cj.innerHTML=`Cartones jugando: <strong style="color:purple;">${cartonesJugando}</strong>`;
    const cg=document.getElementById('info-cartones-gratis');
    cg.innerHTML=`Cartones Gratis jugando: <strong style="color:#00008b;">${cartonesGratisJugando}</strong>`;
    const verBtn=document.getElementById('info-cartones-ver');
    const s=sorteosActivos.find(x=>x.id===currentSorteo);
    if(s && (s.estado==='Sellado' || s.estado==='Jugando')) verBtn.style.display='inline-block'; else verBtn.style.display='none';
    document.getElementById('info-cartones-modal').style.display='flex';
  }

  function mostrarPremiosModal(){
    if(!currentSorteo){
      alert('Debes selecionar primero un sorteo');
      abrirSorteosModal();
      return;
    }
    renderPremios('premios');
    renderPremios('back-premios');
    document.getElementById('premios-modal').style.display='flex';
  }

  async function verCartonesJugadas(){
    const s=sorteosActivos.find(x=>x.id===currentSorteo);
    if(!s) return;
    const url=`sorteosellado.html?s=${currentSorteo}&n=${encodeURIComponent(s.nombre)}&t=${encodeURIComponent(s.tipo)}&f=${encodeURIComponent(s.fecha)}&h=${encodeURIComponent(s.hora)}`;
    window.open(url,'_blank');
    document.getElementById('info-cartones-modal').style.display='none';
  }

  async function abrirJugadosModal(){
    if(!currentSorteo){ alert('Selecciona un sorteo primero'); return; }
    const user=auth.currentUser;
    if(!user) return;
    await actualizarCartonesJugador();
    const grid=document.getElementById('jugados-grid');
    grid.innerHTML='';
    seleccionadoJugado=null;
    const titulo=document.getElementById('jugados-nombre-sorteo');
    const s=sorteosActivos.find(x=>x.id===currentSorteo);
    if(titulo&&s){
      titulo.textContent=s.nombre;
      titulo.className=s.tipo==='Sorteo Diario'?'sorteo-diario':'sorteo-especial';
    }
    const btnCargar=document.getElementById('cargar-jugado-btn');
    const btnEditar=document.getElementById('editar-jugado-btn');
    const botones=document.getElementById('jugados-buttons');
    const snap=await db.collection('CartonJugado').where('userId','==',user.uid).where('sorteoId','==',currentSorteo).get();
    const docs=[];
    snap.forEach(d=>docs.push({id:d.id,...d.data()}));
    const parseNumero=valor=>{
      if(valor===undefined||valor===null) return Number.MAX_SAFE_INTEGER;
      const num=parseInt(valor,10);
      return Number.isNaN(num)?Number.MAX_SAFE_INTEGER:num;
    };
    const ordenados=docs
      .slice()
      .sort((a,b)=>{
        const na=parseNumero(a.cartonNum??a.Ncarton);
        const nb=parseNumero(b.cartonNum??b.Ncarton);
        if(na!==nb) return na-nb;
        if(a.tipocarton===b.tipocarton) return 0;
        return a.tipocarton==='gratis'?-1:1;
      });
    if(ordenados.length===0){
      grid.innerHTML='<div class="no-cartones">No has jugado ning√∫n cart√≥n en este sorteo</div>';
      botones.style.display='none';
      document.getElementById('jugados-modal').style.display='flex';
      return;
    }
    botones.style.display='flex';
    btnCargar.disabled=true;
    btnEditar.disabled=true;
    let idx=0;
    ordenados.forEach(data=>{
      const box=document.createElement('div');
      box.className='mini-carton-box';
      box.addEventListener('click',()=>{
        document.querySelectorAll('#jugados-grid .mini-carton-box').forEach(b=>b.classList.remove('selected'));
        box.classList.add('selected');
        seleccionadoJugado={id:data.id,posiciones:data.posiciones,cartonNum:data.cartonNum,tipocarton:data.tipocarton};
        btnCargar.disabled=false;
        btnEditar.disabled=false;
      });
      const num=document.createElement('div');
      num.className='mini-index';
      const ordenVisual=String(++idx).padStart(2,'0');
      num.textContent=`#${ordenVisual} ${data.tipocarton==='gratis'?'Gratis':'Pagado'}`;
      box.appendChild(num);
      const wrap=document.createElement('div');
      wrap.className='mini-carton-wrapper';
      if(data.tipocarton==='gratis') wrap.classList.add('gratis');
      wrap.appendChild(crearMiniCarton(data.posiciones));
      box.appendChild(wrap);
      const bnum=document.createElement('div');
      const cn=data.cartonNum!==undefined?data.cartonNum.toString().padStart(4,'0'):'----';
      bnum.className='mini-num';
      bnum.textContent=`Cart√≥n: ${cn}`;
      box.appendChild(bnum);
      grid.appendChild(box);
    });
    document.getElementById('jugados-modal').style.display='flex';
  }

  async function editarCartonGuardado(){
    if(!seleccionadoGuardado) return;
    if(await confirm('¬øDeseas editar este cart√≥n?')){
      setBoardFromPosiciones(seleccionadoGuardado.posiciones);
      const check=document.getElementById('guardar-check');
      check.checked=true;
      check.dispatchEvent(new Event('change'));
      document.getElementById('nombre-carton').value=seleccionadoGuardado.nombre||'';
      document.getElementById('cartones-modal').style.display='none';
      editandoTipo='guardado';
      editandoId=seleccionadoGuardado.id;
      activarModoEdicion();
    }
  }

  async function eliminarCartonGuardado(){
    if(!seleccionadoGuardado) return;
    if(await confirm('¬øEstas seguro de borrar este cart√≥n? esta acci√≥n no se puede deshacer')){
      await db.collection('CartonGuardado').doc(seleccionadoGuardado.id).delete();
      await cargarCartonesGuardados();
      abrirCartonesModal();
    }
  }

  async function editarCartonJugado(){
    if(!seleccionadoJugado) return;
    const user=auth.currentUser;
    if(!user||!currentSorteo) return;
    const sorteoRef=db.collection('sorteos').doc(currentSorteo);
    const sorteoDoc=await sorteoRef.get();
    if(!sorteoDoc.exists) return;
    const estado=sorteoDoc.data().estado||'';
    if(estado!=='Activo'){
      alert(`No puedes editar este cart√≥n ya que el sorteo est√° ${estado}`);
      return;
    }
    setBoardFromPosiciones(seleccionadoJugado.posiciones);
    const numEl=document.getElementById('carton-num');
    if(seleccionadoJugado.cartonNum!==undefined){
      numEl.textContent=seleccionadoJugado.cartonNum.toString().padStart(4,'0');
    }
    numEl.style.animation='none';
    consultando=true;
    document.getElementById('jugados-modal').style.display='none';
    editandoTipo='jugado';
    editandoId=seleccionadoJugado.id;
    activarModoEdicion();
  }

  function activarModoEdicion(){
    const btn=document.getElementById('jugar-carton-btn');
    btn.textContent='EDITAR CART√ìN';
    btn.style.background='linear-gradient(blue,white)';
    document.getElementById('guardar-carton-btn').disabled=true;
    document.getElementById('guardar-check').disabled=true;
  }

  function desactivarModoEdicion(){
    const btn=document.getElementById('jugar-carton-btn');
    btn.textContent='JUGAR CART√ìN';
    btn.style.background='linear-gradient(#0a8800,#ffffff)';
    const check=document.getElementById('guardar-check');
    document.getElementById('guardar-carton-btn').disabled=false;
    check.disabled=false;
    if(editandoTipo==='guardado'){
      check.checked=false;
      check.dispatchEvent(new Event('change'));
    }
    editandoTipo=null;
    editandoId=null;
  }

  async function confirmarEdicion(){
    if(!validateBoard(true)){
      alert('Debes llenar las celdas vac√≠as del cart√≥n primero');
      return;
    }
    const posiciones=[];
    document.querySelectorAll('#bingo-board td').forEach(td=>{
      const r=parseInt(td.dataset.row);
      const c=parseInt(td.dataset.col);
      if(!(r===2&&c===2)) posiciones.push({r,c,valor:td.dataset.value||''});
    });
    if(editandoTipo==='guardado'){
      const nombre=document.getElementById('nombre-carton').value.trim();
      await db.collection('CartonGuardado').doc(editandoId).update({posiciones, nombre});
      await cargarCartonesGuardados();
      alert('Cart√≥n guardado editado correctamente.');
    }else if(editandoTipo==='jugado'){
      const sorteoDoc=await db.collection('sorteos').doc(currentSorteo).get();
      const estado=sorteoDoc.data().estado||'';
      if(estado!=='Activo'){
        alert(`No puedes editar este cart√≥n ya que el sorteo est√° ${estado}`);
        return;
      }
      await db.collection('CartonJugado').doc(editandoId).update({posiciones});
      await actualizarCartonesJugador();
      alert('Cart√≥n jugado editado correctamente.');
    }
    desactivarModoEdicion();
    limpiarcarton();
  }

  function crearMiniCarton(posiciones){
    const lista=Array.isArray(posiciones)?posiciones:[];
    const table=document.createElement('table');
    table.className='mini-carton';
    const head=document.createElement('thead');
    const trh=document.createElement('tr');
    ['B','I','N','G','O'].forEach(l=>{const th=document.createElement('th');th.textContent=l;trh.appendChild(th);});
    head.appendChild(trh);table.appendChild(head);
    const tbody=document.createElement('tbody');
    for(let r=0;r<5;r++){
      const tr=document.createElement('tr');
      for(let c=0;c<5;c++){
        const td=document.createElement('td');
        if(r===2&&c===2){td.innerHTML='<span style="color:orange;">‚òÖ</span>';}else{
          const found=lista.find(p=>p.r===r&&p.c===c);
          if(found) td.textContent=found.valor;
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    return table;
  }

  async function cargarCartonJugado(){
    if(!seleccionadoJugado) return;
    if(await confirm('¬øDesea cargar el cart√≥n seleccionado? Se sobreescribir√°n los datos actuales.')){
      desactivarModoEdicion();
      setBoardFromPosiciones(seleccionadoJugado.posiciones);
      const numEl=document.getElementById('carton-num');
      if(seleccionadoJugado.cartonNum!==undefined){
        numEl.textContent=seleccionadoJugado.cartonNum.toString().padStart(4,'0');
      }
      numEl.style.animation='none';
      consultando=true;
      document.getElementById('jugados-modal').style.display='none';
    }
  }

  function setBoardFromPosiciones(pos){
    const carton=[[],[],[],[],[]];
    pos.forEach(p=>{carton[p.r][p.c]=p.valor;});
    setBoard(carton);
  }

  function generarFirmaPosiciones(posiciones){
    if(!Array.isArray(posiciones)) return '';
    return posiciones
      .map(p=>({r:Number(p?.r),c:Number(p?.c),valor:p?.valor??''}))
      .sort((a,b)=>a.r-b.r||a.c-b.c)
      .map(p=>`${p.r}-${p.c}-${p.valor}`)
      .join('|');
  }

  document.getElementById('sorteo-btn').addEventListener('click',abrirSorteosModal);
document.getElementById('jugar-carton-btn').addEventListener('click',()=>{
  if(editandoTipo){
    confirmarEdicion();
  }else{
    confirmarCompra();
  }
});
document.getElementById('gratis-label').addEventListener('click',()=>{
  const gl=document.getElementById('gratis-label');
  if(gl.style.color==='red'){
    const jug=document.getElementById('cartones-gratis-jugando').textContent;
    alert(`Para este sorteo s√≥lo se pueden jugar un m√°ximo de: ${maxCartonesGratis} carton(es) gratis y has jugado ${jug}`);
  }
});
  document.getElementById('guardar-carton-btn').addEventListener('click',guardarCarton);
  document.getElementById('mis-cartones-icon').addEventListener('click',abrirCartonesModal);
  document.getElementById('ver-jugados-btn').addEventListener('click',abrirJugadosModal);
  document.getElementById('cargar-jugado-btn').addEventListener('click',cargarCartonJugado);
  document.getElementById('editar-jugado-btn').addEventListener('click',editarCartonJugado);
  document.getElementById('jugados-close').addEventListener('click',()=>{document.getElementById('jugados-modal').style.display='none';});
  document.getElementById('cargar-guardado-btn').addEventListener('click',cargarCartonGuardado);
  document.getElementById('editar-guardado-btn').addEventListener('click',editarCartonGuardado);
  document.getElementById('borrar-guardado-btn').addEventListener('click',eliminarCartonGuardado);
  document.getElementById('cartones-close').addEventListener('click',()=>{document.getElementById('cartones-modal').style.display='none';});
  document.getElementById('cartones-jugando-valor').addEventListener('click',mostrarCartonesJugandoModal);
  document.getElementById('cartones-gratis-jugando').addEventListener('click',mostrarCartonesJugandoModal);
  document.getElementById('premio-valor').addEventListener('click',mostrarPremiosModal);
  document.getElementById('info-cartones-aceptar').addEventListener('click',()=>{document.getElementById('info-cartones-modal').style.display='none';});
  document.getElementById('info-cartones-ver').addEventListener('click',verCartonesJugadas);
  document.getElementById('premios-aceptar').addEventListener('click',()=>{document.getElementById('premios-modal').style.display='none';});
  document.getElementById('limpiar-btn').addEventListener('click',async()=>{if(await confirm('¬øDeseas limpiar todas las jugadas del carton?')) limpiarcarton();});
  document.getElementById('azar-btn').addEventListener('click',async()=>{if(await confirm('¬øQuieres cargar jugadas al azar?')) cargarAzar();});
  document.getElementById('volver-btn').addEventListener('click',()=>{window.location.href='player.html';});
  document.getElementById('guardar-check').addEventListener('change',e=>{
    const show=e.target.checked;
    document.getElementById('nombre-carton').style.display=show?'inline-block':'none';
    document.getElementById('guardar-carton-btn').style.display=show?'inline-block':'none';
    document.getElementById('guardar-titulo').style.display=show?'none':'inline';
    if(!show) document.getElementById('nombre-carton').value='';
  });

  initFechaHora('fecha-hora');
  iniciarActualizacionFechaActual();

  auth.onAuthStateChanged(async user=>{
    if(user){
      const doc=await db.collection('users').doc(user.email).get();
      if(doc.exists){
        document.getElementById('alias-jugador').value=doc.data().alias||user.displayName||user.email;
      }
      const billeteraRef=db.collection('Billetera').doc(user.email);
      const billeteraDoc=await billeteraRef.get();
      if(billeteraDoc.exists){
        document.getElementById('creditos-label').textContent=billeteraDoc.data().creditos||0;
        document.getElementById('gratis-label').textContent=billeteraDoc.data().CartonesGratis||0;
      }else{
        await billeteraRef.set({creditos:0,CartonesGratis:0});
        document.getElementById('creditos-label').textContent='0';
        document.getElementById('gratis-label').textContent='0';
      }
      cookieKey='jugarcarton_'+user.email.replace(/[^\w]/g,'_');
      sorteoCookieKey=`${cookieKey}_sorteo`;
      loadFromCookie();
    }else{
      cookieKey='';
      sorteoCookieKey='';
      window.location.href='index.html';
      return;
    }
    await cargarSorteosActivos();
    const restaurado=await restaurarSorteoSeleccionado();
    if(!restaurado){
      actualizarFondoCarton();
    }
    await cargarCartonesGuardados();
  });

  createBoard();
  document.querySelectorAll('.carton th').forEach((th,i)=>{
    th.addEventListener('click',()=>toggleForma(i+1));
  });
  </script>
</body>
</html>

