<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jugar Cart√≥n</title>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(rgba(255,255,255,0.7), rgba(255,255,255,0.7)),
                  url('https://img.freepik.com/vetores-premium/padrao-sem-costura-com-simbolos-de-dolar-e-porcentagem_637741-777.jpg');
      background-repeat: repeat;
      background-size: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      text-align: center;
      padding-top: 5px;
    }
    h1#titulo{
      font-family:'Bangers',cursive;
      color:white;
      text-shadow:0 0 10px darkorange;
      margin:5px 0 10px 0;
      font-size:2rem;
    }
    .menu-btn{
      width:250px;
      height:60px;
      font-family:'Bangers',cursive;
      font-size:1.4rem;
      background:rgba(0,170,255,0.8);
      color:white;
      border:4px solid #FFD700;
      border-radius:10px;
      text-shadow:2px 2px 4px #000;
      text-transform:uppercase;
      cursor:pointer;
      transition:transform 0.3s,box-shadow 0.3s,background 0.3s;
    }
    .menu-btn:hover{ transform:scale(1.05); box-shadow:0 0 15px rgba(255,215,0,0.8); }
    .menu-btn:active{ transform:scale(0.95); box-shadow:0 0 5px rgba(255,215,0,0.8); }
    .back-btn{
      position:fixed;
      top:5px;
      left:5px;
      width:120px;
      height:40px;
      background:orange;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:5px;
      font-size:1.2rem;
    }
    @media (orientation:portrait){
      #volver-btn{width:40px;}
      #volver-btn .label{display:none;}
    }
    #sorteo-btn{
      width:240px;
      font-size:1.1rem;
      padding:5px 10px;
      text-align:center;
      border:2px solid gray;
      border-radius:5px;
      background:linear-gradient(#dddddd,#ffffff);
      cursor:pointer;
      white-space:nowrap;
      overflow:hidden;
    }
    #sorteo-btn.diario{background:linear-gradient(#00aa00,#ffffff);}
    #sorteo-btn.especial{background:linear-gradient(#ff8800,#ffffff);}
    .sorteo-diario{color:green;}
    .sorteo-especial{color:orange;}
    .sorteo-info{display:flex;align-items:center;justify-content:center;gap:10px;}
    .datos-sorteo{display:flex;flex-direction:column;align-items:center;gap:10px;justify-content:center;margin-top:5px;flex-wrap:wrap;font-family:'Bangers',cursive;}
    .datos-sorteo div{font-weight:bold;font-size:1.2rem;}
    #valor-carton span,#cartones-jugando span{font-size:1.5rem;}
    #valor-carton-valor,#premio-valor{animation:pulse 1s infinite;display:inline-block;}
    #cartones-jugando-valor,#carton-num{animation:float 1s infinite;display:inline-block;}
    #valor-carton{color:green;display:flex;align-items:center;gap:5px;}
    #cartones-jugando{color:purple;display:flex;align-items:center;gap:5px;}
    #stats-row{display:flex;justify-content:center;align-items:center;gap:20px;}
    .billete-icon{font-size:1.5rem;}
    .carton-icon{width:24px;height:24px;}
    #premio-repartir{color:white;font-family:'Bangers',cursive;font-size:1.8rem;text-shadow:0 0 10px #004400;position:relative;}
    #forma-nombre{position:absolute;top:100%;left:50%;transform:translateX(-50%);font-size:0.8rem;display:none;text-shadow:0 0 5px #004400;}
    .wallet-row{display:flex;align-items:center;gap:5px;margin:3px 0;font-size:1rem;font-weight:bold;}
    #creditos-label,#gratis-label{font-family:'Bangers',cursive;font-size:1.5rem;text-shadow:0 0 5px green;display:inline-block;animation:pulse 1s infinite;}
    #gratis-label{color:#4b0082;text-shadow:0 0 5px #fff;}
    #creditos-label{color:#333;text-shadow:0 0 5px green;}
    .credit-icon{color:white;font-weight:bold;text-shadow:0 0 5px lime;}
    .action-btn{
      font-family:'Bangers',cursive;
      background:linear-gradient(#0a8800,#ffffff);
      color:white;
      border:3px solid #FFD700;
      border-radius:8px;
      text-shadow:2px 2px 4px #000;
      cursor:pointer;
    }
    #jugados-btn-container{position:absolute;bottom:5px;right:50px;}
    #ver-jugados-btn{width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:linear-gradient(purple,#ffffff);border:3px solid #FFD700;border-radius:8px;cursor:pointer;position:relative;}
    #jugados-count{position:absolute;top:-8px;right:-8px;background:purple;color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-family:'Bangers',cursive;z-index:10;}
    #limpiar-btn{width:40px;height:40px;display:flex;align-items:center;justify-content:center;position:absolute;bottom:5px;right:95px;background:linear-gradient(gray,#ffffff);border:3px solid #FFD700;border-radius:8px;cursor:pointer;}
    #azar-btn{width:40px;height:40px;display:flex;align-items:center;justify-content:center;position:absolute;bottom:5px;right:140px;background:linear-gradient(#ffffff,#dddddd);border:3px solid #FFD700;border-radius:8px;cursor:pointer;}
    #ir-billetera-btn{width:40px;height:40px;font-size:1.2rem;display:flex;align-items:center;justify-content:center;position:absolute;bottom:5px;right:5px;margin-left:0;}
    #jugar-carton-btn{width:200px;height:40px;font-size:1.2rem;display:flex;align-items:center;justify-content:center;margin:10px auto;}
    .carton-box{display:flex;justify-content:center;margin:8px auto;perspective:1000px;}
    .carton-wrapper{position:relative;transform-style:preserve-3d;transition:transform 0.6s;border-radius:16px;padding:6px;background:linear-gradient(green,yellow);box-shadow:0 0 15px rgba(0,0,0,0.5);}
    .carton-wrapper.flipped{transform:rotateY(180deg);}
    .carton-wrapper.flipped .carton{pointer-events:none;}
    .carton-wrapper.flipped .carton-back{pointer-events:auto;}
    .carton{margin:0;border-collapse:separate;border-spacing:0;background:linear-gradient(#ffffff,#cccccc);border-radius:10px;table-layout:fixed;backface-visibility:hidden;}
    .carton th,.carton td{background:transparent;border:2px solid gray;width:60px;height:60px;aspect-ratio:1/1;text-align:center;font-weight:bold;padding:0 3px;margin:0;box-sizing:border-box;}
    .carton th{font-size:2.5rem;color:#ff6600;background:radial-gradient(circle,#ffffff,#ffffff 60%,#00aa00);text-shadow:2px 2px 0 #000;}
    .forma-header{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;font-family:'Bangers',cursive;font-size:0.8rem;line-height:1;text-shadow:1px 1px 0 #000;}
    .carton td{cursor:pointer;font-size:1.8rem;text-shadow:0 0 3px green;}
    .carton td.free{background:radial-gradient(circle,#ffffff,#ffff00);display:flex;align-items:center;justify-content:center;font-size:1.2rem;color:#4B0082;}
    .carton td.error{border:2px solid red;}
    .carton-back{position:absolute;top:0;left:0;right:0;bottom:0;border-radius:10px;backface-visibility:hidden;transform:rotateY(180deg);background:linear-gradient(gray,white);display:flex;align-items:center;justify-content:center;}
    .carton-back img{width:80%;height:80%;opacity:0.3;object-fit:contain;}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;z-index:1000;}
    .modal-content{background:#fff;padding:10px;border-radius:10px;display:flex;flex-direction:column;align-items:flex-start;gap:5px;width:max-content;}
    #cartones-list div,#sorteos-list div{display:block;font-weight:bold;font-size:1rem;color:#000;cursor:pointer;font-family:'Poppins',sans-serif;white-space:nowrap;}
    #number-modal-title{font-size:0.8rem;text-align:center;width:100%;text-shadow:0 0 5px blue;margin-bottom:5px;font-family:'Poppins',sans-serif;}
    #number-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;justify-items:center;}
    #number-grid div{width:60px;height:60px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;text-shadow:0 0 5px green;cursor:pointer;}
    #jugados-content{width:max-content;max-width:100%;margin:auto;max-height:80vh;align-items:center;position:relative;padding:5px;box-sizing:border-box;display:flex;flex-direction:column;}
    #jugados-grid{display:grid;grid-template-columns:repeat(2,auto);gap:8px;justify-items:center;overflow-y:auto;flex-grow:1;min-height:0;}
    #jugados-nombre-sorteo,#cargar-jugado-btn{flex-shrink:0;}
    .close-icon{position:absolute;top:5px;right:5px;cursor:pointer;font-size:1.2rem;}
    .mini-carton-box{display:flex;flex-direction:column;align-items:center;cursor:pointer;}
    .mini-carton-box.selected{outline:3px solid blue;}
    .mini-index,.mini-num{padding:1px 3px;background:rgba(255,255,255,0.8);border-radius:3px;font-weight:bold;font-size:0.7rem;margin:2px 0;text-align:center;}
    .mini-index{color:#000;}
    .mini-num{color:purple;}
    .mini-carton-wrapper{background:linear-gradient(green,yellow);padding:3px;border-radius:10px;box-shadow:0 0 5px rgba(0,0,0,0.5);}
    .mini-carton{border-collapse:separate;border-spacing:0;background:linear-gradient(#ffffff,#cccccc);border-radius:8px;}
    .mini-carton th,.mini-carton td{border:1px solid gray;width:20px;height:20px;text-align:center;font-weight:bold;font-size:0.6rem;aspect-ratio:1/1;}
    .mini-carton th{font-size:0.8rem;color:#ff6600;background:radial-gradient(circle,#ffffff,#ffffff 60%,#00aa00);text-shadow:1px 1px 0 #000;}
    @keyframes pulse{0%{transform:scale(1);}50%{transform:scale(1.2);}100%{transform:scale(1);}}
    @keyframes float{0%{transform:translateY(0);}50%{transform:translateY(-5px);}100%{transform:translateY(0);}}
    #player-container{position:relative;border:2px solid green;border-radius:10px;background:linear-gradient(gray,white);padding:10px;margin-top:10px;}
    #alias-row{display:flex;align-items:center;justify-content:center;gap:5px;}
    #alias-jugador{font-size:1.2rem;padding:5px;text-align:center;border-radius:5px;border:1px solid #ccc;width:220px;color:orange;}
    #editar-alias{background:none;border:none;color:#4B0082;font-size:1.5rem;cursor:pointer;border-radius:5px;text-shadow:0 0 4px #fff,0 0 8px #fff;}
    #guardar-carton-btn{background:none;border:none;font-size:1.4rem;cursor:pointer;margin-left:5px;display:none;}
    #nombre-carton{display:none;padding:5px;border-radius:5px;border:1px solid #ccc;}
    .guardar-row{justify-content:center;}
    #mis-cartones-icon{width:24px;height:24px;cursor:pointer;margin-left:5px;}
    #carton-num{font-family:'Bangers',cursive;text-shadow:0 0 5px green;}
    #login-footer{margin-top:20px;}
    #fecha-hora,#derechos{font-size:0.7rem;text-align:center;color:#000;}
    #derechos{font-size:0.6rem;}
  </style>
</head>
<body>
  <button id="volver-btn" class="menu-btn back-btn"><span class="tri">&#9664;</span><span class="label">Volver</span></button>
  <h1 id="titulo">JUGAR CART√ìN</h1>
  <section id="sorteo-section">
    <div class="sorteo-info">
      <button id="sorteo-btn">Selecciona Sorteo</button>
      <div id="fecha-hora-sorteo">
        <div id="fecha-sorteo"></div>
        <div id="hora-sorteo"></div>
      </div>
    </div>
    <div class="datos-sorteo">
      <div id="premio-repartir"><span id="premio-label">Premio a Repartir:</span> <span id="premio-valor">0</span><div id="forma-nombre"></div></div>
      <div id="stats-row">
        <div id="valor-carton"><span class="billete-icon">üíµ</span> Cart√≥n: <span id="valor-carton-valor">0</span></div>
        <div id="cartones-jugando"><img src="https://cdn-icons-png.flaticon.com/32/5065/5065890.png" class="carton-icon" alt="Cart√≥n"> Jugando: <span id="cartones-jugando-valor">0</span></div>
      </div>
    </div>
  </section>
  <section id="alias-section">
    <div id="player-container">
      <div id="alias-row">
        <input type="text" id="alias-jugador" readonly placeholder="Alias">
        <button id="editar-alias" onclick="window.location.href='perfil.html'">&#9998;</button>
      </div>
        <div class="wallet-row"><strong><span class="credit-icon">$</span> Cr√©ditos:</strong> <span id="creditos-label">0</span></div>
        <div class="wallet-row"><strong><img src="https://cdn-icons-png.flaticon.com/32/5065/5065890.png" class="carton-icon" alt="Cart√≥n"> gratis:</strong> <span id="gratis-label">0</span></div>
        <button id="azar-btn" class="action-btn" title="Cargar jugadas al azar"><img src="https://api.iconify.design/mdi/dice-5.svg" class="carton-icon" alt="Azar"></button>
        <button id="limpiar-btn" class="action-btn" title="Limpiar cart√≥n"><img src="https://api.iconify.design/mdi/broom.svg" class="carton-icon" alt="Limpiar"></button>
      <div id="jugados-btn-container">
        <button id="ver-jugados-btn" class="action-btn" title="Cartones jugados"><img src="https://cdn-icons-png.flaticon.com/32/5065/5065890.png" class="carton-icon" alt="cart√≥n"></button>
        <span id="jugados-count">0</span>
      </div>
      <button id="ir-billetera-btn" class="action-btn" onclick="window.location.href='billetera.html'" title="Recargar Billetera">üëõ</button>
    </div>
    <div class="carton-box">
      <div class="carton-wrapper" id="carton-wrapper">
        <table class="carton">
          <thead>
            <tr><th>B</th><th>I</th><th>N</th><th>G</th><th>O</th></tr>
          </thead>
          <tbody id="bingo-board"></tbody>
        </table>
        <div class="carton-back"><img src="https://i.imgur.com/twjhNtZ.png" alt="logo"></div>
      </div>
    </div>
    <div class="wallet-row guardar-row"><label><input type="checkbox" id="guardar-check"><span id="guardar-titulo"> Guardar cart√≥n</span></label><input type="text" id="nombre-carton" placeholder="Nombra el Cart√≥n"><button id="guardar-carton-btn" title="Guardar cart√≥n">üíæ</button><img id="mis-cartones-icon" class="carton-icon" src="https://cdn-icons-png.flaticon.com/32/5065/5065890.png" alt="Mis Cartones" title="Mis Cartones"></div>
    <button id="jugar-carton-btn" class="action-btn">JUGAR CART√ìN</button>
  </section>
  <div id="login-footer">
    <div id="fecha-hora"></div>
    <div id="derechos">Todos los derechos reservados ¬Æ Hexaservice 2025</div>
  </div>
  <div id="number-modal" class="modal" onclick="this.style.display='none'">
    <div id="number-modal-content" class="modal-content" onclick="event.stopPropagation();">
      <div id="number-modal-title">Elige tu jugada</div>
      <div id="number-grid"></div>
    </div>
  </div>
  <div id="cartones-modal" class="modal" onclick="this.style.display='none'">
      <div id="cartones-list" class="modal-content" onclick="event.stopPropagation();"></div>
  </div>
  <div id="sorteos-modal" class="modal" onclick="this.style.display='none'">
      <div id="sorteos-list" class="modal-content" onclick="event.stopPropagation();"></div>
  </div>
  <div id="jugados-modal" class="modal" onclick="this.style.display='none'">
      <div id="jugados-content" class="modal-content" onclick="event.stopPropagation();">
          <span id="jugados-close" class="close-icon">‚úñ</span>
          <h2 id="jugados-nombre-sorteo"></h2>
          <div id="jugados-grid"></div>
          <button id="cargar-jugado-btn" class="action-btn" style="margin-top:10px;">Cargar cart√≥n</button>
      </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-auth-compat.js"></script>
  <script src="auth.js"></script>
  <script>
  ensureAuth();

  const ranges=[[1,15],[16,30],[31,45],[46,60],[61,75]];
const board=document.getElementById('bingo-board');
let currentCell=null;
let sorteoInterval=null;
let currentSorteo=null;
let cartonesGuardados={};
let sorteosActivos=[];
let seleccionadoJugado=null;
let consultando=false;
let cookieKey='';
let formasSorteo=[];
let formaActiva=0;
let premioActual=0;
const formColors=['#90ee90','#fffacd','#add8e6','#d8b0ff','#ffcc99'];
const formGlows=['#006400','#b8860b','#00008b','#4b0082','#8b4513'];

function setCookie(name,value){document.cookie=`${name}=${encodeURIComponent(value)};path=/;max-age=31536000`;}
function getCookie(name){const m=document.cookie.match(new RegExp('(?:^|; )'+name+'=([^;]*)'));return m?decodeURIComponent(m[1]):null;}
function saveToCookie(){
  if(!cookieKey||consultando) return;
  const posiciones=[];
  document.querySelectorAll('#bingo-board td').forEach(td=>{
    if(td.classList.contains('free')) return;
    const val=td.dataset.value;
    if(val) posiciones.push({r:parseInt(td.dataset.row),c:parseInt(td.dataset.col),valor:val});
  });
  setCookie(cookieKey,JSON.stringify({posiciones}));
}
function loadFromCookie(){
  if(!cookieKey) return;
  const raw=getCookie(cookieKey);
  if(!raw) return;
  try{
    const data=JSON.parse(raw);
    if(data.posiciones) setBoardFromPosiciones(data.posiciones);
  }catch(e){}
}

async function cargarFormasSorteo(){
  formasSorteo=[];
  if(!currentSorteo) return;
  try{
    const snap=await db.collection('formas').where('sorteoId','==',currentSorteo).get();
    snap.forEach(doc=>formasSorteo.push(doc.data()));
  }catch(e){console.warn('No se pudieron cargar las formas');}
}

function resetForma(){
  formaActiva=0;
  document.querySelectorAll('.carton th').forEach((th,i)=>{
    th.innerHTML='BINGO'[i];
    th.style.background='radial-gradient(circle,#ffffff,#ffffff 60%,#00aa00)';
    th.style.textShadow='2px 2px 0 #000';
  });
  document.querySelectorAll('#bingo-board td').forEach(td=>{td.style.background='';});
  document.getElementById('premio-label').textContent='Premio a Repartir:';
  document.getElementById('premio-valor').style.textShadow='0 0 10px #004400';
  const pr=document.getElementById('premio-repartir');
  pr.style.textShadow='0 0 10px #004400';
  document.getElementById('forma-nombre').style.display='none';
  actualizarDatosSorteo();
}

function toggleForma(idx){
  if(!currentSorteo) return;
  if(formaActiva===idx){resetForma();return;}
  resetForma();
  const forma=formasSorteo.find(f=>f.idx===idx);
  if(!forma) return;
  formaActiva=idx;
  const th=document.querySelectorAll('.carton th')[idx-1];
  th.innerHTML=`<div class="forma-header">Forma<br>${idx}</div>`;
  th.style.background=`radial-gradient(circle,#ffffff,#ffffff 60%,${formGlows[idx-1]})`;
  th.style.textShadow='1px 1px 0 #000';
  forma.posiciones&&forma.posiciones.forEach(p=>{
    const td=document.querySelector(`#bingo-board td[data-row="${p.r}"][data-col="${p.c}"]`);
    if(td) td.style.background=formColors[idx-1];
  });
  const pr=document.getElementById('premio-repartir');
  const pv=document.getElementById('premio-valor');
  const pl=document.getElementById('premio-label');
  const nombre=document.getElementById('forma-nombre');
  const porcentaje=parseFloat(forma.porcentaje)||0;
  pl.textContent='PREMIO DE FORMA';
  pr.style.textShadow=`0 0 10px ${formGlows[idx-1]}`;
  pv.style.textShadow=`0 0 10px ${formGlows[idx-1]}`;
  nombre.textContent=forma.nombre||'';
  nombre.style.display='block';
  nombre.style.textShadow=`0 0 5px ${formGlows[idx-1]}`;
  pv.textContent=Math.round(premioActual*porcentaje/100);
}

  function flipCard(){
    const wrapper=document.getElementById('carton-wrapper');
    const flipped=wrapper.classList.contains('flipped');
    const start=flipped?180:0;
    const end=flipped?0:180;
    wrapper.animate([
      {transform:`rotateY(${start}deg) scale(1)`},
      {transform:`rotateY(${(start+end)/2}deg) scale(1.1)`},
      {transform:`rotateY(${end}deg) scale(1)`}
    ],{duration:600,easing:'ease-in-out'}).onfinish=()=>{
      wrapper.style.transform=`rotateY(${end}deg)`;
      wrapper.classList.toggle('flipped');
    };
  }

  function createBoard(){
    for(let r=0;r<5;r++){
      const tr=document.createElement('tr');
      for(let c=0;c<5;c++){
        const td=document.createElement('td');
        td.dataset.row=r; td.dataset.col=c;
        if(r===2 && c===2){
          td.classList.add('free');
          const span=document.createElement('span');
          span.id='carton-num';
          span.textContent='0';
          td.appendChild(span);
          td.addEventListener('click',flipCard);
        }else{
          td.addEventListener('click',()=>openModal(td));
        }
        tr.appendChild(td);
      }
      board.appendChild(tr);
    }
    document.querySelector('.carton-back').addEventListener('click',flipCard);
  }

  function openModal(cell){
    currentCell=cell;
    const col=parseInt(cell.dataset.col);
    const [start,end]=ranges[col];
    const grid=document.getElementById('number-grid');
    grid.innerHTML='';
    for(let i=start;i<=end;i++){
      const div=document.createElement('div');
      div.textContent=i;
      div.addEventListener('click',()=>selectNumber(i));
      grid.appendChild(div);
    }
    document.getElementById('number-modal').style.display='flex';
  }

  function selectNumber(num){
    if(!currentCell) return;
    currentCell.textContent=num;
    currentCell.dataset.value=num;
    document.getElementById('number-modal').style.display='none';
    validateBoard();
    saveToCookie();
  }

    function validateBoard(checkEmpty=false){
      let cols=[[],[],[],[],[]];
      let ok=true;
      document.querySelectorAll('#bingo-board td').forEach(td=>{
        const col=parseInt(td.dataset.col);
        if(td.classList.contains('free')) return;
        const val=td.dataset.value||'';
        const duplicate=val!=='' && cols[col].includes(val);
        const empty=val==='';
        if(duplicate || (checkEmpty && empty)){
          td.classList.add('error');
          ok=false;
        }else{
          td.classList.remove('error');
          if(val!=='') cols[col].push(val);
        }
      });
      return ok;
    }

  function limpiarcarton(){
    document.querySelectorAll('#bingo-board td').forEach(td=>{
      if(td.classList.contains('free')) return;
      td.dataset.value='';
      td.textContent='';
      td.classList.remove('error');
    });
    const wrapper=document.getElementById('carton-wrapper');
    wrapper.classList.remove('flipped');
    wrapper.style.transform='';
    const numEl=document.getElementById('carton-num');
    numEl.style.animation='';
    consultando=false;
    seleccionadoJugado=null;
    resetForma();
    saveToCookie();
  }

  function setBoard(carton){
    document.querySelectorAll('#bingo-board td').forEach(td=>{
      if(td.classList.contains('free')) return;
      const r=parseInt(td.dataset.row);
      const c=parseInt(td.dataset.col);
      const val=carton[r][c]||'';
      td.dataset.value=val;
      td.textContent=val;
    });
    validateBoard();
  }

  function cargarAzar(){
    limpiarcarton();
    for(let c=0;c<5;c++){
      const [start,end]=ranges[c];
      const nums=[];
      for(let n=start;n<=end;n++) nums.push(n);
      for(let i=nums.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[nums[i],nums[j]]=[nums[j],nums[i]];}
      for(let r=0;r<5;r++){
        if(r===2&&c===2) continue;
        const td=document.querySelector(`#bingo-board td[data-row="${r}"][data-col="${c}"]`);
        const val=nums.pop();
        td.dataset.value=val;
        td.textContent=val;
      }
    }
    validateBoard();
    saveToCookie();
  }

  async function actualizarDatosSorteo(){
    if(!currentSorteo) return;
    const sorteoRef=db.collection('sorteos').doc(currentSorteo);
    const doc=await sorteoRef.get();
    if(!doc.exists) return;
    const data=doc.data();
  const valor=data.valorCarton||0;
  const jug=data.cartonesjugando||0;
  const premio=data.totalPremios||0;
  premioActual=premio;
  document.getElementById('valor-carton-valor').textContent=valor;
  document.getElementById('cartones-jugando-valor').textContent=jug;
  const pv=document.getElementById('premio-valor');
  if(formaActiva>0){
    const f=formasSorteo.find(x=>x.idx===formaActiva);
    const por=parseFloat(f&&f.porcentaje)||0;
    pv.textContent=Math.round(premioActual*por/100);
  }else{
    pv.textContent=Math.round(premioActual);
  }
  const numEl=document.getElementById('carton-num');
    if(numEl && !consultando){
      numEl.textContent=(jug+1).toString().padStart(4,'0');
    }
  }

  async function actualizarCartonesJugador(){
    const el=document.getElementById('jugados-count');
    const user=auth.currentUser;
    if(!el){return;}
    if(!user||!currentSorteo){el.textContent='0';return;}
    const snap=await db.collection('CartonJugado').where('userId','==',user.uid).where('sorteoId','==',currentSorteo).get();
    el.textContent=snap.size||0;
  }

  function iniciarIntervalo(){
    if(sorteoInterval) clearInterval(sorteoInterval);
    sorteoInterval=setInterval(actualizarDatosSorteo,10000);
    actualizarDatosSorteo();
  }

  function formatearFecha(f){ if(!f) return ''; const [y,m,d]=f.split('-'); return `${d}/${m}/${y}`; }
  function formatearHora(h){ if(!h) return ''; const [hh,mm]=h.split(':'); let n=parseInt(hh); const ampm=n>=12?'pm':'am'; n=n%12||12; return `${n}:${mm} ${ampm}`; }

  function seleccionarSorteo(s){
    resetForma();
    currentSorteo=s.id;
    const btn=document.getElementById('sorteo-btn');
    btn.textContent=s.nombre;
    btn.classList.remove('diario','especial');
    if(s.tipo==='Sorteo Diario'){ btn.classList.add('diario'); }
    else if(s.tipo==='Sorteo Especial'){ btn.classList.add('especial'); }
    btn.style.fontSize = s.nombre.length>20?'0.8rem':'1.1rem';
    document.getElementById('fecha-sorteo').innerHTML=`<span class="cal-icon">üìÖ</span> ${formatearFecha(s.fecha)}`;
    document.getElementById('hora-sorteo').innerHTML=`<span class="clock-icon">‚è∞</span> ${formatearHora(s.hora)}`;
    iniciarIntervalo();
    actualizarCartonesJugador();
    cargarFormasSorteo();
  }

  function abrirSorteosModal(){
    const list=document.getElementById('sorteos-list');
    list.innerHTML='';
    sorteosActivos.forEach((s,i)=>{
      const div=document.createElement('div');
      div.textContent=`${i+1}- ${s.nombre}`;
      div.className=s.tipo==='Sorteo Diario'?'sorteo-diario':'sorteo-especial';
      div.addEventListener('click',()=>{seleccionarSorteo(s);document.getElementById('sorteos-modal').style.display='none';});
      list.appendChild(div);
    });
    document.getElementById('sorteos-modal').style.display='flex';
  }

  async function cargarSorteosActivos(){
    sorteosActivos=[];
    try{
      const snap=await db.collection('sorteos').where('estado','==','Activo').get();
      snap.forEach(doc=>{
        const d=doc.data();
        sorteosActivos.push({id:doc.id,nombre:d.nombre,fecha:d.fecha,hora:d.hora,tipo:d.tipo});
      });
    }catch(e){ console.warn('No se pudieron cargar sorteos'); }
  }

  async function enviarDatos(){
    const alias=document.getElementById('alias-jugador').value.trim();
    const user=auth.currentUser;
    if(alias===''||!user){ alert('Por favor, ingresa tu Alias.'); return; }
      if(!validateBoard(true)){ alert('Corrige los errores antes de enviar.'); return; }
    if(!currentSorteo){ alert('Selecciona un sorteo.'); return; }
    if(consultando){
      alert('Este cart√≥n ya est√° jugando y no se puede jugar nuevamente.');
      limpiarcarton();
      return;
    }

    const billeteraRef=db.collection('Billetera').doc(user.email);
    const billeteraDoc=await billeteraRef.get();
    let creditos=billeteraDoc.data().creditos||0;
    let gratis=billeteraDoc.data().CartonesGratis||0;

  const sorteoRef=db.collection('sorteos').doc(currentSorteo);
  const sorteoDoc=await sorteoRef.get();
  const sorteoData=sorteoDoc.data();
  const valor=Number(sorteoData.valorCarton||0);
  const jugActual=sorteoData.cartonesjugando||0;
  const cartonNum=jugActual+1;
  const vars=await db.collection('Variablesglobales').doc('Parametros').get();
    const porcentaje=Number(vars.data().porcentaje||0);
    const porcentajesu=Number(vars.data().porcentajesu||0);
    let jugarGratis=false;
    if(gratis>0){
      gratis--;
      jugarGratis=true;
      await billeteraRef.update({CartonesGratis:gratis});
      document.getElementById('gratis-label').textContent=gratis;
    }else if(creditos>=valor){
      creditos-=valor;
      await billeteraRef.update({creditos});
      document.getElementById('creditos-label').textContent=creditos;
      const porcentajeVal=valor*porcentaje/100;
      const porcentajeSuVal=valor*porcentajesu/100;
      const paraPremio=valor-porcentajeVal-porcentajeSuVal;
      await sorteoRef.update({
        cartonesjugando: firebase.firestore.FieldValue.increment(1),
        totalPremios: firebase.firestore.FieldValue.increment(paraPremio),
        totalporcentaje: firebase.firestore.FieldValue.increment(porcentajeVal),
        totalporcentajesu: firebase.firestore.FieldValue.increment(porcentajeSuVal)
      });
    }else{
      alert('No tienes cr√©ditos suficientes.');
      return;
    }
    if(jugarGratis){
      await sorteoRef.update({
        cartonesjugando: firebase.firestore.FieldValue.increment(1)
      });
    }
    const posiciones=[];
    document.querySelectorAll('#bingo-board td').forEach(td=>{
      const r=parseInt(td.dataset.row);
      const c=parseInt(td.dataset.col);
      if(!(r===2&&c===2)) posiciones.push({r,c,valor:td.dataset.value||''});
    });
    const ncarton=document.getElementById('carton-num').textContent.toString();
    const dup=await db.collection('CartonJugado').where('sorteoId','==',currentSorteo).where('Ncarton','==',ncarton).get();
    if(!dup.empty){
      alert('Este n√∫mero de cart√≥n ya fue jugado en este sorteo.');
      return;
    }
    await db.collection('CartonJugado').add({
      userId:user.uid,
      alias:alias,
      sorteoId:currentSorteo,
      cartonNum:cartonNum,
      Ncarton:ncarton,
      posiciones:posiciones,
      fecha:new Date().toLocaleDateString('es-ES'),
      hora:new Date().toLocaleTimeString('es-ES')
    });
    await actualizarDatosSorteo();
    await actualizarCartonesJugador();
    alert('Jugada de Cart√≥n enviada correctamente.');
    limpiarcarton();
  }

  async function guardarCarton(){
    const check=document.getElementById('guardar-check');
    const nombre=document.getElementById('nombre-carton').value.trim();
    if(!check.checked || nombre===''){
      alert('Debes colocar un nombre para guardar tu cart√≥n');
      return;
    }
      if(!validateBoard(true)){alert('Corrige los errores antes de guardar.');return;}
    if(consultando){alert('Este cart√≥n ya est√° jugando y no se puede jugar nuevamente.');limpiarcarton();return;}
    const user=auth.currentUser;
    const alias=document.getElementById('alias-jugador').value.trim();
    const posiciones=[];
    document.querySelectorAll('#bingo-board td').forEach(td=>{
      const r=parseInt(td.dataset.row);const c=parseInt(td.dataset.col);
      if(!(r===2&&c===2)) posiciones.push({r,c,valor:td.dataset.value||''});
    });
    await db.collection('CartonGuardado').add({userId:user.uid,alias,nombre,posiciones});
    await cargarCartonesGuardados();
    alert('Cart√≥n guardado');
  }

  async function cargarCartonesGuardados(){
    const user=auth.currentUser;
    if(!user) return;
    cartonesGuardados={};
    const snap=await db.collection('CartonGuardado').where('userId','==',user.uid).get();
    snap.forEach(doc=>{cartonesGuardados[doc.id]=doc.data();});
  }

  function abrirCartonesModal(){
    const list=document.getElementById('cartones-list');
    list.innerHTML='';
    Object.entries(cartonesGuardados).forEach(([id,data],index)=>{
      const div=document.createElement('div');
      div.textContent=`${index+1}- ${data.nombre||'Cart√≥n'}`;
      div.addEventListener('click',()=>{setBoardFromPosiciones(data.posiciones);document.getElementById('cartones-modal').style.display='none';saveToCookie();});
      list.appendChild(div);
    });
    document.getElementById('cartones-modal').style.display='flex';
  }

  async function abrirJugadosModal(){
    if(!currentSorteo){ alert('Selecciona un sorteo primero'); return; }
    const user=auth.currentUser;
    if(!user) return;
    await actualizarCartonesJugador();
    const grid=document.getElementById('jugados-grid');
    grid.innerHTML='';
    seleccionadoJugado=null;
    const titulo=document.getElementById('jugados-nombre-sorteo');
    const s=sorteosActivos.find(x=>x.id===currentSorteo);
    if(titulo&&s){
      titulo.textContent=s.nombre;
      titulo.className=s.tipo==='Sorteo Diario'?'sorteo-diario':'sorteo-especial';
    }
    const snap=await db.collection('CartonJugado').where('userId','==',user.uid).where('sorteoId','==',currentSorteo).get();
    let idx=0;
    snap.forEach(doc=>{
      const data=doc.data();
      const box=document.createElement('div');
      box.className='mini-carton-box';
      box.addEventListener('click',()=>{
        document.querySelectorAll('.mini-carton-box').forEach(b=>b.classList.remove('selected'));
        box.classList.add('selected');
        seleccionadoJugado={posiciones:data.posiciones,cartonNum:data.cartonNum};
        document.getElementById('cargar-jugado-btn').disabled=false;
      });
      const num=document.createElement('div');
      num.className='mini-index';
      num.textContent=`N¬∞ ${++idx}`;
      box.appendChild(num);
      const wrap=document.createElement('div');
      wrap.className='mini-carton-wrapper';
      wrap.appendChild(crearMiniCarton(data.posiciones));
      box.appendChild(wrap);
      const bnum=document.createElement('div');
      const cn=data.cartonNum!==undefined?data.cartonNum.toString().padStart(4,'0'):'----';
      bnum.className='mini-num';
      bnum.textContent=`Cart√≥n: ${cn}`;
      box.appendChild(bnum);
      grid.appendChild(box);
    });
    document.getElementById('cargar-jugado-btn').disabled=true;
    document.getElementById('jugados-modal').style.display='flex';
  }

  function crearMiniCarton(posiciones){
    const table=document.createElement('table');
    table.className='mini-carton';
    const head=document.createElement('thead');
    const trh=document.createElement('tr');
    ['B','I','N','G','O'].forEach(l=>{const th=document.createElement('th');th.textContent=l;trh.appendChild(th);});
    head.appendChild(trh);table.appendChild(head);
    const tbody=document.createElement('tbody');
    for(let r=0;r<5;r++){
      const tr=document.createElement('tr');
      for(let c=0;c<5;c++){
        const td=document.createElement('td');
        if(r===2&&c===2){td.innerHTML='<span style="color:orange;">‚òÖ</span>';}else{
          const found=posiciones.find(p=>p.r===r&&p.c===c);
          if(found) td.textContent=found.valor;
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    return table;
  }

  function cargarCartonJugado(){
    if(!seleccionadoJugado) return;
    if(confirm('¬øDesea cargar el cart√≥n seleccionado? Se sobreescribir√°n los datos actuales.')){
      setBoardFromPosiciones(seleccionadoJugado.posiciones);
      const numEl=document.getElementById('carton-num');
      if(seleccionadoJugado.cartonNum!==undefined){
        numEl.textContent=seleccionadoJugado.cartonNum.toString().padStart(4,'0');
      }
      numEl.style.animation='none';
      consultando=true;
      document.getElementById('jugados-modal').style.display='none';
    }
  }

  function setBoardFromPosiciones(pos){
    const carton=[[],[],[],[],[]];
    pos.forEach(p=>{carton[p.r][p.c]=p.valor;});
    setBoard(carton);
  }

  function actualizarFechaHora(){
    const ahora=new Date();
    const opciones={year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'};
    document.getElementById('fecha-hora').textContent=ahora.toLocaleString('es-ES',opciones);
  }

  document.getElementById('sorteo-btn').addEventListener('click',abrirSorteosModal);
  document.getElementById('jugar-carton-btn').addEventListener('click',enviarDatos);
  document.getElementById('guardar-carton-btn').addEventListener('click',guardarCarton);
  document.getElementById('mis-cartones-icon').addEventListener('click',abrirCartonesModal);
  document.getElementById('ver-jugados-btn').addEventListener('click',abrirJugadosModal);
  document.getElementById('cargar-jugado-btn').addEventListener('click',cargarCartonJugado);
  document.getElementById('jugados-close').addEventListener('click',()=>{document.getElementById('jugados-modal').style.display='none';});
  document.getElementById('limpiar-btn').addEventListener('click',()=>{if(confirm('¬øDeseas limpiar todas las jugadas del carton?')) limpiarcarton();});
  document.getElementById('azar-btn').addEventListener('click',()=>{if(confirm('¬øQuieres cargar jugadas al azar?')) cargarAzar();});
  document.getElementById('volver-btn').addEventListener('click',()=>{window.location.href='player.html';});
  document.getElementById('guardar-check').addEventListener('change',e=>{
    const show=e.target.checked;
    document.getElementById('nombre-carton').style.display=show?'inline-block':'none';
    document.getElementById('guardar-carton-btn').style.display=show?'inline-block':'none';
    document.getElementById('guardar-titulo').style.display=show?'none':'inline';
    if(!show) document.getElementById('nombre-carton').value='';
  });

  auth.onAuthStateChanged(async user=>{
    if(user){
      const doc=await db.collection('users').doc(user.email).get();
      if(doc.exists){
        document.getElementById('alias-jugador').value=doc.data().alias||user.displayName||user.email;
      }
      const billeteraRef=db.collection('Billetera').doc(user.email);
      const billeteraDoc=await billeteraRef.get();
      if(billeteraDoc.exists){
        document.getElementById('creditos-label').textContent=billeteraDoc.data().creditos||0;
        document.getElementById('gratis-label').textContent=billeteraDoc.data().CartonesGratis||0;
      }else{
        await billeteraRef.set({creditos:0,CartonesGratis:0});
        document.getElementById('creditos-label').textContent='0';
        document.getElementById('gratis-label').textContent='0';
      }
      cookieKey='jugarcarton_'+user.email.replace(/[^\w]/g,'_');
      loadFromCookie();
    }else{
      window.location.href='index.html';
    }
    cargarSorteosActivos();
    await cargarCartonesGuardados();
  });

  createBoard();
  document.querySelectorAll('.carton th').forEach((th,i)=>{
    th.addEventListener('click',()=>toggleForma(i+1));
  });
  actualizarFechaHora();
  setInterval(actualizarFechaHora,60000);
  </script>
</body>
</html>

