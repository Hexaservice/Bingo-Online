<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Billetera</title>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(rgba(255,255,255,0.7), rgba(255,255,255,0.7)), url('https://img.freepik.com/vectores-premium/padrao-sem-costura-com-simbolos-de-dolar-e-porcentagem_637741-777.jpg');
      background-repeat: repeat;
      text-align: center;
      padding: 20px;
    }
    .menu-btn {
      width: 250px;
      height: 60px;
      font-family: 'Bangers', cursive;
      font-size: 1.4rem;
      background: rgba(0, 170, 255, 0.8);
      color: white;
      border: 4px solid #FFD700;
      border-radius: 10px;
      text-shadow: 2px 2px 4px #000;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
      margin: 5px;
    }
    .menu-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
    }

    .back-btn {
      position: fixed;
      top: 5px;
      left: 5px;
      width: 120px;
      height: 40px;
      background: orange;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:5px;
      z-index:1000;
    }
    #creditos-container{margin:10px auto;}
    #creditos-title,#creditos-valor{font-family:"Bangers",cursive;color:#fff;}
    #creditos-title{font-size:2rem;text-shadow:0 0 8px #ff8c00;animation:pulse 1s infinite;}
    #creditos-valor{font-size:2.4rem;animation:pulse 1s infinite;}
    #creditos-info{display:flex;align-items:center;justify-content:center;gap:15px;}
    #cartones-gratis{font-family:"Bangers",cursive;color:#fff;font-size:2rem;text-shadow:0 0 8px #00008B;animation:pulse 1s infinite;display:flex;align-items:center;gap:3px;}
    #carton-icon{width:24px;height:24px;}
    #creditos-valor.verde{text-shadow:0 0 5px #006600;}
    #creditos-valor.rojo{text-shadow:0 0 5px red;}
    @keyframes pulse{0%{transform:scale(1);}50%{transform:scale(1.1);}100%{transform:scale(1);}}
    table {
      margin: 10px auto;
      border-collapse: collapse;
      width:100%;
      overflow-x:auto;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px 8px;
      font-size:0.8rem;
      word-break:break-word;
    }
    #tabla-transacciones{width:100%;background:#fff;font-family:Calibri, Arial, sans-serif;margin:5px 0;}
    #tabla-transacciones th,#tabla-transacciones td{font-size:0.9rem;padding:4px 6px;font-weight:bold;}
    #tabla-transacciones th:nth-child(1),#tabla-transacciones td:nth-child(1){width:40px;font-size:0.8rem;}
    #tabla-transacciones th:nth-child(2),#tabla-transacciones td:nth-child(2){width:120px;}
    #tabla-transacciones th:nth-child(3),#tabla-transacciones td:nth-child(3){width:100px;}
    #tabla-transacciones th:nth-child(4),#tabla-transacciones td:nth-child(4){width:140px;}
    #tabla-transacciones th:nth-child(5),#tabla-transacciones td:nth-child(5){width:120px;}
    #tabla-transacciones select,#tabla-transacciones input{font-size:0.9rem;width:100px;}
    #tabla-transacciones th:nth-child(3) input{width:100px;}
    #datos-content{display:none;}
    #transacciones-content{overflow-x:auto;display:none;}
    #transacciones-section .switch{margin-top:4px;}
    #tabla-bancos{background:rgba(255,255,255,0.95);}
    #tabla-bancos th,#tabla-bancos td{
      font-weight:bold;
      color:#00008B;
      text-shadow:0 0 4px #fff;
      text-align:center;
    }
    #banco-retiro{font-weight:bold;color:#00008B;text-shadow:0 0 4px #fff;}
    td.nota-estado{position:relative;cursor:pointer;}
    td.nota-estado::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      width:0;
      height:0;
      border-top:8px solid red;
      border-right:8px solid transparent;
    }
    #modal-detalle{
      position:fixed;
      top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.5);
      display:none;align-items:center;justify-content:center;
      z-index:2000;
    }
    #modal-detalle .contenido{
      background:#fff;padding:15px;border-radius:8px;
      font-family:Calibri, Arial, sans-serif;font-weight:bold;text-align:left;
    }
    #modal-detalle button{margin-top:10px;font-weight:bold;}
    @media (max-width:480px) and (orientation:portrait){
      body{padding:2px;}
      #tabla-transacciones{margin:2px 0;width:100%;}
      #tabla-transacciones th,#tabla-transacciones td{font-size:0.8rem;padding:1px 2px;}
      #tabla-transacciones th:nth-child(1),#tabla-transacciones td:nth-child(1){width:40px;font-size:0.7rem;}
      #tabla-transacciones th:nth-child(2),#tabla-transacciones td:nth-child(2){width:70px;}
      #tabla-transacciones th:nth-child(3),#tabla-transacciones td:nth-child(3){width:50px;}
      #tabla-transacciones th:nth-child(4),#tabla-transacciones td:nth-child(4){width:80px;}
      #tabla-transacciones th:nth-child(5),#tabla-transacciones td:nth-child(5){width:90px;}
      #tabla-transacciones select,#tabla-transacciones input{width:80px;font-size:0.8rem;}
      #tabla-transacciones th:nth-child(3) input{width:50px;}
    }

    @media (orientation:landscape){
      #tabla-transacciones th,#tabla-transacciones td{font-size:0.9rem;}
      #tabla-transacciones th:nth-child(1),#tabla-transacciones td:nth-child(1){width:40px;font-size:0.8rem;}
    }
    .tabs {
      margin-top:20px;
    }
    .tab-buttons{display:flex;justify-content:center;}

    .tab-buttons button {
      flex:1;max-width:150px;padding:12px 0;margin:0 2px;font-family:"Bangers",cursive;font-size:1.2rem;border:1px solid #333;border-bottom:none;border-radius:10px 10px 0 0;color:white;cursor:pointer;text-shadow:2px 2px 4px #000;
    }
    .tab-buttons button[data-tab="depositar"] { background:#0a8800; }
    .tab-buttons button[data-tab="retirar"] { background:#cc0000; }
    .tab-buttons button.active { filter:brightness(1.2); position:relative; top:1px; }
    .tab-content { display:none; margin-top:0; border:1px solid #333; border-radius:0 10px 10px 10px; padding:10px; }
    .tab-content.active { display:block; }
    input, select, textarea {
      font-size:1rem;
      padding:5px;
      margin:5px auto;
      display:block;
      width:250px;
      text-align:center;
    }
    #banco-deposito,#monto-deposito,#referencia,#comentario-deposito{background:#fff;}
    #banco-deposito,#monto-deposito,#referencia{font-weight:bold;}
    #monto-deposito{color:#006400;}
    #referencia{color:#4B0082;}
    #comentario-deposito{color:#333;font-weight:normal;}
    #mis-datos input, #mis-datos select {
      width:260px;
    }
    #banco,#cuenta,#cedula,#pagomovil{font-weight:bold;}
    #banco{color:#00008B;width:100%;box-sizing:border-box;}
    #cuenta{color:#006400;width:100%;box-sizing:border-box;}
    #cedula{color:#4B0082;}
    #pagomovil{color:#FF8C00;}
    .campo{display:flex;flex-direction:column;align-items:center;width:260px;margin:0 auto;}
    #session-info {
      position: fixed;
      top: 10px;
      right: 10px;
      display: flex;
      align-items: center;
      font-size: 0.7rem;
    }
    #user-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    #logout-link {
      font-family: Calibri, Arial, sans-serif;
      margin-left: 5px;
      font-size: 0.7rem;
      color: #007bff;
      text-decoration: underline;
    }
    #mis-datos h3{
      font-size:1.3rem;
      margin:0 0 5px;
    }
    #depositar h3{
      margin:0 0 5px;
    }
    #depositar table{
      margin:5px auto;
    }
    #datos-pm{display:flex;justify-content:center;flex-wrap:wrap;gap:10px;}
    #datos-pm .campo{flex:1 0 120px;max-width:150px;width:auto;}
    #datos-pm .campo input{width:100%;}
    #tipo-cuenta{display:flex;justify-content:center;gap:5px;}
    #tipo-cuenta label{display:flex;align-items:center;gap:3px;}
    #tipo-cuenta input{width:auto;margin:0;}
    .switch{
      position:relative;
      display:inline-block;
      width:42px;
      height:24px;
    }
    .switch input{display:none;}
    .slider{
      position:absolute;
      cursor:pointer;
      top:0;left:0;right:0;bottom:0;
      background-color:#ccc;
      transition:.4s;
      border-radius:24px;
    }
    .slider:before{
      position:absolute;
      content:"";
      height:18px;width:18px;left:3px;bottom:3px;
      background-color:white;
      transition:.4s;
      border-radius:50%;
    }
    input:checked + .slider{background-color:#4caf50;}
    input:checked + .slider:before{transform:translateX(18px);}
    #guardar-datos {
      font-family: 'Bangers', cursive;
      font-size: 1.2rem;
      background: #0a8800;
      color: white;
      border: 3px solid #FFD700;
      border-radius: 8px;
      text-shadow: 2px 2px 4px #000;
      width: 200px;
      cursor:pointer;
    }
    #btn-depositar {
      font-family: 'Bangers', cursive;
      background: linear-gradient(#0a8800, #ffffff);
      color: white;
      border: 3px solid #FFD700;
      border-radius: 8px;
      text-shadow:2px 2px 4px #000;
      font-size:1.2rem;
      width:200px;
      cursor:pointer;
    }
    #btn-retirar {
      font-family: 'Bangers', cursive;
      background: linear-gradient(#cc0000, #ffffff);
      color: white;
      border: 3px solid #FFD700;
      border-radius: 8px;
      text-shadow:2px 2px 4px #000;
      font-size:1.2rem;
      width:200px;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div id="session-info" style="display:none;">
    <img id="user-pic" referrerpolicy="no-referrer" crossorigin="anonymous" src="" alt="Usuario" />
    <a href="#" id="logout-link">Cerrar sesi√≥n</a>
  </div>
  <button id="volver-btn" class="menu-btn back-btn">&#9664; Volver</button>
  <div id="creditos-container">
    <div id="creditos-title">CREDITOS</div>
    <div id="creditos-info">
      <div id="creditos-valor" class="rojo">0</div>
      <div id="cartones-gratis">
        <img id="carton-icon" src="https://cdn-icons-png.flaticon.com/32/5065/5065890.png" alt="Ticket">
        <span id="cartones-valor">0</span>
      </div>
    </div>
  </div>

  <div id="mis-datos">
    <div style="display:flex;align-items:center;justify-content:center;gap:10px;">
      <h3 style="margin:0;">Mis datos bancarios</h3>
      <label class="switch">
        <input type="checkbox" id="toggle-datos">
        <span class="slider"></span>
      </label>
    </div>
    <div id="datos-content">
      <div class="campo">
        <select id="banco">
          <option value="" disabled selected>Banco</option>
        </select>
      </div>
      <div class="campo">
        <input type="text" id="cuenta" placeholder="N¬∞ Cuenta Bancaria">
      </div>
      <div id="tipo-cuenta">
        <label><input type="radio" name="tipo-cuenta" value="Ahorro"> Ahorro</label>
        <label><input type="radio" name="tipo-cuenta" value="Corriente"> Corriente</label>
      </div>
      <div id="datos-pm">
        <div class="campo">
          <input type="text" id="cedula" placeholder="C√©dula">
        </div>
        <div class="campo">
          <input type="text" id="pagomovil" placeholder="N√∫mero Pago m√≥vil">
        </div>
      </div>
      <button id="guardar-datos">Guardar Datos</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tab-buttons">
      <button data-tab="depositar" class="active">DEP√ìSITOS</button>
      <button data-tab="retirar">RETIROS</button>
    </div>
    <div id="depositar" class="tab-content active">
      <h3>Bancos habilitados para dep√≥sitos</h3>
      <table id="tabla-bancos">
        <thead>
          <tr><th>Banco</th><th>N¬∞ Pago M√≥vil</th><th>C√©dula</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <select id="banco-deposito">
        <option value="" disabled selected>Banco donde transferiste</option>
      </select>
      <input type="number" id="monto-deposito" placeholder="Monto">
        <input type="text" id="referencia" placeholder="Referencia (√∫ltimos 5 d√≠gitos)" inputmode="numeric" pattern="\d*" maxlength="5" oninput="this.value=this.value.replace(/\D/g,"");">
      <textarea id="comentario-deposito" placeholder="Comentario (opcional)"></textarea>
      <button id="btn-depositar">Solicitar Dep√≥sito</button>
    </div>
    <div id="retirar" class="tab-content">
      <label id="banco-retiro"></label>
      <input type="number" id="monto-retiro" placeholder="Monto" step="0.01">
      <div id="descuentos-retiro">
        <div id="descuento-bancario" style="font-weight:bold;">
          Descuento Bancario <span id="porcentaje-retiro" style="color:#00008B;"></span>% por retiro bancario
        </div>
        <div id="descuento-admin" style="font-weight:bold;">
          Descuento del <span id="porcentaje-admin" style="color:#00008B;"></span>% por gesti√≥n administrativa
        </div>
      </div>
      <input type="number" id="monto-retiro-neto" placeholder="Monto a recibir" readonly>
      <textarea id="comentario-retiro" placeholder="Comentario (opcional)"></textarea>
      <button id="btn-retirar">Retirar</button>
    </div>
  </div>
  <div id="transacciones-section">
    <div style="display:flex;align-items:center;justify-content:center;gap:10px;">
      <h3 style="margin:0;">Mis transacciones</h3>
      <label class="switch">
        <input type="checkbox" id="toggle-transacciones">
        <span class="slider"></span>
      </label>
    </div>
    <div id="transacciones-content">
      <table id="tabla-transacciones">
        <thead>
          <tr>
            <th>N¬∞</th>
            <th>
              <select id="filtro-tipo">
                <option value="">TIPO</option>
                <option value="deposito">DEPOSITO</option>
                <option value="retiro">RETIRO</option>
              </select>
            </th>
            <th><input id="filtro-monto" type="number" placeholder="MONTO"></th>
            <th><input id="filtro-fecha" type="date"></th>
            <th>
              <select id="filtro-estado">
                <option value="">ESTADO</option>
                <option value="PENDIENTE">Pendiente</option>
                <option value="APROBADO">Aprobado</option>
                <option value="ANULADO">Anulado</option>
              </select>
            </th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="modal-detalle"><div class="contenido"></div></div>

  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-auth-compat.js"></script>
  <script src="auth.js"></script>
  <script>
    ensureAuth();
    const transacciones=[];
    let porcentajeRetiro=0, porcentajeAdministra=0;

    function cargarBancosBilletera(){
      db.collection('Bancos').where('categoria','==','Jugadores').where('estado','==','Activo').onSnapshot(snap=>{
        const sel=document.getElementById('banco');
        sel.innerHTML='<option value="" disabled selected>Banco</option>';
        snap.forEach(doc=>{
          const nombre=doc.data().nombre||doc.id;
          const opt=document.createElement('option');
          opt.value=nombre;
          opt.textContent=nombre;
          sel.appendChild(opt);
        });
      });
    }

    function cargarBancosBingo(){
      db.collection('Bancos').where('categoria','==','Bingo').where('estado','==','Activo').onSnapshot(snap=>{
      const tbody=document.querySelector('#tabla-bancos tbody');
      const sel=document.getElementById('banco-deposito');
      sel.innerHTML='<option value="" disabled selected>Banco donde transferiste</option>';
      tbody.innerHTML='';
      snap.forEach(doc=>{
        const nombre=doc.data().nombre||doc.id;
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${nombre}</td><td>${doc.data().pagomovil||''}</td><td>${doc.data().cedula||''}</td>`;
        tbody.appendChild(tr);
        const opt=document.createElement('option');
        opt.value=nombre;
        opt.textContent=nombre;
        sel.appendChild(opt);
      });
    });
    }

    document.querySelectorAll('.tab-buttons button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-buttons button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
      });
    });

    auth.onAuthStateChanged(async user => {
      if(!user) return;
      cargarBancosBilletera();
      cargarBancosBingo();
      const paramDoc = await db.collection('Variablesglobales').doc('Parametros').get();
      if(paramDoc.exists){
        porcentajeRetiro = parseFloat(paramDoc.data().porcentajeretiro) || 0;
        porcentajeAdministra = parseFloat(paramDoc.data().porcentajeadministra) || 0;
        document.getElementById('porcentaje-retiro').textContent = porcentajeRetiro;
        document.getElementById('porcentaje-admin').textContent = porcentajeAdministra;
        actualizarMontoNeto();
      }
      const billeteraRef = db.collection('Billetera').doc(user.email);
      const doc = await billeteraRef.get();
      if(doc.exists){
        const data = doc.data();
        const valorEl=document.getElementById('creditos-valor');
        valorEl.textContent=data.creditos||0;
        valorEl.className=data.creditos>0?'verde':'rojo';
        document.getElementById('cartones-valor').textContent = data.CartonesGratis || 0;
        document.getElementById('cedula').value = data.cedula || '';
        document.getElementById('pagomovil').value = data.pagomovil || '';
        document.getElementById('banco').value = data.banco || '';
        document.getElementById('cuenta').value = data.cuenta || '';
        if(data.tipoCuenta){
          const r=document.querySelector(`input[name='tipo-cuenta'][value='${data.tipoCuenta}']`);
          if(r) r.checked=true;
        }
        document.getElementById('banco-retiro').textContent = 'Banco donde recibir√°s: '+(data.banco||'');
      } else {
        await billeteraRef.set({creditos:0, CartonesGratis:0});
        document.getElementById('creditos-valor').textContent='0';
        document.getElementById('creditos-valor').className='rojo';
        document.getElementById('cartones-valor').textContent='0';
        document.getElementById('banco-retiro').textContent='Banco donde recibir√°s:';
      }
      cargarTransacciones();
    });

    document.getElementById('guardar-datos').addEventListener('click', async () => {
      const user = auth.currentUser;
      const data = {
        cedula: document.getElementById('cedula').value.trim(),
        pagomovil: document.getElementById('pagomovil').value.trim(),
        banco: document.getElementById('banco').value,
        cuenta: document.getElementById('cuenta').value.trim(),
        tipoCuenta: document.querySelector('input[name="tipo-cuenta"]:checked')?.value || ''
      };
      if(!data.cedula){ alert('Ingrese su c√©dula'); document.getElementById('cedula').focus(); return; }
      if(!/^\d+$/.test(data.cedula)){ alert('La c√©dula solo debe contener n√∫meros'); document.getElementById('cedula').focus(); return; }
      if(!data.pagomovil){ alert('Ingrese su n√∫mero de pago m√≥vil'); document.getElementById('pagomovil').focus(); return; }
      if(!/^\d+$/.test(data.pagomovil)){ alert('El pago m√≥vil solo debe contener n√∫meros'); document.getElementById('pagomovil').focus(); return; }
      if(!data.banco){ alert('Seleccione su banco'); document.getElementById('banco').focus(); return; }
      if(!data.cuenta){ alert('Ingrese su n√∫mero de cuenta'); document.getElementById('cuenta').focus(); return; }
      if(!/^\d+$/.test(data.cuenta)){ alert('La cuenta solo debe contener n√∫meros'); document.getElementById('cuenta').focus(); return; }
      if(!data.tipoCuenta){ alert('Seleccione el tipo de cuenta'); return; }
      data.CartonesGratis=parseInt(document.getElementById('cartones-valor').textContent)||0;
      await db.collection('Billetera').doc(user.email).set(data, {merge:true});
      alert('Datos guardados');
    });

    function fechaActual(){
      const d=new Date();
      const dia=String(d.getDate()).padStart(2,'0');
      const mes=String(d.getMonth()+1).padStart(2,'0');
      const anio=d.getFullYear();
      return `${dia}/${mes}/${anio}`;
    }
    function horaActual(){
      const d=new Date();
      return d.toLocaleTimeString('es-VE',{hour:'2-digit',minute:'2-digit'});
    }

    function formatearFecha(str){
      if(!str) return '';
      if(str.includes('/')){
        const [d,m,a]=str.split('/');
        return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${a.padStart(4,'0')}`;
      }
      const [a,m,d]=str.split('-');
      return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${a}`;
    }

    function aHora24(str){
      if(!str) return '00:00';
      str=str.toLowerCase().replace(/\./g,'').replace(/\s+/g,'');
      const m=str.match(/(\d{1,2}):(\d{2})(?::(\d{2}))?(a|p)?m?/);
      if(!m) return str;
      let h=parseInt(m[1],10);const min=m[2];const ap=m[4];
      if(ap==='p'&&h<12)h+=12;
      if(ap==='a'&&h===12)h=0;
      return `${String(h).padStart(2,'0')}:${min}`;
    }

    function parseFechaHora(f,h){
      const [d,m,a]=f.split('/');
      return new Date(`${a}-${m}-${d}T${aHora24(h)}:00`);
    }

    function formatearHora(str){
      if(!str) return '';
      const [h24,min] = aHora24(str).split(':');
      let h=parseInt(h24,10);
      const ampm=h>=12?'pm':'am';
      h=h%12; if(h===0) h=12;
      return `${h}:${min} ${ampm}`;
    }

    async function cargarTransacciones(){
      const user=auth.currentUser;
      const snap=await db.collection('transacciones').where('IDbilletera','==',user.email).get();
      transacciones.length=0;
      snap.forEach(doc=>{
        const data=doc.data();
        data.fechasolicitud=formatearFecha(data.fechasolicitud);
        data.fechagestion=formatearFecha(data.fechagestion);
        transacciones.push({id:doc.id,...data});
      });
      transacciones.sort((a,b)=>{
        const da=parseFechaHora(a.fechagestion||a.fechasolicitud,a.horagestion||a.horasolicitud);
        const db=parseFechaHora(b.fechagestion||b.fechasolicitud,b.horagestion||b.horasolicitud);
        return db-da;
      });
      filtrarTransacciones();
    }

    function filtrarTransacciones(){
      const tipo=document.getElementById('filtro-tipo').value;
      const monto=document.getElementById('filtro-monto').value.trim();
      const fechaInput=document.getElementById('filtro-fecha').value;
      const fecha=fechaInput?fechaInput.split('-').reverse().join('/'):'';
      const estado=document.getElementById('filtro-estado').value;
      const tbody=document.querySelector('#tabla-transacciones tbody');
      tbody.innerHTML='';
      let n=1;
      transacciones.forEach(t=>{
        if(t.estado==='ARCHIVADO') return;
        if(tipo && t.tipotrans!==tipo) return;
        if(monto && parseFloat(t.Monto)!=parseFloat(monto)) return;
        const f=formatearFecha(t.estado==='PENDIENTE'?t.fechasolicitud:t.fechagestion);
        if(fecha && f!==fecha) return;
        if(estado && t.estado!==estado) return;
        const estadoColor=t.estado==='PENDIENTE'?'orange':t.estado==='ANULADO'?'red':t.estado==='APROBADO'?'green':'black';
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${n}</td><td style="color:${t.tipotrans==='deposito'?'green':'red'}">${t.tipotrans.toUpperCase()}</td><td class="celda-monto" style="color:${t.tipotrans==='deposito'?'green':'red'}">${t.Monto}</td><td class="celda-fecha">${f}</td><td style="color:${estadoColor}">${t.estado}</td>`;
        const fechaTd=tr.querySelector('.celda-fecha');
        fechaTd.style.cursor='pointer';
        fechaTd.addEventListener('click',()=>mostrarDetalle(t));
        const montoTd=tr.querySelector('.celda-monto');
        montoTd.style.cursor='pointer';
        montoTd.addEventListener('click',()=>mostrarDetalleMonto(t));
        const estadoTd=tr.lastElementChild;
        if(t.estado==='ANULADO' && t.nota){
          estadoTd.classList.add('nota-estado');
          estadoTd.addEventListener('click',e=>{e.stopPropagation();alert(t.nota);});
        }
        tbody.appendChild(tr);n++;});
      }

      function mostrarDetalle(t){
        const ref=t.referencia||'';
        const fs=formatearFecha(t.fechasolicitud||'');
        const hs=formatearHora(t.horasolicitud||'');
        const fg=formatearFecha(t.fechagestion||'');
        const hg=formatearHora(t.horagestion||'');
        const cont=document.querySelector('#modal-detalle .contenido');
        cont.innerHTML=`<div style="color:#00008B;">Referencia: ${ref}</div>`+
        `<div style="color:orange;">Fecha de solicitud: ${fs}</div>`+
        `<div style="color:orange;">Hora de solicitud: ${hs}</div>`+
        `<div style="color:green;">Fecha de gesti√≥n: ${fg}</div>`+
        `<div style="color:green;">Hora de gesti√≥n: ${hg}</div>`+
        `<button id="modal-ok">Aceptar</button>`;
        const modal=document.getElementById('modal-detalle');
        modal.style.display='flex';
        document.getElementById('modal-ok').addEventListener('click',()=>{modal.style.display='none';},{once:true});
      }

      function mostrarDetalleMonto(t){
        const solicitado=t.tipotrans==='retiro'?parseFloat(t.MontoSolicitado||t.Monto):parseFloat(t.Monto);
        const comB=t.tipotrans==='retiro'?solicitado*porcentajeRetiro/100:0;
        const comG=t.tipotrans==='retiro'?solicitado*porcentajeAdministra/100:0;
        const total=parseFloat(t.Monto);
        const cont=document.querySelector('#modal-detalle .contenido');
        cont.innerHTML=
          `<div style="font-weight:bold;color:purple;">Monto solicitado: ${solicitado.toFixed(2)}</div>`+
          `<div style="color:orange;">Comisi√≥n Bancaria: ${comB.toFixed(2)}</div>`+
          `<div style="color:orange;">Comisi√≥n Gesti√≥n: ${comG.toFixed(2)}</div>`+
          `<div style="font-weight:bold;color:darkgreen;">Total recibido: ${total.toFixed(2)}</div>`+
          `<button id='modal-ok'>Aceptar</button>`;
        const modal=document.getElementById('modal-detalle');
        modal.style.display='flex';
        document.getElementById('modal-ok').addEventListener('click',()=>{modal.style.display='none';},{once:true});
      }

      document.getElementById('filtro-tipo').addEventListener('change',filtrarTransacciones);
      document.getElementById('filtro-monto').addEventListener('input',filtrarTransacciones);
    document.getElementById('filtro-fecha').addEventListener('change',filtrarTransacciones);
    document.getElementById('filtro-estado').addEventListener('change',filtrarTransacciones);

    async function validarDatosBancarios(){
      const user=auth.currentUser;
      const doc=await db.collection('Billetera').doc(user.email).get();
      const d=doc.data()||{};
      if(d.banco && d.cuenta && d.cedula && d.pagomovil && d.tipoCuenta){
        return true;
      }
      alert('Antes de realizar un Deposito o Retiro debes tener todos tus datos bancarios Registrados');
      const toggle=document.getElementById('toggle-datos');
      toggle.checked=true;
      document.getElementById('datos-content').style.display='block';
      if(!d.banco){document.getElementById('banco').focus();}
      else if(!d.cuenta){document.getElementById('cuenta').focus();}
      else if(!d.cedula){document.getElementById('cedula').focus();}
      else if(!d.pagomovil){document.getElementById('pagomovil').focus();}
      else if(!d.tipoCuenta){document.querySelector('input[name="tipo-cuenta"]').focus();}
      return false;
    }

    function limpiarCamposTransaccion(tipo){
      if(tipo==='deposito'){
        document.getElementById('banco-deposito').selectedIndex=0;
        document.getElementById('monto-deposito').value='';
        document.getElementById('referencia').value='';
        document.getElementById('comentario-deposito').value='';
      }else if(tipo==='retiro'){
        document.getElementById('monto-retiro').value='';
        document.getElementById('comentario-retiro').value='';
        document.getElementById('monto-retiro-neto').value='';
      }
    }

    function actualizarMontoNeto(){
      const monto=parseFloat(document.getElementById('monto-retiro').value)||0;
      const neto=monto - (monto*porcentajeRetiro/100) - (monto*porcentajeAdministra/100);
      document.getElementById('monto-retiro-neto').value=neto>0?neto.toFixed(2):'';
    }

    document.getElementById('monto-retiro').addEventListener('input',actualizarMontoNeto);

    document.getElementById('btn-depositar').addEventListener('click', async () => {
      if(!await validarDatosBancarios()) return;
      const user = auth.currentUser;
      const banco=document.getElementById('banco-deposito').value;
      if(!banco){alert('Seleccione el banco donde transferiste');document.getElementById('banco-deposito').focus();return;}
      const montoStr=document.getElementById('monto-deposito').value.trim();
      const monto=parseFloat(montoStr);
      if(!montoStr || isNaN(monto) || monto<=0){alert('Ingrese un monto v√°lido');document.getElementById('monto-deposito').focus();return;}
      const ref=document.getElementById('referencia').value.trim();
      if(!/^[0-9]{5}$/.test(ref)){alert('Ingrese la referencia de 5 d√≠gitos');document.getElementById('referencia').focus();return;}
      const data = {
        tipotrans:'deposito',
        bancoreceptor:banco,
        Monto:monto,
        referencia:ref,
        comentario: document.getElementById('comentario-deposito').value.trim(),
        estado:'PENDIENTE',
        IDbilletera: user.email,
        fechasolicitud: fechaActual(),
        horasolicitud: horaActual(),
        usuariogestor:'',
        rolusuario:'',
        fechagestion:'',
        horagestion:'',
        nota:''
      };
      await db.collection('transacciones').add(data);
      alert('Bien, recibimos tu solicitud, una vez verificado el pago se recargar√° tu billetera');
      limpiarCamposTransaccion('deposito');
      cargarTransacciones();
    });

    async function ejecutarRetiro(monto,montoFinal){
      const user=auth.currentUser;
      const docB=await db.collection('Billetera').doc(user.email).get();
      const data={
        tipotrans:'retiro',
        bancoreceptor: docB.exists?(docB.data().banco||''):'',
        MontoSolicitado:monto,
        Monto:montoFinal,
        referencia:'',
        comentario:document.getElementById('comentario-retiro').value.trim(),
        estado:'PENDIENTE',
        IDbilletera:user.email,
        fechasolicitud:fechaActual(),
        horasolicitud:horaActual(),
        usuariogestor:'',
        rolusuario:'',
        fechagestion:'',
        horagestion:'',
        nota:''
      };
      await db.collection('transacciones').add(data);
      alert('Solicitud enviada, una vez validada se transferir√° a tu pago m√≥vil');
      limpiarCamposTransaccion('retiro');
      cargarTransacciones();
    }

    document.getElementById('btn-retirar').addEventListener('click', async () => {
      if(!await validarDatosBancarios()) return;
      const montoStr=document.getElementById('monto-retiro').value.trim();
      const monto=parseFloat(montoStr);
      if(!montoStr || isNaN(monto) || monto<=0){alert('Ingrese un monto v√°lido');document.getElementById('monto-retiro').focus();return;}
      const creditos=parseFloat(document.getElementById('creditos-valor').textContent) || 0;
      if(monto>creditos){ alert('El monto supera los cr√©ditos disponibles'); return; }
      const montoFinal=monto - (monto*porcentajeRetiro/100) - (monto*porcentajeAdministra/100);
      document.getElementById('monto-retiro-neto').value = montoFinal>0 ? montoFinal.toFixed(2) : '';
      if(confirm(`¬øConfirmas la solicitud de retiro por ${montoFinal.toFixed(2)}?`)){
        await ejecutarRetiro(monto,montoFinal);
      }
    });

    document.getElementById('volver-btn').addEventListener('click',()=>{
      window.location.href='player.html';
    });

    const camposLabels=[
      {campo:'banco',label:'label-banco'},
      {campo:'cuenta',label:'label-cuenta'},
      {campo:'cedula',label:'label-cedula'},
      {campo:'pagomovil',label:'label-pagomovil'}
    ];
    camposLabels.forEach(({campo,label})=>{
      const c=document.getElementById(campo);
      const l=document.getElementById(label);
      function actualizar(){l.style.display=c.value?'block':'none';}
      c.addEventListener('input',actualizar);
      c.addEventListener('change',actualizar);
      actualizar();
    });

    </script>
    <script>
      document.addEventListener('DOMContentLoaded',()=>{
      const toggle=document.getElementById('toggle-datos');
      const datos=document.getElementById('datos-content');
      const toggleT=document.getElementById('toggle-transacciones');
      const transDiv=document.getElementById('transacciones-content');

      function actualizarVisibilidad(){
        datos.style.display=toggle.checked?'block':'none';
      }
      function visTrans(){
        transDiv.style.display=toggleT.checked?'block':'none';
      }
      toggle.addEventListener('change',actualizarVisibilidad);
      toggleT.addEventListener('change',visTrans);
      actualizarVisibilidad();
      visTrans();
    });
  </script>
</body>
</html>
